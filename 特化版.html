<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— å›½ç•ŒåŒ»ç”Ÿï¼šå‰çº¿æŒ‡æŒ¥å®˜ (DeepSeek R1ç‰ˆ)</title>
    <style>
        /* æ—¥å¤œæ¨¡å¼å˜é‡å®šä¹‰ */
        :root {
            /* å¤œé—´æ¨¡å¼ (é»˜è®¤) */
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
            --primary: #ff4d4d;
            --accent: #d35400;
            --green: #2ecc71;
            --blue: #3498db;
            --gold: #f1c40f;
            --purple: #9b59b6;
            --border: #333;
            --input-bg: #2d2d2d;
            --bio-bg: #2a2520;
            --bio-text: #bdc3c7;
            --hover: #333;
            --danger: #e74c3c;
            --nav-height: 60px;
        }

        /* æ—¥é—´æ¨¡å¼ç±» */
        body.day-mode {
            --bg: #fdf6e3;
            --panel: #ffffff;
            --text: #333333;
            --primary: #EE0000;
            --accent: #e67e22;
            --green: #27ae60;
            --blue: #2980b9;
            --gold: #f39c12;
            --purple: #8e44ad;
            --border: #ddd;
            --input-bg: #eee;
            --bio-bg: #fff8e1;
            --bio-text: #5d4037;
            --hover: #fffdf5;
            --danger: #c0392b;
        }

        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; transition: background 0.3s, color 0.3s; padding-bottom: var(--nav-height); }
        .container { max-width: 800px; margin: 0 auto; background: var(--panel); padding: 20px; min-height: 100vh; box-sizing: border-box; position: relative; }
        
        /* å¤´éƒ¨ä¸çŠ¶æ€ */
        header { border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; flex-direction: column; gap: 5px; }
        
        .system-btns { display: flex; gap: 8px; margin-bottom: 5px; }
        .sys-btn { padding: 4px 8px; font-size: 0.8rem; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; }
        .sys-btn:hover { background: var(--accent); color: white; }

        .header-center { 
            font-size: 1.1rem; font-weight: bold; color: var(--danger); 
            border: 2px solid var(--danger); padding: 5px 15px; border-radius: 20px; 
            background: rgba(231, 76, 60, 0.1); 
            animation: heartbeat 2s infinite; 
            text-align: center;
        }
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        h1 { margin: 0; font-size: 1.6rem; color: var(--text); }
        #game-location-display { font-size: 0.95rem; color: var(--accent); font-weight: bold; margin-top: 5px; display: none; animation: fadeIn 1s; }
        
        .day-counter { background: var(--border); color: var(--text); padding: 5px 10px; border-radius: 4px; font-weight: bold; height: fit-content; border: 1px solid var(--text); min-width: 80px; text-align: center; }

        #theme-toggle {
            position: absolute; top: 10px; right: 10px; z-index: 100;
            background: rgba(0,0,0,0.5); border: 1px solid var(--text); color: var(--text);
            padding: 5px; font-size: 1rem; margin: 0; width: auto; border-radius: 50%;
        }

        /* ç•Œé¢åˆ‡æ¢ */
        .screen { display: none; animation: fadeIn 0.5s; padding-bottom: 20px; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* åŠ è½½ç•Œé¢ */
        #loading-screen { text-align: center; padding-top: 50px; }
        .loader-content { display: inline-block; text-align: left; background: #000; color: #0f0; padding: 20px; border-radius: 5px; font-family: 'Courier New', Courier, monospace; width: 80%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .loader-spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .log-line { margin: 5px 0; opacity: 0; animation: typeIn 0.5s forwards; }
        @keyframes typeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* æŒ‰é’®ä½“ç³» */
        button { background: var(--border); color: var(--text); border: none; padding: 12px 18px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-bottom: 8px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); background: var(--primary); color: white; }
        button:disabled { background: #555; cursor: not-allowed; transform: none; color: #888; }
        
        .action-btn { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; background: var(--panel); border: 1px solid var(--border); }
        .action-btn:hover { background: var(--hover); }
        
        .skill-btn { background: var(--accent); color: white; width: 100%; }
        .rest-btn { background: var(--green); color: white; width: 100%; margin-top: 15px; font-weight: bold; }
        
        .choice-btn { 
            background: var(--panel); color: var(--text); border: 2px solid var(--border); width: 100%; text-align: left; padding: 18px; margin-bottom: 12px;
            transition: all 0.2s;
        }
        .choice-btn:hover { border-color: var(--accent); background: var(--hover); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .input-group { background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: var(--text); }
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; background: var(--panel); color: var(--text); }

        /* Slider æ ·å¼ */
        .slider-container { background: var(--input-bg); padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 8px; }
        input[type=range] { width: 100%; margin: 10px 0; }
        .slider-val { float: right; font-weight: bold; color: var(--gold); }

        /* æ•°å€¼æ¡ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--input-bg); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent); position: relative; }
        .bar-bg { background: #555; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; background: var(--accent); width: 50%; transition: width 0.5s ease-out; }
        .bar-fill.high { background: var(--green); }
        .bar-fill.low { background: var(--primary); }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--panel); border-top: 1px solid var(--border);
            display: grid; grid-template-columns: repeat(7, 1fr); /* 7ä¸ªTab */
            z-index: 999; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .nav-item {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; color: #888; font-size: 0.7rem; transition: 0.2s; padding: 2px 0;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; background: rgba(255,255,255,0.05); }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }

        /* å†…å®¹åŒºåŸŸ */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        .bio-box { background: var(--bio-bg); padding: 15px; border-radius: 6px; font-style: italic; color: var(--bio-text); line-height: 1.6; margin-bottom: 20px; border: 1px dashed var(--border); }

        .rank-card {
            background: linear-gradient(135deg, var(--input-bg), var(--panel));
            border: 2px solid var(--gold); border-radius: 8px; padding: 15px;
            margin-bottom: 20px; text-align: center;
        }
        .rank-title { font-size: 1.4rem; font-weight: bold; color: var(--gold); margin-bottom: 5px; }
        .rank-progress { font-size: 0.9rem; color: #888; margin-bottom: 10px; }
        .rank-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

        /* å•†åº—ç‰©å“ Grid */
        .item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card { background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .item-name { font-weight: bold; color: var(--accent); margin-bottom: 5px; font-size: 1rem; }
        .item-price { color: var(--gold); font-weight: bold; margin-bottom: 5px; }
        .item-desc { font-size: 0.8em; color: #aaa; margin-bottom: 10px; height: 3em; overflow: hidden; }
        .buy-btn { width: 100%; padding: 8px; font-size: 0.9rem; background: var(--border); color: var(--text); }
        .buy-btn:not(:disabled):hover { background: var(--green); color: white; }

        #event-area { background: var(--panel); border: 1px solid var(--border); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .event-tag { display: inline-block; background: var(--primary); color: white; padding: 3px 8px; font-size: 0.8rem; border-radius: 4px; margin-bottom: 10px; text-transform: uppercase; }
        .event-text { line-height: 1.8; color: var(--text); font-size: 1.05rem; margin-bottom: 25px; text-align: justify; }
        .loading-spinner { text-align: center; padding: 40px; color: #888; display: none; }

        /* ç—…æˆ¿æ ·å¼ */
        .patient-card { background: var(--input-bg); border-left: 4px solid #888; padding: 10px; margin-bottom: 10px; border-radius: 4px; position: relative; }
        .p-sev-0 { border-color: var(--green); }
        .p-sev-1 { border-color: var(--gold); }
        .p-sev-2 { border-color: var(--danger); }
        .p-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; }
        .p-info { font-size: 0.9rem; color: #bbb; margin-bottom: 5px; }
        .p-desc { font-size: 0.85rem; font-style: italic; color: #888; margin-bottom: 8px; }
        .p-actions { display: flex; gap: 5px; margin-top: 5px; }
        .p-btn { padding: 4px 8px; font-size: 0.8rem; flex: 1; }

        /* è€ƒæ ¸æ ·å¼ */
        .exam-box { background: var(--input-bg); padding: 15px; border: 1px solid var(--border); border-radius: 8px; }
        .exam-q { font-size: 1.1rem; margin-bottom: 15px; font-weight: bold; }
        .exam-opt { width: 100%; text-align: left; margin-bottom: 8px; padding: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
        .exam-opt:hover { border-color: var(--blue); }
        .streak-badge { background: var(--gold); color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; margin-left: 10px; }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .custom-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 2000; display: none;
            justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: var(--panel); width: 90%; max-width: 400px; padding: 0; 
            border-radius: 10px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: popIn 0.3s; border: 1px solid var(--border); color: var(--text); position: relative; max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { background: var(--input-bg); color: var(--text); padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid var(--border); }
        .modal-body { padding: 20px; text-align: center; }
        
        #result-status { font-weight: bold; font-size: 1.2rem; text-align: center; margin-bottom: 10px; }
        .status-success { color: var(--green); }
        .status-fail { color: var(--primary); }

        #result-text, .msg-text { font-style: italic; color: var(--text); opacity: 0.9; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); line-height: 1.5; }

        .change-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .change-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 1.1rem; }
        .change-val { font-weight: bold; }
        .val-up { color: var(--green); }
        .val-down { color: var(--primary); }
        .modal-btn { width: 100%; padding: 15px; background: var(--primary); border-radius: 0; margin: 0; font-size: 1.1rem; color: white; cursor: pointer; border: none; }
        .modal-btn:hover { opacity: 0.9; }
        .modal-btn.secondary { background: var(--border); color: var(--text); }
        
        .save-slot-btn { 
            display: block; width: 100%; text-align: left; margin-bottom: 10px; 
            background: var(--input-bg); border: 1px solid var(--border); padding: 15px;
            border-radius: 6px; cursor: pointer;
        }
        .save-slot-btn:hover { border-color: var(--accent); }
        .save-meta { font-size: 0.8em; color: #888; margin-top: 5px; }

        #start-event-btn { 
            width: 100%; margin-top: 15px; background: var(--accent); padding: 15px; 
            font-size: 1.1rem; font-weight: bold; display: none; color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(230, 126, 34, 0); } 100% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); } }

        #story-container {
            margin-top: 20px; text-align: left;
            border: 1px solid var(--border); background: var(--input-bg);
            padding: 15px; border-radius: 6px; display: none;
        }
        #story-content {
            font-family: 'Georgia', serif; line-height: 1.8; white-space: pre-wrap;
            max-height: 300px; overflow-y: auto; color: var(--text);
        }
        #gen-story-btn {
            background: var(--accent);
            width: 100%; margin-top: 15px; padding: 15px;
            font-weight: bold; color: white;
        }

        .achieve-list { list-style: none; padding: 0; }
        .achieve-item { background: var(--input-bg); margin-bottom: 10px; padding: 10px; border-radius: 4px; border-left: 3px solid var(--gold); }
    </style>
</head>
<body>

<button id="theme-toggle" onclick="toggleTheme()">â˜€/ğŸŒ™</button>

<div class="container">
    <header>
        <div class="header-left">
            <div class="system-btns">
                <button class="sys-btn" id="exit-game-btn" onclick="tryExitGame()">ğŸšª é€€å‡º</button>
                <button class="sys-btn" onclick="saveGameManual()">ğŸ’¾ å­˜æ¡£</button>
                <button class="sys-btn" onclick="openLoadModal()">ğŸ“‚ è¯»æ¡£</button>
            </div>
            <h1>ğŸš‘ å‰çº¿æŒ‡æŒ¥å®˜ <span style="font-size:0.6em; color:#888">MSF</span></h1>
            <div id="game-location-display">ğŸ“ ???</div>
        </div>
        
        <div class="header-center">âš  å±é™©åº¦ <span id="val-danger">5</span></div>

        <div class="day-counter" id="day-display">ç¬¬1å¹´ æ˜¥</div>
    </header>

    <div id="setup-screen" class="screen active">
        <div class="input-group">
            <h3>ğŸ“¡ æ€»éƒ¨é€šè®¯è®¾ç½®</h3>
            
            <p style="font-size:0.8em; color:#888;">å¼€å‘è€…API Keyå·²é¢„è£…ã€‚å¦‚éœ€ä½¿ç”¨è‡ªå·±çš„Keyè¯·åœ¨ä¸‹æ–¹è¾“å…¥ã€‚</p>
            <label style="font-size:0.9em; font-weight:bold;">API Base URL:</label>
            <input type="text" id="api-url" value="https://api.deepseek.com">

            <label style="font-size:0.9em; font-weight:bold; margin-top:10px; display:block;">è‡ªå®šä¹‰API Key (å¯é€‰):</label>
            <input type="password" id="api-key" placeholder="ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤Key...">
            
            <label style="font-size:0.9em; font-weight:bold; margin-top:10px; display:block;">æ¨¡å‹ç‰ˆæœ¬:</label>
            <input type="text" id="model-name" value="deepseek-reasoner" placeholder="deepseek-reasoner">
            
            <div style="margin-top:15px;">
                <input type="checkbox" id="use-mock" onchange="toggleApiInput()"> 
                <label for="use-mock">ç¦»çº¿æ¨¡æ‹Ÿæ¨¡å¼ (æ—  Key å¯ç©)</label>
            </div>
        </div>
        <div class="input-group">
            <h3>ğŸªª å¿—æ„¿ç”³è¯·è¡¨</h3>
            
            <button id="continue-btn" onclick="openLoadModal()" style="display:none; background:var(--green); color:white; width:100%; margin-bottom:15px; border:2px solid var(--text);">ğŸ”„ ç»§ç»­æ¸¸æˆ (æ£€æµ‹åˆ°å­˜æ¡£)</button>

            <div style="margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 10px;">
                <strong>ğŸ“ ä»»åŠ¡åœ°ç‚¹:</strong> <span id="p-location" style="color:var(--primary); font-weight:bold;">æ­£åœ¨åˆ†é…...</span>
            </div>

            <div style="display: flex; justify-content: space-between; margin-bottom:10px;">
                <div>
                    <strong><span id="p-name">?</span></strong> 
                    <span style="color:#888; font-size:0.9em;">(<span id="p-gender">?</span> / <span id="p-dept">?</span>)</span>
                </div>
                <button onclick="rollCharacter()" style="padding:5px 10px; font-size:0.8rem;">ğŸ² é‡ç½®</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; text-align:center;">
                <div style="background:var(--panel); border:1px solid var(--border); padding:5px; border-radius:4px;">åŒ»å­¦<br><strong id="p-med" style="font-size:1.2em">0</strong></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:5px; border-radius:4px;">è¡Œæ”¿<br><strong id="p-admin" style="font-size:1.2em">0</strong></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:5px; border-radius:4px;">ç¤¾äº¤<br><strong id="p-soc" style="font-size:1.2em">0</strong></div>
            </div>
        </div>
        <button onclick="tryStartNewGame()" style="width:100%; padding:15px; font-size:1.2rem; background:var(--primary); color:white;">âœï¸ ç­¾ç½²å¹¶å‡ºå‘ (æ–°æ¸¸æˆ)</button>
    </div>

    <div id="loading-screen" class="screen">
        <div class="loader-content">
            <div>> è¿æ¥ MSF å«æ˜Ÿç½‘ç»œ...</div>
            <div id="log-box"></div>
            <div class="loader-spinner"></div>
            <div style="text-align:center; color:#888; font-size:0.8em; margin-top:10px;">ä»»åŠ¡ç”Ÿæˆä¸­ï¼Œè¯·ä¿æŒä¿¡å·ç•…é€š</div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        
        <div id="tab-event" class="tab-content active">
            <h3>ğŸš¨ å­£åº¦ç®€æŠ¥</h3>
            <div id="loading-spinner" class="loading-spinner">
                ğŸ›°ï¸ æ­£åœ¨ä»å‰çº¿è·å–æƒ…æŠ¥ (DeepSeekæ¨ç†ä¸­)...
            </div>

            <div id="event-area" style="display:none;">
                <span class="event-tag" id="event-tag">EVENT</span>
                <div class="event-text" id="event-desc"></div>
                <div id="choices-container"></div>
            </div>

            <button id="start-event-btn" onclick="fetchDailyEvent()">ğŸ“¡ è·å–å­£åº¦æƒ…æŠ¥ (å¼€å§‹äº‹ä»¶)</button>
            
            <div id="next-quarter-msg" style="text-align:center; margin-top:20px; color:#888; display:none;">
                æœ¬å­£åº¦äº‹ä»¶å·²å¤„ç†ã€‚è¯·ç®¡ç†äººç‰©ä¸åŸºåœ°ï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€å­£åº¦ã€‚
            </div>
            <button id="next-day-btn" onclick="triggerNextQuarter()" style="width:100%; margin-top:15px; background:var(--primary); padding:15px; font-size:1.1rem; display:none; color: white;">ğŸ“… è¿›å…¥ä¸‹ä¸€å­£åº¦</button>
        </div>

        <div id="tab-character" class="tab-content">
            <div id="bio-container" class="bio-box"></div>

            <div class="rank-card">
                <div class="rank-title" id="val-rank-name">åŒ»ç–—ä¸“å‘˜</div>
                <div class="rank-progress">å½“å‰èŒçº§: Lv.<span id="val-rank-lvl">1</span></div>
                <div style="font-size:0.9em; margin-bottom:5px;">ä¸Šçº§å¥½æ„Ÿåº¦: <span id="val-favor">10</span>/100</div>
                <div class="bar-bg" style="margin-bottom:10px;"><div class="bar-fill" id="bar-favor" style="background:var(--gold)"></div></div>
                <div style="font-size:0.9em; color:#fff;">è€ƒæ ¸è¿èƒœ: <span id="val-max-streak" style="color:var(--gold)">0</span> (æ™‹å‡å…³é”®)</div>
                
                <div class="rank-actions">
                    <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('network')">ğŸ¤ è”ç»œæ„Ÿæƒ…</button>
                    <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('fund')">ğŸ’° è¯·æ±‚èµ„é‡‘</button>
                </div>
                <button id="btn-promo" style="width:100%; margin-top:10px; background:var(--blue); color:white;" onclick="applyForPromotion()">â¬†ï¸ ç”³è¯·æ™‹å‡ (ä»…ç§‹å­£å¼€æ”¾)</button>
                <div id="promo-status" style="font-size:0.8em; color:#888; margin-top:5px;"></div>
            </div>

            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--purple);">
                ğŸ’µ ä¸ªäººå­˜æ¬¾: <span id="val-cash-char" style="font-weight:bold; color:var(--purple); float:right;">$100</span>
                <div style="font-size:0.8em; color:#888; margin-top:5px;">ç”Ÿæ´»è´¹: -$50 (å­£åº¦ç»“ç®—æ—¶æ‰£é™¤)</div>
                <div style="font-size:0.8em; color:#2ecc71; margin-top:2px;">ä¸‹å­£åº¦è–ªæ°´: <span id="val-salary"></span></div>
            </div>

            <h4>äººç‰©ç‰¹æ€§</h4>
            <div class="stats-grid">
                <div class="stat-box">â¤ï¸ å¥åº· <span style="float:right;" id="val-health">0</span><div class="bar-bg"><div class="bar-fill" id="bar-health"></div></div></div>
                <div class="stat-box">âš¡ ç²¾åŠ› <span style="float:right;" id="val-energy">0</span><div class="bar-bg"><div class="bar-fill" id="bar-energy"></div></div></div>
                <div class="stat-box">ğŸ’‰ åŒ»å­¦ <span style="float:right;" id="val-med">0</span><div class="bar-bg"><div class="bar-fill" id="bar-med" style="background:var(--blue)"></div></div></div>
                <div class="stat-box">ğŸ“‹ è¡Œæ”¿ <span style="float:right;" id="val-admin">0</span><div class="bar-bg"><div class="bar-fill" id="bar-admin" style="background:var(--blue)"></div></div></div>
                <div class="stat-box">ğŸ—£ï¸ ç¤¾äº¤ <span style="float:right;" id="val-soc">0</span><div class="bar-bg"><div class="bar-fill" id="bar-soc" style="background:var(--blue)"></div></div></div>
                <div class="stat-box" style="border-left-color:var(--danger);">ğŸ‘® å«Œç–‘ <span style="float:right;" id="val-suspicion">0</span><div class="bar-bg"><div class="bar-fill" id="bar-suspicion" style="background:var(--danger)"></div></div></div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <button class="skill-btn" onclick="trainSkill('med')">ğŸ“– ç ”è¯»åŒ»å­¦</button>
                <button class="skill-btn" onclick="trainSkill('admin')">ğŸ“‹ å¤„ç†æ–‡ä¹¦</button>
                <button class="skill-btn" onclick="trainSkill('soc')">ğŸ—£ï¸ äº¤æµç»éªŒ</button>
            </div>
            
            <button class="rest-btn" id="btn-rest" onclick="doRest()">ğŸ›Œ ä¼‘æ¯ (æœ¬å­£åº¦é™ä¸€æ¬¡)</button>
        </div>

        <div id="tab-ward" class="tab-content">
            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--blue);">
                ğŸ¥ ä½é™¢éƒ¨: <span id="ward-count">0</span> / <span id="ward-cap">20</span>
                <span style="float:right; font-size:0.8em; color:#aaa;" id="ward-limit-msg">æœ¬å­£æ”¶æ²»: 0/3</span>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="action-btn" style="flex:1; justify-content:center; background:var(--blue); color:white;" onclick="admitPatient()">â• æ”¶å…¥é™¢</button>
                <button class="action-btn" id="btn-rounds" style="flex:1; justify-content:center; background:var(--purple); color:white;" onclick="doRounds()">ğŸ©º æŸ¥æˆ¿ (æ¶ˆè€—ç‰©èµ„/å¥åº·)</button>
            </div>
            
            <div id="patient-list"></div>
        </div>

        <div id="tab-exam" class="tab-content">
            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--gold);">
                ğŸ“ æ‰§ä¸šèƒ½åŠ›è€ƒæ ¸
                <div style="font-size:0.8em; color:#aaa;">å½“å‰è¿èƒœ: <span id="curr-streak">0</span> | æœ€é«˜è¿èƒœ: <span id="best-streak">0</span></div>
            </div>
            
            <div id="exam-start-area">
                <p>æ¯å­£åº¦å¯å‚åŠ ä¸€æ¬¡è€ƒæ ¸ã€‚è¿èƒœæ˜¯æ™‹å‡çš„å…³é”®ã€‚</p>
                <p style="font-size:0.8em; color:#888;">è¿èƒœè¦æ±‚: Lv2(3), Lv3(5), Lv4(10), Lv5(15), Lv6(20)</p>
                <button class="skill-btn" id="btn-start-exam" onclick="startExam()">âœï¸ å¼€å§‹è€ƒè¯•</button>
                
                <details style="margin-top:20px; border:1px solid var(--border); padding:10px; border-radius:4px;">
                    <summary style="cursor:pointer; font-size:0.8em; color:#888;">[å¼€å‘è€…] å¯¼å…¥é¢˜åº“</summary>
                    <textarea id="exam-import-area" style="width:100%; height:100px; background:var(--input-bg); color:var(--text); border:none; margin-top:5px;" placeholder='[{"q":"é—®é¢˜?","o":["A","B","C","D"],"a":0},...]'></textarea>
                    <button onclick="importQuestions()" style="width:100%; margin-top:5px; font-size:0.8em;">å¯¼å…¥JSON</button>
                </details>
            </div>

            <div id="exam-ui" style="display:none;" class="exam-box">
                <div id="exam-q-text" class="exam-q"></div>
                <div id="exam-options"></div>
            </div>
        </div>

        <div id="tab-base" class="tab-content">
            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--gold);">
                <div>ğŸ’° åŸºåœ°èµ„é‡‘: <span id="val-funds" style="font-weight:bold; color:var(--gold);">$10000</span></div>
                <div style="font-size:0.9em; margin-top:5px;">ğŸ° ç­‰çº§: <span id="val-base-lvl">åŸºç¡€åŒ»ç–—ç‚¹</span> (Lv.<span id="val-base-lvl-num">1</span>)</div>
                <div style="font-size:0.8em; color:#888;">æ¯å­£æ¶ˆè€—: $1000 - (è¡Œæ”¿x10) + (ç´§å¼ x10) | æ‹¨æ¬¾ +$1000</div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">ğŸ¤’ éš¾æ°‘ <span style="float:right; font-weight:bold;" id="val-refugees">0</span></div>
                <div class="stat-box">ğŸ˜  ç´§å¼  <span style="float:right;" id="val-tension">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-tension"></div></div></div>
                <div class="stat-box">ğŸ“¦ ç‰©èµ„ <span style="float:right;" id="val-supplies">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-supplies"></div></div></div>
                <div class="stat-box">ğŸ’§ å‡€æ°´ <span style="float:right;" id="val-water">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-water"></div></div></div>
            </div>
            
            <h4>åŸºåœ°è¡ŒåŠ¨ (æ¶ˆè€—èµ„æº/ç²¾åŠ›)</h4>
            <button class="action-btn" onclick="doAction('distribute_food')"><span>ğŸ¥£ åˆ†å‘å£ç²®ä¸è¯å“</span><span style="font-size:0.8em; color:#888;">ç‰©èµ„-5, ç´§å¼ å‡å°‘å—ç¤¾äº¤åŠ æˆ</span></button>
            <button class="action-btn" onclick="doAction('distribute_water')"><span>ğŸš° æä¾›å‡€æ°´</span><span style="font-size:0.8em; color:#888;">æ°´-5, ç´§å¼ å‡å°‘å—ç¤¾äº¤åŠ æˆ</span></button>
            <button class="action-btn" onclick="doAction('transport')"><span>ğŸš™ æ¥æ”¶ç©ºæŠ•ç‰©èµ„</span><span style="font-size:0.8em; color:#888;">ç‰©èµ„/æ°´+10, å¥åº·-5</span></button>
            <button class="action-btn" onclick="doAction('pacify')"><span>ğŸ•Šï¸ å®‰æŠšæ°‘ä¼—</span><span style="font-size:0.8em; color:#888;">ç´§å¼ -5, ç²¾åŠ›-10</span></button>
            <button class="action-btn" onclick="doAction('rescue')"><span>ğŸš‘ å‰çº¿æ•‘æ´</span><span style="font-size:0.8em; color:#888;">å¥åº·-10, éš¾æ°‘+10</span></button>
            <button class="action-btn" onclick="doAction('big_spender')"><span>ğŸ’¸ å¤§æ’’å¸è¡ŒåŠ¨</span><span style="font-size:0.8em; color:#888;">èµ„é‡‘-1000, ç´§å¼ -8</span></button>
            
            <h4 style="margin-top:20px; color:var(--gold);">èµ„é‡‘æ“ä½œ</h4>
            
            <div class="slider-container" style="border-left:4px solid var(--primary);">
                <div style="margin-bottom:5px;">ğŸ•µï¸ æŒªç”¨å…¬æ¬¾ <span id="em-val" class="slider-val">0%</span></div>
                <input type="range" id="em-slider" min="0" max="100" value="0" oninput="updateSliderUI('em')">
                <div style="font-size:0.8em; color:#aaa;">æŒªç”¨åŸºåœ° <span id="em-steal">$0</span> -> ä¸ªäººè·å¾— <span id="em-gain">$0</span> (å«Œç–‘â†‘)</div>
                <button class="action-btn" style="margin-top:5px; justify-content:center; border-color:var(--primary);" onclick="commitEmbezzle()">ç¡®è®¤æŒªç”¨</button>
            </div>

            <div class="slider-container" style="border-left:4px solid var(--green);">
                <div style="margin-bottom:5px;">ğŸ¤ æèµ èµ„é‡‘ <span id="don-val" class="slider-val">0%</span></div>
                <input type="range" id="don-slider" min="0" max="100" value="0" oninput="updateSliderUI('don')">
                <div style="font-size:0.8em; color:#aaa;">ä¸ªäººæå‡º <span id="don-give">$0</span> -> åŸºåœ°è·å¾— <span id="don-get">$0</span></div>
                <button class="action-btn" style="margin-top:5px; justify-content:center; border-color:var(--green);" onclick="commitDonate()">ç¡®è®¤æèµ </button>
            </div>
        </div>
        
        <div id="tab-items" class="tab-content">
             <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--purple);">
                ğŸ’µ ä¸ªäººå­˜æ¬¾: <span id="val-cash-items" style="font-weight:bold; color:var(--purple); float:right;">$100</span>
            </div>
            <h3>ğŸ›’ è¡¥ç»™ç«™ & å»ºè®¾</h3>
            
            <div class="item-grid" style="margin-bottom:20px;">
                <div class="item-card">
                    <div><div class="item-name">ğŸ“¦ è´­ä¹°ç‰©èµ„åŒ…</div><div class="item-price">åŸºåœ°èµ„é‡‘ $500</div><div class="item-desc">ç‰©èµ„ +5</div></div>
                    <button class="buy-btn" onclick="buyBaseItem('supplies')">è´­ä¹°</button>
                </div>
                <div class="item-card">
                    <div><div class="item-name">ğŸ’§ è´­ä¹°å‡€æ°´</div><div class="item-price">åŸºåœ°èµ„é‡‘ $500</div><div class="item-desc">å‡€æ°´ +5</div></div>
                    <button class="buy-btn" onclick="buyBaseItem('water')">è´­ä¹°</button>
                </div>
            </div>

            <div id="shop-container" class="item-grid"></div>
        </div>

        <div id="tab-achievements" class="tab-content">
            <h3>ğŸ† å±¥å†è®°å½•</h3>
            <ul id="achievement-list" class="achieve-list">
                <li class="achieve-item">æ¸¸æˆå¼€å§‹ - æŠµè¾¾å‰çº¿</li>
            </ul>
        </div>

    </div>

    <div class="bottom-nav" id="bottom-nav" style="display:none;">
        <div class="nav-item active" onclick="switchNav('event', this)">
            <div class="nav-icon">ğŸš¨</div>
            <div>äº‹ä»¶</div>
        </div>
        <div class="nav-item" onclick="switchNav('ward', this)">
            <div class="nav-icon">ğŸ¥</div>
            <div>ç—…æˆ¿</div>
        </div>
        <div class="nav-item" onclick="switchNav('character', this)">
            <div class="nav-icon">ğŸ©º</div>
            <div>äººç‰©</div>
        </div>
        <div class="nav-item" onclick="switchNav('base', this)">
            <div class="nav-icon">â›º</div>
            <div>åŸºåœ°</div>
        </div>
        <div class="nav-item" onclick="switchNav('items', this)">
            <div class="nav-icon">ğŸ›’</div>
            <div>ç‰©å“</div>
        </div>
        <div class="nav-item" onclick="switchNav('exam', this)">
            <div class="nav-icon">ğŸ“</div>
            <div>è€ƒæ ¸</div>
        </div>
        <div class="nav-item" onclick="switchNav('achievements', this)">
            <div class="nav-icon">ğŸ†</div>
            <div>æˆå°±</div>
        </div>
    </div>

    <div id="end-screen" class="screen" style="text-align:center; padding-top:50px;">
        <h1 id="end-title">æ¸¸æˆç»“æŸ</h1>
        <p id="end-reason" style="font-size:1.2rem; margin:20px 0; line-height:1.6;"></p>
        
        <button id="gen-story-btn" onclick="generateStory()">ğŸ“– ç”Ÿæˆæˆ˜åœ°æ—¥è®° (å›é¡¾)</button>
        <div id="story-container">
            <h4 style="margin-top:0; color:var(--accent);">ğŸ“‘ æˆ˜åœ°æ—¥å¿—</h4>
            <div id="story-content">ç”Ÿæˆä¸­...</div>
        </div>
        
        <div id="continue-game-area" style="display:none; margin-top:20px;">
            <p>æ‚¨å·²è¾¾æˆæœ€é«˜æˆå°±ï¼æ‚¨å¯ä»¥é€‰æ‹©ç»§ç»­ç»è¥ï¼Œæˆ–é‡æ–°å¼€å§‹ã€‚</p>
            <button onclick="continueGame()" style="background:var(--green); color:white;">ğŸ”„ ç»§ç»­ç•™ä»»</button>
        </div>

        <button onclick="location.reload()" style="background:var(--border); color:var(--text); padding:15px 40px; margin-top:20px;">ğŸ” é‡æ–°å¼€å§‹</button>
    </div>
</div>

<div id="message-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" id="msg-title">æç¤º</div>
        <div class="modal-body">
            <p id="msg-content" class="msg-text"></p>
            <button class="modal-btn" onclick="closeMsgModal()">ç¡® å®š</button>
        </div>
    </div>
</div>

<div id="confirm-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" id="cfm-title">ç¡®è®¤</div>
        <div class="modal-body">
            <p id="cfm-content" class="msg-text"></p>
            <div style="display:flex; gap:1px;">
                <button class="modal-btn secondary" onclick="closeConfirmModal(false)" style="flex:1;">å– æ¶ˆ</button>
                <button class="modal-btn" onclick="closeConfirmModal(true)" style="flex:1;">ç¡® å®š</button>
            </div>
        </div>
    </div>
</div>

<div id="load-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">è¯»å–æ¡£æ¡ˆ</div>
        <div class="modal-body" style="text-align:left;">
            <button class="save-slot-btn" onclick="loadSlot('auto')">
                <div style="font-weight:bold;">ğŸ“¼ è‡ªåŠ¨å­˜æ¡£</div>
                <div class="save-meta" id="slot-auto-info">æ— è®°å½•</div>
            </button>
            <button class="save-slot-btn" onclick="loadSlot('manual')">
                <div style="font-weight:bold;">ğŸ’¾ æ‰‹åŠ¨å­˜æ¡£</div>
                <div class="save-meta" id="slot-manual-info">æ— è®°å½•</div>
            </button>
            <button class="modal-btn secondary" style="width:100%; margin-top:10px;" onclick="$('load-modal').style.display='none'">å…³ é—­</button>
        </div>
    </div>
</div>

<div id="result-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">è¡ŒåŠ¨å›æŠ¥</div>
        <div class="modal-body">
            <div id="result-status"></div>
            <p id="result-text"></p>
            <ul id="result-list" class="change-list"></ul>
            <button class="modal-btn" onclick="closeModal()">ç¡® å®š</button>
        </div>
    </div>
</div>

<div id="investigation-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--danger); color:white;">ğŸš¨ è´¢åŠ¡å®¡æŸ¥</div>
        <div class="modal-body">
            <p style="margin-bottom:20px; line-height:1.6;">ä½ çš„è´¦æˆ·å¼‚å¸¸å˜åŠ¨å¼•èµ·äº†æ€»éƒ¨çš„æ€€ç–‘ã€‚è°ƒæŸ¥ç»„å·²ç»ä»‹å…¥ï¼Œä½ é¢ä¸´ä¸¥é‡çš„æŒ‡æ§ã€‚</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button style="background:var(--primary); color:white; border:none; padding:15px; border-radius:4px;" onclick="handleInvestigationAction('resist')">ğŸ›‘ è´Ÿéš…é¡½æŠ—</button>
                <button style="background:var(--blue); color:white; border:none; padding:15px; border-radius:4px;" onclick="handleInvestigationAction('surrender')">ğŸ³ï¸ å…¨æ•°ä¸Šäº¤</button>
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:10px; text-align:center;">
                é¡½æŠ—: è¯•å›¾æ©ç›– (å¯èƒ½ç›´æ¥å®šç½ª)<br>
                ä¸Šäº¤: æ¸…ç©ºå­˜æ¬¾å¹¶é™èŒ (ä¿ç•™å·¥ä½œ)
            </div>
        </div>
    </div>
</div>

<script>
    // --- å¼€å‘è€…é…ç½® ---
    const DEVELOPER_API_KEY = "sk-9587151f054b41cf903c0b7d892f67c0"; // å¼€å‘è€…å¯åœ¨æ­¤å¡«å…¥é»˜è®¤KEY

    // --- å…¨å±€å·¥å…·ä¸æ•°æ®å®šä¹‰ ---
    const $ = id => document.getElementById(id);
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    const SAVE_KEY_AUTO = 'msf_commander_save_auto';
    const SAVE_KEY_MANUAL = 'msf_commander_save_manual';

    // æ•°æ®åˆ—è¡¨
    const CHAR_NAMES = ["Alex", "Dr. Sarah", "Jean", "Dr. Ahmed", "Maria", "David", "Liang", "Dr. Chen"];
    const CHAR_DEPTS = ["éª¨ç§‘", "æ„ŸæŸ“ç§‘", "å„¿ç§‘", "å¦‡äº§ç§‘", "æ€¥è¯Šç§‘", "å†…ç§‘", "çœ¼ç§‘"];
    const CHAR_LOCATIONS = [
        "å—è‹ä¸¹ - æœ¬æä¹Œ (Bentiu)", 
        "å·´è¥¿ - é˜¿ç»´æ–¯å¡”ï¼ˆBoa Vistaï¼‰", 
        "é˜¿å¯Œæ±— - æ˜†éƒ½å£« (Kunduz)", 
        "ä¹Ÿé—¨ - æ‘©å¡ (Mocha)", 
        "æµ·åœ° - å¤ªé˜³åŸ (CitÃ© Soleil)", 
        "åˆšæœé‡‘ - åŒ—åŸºä¼ (North Kivu)", 
        "ä¸­éå…±å’Œå›½ - ç­å‰ (Bangui)"
    ];
    
    const RANKS = [
        "åŒ»ç–—ä¸“å‘˜ (Level 1)",
        "ä¸´åºŠä¸“å®¶ (Level 2)",
        "åŒ»ç–—ä¸»ç®¡ (Level 3)",
        "é¡¹ç›®ç»Ÿç­¹ (Level 4)",
        "å‰¯æ€»ç­¹ (Level 5)",
        "åŒºåŸŸæ€»ç­¹ (Level 6)"
    ];
    const RANK_SALARIES = [100, 400, 800, 1200, 1600, 2000];
    const RANK_REQ_STREAK = [0, 3, 5, 10, 15, 20]; // å¯¹åº” 1->2, 2->3 ç­‰

    const BASE_LEVELS = [
        { name: "åŸºç¡€åŒ»ç–—ç‚¹", cap: 150, cost: 0, wardCap: 5 },
        { name: "ç§»åŠ¨åŒ»ç–—é˜Ÿ", cap: 200, cost: 10000, wardCap: 7 },
        { name: "é‡æˆ˜åŒ»é™¢", cap: 250, cost: 20000, wardCap: 9 },
        { name: "ä¸“ç§‘ä¸­å¿ƒ", cap: 500, cost: 50000, wardCap: 12 }
    ];

    const SHOP_ITEMS = [
        { id: 'snack', name: 'ğŸ« é›¶é£Ÿ', price: 100, desc: 'å¢åŠ  3ç‚¹ ç²¾åŠ›', type: 'cons', effect: { energy: 3 } },
        { id: 'medkit', name: 'ğŸ©¹ æ€¥æ•‘åŒ…', price: 150, desc: 'å¢åŠ  3ç‚¹ å¥åº·', type: 'cons', effect: { health: 3 } },
        { id: 'coffee', name: 'â˜• ç°ç£¨å’–å•¡', price: 200, desc: 'å¢åŠ  5ç‚¹ ç²¾åŠ›', type: 'cons', effect: { energy: 5 } },    
        { id: 'suit', name: 'ğŸ‘” æ­£è£…', price: 400, desc: 'æ°¸ä¹…å¢åŠ  5ç‚¹ ç¤¾äº¤', type: 'perm', effect: { soc: 5 } },
		{ id: 'book', name: 'ğŸ“š ç®¡ç†å­¦åŸ¹è®­ç­', price: 600, desc: 'æ°¸ä¹…å¢åŠ  5ç‚¹ è¡Œæ”¿', type: 'perm', effect: { admin: 5 } },
		{ id: 'scope', name: 'ğŸ©º ç‰¹çº§å¬è¯Šå™¨', price: 800, desc: 'æ°¸ä¹…å¢åŠ  5ç‚¹ åŒ»å­¦', type: 'perm', effect: { med: 5 } },
		{ id: 'coat', name: 'ğŸ‘©â€âš•ï¸é˜²åˆºç™½å¤§è¤‚', price: 1200, desc: 'æ°¸ä¹…å¢åŠ  10ç‚¹ åŒ»å­¦', type: 'perm', effect: { med: 10 } },
        { id: 'laptop', name: 'ğŸ’» ç¬”è®°æœ¬', price: 1500, desc: 'æ°¸ä¹…å¢åŠ  10ç‚¹ è¡Œæ”¿', type: 'perm', effect: { admin: 10 } },
        { id: 'phone', name: 'ğŸ“¡ å«æ˜Ÿç”µè¯', price: 1800, desc: 'æ°¸ä¹…å¢åŠ  10ç‚¹ ç¤¾äº¤', type: 'perm', effect: { soc: 10 } },
        { id: 'device', name: 'ğŸ”¬ å®éªŒè®¾å¤‡', price: 5000, desc: 'æ°¸ä¹…å¢åŠ  15ç‚¹ åŒ»å­¦', type: 'perm', effect: { med: 15 } },
        { id: 'suv', name: 'ğŸš™ è¶Šé‡è½¦', price: 10000, desc: 'æ¬è¿ç‰©èµ„ä¸å†æ¶ˆè€—å¥åº·', type: 'perm', effect: {} },
        // åŸºåœ°å‡çº§
        { id: 'base_lv2', name: 'ğŸ—ï¸ æ‰©å»º:ç§»åŠ¨åŒ»ç–—é˜Ÿ', price: 10000, desc: 'éš¾æ°‘ä¸Šé™200, æ›´å¤šåºŠä½', type: 'base', level: 1 },
        { id: 'base_lv3', name: 'ğŸ¥ æ‰©å»º:é‡æˆ˜åŒ»é™¢', price: 20000, desc: 'éš¾æ°‘ä¸Šé™250, æ›´å¤šåºŠä½', type: 'base', level: 2 },
        { id: 'base_lv4', name: 'ğŸ™ï¸ æ‰©å»º:ä¸“ç§‘ä¸­å¿ƒ', price: 50000, desc: 'éš¾æ°‘ä¸Šé™500, æ›´å¤šåºŠä½', type: 'base', level: 3 }
    ];

    // é»˜è®¤é¢˜åº“
    const DEFAULT_QUESTIONS = [
        {"q":"ä¼‘å…‹ç—…äººè¡¥æ¶²çš„é¦–é€‰æ¶²ä½“æ˜¯ï¼Ÿ","o":["è‘¡è„ç³–æ³¨å°„æ¶²","å¹³è¡¡ç›æº¶æ¶²","å…¨è¡€","è¡€æµ†"],"a":1},
        {"q":"å¿ƒè‚ºå¤è‹(CPR)æŒ‰å‹ä¸äººå·¥å‘¼å¸çš„æ¯”ä¾‹æ˜¯ï¼Ÿ","o":["15:2","30:2","5:1","15:1"],"a":1},
        {"q":"æ— å›½ç•ŒåŒ»ç”Ÿ(MSF)æˆç«‹äºå“ªä¸€å¹´ï¼Ÿ","o":["1945","1960","1971","1999"],"a":2},
        {"q":"ä»¥ä¸‹å“ªç§ä¸æ˜¯é€šè¿‡è¡€æ¶²ä¼ æ’­çš„ç–¾ç—…ï¼Ÿ","o":["ç”²è‚","ä¹™è‚","ä¸™è‚","è‰¾æ»‹ç—…"],"a":0},
        {"q":"åœ¨ç¾éš¾ç°åœºæ£€ä¼¤åˆ†ç±»ä¸­ï¼Œçº¢è‰²æ ‡ç­¾ä»£è¡¨ï¼Ÿ","o":["è½»ä¼¤","é‡ä¼¤(éœ€ç«‹å³æ€¥æ•‘)","æ­»äº¡","æš‚ç¼“æ²»ç–—"],"a":1}
    ];

    const CONFIG = { ranks: RANKS };
    
    // çŠ¶æ€æ•°æ®
    let player = { 
        name:"", gender:"", dept:"", med:0, admin:0, soc:0, health:60, energy:60, location: "",
        suspicion: 0, investigationCount: 0, rankIndex: 0, favor: 10,
        lastPromoQuarter: 0, appliedPromo: false, cash: 100, items: []
    };
    let camp = { refugees: 100, supplies: 60, water: 60, tension: 30, funds: 10000, baseLevelIdx: 0 }; 
    let currentQuarter = 1; 
    let quartersSinceRank6 = 0;
    let dangerLevel = 5; 
    let isEventResolved = false; 
    let hasRestedToday = false; 
    let historyLog = [];
    let isVictoryPending = false;
    let bioCache = "";
    
    // æ–°å¢æ¨¡å—æ•°æ®
    let patients = [];
    let admittedCount = 0; // æœ¬å­£åº¦æ”¶æ²»äººæ•°
    let hasRounded = false; // æœ¬å­£åº¦æ˜¯å¦æŸ¥æˆ¿
    let examQuestions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
    let examStreak = 0;
    let maxExamStreak = 0;
    let hasTakenExam = false; // æœ¬å­£åº¦æ˜¯å¦è€ƒè¿‡

    // å¼¹çª—å›è°ƒ
    let confirmCallback = null;

    // --- æ ¸å¿ƒå·¥å…· ---
    
    function showMessage(title, text) {
        $('msg-title').innerText = title;
        $('msg-content').innerText = text;
        $('message-modal').style.display = 'flex';
    }
    
    function closeMsgModal() {
        $('message-modal').style.display = 'none';
    }

    function showConfirm(title, text, callback) {
        $('cfm-title').innerText = title;
        $('cfm-content').innerText = text;
        confirmCallback = callback;
        $('confirm-modal').style.display = 'flex';
    }

    function closeConfirmModal(result) {
        $('confirm-modal').style.display = 'none';
        if (confirmCallback) confirmCallback(result);
    }

    // --- æ¸¸æˆé€»è¾‘ ---

    function generateRandomData() {
        player.name = CHAR_NAMES[randInt(0, CHAR_NAMES.length-1)];
        player.gender = Math.random() > 0.5 ? "ç”·" : "å¥³";
        player.dept = CHAR_DEPTS[randInt(0, CHAR_DEPTS.length-1)];
        player.location = CHAR_LOCATIONS[randInt(0, CHAR_LOCATIONS.length-1)]; 
        player.suspicion = 0;
        player.investigationCount = 0;
        
        let sum = 0;
        do {
            player.med = randInt(0, 100);
            player.admin = randInt(0, 100);
            player.soc = randInt(0, 100);
            sum = player.med + player.admin + player.soc;
        } while (sum < 100 || sum > 180);
    }

    function updateSetupUI() {
        if(!$('p-name')) return;
        $('p-name').innerText = player.name;
        $('p-gender').innerText = player.gender;
        $('p-dept').innerText = player.dept;
        $('p-location').innerText = player.location;
        $('p-med').innerText = player.med;
        $('p-admin').innerText = player.admin;
        $('p-soc').innerText = player.soc;
    }

    function rollCharacter() {
        generateRandomData();
        updateSetupUI();
    }

    // --- å­˜æ¡£ç³»ç»Ÿ ---

    function saveGame(type) {
        const gameState = {
            player, camp, currentQuarter, dangerLevel, 
            isEventResolved, hasRestedToday, historyLog, 
            isVictoryPending, quartersSinceRank6, bioCache,
            patients, admittedCount, hasRounded,
            examQuestions, examStreak, maxExamStreak, hasTakenExam,
            saveDate: new Date().toLocaleString()
        };
        const key = type === 'auto' ? SAVE_KEY_AUTO : SAVE_KEY_MANUAL;
        localStorage.setItem(key, JSON.stringify(gameState));
    }

    function saveGameManual() {
        saveGame('manual');
        showMessage("ç³»ç»Ÿæç¤º", "âœ… æ‰‹åŠ¨å­˜æ¡£æˆåŠŸï¼");
    }

    function openLoadModal() {
        const autoData = localStorage.getItem(SAVE_KEY_AUTO);
        const manualData = localStorage.getItem(SAVE_KEY_MANUAL);

        $('slot-auto-info').innerText = autoData ? JSON.parse(autoData).saveDate : "æ— è®°å½•";
        $('slot-manual-info').innerText = manualData ? JSON.parse(manualData).saveDate : "æ— è®°å½•";
        
        $('load-modal').style.display = 'flex';
    }

    function loadSlot(type) {
        const key = type === 'auto' ? SAVE_KEY_AUTO : SAVE_KEY_MANUAL;
        const data = localStorage.getItem(key);
        if (!data) {
            showMessage("é”™è¯¯", "è¯¥æ ä½æ²¡æœ‰å­˜æ¡£ã€‚");
            return;
        }
        
        try {
            const state = JSON.parse(data);
            player = state.player;
            camp = state.camp;
            currentQuarter = state.currentQuarter;
            dangerLevel = state.dangerLevel;
            isEventResolved = state.isEventResolved;
            hasRestedToday = state.hasRestedToday;
            historyLog = state.historyLog;
            isVictoryPending = state.isVictoryPending;
            quartersSinceRank6 = state.quartersSinceRank6;
            bioCache = state.bioCache || "";
            // New state load
            patients = state.patients || [];
            admittedCount = state.admittedCount || 0;
            hasRounded = state.hasRounded || false;
            examQuestions = state.examQuestions || JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
            examStreak = state.examStreak || 0;
            maxExamStreak = state.maxExamStreak || 0;
            hasTakenExam = state.hasTakenExam || false;
            
            $('load-modal').style.display = 'none';
            if($('setup-screen').classList.contains('active')) {
                $('setup-screen').classList.remove('active');
            }
            initGame(true); 
            showMessage("ç³»ç»Ÿæç¤º", "ğŸ“‚ è¯»æ¡£æˆåŠŸï¼");
        } catch(e) {
            console.error("Load failed", e);
            showMessage("é”™è¯¯", "å­˜æ¡£æ–‡ä»¶æŸåã€‚");
        }
    }

    function checkSaveFile() {
        const hasAuto = localStorage.getItem(SAVE_KEY_AUTO);
        const hasManual = localStorage.getItem(SAVE_KEY_MANUAL);
        if (hasAuto || hasManual) {
            $('continue-btn').style.display = 'block';
        } else {
            $('continue-btn').style.display = 'none';
        }
    }

    function tryExitGame() {
        showConfirm("é€€å‡ºæ¸¸æˆ", "ç¡®å®šè¦é€€å‡ºå—ï¼Ÿå½“å‰è¿›åº¦å°†è‡ªåŠ¨ä¿å­˜ã€‚", (result) => {
            if(result) {
                saveGame('auto');
                $('game-screen').classList.remove('active');
                $('end-screen').classList.remove('active');
                $('setup-screen').classList.add('active');
                $('bottom-nav').style.display = 'none';
                $('exit-game-btn').style.display = 'none';
                checkSaveFile();
            }
        });
    }
    
    function tryStartNewGame() {
        if($('continue-btn').style.display !== 'none') {
            showConfirm("æ–°æ¸¸æˆ", "å¼€å§‹æ–°æ¸¸æˆå°†è¦†ç›–å­˜æ¡£ï¼Œç¡®å®šå—ï¼Ÿ", (res) => {
                if(res) startNewGame();
            });
        } else {
            startNewGame();
        }
    }

    function startNewGame() {
        // Reset Logic
        historyLog = [];
        dangerLevel = 5;
        currentQuarter = 1;
        isEventResolved = false;
        isVictoryPending = false;
        camp = { refugees: 100, supplies: 60, water: 60, tension: 30, funds: 10000, baseLevelIdx: 0 };
        player.rankIndex = 0;
        player.favor = 10;
        player.cash = 100;
        player.items = [];
        player.suspicion = 0;
        player.investigationCount = 0;
        player.appliedPromo = false;
        
        patients = [];
        admittedCount = 0;
        hasRounded = false;
        examStreak = 0;
        maxExamStreak = 0;
        hasTakenExam = false;
        examQuestions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
        
        initGame(false);
    }

    window.onload = function() {
        checkSaveFile();
        renderShop();
        rollCharacter();
    };

    function toggleTheme() {
        document.body.classList.toggle('day-mode');
    }

    function switchNav(tabName, btnElement) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        $('tab-' + tabName).classList.add('active');
        if(btnElement) btnElement.classList.add('active');
    }

    function toggleApiInput() {
        let isMock = $('use-mock').checked;
        $('api-key').disabled = isMock;
        $('model-name').disabled = isMock;
        $('api-url').disabled = isMock;
    }

    async function initGame(isLoad = false) {
        if(!isLoad && !player.name) rollCharacter();
        
        $('setup-screen').classList.remove('active');
        $('loading-screen').classList.add('active');
        $('exit-game-btn').style.display = 'block';

        if (!isLoad) {
            addLog("> éªŒè¯èº«ä»½æƒé™..."); await wait(600);
            let locName = player.location ? player.location.split(' - ')[0] : "æœªçŸ¥åŒºåŸŸ";
            addLog(`> åŠ å¯†è¿æ¥è‡³æŒ‡æŒ¥éƒ¨: ${locName}...`); await wait(800); 
            addLog("> æ­£åœ¨ä¸‹è½½äººå‘˜æ¡£æ¡ˆ...");
            
            try {
                const bioText = await generateBio();
                bioCache = bioText; // Cache bio
                $('bio-container').innerHTML = bioText;
            } catch (e) {
                console.error(e);
                $('bio-container').innerHTML = "ï¼ˆæ•°æ®æŸåï¼Œæ— æ³•æ˜¾ç¤ºæ¡£æ¡ˆï¼‰";
            }
        } else {
            $('bio-container').innerHTML = bioCache || "ï¼ˆæ¡£æ¡ˆè¯»å–ä¸­...ï¼‰";
            addLog("> è¯»å–æœ¬åœ°ç¼“å­˜..."); await wait(500);
            addLog("> æ¢å¤æŒ‡æŒ¥é“¾è·¯..."); await wait(500);
        }
        
        startGameUI(isLoad);
    }

    function addLog(text) {
        const div = document.createElement('div');
        div.className = 'log-line';
        div.innerText = text;
        $('log-box').appendChild(div);
    }

    function startGameUI(isLoad) {
        $('loading-screen').classList.remove('active');
        $('game-screen').classList.add('active');
        $('bottom-nav').style.display = 'grid'; // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆª
        
        $('game-location-display').style.display = 'block';
        $('game-location-display').innerText = 'ğŸ“ ' + player.location;

        if (!isLoad) {
            // æ–°æ¸¸æˆåˆå§‹åŒ–
            isEventResolved = false;
            $('start-event-btn').style.display = 'block';
            $('next-day-btn').style.display = 'none';
            $('event-area').style.display = 'none';
            
            const firstSalary = RANK_SALARIES[player.rankIndex];
            player.cash += firstSalary;
            saveGame('auto');
        } else {
            // è¯»æ¡£æ¢å¤çŠ¶æ€
            $('log-box').innerHTML = ""; 
            if (isEventResolved) {
                $('start-event-btn').style.display = 'none';
                $('event-area').style.display = 'none';
                $('next-day-btn').style.display = 'block';
                $('next-quarter-msg').style.display = 'block';
            } else {
                $('start-event-btn').style.display = 'block';
                $('next-day-btn').style.display = 'none';
                $('event-area').style.display = 'none';
                $('next-quarter-msg').style.display = 'none';
            }
        }
        
        updateUI();
        renderPatients();
        renderExamUI();
    }

    async function fetchDailyEvent() {
        $('start-event-btn').style.display = 'none';
        $('loading-spinner').style.display = 'block';
        
        try {
            const eventData = await generateEventData();
            renderEvent(eventData);
        } catch (e) {
            console.error(e);
            renderEvent(mockEvent());
        }
    }

    // --- åŸºåœ° & å•†åº—é€»è¾‘ ---

    function renderShop() {
        const container = $('shop-container');
        container.innerHTML = '';
        SHOP_ITEMS.forEach(item => {
            if(item.id.includes('base_lv')) {
                // Check level requirement
                if(item.level <= camp.baseLevelIdx) return; // Already bought or lower level
                if(item.level > camp.baseLevelIdx + 1) return; // Next level only
            }

            const el = document.createElement('div');
            el.className = 'item-card';
            el.innerHTML = `
                <div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price}</div>
                    <div class="item-desc">${item.desc}</div>
                </div>
                <button class="buy-btn" id="btn-buy-${item.id}" onclick="buyItem('${item.id}')">è´­ä¹°</button>
            `;
            container.appendChild(el);
        });
    }

    function buyItem(itemId) {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if(!item) return;

        if (item.type === 'perm' && player.items.includes(item.id)) {
            return showMessage("æç¤º", "ä½ å·²ç»æ‹¥æœ‰è¯¥ç‰©å“äº†ï¼");
        }
        if (player.cash < item.price) {
            return showMessage("æç¤º", "èµ„é‡‘ä¸è¶³ï¼");
        }

        // Transaction
        player.cash -= item.price;
        if (item.type === 'perm') {
            player.items.push(item.id);
            applyChanges(item.effect);
            showMessage("è´­ä¹°æˆåŠŸ", `${item.name}ï¼šèƒ½åŠ›å·²æ°¸ä¹…æå‡ã€‚`);
        } else if (item.type === 'base') {
            camp.baseLevelIdx = item.level;
            camp.funds -= item.price; // Oops, user pays with personal cash? No, prompt says "base funds buy equipment".
            // Logic correction based on Prompt 7: "use base funds buy equipment"
            // Wait, standard shop uses player cash. Let's adjust for base items.
            // Prompt says: "Base funds buy equipment... Lv2.. cost 10000"
            // Revert logic: Base upgrades use BASE FUNDS.
            player.cash += item.price; // Refund player
            if (camp.funds < item.price) {
                player.cash -= item.price; // Take back refund
                return showMessage("æç¤º", "åŸºåœ°èµ„é‡‘ä¸è¶³ï¼");
            }
            camp.funds -= item.price;
            showMessage("åŸºåœ°å‡çº§", `${item.name} å»ºè®¾å®Œæˆï¼å®¹é‡æå‡ã€‚`);
        } else {
            applyChanges(item.effect);
            showMessage("è´­ä¹°æˆåŠŸ", `${item.name}ï¼šå·²ç«‹å³ä½¿ç”¨ã€‚`);
        }
        
        updateUI();
        renderShop(); // Update for upgrades
        saveGame('auto');
    }

    function buyBaseItem(type) {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        if(camp.funds < 500) return showMessage("æç¤º", "åŸºåœ°èµ„é‡‘ä¸è¶³ï¼");
        
        camp.funds -= 500;
        if(type === 'supplies') {
            camp.supplies += 5;
            showMessage("è¡¥ç»™", "ç‰©èµ„ +5");
        } else {
            camp.water += 5;
            showMessage("è¡¥ç»™", "å‡€æ°´ +5");
        }
        updateUI();
        saveGame('auto');
    }

    // --- ç—…æˆ¿ç³»ç»Ÿé€»è¾‘ ---

    function renderPatients() {
        const list = $('patient-list');
        list.innerHTML = '';
        if(patients.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">ç—…æˆ¿ç©ºç½®ä¸­</div>';
            return;
        }

        patients.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = `patient-card p-sev-${p.sev}`;
            const sevText = ["è½»ç—‡","ä¸­ç—‡","é‡ç—‡"][p.sev];
            const sevColor = ["#2ecc71","#f1c40f","#e74c3c"][p.sev];
            
            card.innerHTML = `
                <div class="p-header">
                    <span>${p.bed}åºŠ  (${p.age}å²ï¼Œ${p.gender})</span>
                    <span style="color:${sevColor}">${sevText}</span>
                </div>
                <div class="p-info">ä¸»è¯‰: ${p.cc}</div>
                <div class="p-desc">${p.hpi}</div>
                <div style="font-size:0.9em; margin-bottom:5px;">è¯Šç–—è¿›åº¦: ${p.prog}% <div class="bar-bg" style="display:inline-block; width:100px; height:6px; vertical-align:middle;"><div class="bar-fill" style="width:${p.prog}%; background:var(--blue);"></div></div></div>
                <div class="p-actions">
                    <button class="p-btn" style="background:var(--blue); color:white;" onclick="treatPatient(${idx})">æ²»ç–—</button>
                    <button class="p-btn" style="background:var(--border); color:var(--text);" onclick="dischargePatient(${idx})">å‡ºé™¢</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    async function admitPatient() {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        const maxCap = BASE_LEVELS[camp.baseLevelIdx].wardCap;
        if(patients.length >= maxCap) return showMessage("åºŠä½å·²æ»¡", "æ— æ³•æ”¶æ²»æ›´å¤šç—…äººã€‚");
        if(admittedCount >= 3) return showMessage("é™é¢å·²æ»¡", "æ¯å­£åº¦æœ€å¤šæ”¶æ²»3äººã€‚");

        admittedCount++;
        
        // Generate basic data
        const bedNum = findEmptyBed(maxCap);
        const age = randInt(0, 75);
        const gender = Math.random()>0.5?"ç”·":"å¥³";
        const sev = randInt(0, 2); // 0,1,2
        const name = "P." + randInt(100,999);
        
        const newPatient = {
            bed: bedNum,
            name: name,
            age: age,
            gender: gender,
            sev: sev,
            cc: "ç”Ÿæˆä¸­...",
            hpi: "ç”Ÿæˆä¸­...",
            prog: 0
        };
        
        patients.push(newPatient);
        // Sort by bed
        patients.sort((a,b) => a.bed - b.bed);
        renderPatients();
        updateUI();

        // API Call for text
        try {
            const prompt = `ç”Ÿæˆä¸€ä¸ªæ— å›½ç•ŒåŒ»ç”Ÿå‰çº¿ç—…äººç—…ä¾‹ã€‚
            ç§‘å®¤:${player.dept}ã€‚ç—…äºº:${age}å²${gender}ï¼Œå±æ€¥åº¦:${["è½»ç—‡","ä¸­ç—‡","é‡ç—‡"][sev]}ã€‚
            è¯·è¿”å›JSONæ ¼å¼: {"cc":"ä¸»è¯‰(20å­—å†…)", "hpi":"ç°ç—…å²(70å­—å·¦å³)"}`;
            
            const res = await callDeepSeek(prompt, true);
            newPatient.cc = res.cc;
            newPatient.hpi = res.hpi;
            renderPatients();
        } catch(e) {
            newPatient.cc = "è…¹ç—›ä¼´å‘çƒ­3å¤©";
            newPatient.hpi = "æ‚£è€…3å¤©å‰æ— æ˜æ˜¾è¯±å› å‡ºç°è…¹ç—›ï¼Œä¼´å‘çƒ­ï¼Œæœ€é«˜ä½“æ¸©38.5åº¦ã€‚";
            renderPatients();
        }
        saveGame('auto');
    }

    function findEmptyBed(max) {
        const taken = patients.map(p => p.bed);
        let bed = randInt(1, max);
        while(taken.includes(bed)) {
            bed = randInt(1, max);
        }
        return bed;
    }

    function doRounds() {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        if(hasRounded) return showMessage("æç¤º", "æœ¬å­£åº¦å·²æŸ¥æˆ¿ã€‚");
        if(patients.length === 0) return showMessage("æç¤º", "æ²¡æœ‰ç—…äººã€‚");
        if(camp.supplies < 5) return showMessage("ç‰©èµ„ä¸è¶³", "éœ€è¦5ç‰©èµ„ã€‚");
        if(player.health < 5) return showMessage("ä½“åŠ›ä¸è¶³", "å¤ªç´¯äº†ã€‚");

        camp.supplies -= 5;
        player.health -= 5;
        hasRounded = true;

        let log = "";
        patients.forEach(p => {
            const gain = randInt(5, 10);
            p.prog = Math.min(100, p.prog + gain);
        });
        
        showMessage("æŸ¥æˆ¿ç»“æŸ", "æ‰€æœ‰ç—…äººè¯Šç–—è¿›åº¦æå‡ 5-10%ã€‚");
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    function treatPatient(idx) {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        if(player.energy < 2) return showMessage("ç²¾åŠ›ä¸è¶³", "æ— æ³•é›†ä¸­ç²¾åŠ›æ²»ç–—ã€‚");
        player.energy -= 2;

        const p = patients[idx];
        // Formula: floor(10% Med) + rand(10-20) - sev*3
        let gain = Math.floor(player.med * 0.1) + randInt(10, 20) - (p.sev * 3);
        // Buffs? Assuming items might add buffs later, strictly logic now:
        if(player.items.includes('device')) gain += 5; // Example buff
        
        if(gain < 1) gain = 1;
        p.prog = Math.min(100, p.prog + gain);
        
        renderPatients();
        updateUI();
    }

    function dischargePatient(idx) {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        const p = patients[idx];
        
        if(p.prog >= 100) {
            // Success
            const reward = randInt(50, 150) + (p.sev * 50);
            player.cash += reward;
            showMessage("æ²»æ„ˆå‡ºé™¢", `ç—…äººåº·å¤ç¦»å¼€ã€‚æ”¶åˆ°æŠ¥é…¬/æèµ  $${reward}ã€‚`);
        } else {
            // Fail/Early discharge
            camp.tension += 5;
            showMessage("æå‰å‡ºé™¢", `æ²»ç–—æœªå®Œæˆã€‚ç—…äººå®¶å±è¡¨ç¤ºä¸æ»¡ï¼Œè¥åœ°ç´§å¼ åº¦ +5ã€‚`);
        }
        
        patients.splice(idx, 1);
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    // --- è€ƒæ ¸ç³»ç»Ÿé€»è¾‘ ---

    function startExam() {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        if(hasTakenExam) return showMessage("æç¤º", "æœ¬å­£åº¦å·²å‚åŠ è¿‡è€ƒæ ¸ã€‚");
        
        hasTakenExam = true;
        $('exam-start-area').style.display = 'none';
        $('exam-ui').style.display = 'block';
        
        // Use default questions if empty or exhausted (simple cycle logic)
        if(examQuestions.length === 0) examQuestions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
        
        loadNextQuestion();
    }

    function loadNextQuestion() {
        // Pick random
        if(examQuestions.length === 0) {
            // End of bank, assume loop or win? Let's keep streak going by reusing default
            examQuestions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
        }
        const qIdx = randInt(0, examQuestions.length - 1);
        const qData = examQuestions[qIdx];
        
        // Remove used
        examQuestions.splice(qIdx, 1); // Remove to prevent repeat in one session? 
        // Logic: Continuous correct answers.
        
        $('exam-q-text').innerText = qData.q;
        const div = $('exam-options');
        div.innerHTML = '';
        
        qData.o.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'exam-opt';
            btn.innerText = ["A","B","C","D"][idx] + ". " + opt;
            btn.onclick = () => checkAnswer(idx, qData.a);
            div.appendChild(btn);
        });
    }

    function checkAnswer(chosen, correct) {
        if(chosen === correct) {
            examStreak++;
            if(examStreak > maxExamStreak) maxExamStreak = examStreak;
            updateUI();
            alert("å›ç­”æ­£ç¡®ï¼è¿èƒœ +1");
            loadNextQuestion();
        } else {
            alert(`å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: ${["A","B","C","D"][correct]}ã€‚æœ¬æ¬¡è€ƒæ ¸ç»“æŸã€‚`);
            examStreak = 0; // Reset streak on fail?
            // Prompt says: "High streak persists, but next exam needs to accumulate streak again".
            // Actually usually streak resets on fail. Let's reset current streak.
            quitExam();
        }
        saveGame('auto');
    }

    function quitExam() {
        $('exam-start-area').style.display = 'block';
        $('exam-ui').style.display = 'none';
        updateUI();
    }

    function importQuestions() {
        const json = $('exam-import-area').value;
        try {
            const data = JSON.parse(json);
            if(Array.isArray(data) && data.length > 0 && data[0].q) {
                examQuestions = data;
                alert(`æˆåŠŸå¯¼å…¥ ${data.length} é“é¢˜ç›®ã€‚`);
            } else {
                alert("æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
        } catch(e) {
            alert("JSONè§£æå¤±è´¥ã€‚");
        }
    }

    // --- UI æ›´æ–° ---
    
    function getSeasonInfo() {
        const year = Math.ceil(currentQuarter / 4);
        const seasonIndex = (currentQuarter - 1) % 4; 
        const seasons = ["æ˜¥", "å¤", "ç§‹", "å†¬"];
        return { year, season: seasons[seasonIndex], index: seasonIndex };
    }

    function updateSliderUI(type) {
        if(type === 'em') {
            const val = $('em-slider').value;
            $('em-val').innerText = val + "%";
            const steal = Math.floor(camp.funds * (val/100));
            $('em-steal').innerText = '$' + steal;
            $('em-gain').innerText = '$' + Math.floor(steal/2);
        } else if (type === 'don') {
            const val = $('don-slider').value;
            $('don-val').innerText = val + "%";
            const give = Math.floor(player.cash * (val/100));
            $('don-give').innerText = '$' + give;
            $('don-get').innerText = '$' + give;
        }
    }

    function updateUI() {
        const timeInfo = getSeasonInfo();
        $('day-display').innerText = `ç¬¬${timeInfo.year}å¹´ ${timeInfo.season}`;
        
        $('val-danger').innerText = dangerLevel; 
        $('val-refugees').innerText = camp.refugees;
        $('val-funds').innerText = '$' + camp.funds;
        $('val-cash-char').innerText = '$' + player.cash;
        $('val-cash-items').innerText = '$' + player.cash;
        $('val-base-lvl').innerText = BASE_LEVELS[camp.baseLevelIdx].name;
        $('val-base-lvl-num').innerText = camp.baseLevelIdx + 1;
        
        const currentSalary = RANK_SALARIES[player.rankIndex];
        $('val-salary').innerText = `+$${currentSalary}`;
        
        $('curr-streak').innerText = examStreak;
        $('best-streak').innerText = maxExamStreak;
        $('val-max-streak').innerText = maxExamStreak;

        // Ward UI
        const wardCap = BASE_LEVELS[camp.baseLevelIdx].wardCap;
        $('ward-count').innerText = patients.length;
        $('ward-cap').innerText = wardCap;
        $('ward-limit-msg').innerText = `æœ¬å­£æ”¶æ²»: ${admittedCount}/3`;

        const updateBar = (id, val, isReverse=false) => {
            let el = $(id);
            if(!el) return;
            el.innerText = val + (id.includes('tension')||id.includes('supplies')||id.includes('water')?'%':'');
            let bar = $('bar-' + id.replace('val-',''));
            if(bar) {
                bar.style.width = Math.max(0, Math.min(100, val)) + '%';
                bar.className = 'bar-fill';
                if (isReverse) { 
                    if(val > 70) bar.classList.add('low'); else if(val < 30) bar.classList.add('high');
                } else { 
                    if(val < 30) bar.classList.add('low'); else if(val > 70) bar.classList.add('high');
                }
            }
        };

        updateBar('val-tension', camp.tension, true);
        updateBar('val-supplies', camp.supplies);
        updateBar('val-water', camp.water);
        updateBar('val-health', player.health);
        updateBar('val-energy', player.energy);
        updateBar('val-med', player.med);
        updateBar('val-admin', player.admin);
        updateBar('val-soc', player.soc);
        
        // å«Œç–‘åº¦ UI
        $('val-suspicion').innerText = player.suspicion;
        $('bar-suspicion').style.width = Math.min(100, player.suspicion) + '%';
        
        // èŒçº§UI
        $('val-rank-name').innerText = CONFIG.ranks[player.rankIndex];
        $('val-rank-lvl').innerText = player.rankIndex + 1;
        $('val-favor').innerText = player.favor;
        $('bar-favor').style.width = player.favor + '%';
        
        // å•†åº—æŒ‰é’®çŠ¶æ€
        SHOP_ITEMS.forEach(item => {
            const btn = $('btn-buy-' + item.id);
            if(btn) {
                let price = item.price;
                let fundSource = (item.type === 'base') ? camp.funds : player.cash; // Wait, actually logic says base funds buy equip
                
                // Logic correction: 
                // Consumables (type 'cons') -> Player Cash? No prompt says "Base funds buy supplies/water" in Prompt 7
                // Wait. Prompt 7: "1. base funds buy supplies/water... 2. permanent base upgrades... cost 10000"
                // So Base Items use Camp Funds. Personal Items use Player Cash.
                
                if (item.id === 'supplies' || item.id === 'water') {
                    // Handled by buyBaseItem buttons separately
                } else if (item.type === 'base') {
                     if (camp.funds < price) btn.style.opacity = "0.5"; else btn.style.opacity = "1";
                } else {
                     if (player.items.includes(item.id)) { btn.disabled = true; btn.innerText = "å·²æ‹¥æœ‰"; }
                     else if (player.cash < price) btn.style.opacity = "0.5"; else btn.style.opacity = "1";
                }
            }
        });

        // æ™‹å‡çŠ¶æ€
        let promoText = "";
        const seasonIdx = (currentQuarter - 1) % 4; // 2 is Autumn
        const nextRankReq = RANK_REQ_STREAK[player.rankIndex]; // Req to go to next level? 
        // Array index 0 is rank 1. Req for rank 2 is index 1?
        // RANK_REQ_STREAK = [0, 3, 5, 10, 15, 20]
        // Current Rank Index 0 (Lv1). Target Rank Index 1 (Lv2). Need streak 3 (idx 1).
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;

        if (player.rankIndex >= 5) {
             promoText = "å·²è¾¾æœ€é«˜èŒçº§";
             $('btn-promo').disabled = true;
             $('btn-promo').style.background = "#555";
        } else if (player.appliedPromo) {
             promoText = "ç­‰å¾…æ€»éƒ¨å®¡æ ¸ (å†¬æœ«å‡ºç»“æœ)";
             $('btn-promo').disabled = true;
             $('btn-promo').style.background = "#d35400";
        } else {
             if (seasonIdx === 2) { 
                 if (maxExamStreak >= reqStreak) {
                    promoText = `ç§‹å­£çª—å£å¼€æ”¾ (æ»¡è¶³è¿èƒœ ${reqStreak})`;
                    $('btn-promo').disabled = false;
                    $('btn-promo').style.background = "var(--blue)";
                 } else {
                    promoText = `ç§‹å­£çª—å£å¼€æ”¾ (è¿èƒœä¸è¶³, éœ€${reqStreak})`;
                    $('btn-promo').disabled = true;
                    $('btn-promo').style.background = "#555";
                 }
             } else {
                 promoText = `ä»…ç§‹å­£å¼€æ”¾ (éœ€è¿èƒœ${reqStreak})`;
                 $('btn-promo').disabled = true;
                 $('btn-promo').style.background = "#555";
             }
        }
        $('promo-status').innerText = promoText;

        const restBtn = $('btn-rest');
        if (hasRestedToday) {
            restBtn.disabled = true;
            restBtn.innerText = "ğŸ›Œ ä¼‘æ¯ (æœ¬å­£å·²ä¼‘)";
            restBtn.style.background = "#555";
        } else {
            restBtn.disabled = false;
            restBtn.innerText = "ğŸ›Œ ä¼‘æ¯ (æœ¬å­£é™ä¸€æ¬¡)";
            restBtn.style.background = "var(--green)";
        }
        
        updateSliderUI('em');
        updateSliderUI('don');
    }

    // --- äº’åŠ¨é€»è¾‘ ---

    function doAction(type) {
        if(!isEventResolved) {
             switchNav('event');
             return showMessage("æç¤º", "è¯·å…ˆå‰å¾€ã€äº‹ä»¶ã€‘é¡µå¤„ç†æœ¬å­£åº¦çªå‘æƒ…å†µï¼");
        }
        
        // è®¡ç®—ç¤¾äº¤å¯¹ç´§å¼ åº¦å‡å°‘çš„åŠ æˆï¼š1 + floor(10% soc)
        let socBonus = 1 + Math.floor(player.soc * 0.1);

        let changes = {};
        if (type === 'distribute_food') {
            if (camp.supplies < 5) return showMessage("ç‰©èµ„ä¸è¶³", "åº“å­˜ä¸è¶³ï¼");
            changes = { supplies: -5, tension: -socBonus };
        } else if (type === 'distribute_water') {
            if (camp.water < 5) return showMessage("å‡€æ°´ä¸è¶³", "åº“å­˜ä¸è¶³ï¼");
            changes = { water: -5, tension: -socBonus };
        } else if (type === 'transport') {
            let healthCost = 5;
            if (player.items.includes('suv')) { healthCost = 0; }
            if (player.health < healthCost && healthCost > 0) return showMessage("ä½“åŠ›ä¸è¶³", "å¤ªç´¯äº†ï¼");
            changes = { supplies: 10, water: 10, health: -healthCost };
        } else if (type === 'pacify') {
            if(player.energy < 10) return showMessage("ç²¾åŠ›ä¸è¶³", "éœ€è¦10ç‚¹ç²¾åŠ›");
            changes = { tension: -5, energy: -10 };
        } else if (type === 'rescue') {
            if(player.health < 10) return showMessage("ä½“åŠ›ä¸è¶³", "éœ€è¦10ç‚¹å¥åº·");
            const cap = BASE_LEVELS[camp.baseLevelIdx].cap;
            if(camp.refugees >= cap) return showMessage("è¥åœ°å·²æ»¡", `å½“å‰ç­‰çº§ä¸Šé™ ${cap} äºº`);
            changes = { health: -10, refugees: 10 };
        } else if (type === 'big_spender') {
            if(camp.funds < 1000) return showMessage("èµ„é‡‘ä¸è¶³", "éœ€è¦$1000åŸºåœ°èµ„é‡‘");
            changes = { funds: -1000, tension: -8 };
        }

        applyChanges(changes);
        showResultModal(changes, "åŸºåœ°è¡ŒåŠ¨", "è¡ŒåŠ¨å·²æ‰§è¡Œã€‚");
        saveGame('auto');
    }

    function commitEmbezzle() {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†äº‹ä»¶ï¼");
        const val = $('em-slider').value;
        const stealAmount = Math.floor(camp.funds * (val/100));
        
        if (stealAmount <= 0) return;
        
        camp.funds -= stealAmount;
        const gain = Math.floor(stealAmount / 2);
        player.cash += gain;

        // å«Œç–‘åº¦å¢åŠ 
        let reduction = Math.floor((player.admin * 0.1) + (player.soc * 0.1));
        let susIncrease = 30 - reduction; 
        player.suspicion += susIncrease;
        
        updateUI();
        saveGame('auto');
        showCustomModal(
            `<li class="change-item"><span class="change-name">åŸºåœ°èµ„é‡‘</span> <span class="change-val val-down">-$${stealAmount}</span></li>` +
            `<li class="change-item"><span class="change-name">ä¸ªäººå­˜æ¬¾</span> <span class="change-val val-up">+$${gain}</span></li>` +
            `<li class="change-item"><span class="change-name">å«Œç–‘åº¦</span> <span class="change-val val-down">+${susIncrease}</span></li>`,
            "æ“ä½œæˆåŠŸ",
            "æŒªç”¨å®Œæˆã€‚é£é™©æ­£åœ¨ç´¯ç§¯..."
        );

        if (player.suspicion >= 100) {
            setTimeout(checkSuspicion, 1000); 
        }
        $('em-slider').value = 0; // Reset
    }

    function checkSuspicion() {
        if (player.suspicion >= 100) {
             $('investigation-modal').style.display = 'flex';
        }
    }

    function handleInvestigationAction(action) {
        $('investigation-modal').style.display = 'none';
        
        if (player.investigationCount > 0) {
            endGameByInvestigation();
            return;
        }

        if (action === 'resist') {
            endGameByInvestigation();
        } else {
            player.investigationCount++;
            player.suspicion = 0;
            player.cash = 0;
            player.rankIndex = Math.max(0, player.rankIndex - 2);
            updateUI();
            saveGame('auto');
            showMessage("æ¥å—å¤„åˆ†", "ä½ ä¸Šäº¤äº†æ‰€æœ‰éæ³•æ‰€å¾—å¹¶æ¥å—äº†é™èŒå¤„åˆ†ã€‚è¿™æ˜¯æœ€åä¸€æ¬¡æœºä¼šã€‚");
        }
    }

    function endGameByInvestigation() {
        $('game-screen').classList.remove('active');
        $('end-screen').classList.add('active');
        $('bottom-nav').style.display = 'none';
        $('exit-game-btn').style.display = 'none';
        $('end-reason').innerText = "ä½ çš„è´ªæ±¡è¡Œä¸ºå·²è¢«è¯å®ã€‚ä½ å·²è¢«é€®æ•å¹¶ç§»äº¤å›½é™…æ³•åº­ï¼ŒèŒä¸šç”Ÿæ¶¯å½»åº•ç»ˆç»“ã€‚";
        $('end-title').style.color = "var(--primary)";
        $('end-title').innerText = "èº«é™·å›¹åœ„";
        localStorage.removeItem(SAVE_KEY_AUTO); 
        localStorage.removeItem(SAVE_KEY_MANUAL);
    }

    function commitDonate() {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†äº‹ä»¶ï¼");
        const val = $('don-slider').value;
        const give = Math.floor(player.cash * (val/100));
        
        if (give <= 0) return;
        
        player.cash -= give;
        camp.funds += give;
        
        updateUI();
        saveGame('auto');
        showCustomModal(
            `<li class="change-item"><span class="change-name">ä¸ªäººå­˜æ¬¾</span> <span class="change-val val-down">-$${give}</span></li>` +
            `<li class="change-item"><span class="change-name">åŸºåœ°èµ„é‡‘</span> <span class="change-val val-up">+$${give}</span></li>`,
            "æèµ æˆåŠŸ",
            "ä½ çš„æ…·æ…¨è§£å›Šç¼“è§£äº†åŸºåœ°çš„è´¢æ”¿å‹åŠ›ã€‚"
        );
        $('don-slider').value = 0;
    }

    function trainSkill(type) {
        if(!isEventResolved) {
            switchNav('event');
            return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        }
        if(player.energy < 3) return showMessage("çŠ¶æ€ä¸ä½³", "ä½ ç²¾åŠ›ä¸è¶³ï¼Œæ— æ³•é›†ä¸­æ³¨æ„åŠ›ã€‚");
        
        let gain = randInt(1, 5);
        player[type] = Math.min(100, player[type] + gain);
        applyChanges({ energy: -3 }); 

        let typeName = type==='med'?'åŒ»å­¦':(type==='admin'?'è¡Œæ”¿':'ç¤¾äº¤');
        let listHtml = `<li class="change-item"><span class="change-name">${typeName}æå‡</span> <span class="change-val val-up">+${gain}</span></li>` +
                       `<li class="change-item"><span class="change-name">ç²¾åŠ›</span> <span class="change-val val-down">-3</span></li>`;
        showCustomModal(listHtml, "èƒ½åŠ›è¿›ä¿®", "ä½ æŠ•å…¥äº†æ—¶é—´æå‡è‡ªæˆ‘ã€‚");
        saveGame('auto');
    }

    function doRest() {
        if(!isEventResolved) {
            switchNav('event');
            return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        }
        if(hasRestedToday) return showMessage("æç¤º", "æœ¬å­£åº¦å·²ç»ä¼‘æ¯è¿‡äº†ï¼");

        hasRestedToday = true; 
        applyChanges({ health: 5, energy: 5 });

        let listHtml = `<li class="change-item"><span class="change-name">å¥åº·æ¢å¤</span> <span class="change-val val-up">+5</span></li>` +
                       `<li class="change-item"><span class="change-name">ç²¾åŠ›æ¢å¤</span> <span class="change-val val-up">+5</span></li>`;
        showCustomModal(listHtml, "ä¼‘æ•´ç»“æŸ", "è™½ç„¶åªæœ‰çŸ­æš‚çš„ä¼‘æ¯ï¼Œä½†æ„Ÿè§‰å¥½å¤šäº†ã€‚");
        updateUI(); 
        saveGame('auto');
    }

    function interactBoss(type) {
        if(!isEventResolved) {
            switchNav('event');
            return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        }
        
        if (type === 'network') {
            if (player.energy < 3) return showMessage("çŠ¶æ€ä¸ä½³", "ç²¾åŠ›å¤ªå·®ï¼Œä¸é€‚åˆç¤¾äº¤ã€‚");
            
            let randBase = randInt(-3, 3);
            let socBonus = Math.floor(player.soc * 0.1);
            let gain = randBase + socBonus;

            let oldFavor = player.favor;
            player.favor = Math.min(100, Math.max(0, player.favor + gain));
            applyChanges({ energy: -3 });
            
            let actualChange = player.favor - oldFavor;
            let listHtml = `<li class="change-item"><span class="change-name">ä¸Šçº§å¥½æ„Ÿ</span> <span class="change-val ${actualChange>=0?'val-up':'val-down'}">${actualChange>=0?'+':''}${actualChange}</span></li>` +
                           `<li class="change-item"><span class="change-name">ç²¾åŠ›</span> <span class="change-val val-down">-3</span></li>`;
            
            let desc = actualChange > 0 ? "æ²Ÿé€šéå¸¸é¡ºåˆ©ï¼Œä¸Šçº§å¯¹ä½ çš„å°è±¡åŠ æ·±äº†ã€‚" : (actualChange < 0 ? "ä¹Ÿè®¸æ˜¯è¯´è¯æ–¹å¼ä¸å¯¹ï¼Œæ°”æ°›å˜å¾—å°´å°¬äº†ã€‚" : "è¿™æ˜¯ä¸€æ¬¡å¹³æ·¡çš„è°ˆè¯ã€‚");
            showCustomModal(listHtml, "äººé™…äº¤å¾€", desc);

        } else if (type === 'fund') {
            if (player.favor < 3) return showMessage("è¯·æ±‚è¢«æ‹’", "ä¸Šçº§å¯¹ä½ çš„å¥½æ„Ÿä¸è¶³ï¼Œä¸æ„¿å—ç†è¯·æ±‚ã€‚");
            
            player.favor -= 3;
            let success = (Math.random() * 100) < player.favor;
            
            let listHtml = `<li class="change-item"><span class="change-name">ä¸Šçº§å¥½æ„Ÿ</span> <span class="change-val val-down">-3</span></li>`;
            let msg = "";
            let title = "";
            
            if (success) {
                let amount = randInt(500, 1000);
                camp.funds += amount;
                title = "ç”³è¯·æ‰¹å‡†";
                msg = `ä¸Šçº§æ‰¹å‡†äº†ä½ çš„ç‰¹åˆ«èµ„é‡‘ç”³è¯·ã€‚`;
                listHtml += `<li class="change-item"><span class="change-name">åŸºåœ°èµ„é‡‘</span> <span class="change-val val-up">+$${amount}</span></li>`;
            } else {
                title = "ç”³è¯·é©³å›";
                msg = "ä¸Šçº§è®¤ä¸ºç›®å‰ä¸éœ€è¦é¢å¤–æ‹¨æ¬¾ã€‚";
            }
            updateUI();
            showCustomModal(listHtml, title, msg);
        }
        saveGame('auto');
    }

    function applyForPromotion() {
        if(!isEventResolved) return showMessage("æç¤º", "è¯·å…ˆå¤„ç†çªå‘äº‹ä»¶ï¼");
        
        // Check strict streak req
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;
        if (maxExamStreak < reqStreak) {
            return showMessage("æ¡ä»¶ä¸è¶³", `å½“å‰èŒçº§æ™‹å‡éœ€è¦æœ€é«˜è¿èƒœè¾¾åˆ° ${reqStreak} æ¬¡ã€‚`);
        }

        player.appliedPromo = true;
        player.lastPromoQuarter = currentQuarter; 
        updateUI();
        saveGame('auto');
        showMessage("å·²æäº¤", "å·²æäº¤æ™‹å‡ç”³è¯·ï¼Œæ€»éƒ¨å°†åœ¨å†¬å­£ç»“æŸæ—¶è¿›è¡Œè€ƒæ ¸ã€‚");
    }

    function processPromotion() {
        if (!player.appliedPromo) return;
        
        // Hard requirement: Streak. Assuming checked at apply time, but check again for safety
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;
        
        let success = (maxExamStreak >= reqStreak);
        let logText = "";
        let resultHtml = "";
        
        if (success) {
            player.rankIndex++;
            player.favor -= 30; 
            if (player.favor < 0) player.favor = 0;
            logText = `æ­å–œï¼ä½ çš„æ™‹å‡ç”³è¯·é€šè¿‡äº†ã€‚ç°ä»»èŒçº§ï¼š${CONFIG.ranks[player.rankIndex]}ã€‚è–ªæ°´æå‡è‡³ $${RANK_SALARIES[player.rankIndex]}ã€‚`;
            addAchievement(`ç¬¬${Math.ceil(currentQuarter/4)}å¹´: æ™‹å‡ä¸º ${CONFIG.ranks[player.rankIndex]}`);
            resultHtml = `<li class="change-item"><span class="change-name">èŒçº§</span> <span class="change-val val-up">æ™‹å‡</span></li>`;
        } else {
            logText = `å¾ˆé—æ†¾ï¼Œä½ çš„æ™‹å‡ç”³è¯·è¢«é©³å›ã€‚éœ€åœ¨è€ƒæ ¸ä¸­è¯æ˜è‡ªå·±(æœ€é«˜è¿èƒœ>=${reqStreak})ã€‚`;
            resultHtml = `<li class="change-item"><span class="change-name">ç»“æœ</span> <span class="change-val val-down">å¤±è´¥</span></li>`;
        }
        
        showCustomModal(resultHtml, "å¹´åº¦è€ƒæ ¸ç»“æœ", logText);
        player.appliedPromo = false;
    }
    
    function addAchievement(text) {
        let li = document.createElement('li');
        li.className = 'achieve-item';
        li.innerText = text;
        $('achievement-list').appendChild(li);
    }

    // --- æ ¸å¿ƒå¾ªç¯ API ---

    async function callDeepSeek(prompt, isJson = false) {
        let apiKey = $('api-key').value;
        if (!apiKey || apiKey.trim() === "") apiKey = DEVELOPER_API_KEY; // Use hardcoded key if empty

        const apiUrl = $('api-url').value; 
        const model = $('model-name').value;
        const endpoint = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
        const body = { model: model, messages: [{ role: "system", content: "You are a game engine." }, { role: "user", content: prompt }], stream: false };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const err = await response.text();
            throw new Error(`API Error: ${response.status} - ${err}`);
        }

        const json = await response.json();
        let content = json.choices[0].message.content;
        content = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();

        if (isJson) return JSON.parse(content);
        return content;
    }

    async function generateStory() {
        $('gen-story-btn').disabled = true;
        $('gen-story-btn').innerText = "â³ æ­£åœ¨æ•´ç†æ¡£æ¡ˆ...";
        $('story-container').style.display = 'block';

        const summary = historyLog.map(log => 
            `Q${log.day}: é‡åˆ°ã€${log.event}ã€‘ã€‚é€‰æ‹©ã€${log.choice}ã€‘ã€‚ç»“æœï¼š${log.isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}ã€‚åæœï¼š${log.resultText}`
        ).join("\n");

        const prompt = `ä½ æ˜¯ä¸€å${player.dept}åŒ»ç”Ÿï¼Œåå«${player.name}ï¼Œæœ€ç»ˆèŒçº§${CONFIG.ranks[player.rankIndex]}ã€‚åœ°ç‚¹ï¼š${player.location}ã€‚è¯·æ ¹æ®ä»¥ä¸‹æˆ‘çš„å‰çº¿ç»å†ï¼Œä»¥ç¬¬ä¸€äººç§°å†™ä¸€ç¯‡â€œæˆ˜åœ°æ—¥è®°â€ã€‚\nç»å†è®°å½•ï¼š\n${summary}\nè¦æ±‚ï¼šæƒ…æ„ŸçœŸæŒšï¼Œä½“ç°æ— å›½ç•ŒåŒ»ç”Ÿçš„ç²¾ç¥ä¸æˆ˜äº‰æ®‹é…·ã€‚çº¦300å­—ã€‚`;

        try {
            if($('use-mock').checked) { 
                await wait(1500); 
                $('story-content').innerText = "ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰æ—¥è®°ç”Ÿæˆæ¼”ç¤ºï¼š\nä»Šå¤©æ˜¯ä¸ªè‰°éš¾çš„æ—¥å­ã€‚é›¨ä¸€ç›´åœ¨ä¸‹...ï¼ˆè¯·ä½¿ç”¨API Keyè·å–å®Œæ•´AIç”Ÿæˆæ•…äº‹ï¼‰";
            } else {
                const story = await callDeepSeek(prompt, false);
                $('story-content').innerText = story;
            }
        } catch(e) {
            $('story-content').innerText = "ç”Ÿæˆå¤±è´¥: " + e.message;
        }
        $('gen-story-btn').innerText = "ğŸ“– ç”Ÿæˆæˆ˜åœ°æ—¥è®° (å›é¡¾)";
        $('gen-story-btn').disabled = false;
    }

    async function generateBio() {
        const prompt = `ä½ æ˜¯ä¸€ä¸ªå°è¯´å®¶ã€‚èƒŒæ™¯ï¼š${player.location} çš„æ— å›½ç•ŒåŒ»ç”Ÿ(MSF)è¥åœ°ã€‚äººç‰©ï¼š${player.name}ï¼Œ${player.gender}ï¼Œç§‘å®¤ï¼šã€${player.dept}ã€‘ã€‚å‚è€ƒæ•°å€¼ï¼šåŒ»å­¦${player.med}ï¼Œè¡Œæ”¿${player.admin}ï¼Œç¤¾äº¤${player.soc}ã€‚\nè¯·ç”Ÿæˆä¸€æ®µçº¦150å­—çš„äººç‰©ä»‹ç»ï¼Œç¦æ­¢å‡ºç°å…·ä½“æ•°å€¼ï¼Œä½¿ç”¨ç”Ÿæ´»åŒ–é˜¶æ¢¯æè¿°ã€‚`;
        if($('use-mock').checked) { await wait(1000); return "ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰è¿™é‡Œæ˜¯å‰çº¿ã€‚ä½œä¸ºä¸€åå¤–ç§‘åŒ»ç”Ÿï¼Œä»–å†·é™è€Œæœæ•¢ï¼Œæ‰‹æœ¯åˆ€æ˜¯ä»–åœ¨åœ°ç‹±ä¸­å”¯ä¸€çš„ä¿¡ä»°ã€‚"; }
        return await callDeepSeek(prompt, false);
    }

    async function generateEventData() {
        const roll = Math.random() * 100;
        let eventType = "";
        let effectConstraints = "";

        if (roll < 40) {
            eventType = "å¤–éƒ¨å±æœº";
            effectConstraints = "é€‰é¡¹ç»“æœå¿…é¡»åªå½±å“ã€åŸºåœ°å±æ€§ã€‘ï¼šç´§å¼ åº¦(tension)ã€èµ„é‡‘(funds)(-500/1000/1500)ã€ç‰©èµ„(supplies)(5-10)ã€å‡€æ°´(water)(5-10)ã€‚";
        } else if (roll < 70) {
            eventType = "å†…éƒ¨å±æœº";
            effectConstraints = "é€‰é¡¹ç»“æœå¿…é¡»åªå½±å“ã€åŸºåœ°å±æ€§ã€‘ï¼šç´§å¼ åº¦(tension)ã€èµ„é‡‘(funds)(-500/1000/1500)ã€ç‰©èµ„(supplies)(5-10)ã€å‡€æ°´(water)(5-10)ã€‚";
        } else if (roll < 90) {
            eventType = "ä¸ªäººå±æœº";
            effectConstraints = "é€‰é¡¹ç»“æœå¿…é¡»åªå½±å“ã€äººç‰©å±æ€§ã€‘ï¼šå¥åº·(health)ï¼ˆ-5æˆ–+5ï¼‰ã€ç²¾åŠ›(energy)ï¼ˆ-5æˆ–+5ï¼‰ã€é‡‘é’±(cash)(-50/100/200/250)ã€èƒ½åŠ›(med/admin/soc)(2-5)ã€å«Œç–‘åº¦(suspicion)(-10åˆ°+10)ã€‚";
        } else {
            eventType = "å¹¸è¿äº‹ä»¶";
            effectConstraints = "è¯·æä¾›3ä¸ªæ­£é¢é€‰é¡¹ï¼ˆå¯ä»¥3é€‰1ï¼‰ï¼Œæ¯ä¸ªé€‰é¡¹å¢åŠ éšæœºä¸€é¡¹ã€åŸºåœ°å±æ€§ã€‘æˆ–ã€äººç‰©å±æ€§ã€‘ï¼ˆæ•°å€¼=5ï¼‰ï¼Œé™¤äº†é‡‘é’±(cash)(100/200/250)å’Œèµ„é‡‘(funds)(500/1000/1500)ã€‚";
        }
        
        const timeInfo = getSeasonInfo();
        const displayTime = `ç¬¬${timeInfo.year}å¹´ ${timeInfo.season}`;

        const contextPrompt = `
        èƒŒæ™¯ï¼š${player.location} (æ— å›½ç•ŒåŒ»ç”Ÿå‰çº¿)ã€‚å½“å‰æ—¶é—´ï¼š${displayTime}ã€‚
        äº‹ä»¶ç±»å‹è¦æ±‚ï¼šã€${eventType}ã€‘ã€‚
        çº¦æŸæ¡ä»¶ï¼š${effectConstraints}
        ç©å®¶èŒä½:${CONFIG.ranks[player.rankIndex]}ã€‚
        
        è¯·ç”Ÿæˆä¸€ä¸ªç¬¦åˆç±»å‹çš„éšæœºäº‹ä»¶ã€‚
        è¦æ±‚ï¼š
        1. å¿…é¡»åŒ…å«3ä¸ªé€‰é¡¹ã€‚å¯¹äºå±æœºäº‹ä»¶ï¼Œå…¶ä¸­1-2ä¸ªä¸ºé™·é˜±/æ— æ•ˆé€‰é¡¹ï¼›å¯¹äºå¹¸è¿äº‹ä»¶ï¼Œ3ä¸ªéƒ½æ˜¯å¥–åŠ±ã€‚
        2. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦Markdownä»£ç å—æ ‡è®°ï¼š
        {
            "type": "${eventType}ï¼š(å…·ä½“åç§°)",
            "description": "...",
            "choices": [
                { "text": "...", "stat": "med/admin/soc", "result_win": "...", "result_lose": "...", "effects_win": {"key": value}, "effects_lose": {"key": value} }
            ]
        }
        æ³¨æ„ï¼šeffectså¯¹è±¡çš„keyåªèƒ½æ˜¯: tension, funds, supplies, water, health, energy, cash, med, admin, soc, suspicionã€‚
        `;
        
        if($('use-mock').checked) { await wait(1500); return mockEvent(eventType); }
        return await callDeepSeek(contextPrompt, true);
    }

    // --- æ¸¸æˆå¾ªç¯ ---

    async function triggerNextQuarter() {
        
        // 1. æœ¬å­£åº¦ç»“ç®—ï¼šæ‰£é™¤ä¸ªäººç”Ÿæ´»è´¹
        player.cash -= 50;

        // 2. åŸºåœ°èµ„é‡‘æ¶ˆè€—è®¡ç®—
        let fundCost = 1000 - (player.admin * 10) + (camp.tension * 10);
        if (fundCost < 0) fundCost = 100; // æœ€ä½æ¶ˆè€—
        camp.funds -= fundCost;

        // éš¾æ°‘è‡ªç„¶è¡°å‡
        const decayRef = randInt(5, 10);
        camp.refugees = Math.max(0, camp.refugees - decayRef);

        if (!checkGameOver()) return;
        
        $('next-day-btn').style.display = 'none';
        $('next-quarter-msg').style.display = 'none';
        $('event-area').style.display = 'none';
        $('start-event-btn').style.display = 'block'; 
        isEventResolved = false;
        hasRestedToday = false; 
        admittedCount = 0; // Reset admissions
        hasRounded = false; // Reset rounds
        hasTakenExam = false; // Reset exam attempt (streak preserved if didn't fail)

        // 3. åŸºåœ°å›ºå®šæ‹¨æ¬¾ (æ–°å­£åº¦èµ„é‡‘)
        camp.funds += 1000;
        
        // å¢åŠ å­£åº¦
        currentQuarter++;

        // 4. ä¸ªäººè–ªæ°´å‘æ”¾ (æ–°å­£åº¦å¼€å§‹)
        const salary = RANK_SALARIES[player.rankIndex];
        player.cash += salary;

        // 5. å«Œç–‘åº¦è‡ªç„¶è¡°å‡
        let decay = randInt(3, 7);
        player.suspicion = Math.max(0, player.suspicion - decay);
        
        // å±é™©åº¦è‡ªç„¶å¢é•¿
        if ((currentQuarter - 1) % 4 === 0) { 
            dangerLevel += 5;
        }

        updateUI();
        
        if (player.appliedPromo && (currentQuarter - 2) % 4 === 3) {
            processPromotion();
        }

        if (!checkGameOver()) return;
        if (checkVictory()) return;
        
        if (player.suspicion >= 100) {
            if (player.investigationCount > 0) {
                endGameByInvestigation();
            } else {
                $('investigation-modal').style.display = 'flex';
            }
        } else {
            switchNav('event');
        }
        saveGame('auto');
    }

    function renderEvent(data) {
        $('loading-spinner').style.display = 'none';
        $('event-area').style.display = 'block';
        $('event-tag').innerText = data.type;
        $('event-desc').innerText = data.description;
        const c = $('choices-container');
        c.innerHTML = '';
        data.choices.forEach(choice => {
            let btn = document.createElement('button');
            btn.className = 'choice-btn';
            let statName = choice.stat === 'med' ? 'åŒ»å­¦' : (choice.stat === 'admin' ? 'è¡Œæ”¿' : 'ç¤¾äº¤');
            btn.innerHTML = `<strong>> ${choice.text}</strong> <span style="font-size:0.8em; color:var(--accent)">[æ£€å®š:${statName}]</span>`;
            btn.onclick = () => resolveEvent(choice, data.type);
            c.appendChild(btn);
        });
    }

    function resolveEvent(choice, eventType) {
        let threshold = 9 + (dangerLevel / 5);
        const statVal = player[choice.stat] || 0;
        const roll = Math.random() * 10;
        const score = (statVal * 0.1) + roll;
        const isSuccess = score >= threshold;

        const finalEffects = isSuccess ? choice.effects_win : choice.effects_lose;
        const finalResultText = isSuccess ? choice.result_win : choice.result_lose;
        
        applyChanges(finalEffects);
        historyLog.push({ day: currentQuarter, event: eventType, choice: choice.text, isSuccess: isSuccess, resultText: finalResultText });

        const statusText = isSuccess ? `âœ… æ£€å®šæˆåŠŸ` : `âŒ æ£€å®šå¤±è´¥`;
        const statusClass = isSuccess ? "status-success" : "status-fail";
        showResultModal(finalEffects, "äº‹ä»¶ç»“ç®—", finalResultText, statusText, statusClass);
        
        isEventResolved = true;
        $('event-area').style.display = 'none';
        $('next-day-btn').style.display = 'block'; 
        $('next-quarter-msg').style.display = 'block';
        
        checkGameOver();
        saveGame('auto');
    }

    function mockEvent(type) {
        let desc = "çªå‘æƒ…å†µï¼š";
        let c = [];
        if (type.includes("å¤–éƒ¨") || type.includes("å†…éƒ¨")) {
             desc += "ç”±äºæˆ˜ä¹±ï¼Œä¸€æ‰¹éš¾æ°‘æ¶Œå…¥ï¼Œå¯¼è‡´ç‰©èµ„ç´§å¼ ã€‚";
             c = [
                 { text: "ç´§æ€¥è°ƒé…", stat: "admin", result_win: "ç‰©èµ„é‡æ–°åˆ†é…ã€‚", result_lose: "å¼•å‘æ··ä¹±ã€‚", effects_win: {tension:-5}, effects_lose: {tension:5, supplies:-10} },
                 { text: "å®‰æŠšæƒ…ç»ª", stat: "soc", result_win: "å¤§å®¶å†·é™ä¸‹æ¥ã€‚", result_lose: "æ²¡äººå¬ä½ çš„ã€‚", effects_win: {tension:-10}, effects_lose: {energy:-5} },
                 { text: "åŒ»ç–—æ”¯æ´", stat: "med", result_win: "é˜²æ­¢äº†ç–«æƒ…ã€‚", result_lose: "è¯å“è€—å°½ã€‚", effects_win: {health:2}, effects_lose: {supplies:-20} }
             ];
        } else if (type.includes("ä¸ªäºº")) {
            desc += "ä½ æ„Ÿåˆ°èº«ä½“ä¸é€‚ï¼Œå¯èƒ½æ˜¯è¿‡åº¦åŠ³ç´¯ã€‚";
            c = [
                { text: "è‡ªæˆ‘è¯Šæ–­", stat: "med", result_win: "åªæ˜¯å°æ„Ÿå†’ã€‚", result_lose: "è¯¯è¯ŠåŠ é‡ã€‚", effects_win: {health:2}, effects_lose: {health:-5} },
                { text: "åšæŒå·¥ä½œ", stat: "admin", result_win: "å·¥ä½œå®Œæˆäº†ã€‚", result_lose: "æ™•å€’åœ¨å²—ä½ã€‚", effects_win: {cash:50}, effects_lose: {health:-10} },
                { text: "æ‰¾äººå€¾è¯‰", stat: "soc", result_win: "å¿ƒæƒ…å¥½å¤šäº†ã€‚", result_lose: "è¢«å«Œå¼ƒçƒ¦ã€‚", effects_win: {energy:5}, effects_lose: {energy:-5} }
            ];
        } else {
            desc += "è¿™æ˜¯ä¸€ä¸ªå¹¸è¿çš„æ—¥å­ï¼";
            c = [
                { text: "æ¡åˆ°é’±", stat: "admin", result_win: "è¿æ°”ä¸é”™ã€‚", result_lose: "è¿æ°”ä¸é”™ã€‚", effects_win: {cash:200}, effects_lose: {cash:200} },
                { text: "ä¼‘æ¯å……è¶³", stat: "med", result_win: "ç²¾åŠ›å……æ²›ã€‚", result_lose: "ç²¾åŠ›å……æ²›ã€‚", effects_win: {health:5}, effects_lose: {health:5} },
                { text: "æ”¶åˆ°æ„Ÿè°¢ä¿¡", stat: "soc", result_win: "å¿ƒæƒ…å¤§å¥½ã€‚", result_lose: "å¿ƒæƒ…å¤§å¥½ã€‚", effects_win: {energy:5}, effects_lose: {energy:5} }
            ];
        }
        
        return {
            type: type,
            description: desc,
            choices: c
        };
    }

    function applyChanges(effects) {
        for(let key in effects) {
            if(player[key] !== undefined) player[key] += effects[key];
            if(camp[key] !== undefined) camp[key] += effects[key];
        }
        updateUI();
    }

    function showResultModal(effects, title, description, statusText, statusClass) {
        const list = $('result-list');
        list.innerHTML = '';
        if (statusText) {
            $('result-status').innerText = statusText;
            $('result-status').className = statusClass || "";
            $('result-status').style.display = 'block';
        } else {
            $('result-status').style.display = 'none';
        }
        $('result-text').innerText = description;
        
        let hasContent = false;
        const map = { health: "å¥åº·", energy: "ç²¾åŠ›", supplies: "ç‰©èµ„", water: "å‡€æ°´", tension: "ç´§å¼ åº¦", refugees: "éš¾æ°‘", funds: "èµ„é‡‘", favor: "å¥½æ„Ÿ", med:"åŒ»å­¦", admin:"è¡Œæ”¿", soc:"ç¤¾äº¤", cash:"é‡‘é’±", suspicion:"å«Œç–‘" };
        for(let key in effects) {
            let val = effects[key];
            if(val === 0) continue;
            hasContent = true;
            let isGood = (key === 'tension' || key === 'suspicion') ? val < 0 : val > 0;
            if(key === 'funds' && val < 0) isGood = false;
            
            let li = document.createElement('li');
            li.className = 'change-item';
            let displayVal = val;
            if (key === 'funds' || key === 'cash') displayVal = '$' + val;
            
            li.innerHTML = `<span class="change-name">${map[key]||key}</span><span class="change-val ${isGood?'val-up':'val-down'}">${val>0?'+':''}${displayVal}</span>`;
            list.appendChild(li);
        }
        if(!hasContent) list.innerHTML = '<li class="change-item">æ— æ˜¾è‘—æ•°å€¼å˜åŒ–</li>';
        
        $('result-modal').querySelector('.modal-header').innerText = title;
        $('result-modal').style.display = 'flex';
    }
    
    function showCustomModal(html, title, description) {
        $('result-status').style.display = 'none'; 
        $('result-text').innerText = description;
        $('result-list').innerHTML = html;
        $('result-modal').querySelector('.modal-header').innerText = title;
        $('result-modal').style.display = 'flex';
    }

    function closeModal() {
        $('result-modal').style.display = 'none';
        checkGameOver();
    }

    function checkGameOver() {
        let reason = null;
        if(camp.tension >= 100) reason = "è¥åœ°æš´åŠ¨ï¼Œæ­¦è£…åˆ†å­æ¥ç®¡äº†è¿™é‡Œã€‚";
        else if(camp.supplies <= 0) reason = "ç‰©èµ„è€—å°½ï¼Œè¥åœ°å´©æºƒã€‚";
        else if(camp.water <= 0) reason = "æ°´æºæ¯ç«­ï¼Œç–«æƒ…å¤±æ§ã€‚";
        else if(camp.funds <= 0) reason = "åŸºåœ°èµ„é‡‘æ–­è£‚ï¼Œé¡¹ç›®è¢«è¿«å…³åœã€‚";
        else if(player.cash < 0) reason = "ä¸ªäººç ´äº§ï¼Œæ— æ³•ç»´æŒç”Ÿè®¡ï¼Œè¢«è¿«å›å›½ã€‚";
        else if(player.health <= 0) reason = "ä½ åœ¨å²—ä½ä¸Šå€’ä¸‹äº†ã€‚";
        else if(player.energy <= 0) reason = "ä½ çš„ç²¾åŠ›å½»åº•é€æ”¯ã€‚";
        
        if(reason) {
            $('game-screen').classList.remove('active');
            $('end-screen').classList.add('active');
            $('bottom-nav').style.display = 'none';
            $('exit-game-btn').style.display = 'none';
            $('end-reason').innerText = reason;
            $('end-title').style.color = "var(--primary)";
            $('end-title').innerText = "è¡ŒåŠ¨å¤±è´¥";
            localStorage.removeItem(SAVE_KEY_AUTO);
            return false;
        }
        return true;
    }

    function checkVictory() {
        if (player.rankIndex === 5) {
            quartersSinceRank6++;
        }
        
        if (player.rankIndex === 5 && quartersSinceRank6 >= 3 && !isVictoryPending) {
             $('game-screen').classList.remove('active');
             $('end-screen').classList.add('active');
             $('bottom-nav').style.display = 'none';
             $('exit-game-btn').style.display = 'none';
             $('end-title').style.color = "var(--green)";
             $('end-title').innerText = "å…‰è£é€€ä¼‘";
             $('end-reason').innerText = `ä½ å·²æˆä¸ºåŒºåŸŸæ€»ç­¹å¹¶ç¨³å®šç»´æŒäº†å±€åŠ¿ã€‚ä½ æ˜¯éå‡¡çš„æŒ‡æŒ¥å®˜ã€‚`;
             $('continue-game-area').style.display = 'block';
             localStorage.removeItem(SAVE_KEY_AUTO); 
             return true;
        }
        return false;
    }

    function continueGame() {
        isVictoryPending = true; 
        $('end-screen').classList.remove('active');
        $('game-screen').classList.add('active');
        $('bottom-nav').style.display = 'grid';
        $('exit-game-btn').style.display = 'block';
        saveGame('auto'); 
        switchNav('event');
    }
</script>

</body>
</html>