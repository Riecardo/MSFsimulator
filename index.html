<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>无国界医生：前线指挥官 (DeepSeek R1版)</title>
    <link rel="stylesheet" href="form.css">
    <script src="test.js"></script>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <div class="system-btns">
                <button class="sys-btn" onclick="openSettingsModal()">⚙️ 设置</button>
                <button class="sys-btn" onclick="openAchievementsModal()">🏆 成就</button>
            </div>
            <h1>🚑 前线指挥官 <span style="font-size:0.6em; color:#888">MSF</span></h1>
            <div id="game-location-display">📍 ???</div>
        </div>

        <div class="day-counter" id="day-display">第1年 春</div>
    </header>

    <div id="setup-screen" class="screen active">
        <div class="story-intro" style="background:linear-gradient(135deg, rgba(44,62,80,0.95), rgba(52,73,94,0.9)); border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:20px; position:relative; overflow:hidden;">
            <div style="position:absolute; top:0; right:0; font-size:4rem; opacity:0.1; transform:translate(10%, -20%);">🏥</div>
            <h3 style="margin:0 0 15px 0; color:var(--gold); font-size:1.2rem; letter-spacing:2px;">📜 战地档案 · 序章</h3>
            <p style="font-size:0.95rem; line-height:1.9; color:#ccc; margin:0; text-align:justify; text-indent:2em;">
                步入二十一世纪，世界并未如人们期望的那样走向和平。在南苏丹的难民营里，枪声与婴儿的啼哭交织；在也门的废墟间，医疗帐篷是方圆百里唯一的光。无国界医生组织（MSF）的志愿者们，穿梭于被遗忘的角落，用听诊器对抗炮火，以手术刀守护最后的底线。
            </p>
            <p style="font-size:0.95rem; line-height:1.9; color:#ccc; margin:15px 0 0 0; text-align:justify; text-indent:2em;">
                你即将成为他们中的一员。在资源匮乏的前线营地，你要救治伤患、管理物资、安抚难民、应对突发危机。每一个决定都关乎生死，每一次选择都考验人性。从一名普通医疗专员做起，凭借医术与智慧晋升至最高职级——这是你的使命，也是你的救赎。
            </p>
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.85rem; color:var(--gold); text-align:center;">
                🎯 <strong>游戏目标</strong>：活下去，坚持住，在战火中守护生命与希望。
            </div>
        </div>

        <div class="input-group">
            <h3>🪪 志愿申请表</h3>
            
            <div class="setup-header-row" style="margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
                <div style="margin-bottom: 15px;">
                    <strong>📍 任务地点:</strong> <span id="p-location" style="color:var(--primary); font-size:1.3rem;">正在分配...</span>
                    <button onclick="rollLocation()" style="padding:4px 10px; font-size:0.8rem; margin-left:10px;">🎲 随机地点</button>
                    <div id="p-location-desc" style="font-size:0.85rem; color:#888; margin-top:8px; line-height:1.5; font-style:italic; font-weight:normal;"></div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                    <div style="display:flex; align-items: center; gap: 10px;">
                        <input type="text" id="input-lastname" placeholder="姓" style="width: 60px; padding: 8px; font-size: 1.1rem;">
                        <input type="text" id="input-firstname" placeholder="名" style="width: 100px; padding: 8px; font-size: 1.1rem;">
                        <button onclick="rollName()" style="padding:8px 15px; font-size:0.9rem;">🎲 随机姓名</button>
                    </div>
                    
                    <div style="display:flex; align-items: center; gap: 15px;">
                        <div>
                            <strong>性别:</strong>
                            <select id="select-gender" style="padding:8px; background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:4px; font-size:1rem; margin-left:5px;">
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <div>
                            <strong>科室:</strong>
                            <select id="select-dept" style="padding:8px; background:var(--panel); color:var(--text); border:1px solid var(--border); border-radius:4px; font-size:1rem; margin-left:5px;">
                                <option value="全科">全科</option>
                                <option value="内科">内科</option>
                                <option value="外科">外科</option>
                                <option value="传染科">传染科</option>
                                <option value="儿科">儿科</option>
                                <option value="妇产科">妇产科</option>
                                <option value="急诊科">急诊科</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom:10px; display:flex; justify-content: space-between; align-items: center;">
                <strong>📊 初始能力值</strong>
                <button onclick="rollStats()" style="padding:4px 10px; font-size:0.8rem;">🎲 随机能力</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; text-align:center; margin-bottom: 20px;">
                <div style="background:var(--panel); border:1px solid var(--border); padding:10px; border-radius:4px;">医学<br><strong id="p-med" style="font-size:1.4em">0</strong></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:10px; border-radius:4px;">行政<br><strong id="p-admin" style="font-size:1.4em">0</strong></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:10px; border-radius:4px;">社交<br><strong id="p-soc" style="font-size:1.4em">0</strong></div>
            </div>

            <div class="setup-btn-container">
                <button class="setup-main-btn" style="background:var(--primary); color:white; font-weight:bold;" onclick="tryStartNewGame()">🚀 开始新游戏</button>
                <button id="continue-btn" class="setup-main-btn" onclick="openLoadModal()" style="display:none; background:var(--green); color:white; border:2px solid var(--text);">🔄 继续游戏 (检测到存档)</button>
            </div>
        </div>

        <details style="margin-top:20px; border:1px solid var(--border); border-radius:4px; background:var(--panel);">
            <summary style="padding:12px 15px; cursor:pointer; color:#888; font-size:0.9rem;">📡 高级设置 (API配置)</summary>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <p style="font-size:0.8em; color:#888; margin-bottom:10px;">开发者API Key已预装。如需使用自己的Key请在下方输入。</p>
                <label style="font-size:0.85em; font-weight:bold;">API Base URL:</label>
                <input type="text" id="api-url" value="https://api.deepseek.com" style="margin-bottom:10px;">

                <label style="font-size:0.85em; font-weight:bold;">自定义API Key (可选):</label>
                <input type="password" id="api-key" placeholder="不填则使用默认Key..." style="margin-bottom:10px;">
                
                <label style="font-size:0.85em; font-weight:bold;">模型版本:</label>
                <input type="text" id="model-name" value="deepseek-reasoner" placeholder="deepseek-reasoner" style="margin-bottom:10px;">
                
                <div style="margin-top:5px;">
                    <input type="checkbox" id="use-mock" onchange="toggleApiInput()"> 
                    <label for="use-mock" style="font-size:0.85em;">离线模拟模式 (无 Key 可玩)</label>
                </div>
            </div>
        </details>
    </div>

    <div id="loading-screen" class="screen">
        <div class="loader-content">
            <div>> 连接 MSF 卫星网络...</div>
            <div id="log-box"></div>
            <div class="loader-spinner"></div>
            <div style="text-align:center; color:#888; font-size:0.8em; margin-top:10px;">任务生成中，请保持信号畅通</div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        
        <div id="tab-event" class="tab-content active">
            <h3>🚨 季度简报</h3>
            <div id="loading-spinner" class="loading-spinner">
                🛰️ 正在从前线获取情报 (DeepSeek推理中)...
            </div>

            <div id="event-area" style="display:none;">
                <span class="event-tag" id="event-tag">EVENT</span>
                <div class="event-text" id="event-desc"></div>
                <div id="choices-container"></div>
            </div>

            <button id="start-event-btn" onclick="fetchDailyEvent()">📡 获取季度情报 (开始事件)</button>
            
            <div id="next-quarter-msg" style="text-align:center; margin-top:20px; color:#888; display:none;">
                本季度事件已处理。请管理人物与基地，准备进入下一季度。
            </div>
            <button id="next-day-btn" onclick="triggerNextQuarter()" style="width:100%; margin-top:15px; background:var(--primary); padding:15px; font-size:1.1rem; display:none; color: white;">📅 进入下一季度</button>
        </div>

        <div id="tab-character" class="tab-content">
            <div class="sub-tab-nav" style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                <button class="nav-item active char-nav-btn" onclick="switchCharSubTab('archive', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">档案</button>
                <button class="nav-item char-nav-btn" onclick="switchCharSubTab('workstation', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">工作站</button>
                <button class="nav-item char-nav-btn" onclick="switchCharSubTab('supply', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">补给站</button>
                <button class="nav-item char-nav-btn" onclick="switchCharSubTab('promo', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">职业</button>
            </div>

            <div id="char-archive" class="char-sub-tab active">
                <div class="resume-card" style="background:var(--panel); border:1px solid var(--border); padding:20px; border-radius:8px; display:flex; gap:20px; align-items: flex-start; margin-bottom:20px;">
                    <div id="char-icon" style="font-size:4rem; background:var(--input-bg); width:100px; height:100px; display:flex; align-items:center; justify-content:center; border-radius:8px; cursor:pointer;" onmousedown="startDevPress()" onmouseup="endDevPress()" onmouseleave="endDevPress()" ontouchstart="startDevPress()" ontouchend="endDevPress()">👩‍⚕️</div>
                    <div style="flex:1;">
                        <h2 id="char-name-display" style="margin:0 0 10px 0; color:var(--gold);">姓名</h2>
                        <div style="font-size:1.1rem; color:var(--text); opacity:0.8;">
                            <span id="char-gender-display">性别</span> · <span id="char-dept-display">科室</span>
                        </div>
                    </div>
                </div>
                <div class="bio-box" id="bio-container" style="min-height:100px; margin-bottom:20px;"></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:15px; border-radius:8px;">
                    <h3 style="margin-top:0; border-bottom:1px solid var(--border); padding-bottom:5px;">📜 履历记录</h3>
                    <div id="career-summary-archive" style="font-size:0.9rem; line-height:1.8; color:#aaa;">
                        <div>累计治疗病人: <span id="summary-cured-archive" style="color:var(--blue)">0</span></div>
                        <div>累计度过季度: <span id="summary-quarters-archive" style="color:var(--gold)">0</span></div>
                        <div>最高职级: <span id="summary-max-rank-archive" style="color:var(--accent)">1</span></div>
                    </div>
                </div>
            </div>

            <div id="char-workstation" class="char-sub-tab" style="display:none;">
                <div style="display:flex; gap:15px; margin-bottom:20px; background:var(--panel); padding:15px; border-radius:8px; border:1px solid var(--border);">
                    <img src="image/work1.png" alt="工作站" style="width:100px; height:100px; border-radius:4px; object-fit:cover; flex-shrink:0;">
                    <div style="flex:1;">
                        <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">个人存款: <span id="val-cash-work" style="color:var(--gold);">$0</span></div>
                        <div class="stat-box" style="margin-bottom:10px; padding:5px; background:none; border:none;">❤️ 健康 <span style="float:right;" id="val-health-work">0</span><div class="bar-bg" style="height:6px;"><div class="bar-fill" id="bar-health-work"></div></div></div>
                        <div class="stat-box" style="padding:5px; background:none; border:none;">⚡ 精力 <span style="float:right;" id="val-energy-work">0</span><div class="bar-bg" style="height:6px;"><div class="bar-fill" id="bar-energy-work"></div></div></div>
                    </div>
                </div>
                
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div style="text-align:center; background:var(--input-bg); padding:10px; border-radius:4px; font-size:0.85rem;">医学<br><strong id="val-med-work">0</strong></div>
                    <div style="text-align:center; background:var(--input-bg); padding:10px; border-radius:4px; font-size:0.85rem;">行政<br><strong id="val-admin-work">0</strong></div>
                    <div style="text-align:center; background:var(--input-bg); padding:10px; border-radius:4px; font-size:0.85rem;">社交<br><strong id="val-soc-work">0</strong></div>
                </div>

                <h4>能力进修 (消耗精力)</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <button class="skill-btn" onclick="trainSkill('med')" style="font-size:0.85rem; padding:10px;">📖 研读医学</button>
                    <button class="skill-btn" onclick="trainSkill('admin')" style="font-size:0.85rem; padding:10px;">📋 处理文书</button>
                    <button class="skill-btn" onclick="trainSkill('soc')" style="font-size:0.85rem; padding:10px;">🗣️ 交流经验</button>
                </div>

                <h4>身心维护 (每季限一次)</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="action-btn" id="btn-running" onclick="doTrainingAction('running')" style="justify-content:center; padding:10px;">🏃 跑步健身 (+5健康)</button>
                    <button class="action-btn" id="btn-sleep" onclick="doTrainingAction('sleep')" style="justify-content:center; padding:10px;">🛌 睡个好觉 (+5精力)</button>
                </div>
            </div>

            <div id="char-supply" class="char-sub-tab" style="display:none;">
                <div style="display:flex; gap:15px; margin-bottom:20px; background:var(--panel); padding:15px; border-radius:8px; border:1px solid var(--border);">
                    <img id="img-supply" src="image/supply1.png" alt="补给站" style="width:100px; height:100px; border-radius:4px; object-fit:cover; flex-shrink:0;">
                    <div style="flex:1;">
                        <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">个人存款: <span id="val-cash-supply" style="color:var(--gold);">$0</span></div>
                        <div class="stat-box" style="margin-bottom:10px; padding:5px; background:none; border:none;">❤️ 健康 <span style="float:right;" id="val-health-supply">0</span><div class="bar-bg" style="height:6px;"><div class="bar-fill" id="bar-health-supply"></div></div></div>
                        <div class="stat-box" style="padding:5px; background:none; border:none;">⚡ 精力 <span style="float:right;" id="val-energy-supply">0</span><div class="bar-bg" style="height:6px;"><div class="bar-fill" id="bar-energy-supply"></div></div></div>
                    </div>
                </div>
                <h3>🛒 补给清单</h3>
                <div id="personal-shop-container" class="item-grid"></div>
            </div>

            <div id="char-promo" class="char-sub-tab" style="display:none;">
                <div class="rank-card">
                    <div class="rank-title" id="val-rank-name">医疗专员</div>
                    <div class="rank-progress">当前职级: Lv.<span id="val-rank-lvl">1</span></div>
                    <div style="font-size:0.9em; margin-bottom:5px;">上级好感度: <span id="val-favor">10</span>/100</div>
                    <div class="bar-bg" style="margin-bottom:10px;"><div class="bar-fill" id="bar-favor" style="background:var(--gold)"></div></div>
                    <div style="font-size:1rem; margin-bottom:5px;">考核连胜: <span id="val-max-streak" style="color:var(--gold); font-weight:bold;">0</span></div>
                    <div style="font-size:1rem; color:#2ecc71; margin-bottom:10px;">季度薪水: <span id="val-salary-promo"></span></div>
                    
                    <div class="rank-actions" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                        <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('network')">🤝 联络感情</button>
                        <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('fund')">💰 请求资金</button>
                        <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('bribe')">🤝 贿赂</button>
                    </div>
                    <button id="btn-promo" style="width:100%; margin-top:10px; background:var(--blue); color:white;" onclick="applyForPromotion()">⬆️ 申请晋升</button>
                    <div id="promo-status" style="font-size:0.8em; color:#888; margin-top:5px;"></div>
                </div>

                <hr style="border:none; border-top:1px solid var(--border); margin:20px 0;">
                
                <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--gold);">
                    📝 执业能力考核
                    <div style="font-size:0.8em; color:#aaa;">当前连胜: <span id="curr-streak">0</span> | 最高连胜: <span id="best-streak">0</span></div>
                </div>
                
                <div id="exam-start-area">
                    <div style="background:var(--panel); padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid var(--border);">
                        <div style="font-weight:bold; margin-bottom:10px; color:var(--gold); border-bottom:1px solid var(--border); padding-bottom:5px;">📊 职级晋升连胜要求</div>
                        <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; text-align:center;">
                            <div><div style="font-size:0.8rem; color:#888;">Lv.2</div><div style="font-weight:bold; font-size:1.2rem;">3</div></div>
                            <div><div style="font-size:0.8rem; color:#888;">Lv.3</div><div style="font-weight:bold; font-size:1.2rem;">5</div></div>
                            <div><div style="font-size:0.8rem; color:#888;">Lv.4</div><div style="font-weight:bold; font-size:1.2rem;">10</div></div>
                            <div><div style="font-size:0.8rem; color:#888;">Lv.5</div><div style="font-weight:bold; font-size:1.2rem;">15</div></div>
                            <div><div style="font-size:0.8rem; color:#888;">Lv.6</div><div style="font-weight:bold; font-size:1.2rem;">20</div></div>
                        </div>
                    </div>
                    <button class="skill-btn" id="btn-start-exam" onclick="startExam()" style="width:100%; padding:15px; font-weight:bold; font-size:1.1rem;">✍️ 开始考试</button>
                </div>

                <div id="exam-ui" style="display:none;" class="exam-box">
                    <div id="exam-q-text" class="exam-q"></div>
                    <div id="exam-options"></div>
                    <div id="confirm-exam-area" style="margin-top:15px; display:none;">
                        <button id="btn-confirm-answer" class="skill-btn" style="width:100%; padding:12px; font-weight:bold; background:var(--green);">✔️ 确认并提交答案</button>
                    </div>
                    <div id="exam-result" style="margin-top:20px; padding:15px; border-radius:6px; display:none;"></div>
                    <button id="exam-quit-btn" style="width:100%; margin-top:15px; display:none; background:var(--border); color:var(--text);" onclick="quitExam()">退出答题</button>
                </div>
            </div>
        </div>

        <div id="tab-base" class="tab-content">
            <div class="sub-tab-nav" style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                <button class="nav-item active" onclick="switchBaseSubTab('mgmt', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">管理</button>
                <button class="nav-item" onclick="switchBaseSubTab('ward', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">病房</button>
                <button class="nav-item" onclick="switchBaseSubTab('procure', this)" style="flex:1; padding:10px; background:none; border:none; color:var(--text); font-size:0.9rem;">采购</button>
            </div>

            <div id="base-mgmt" class="base-sub-tab active">
                <div style="background:var(--panel); border:1px solid var(--border); padding:12px 15px; border-radius:6px; margin-bottom:15px; text-align:center;">
                    <div style="font-size:1.2rem; font-weight:bold; color:var(--gold);">
                        <span id="val-base-lvl">基础医疗点</span> (Lv.<span id="val-base-lvl-num">1</span>)
                    </div>
                </div>
                <img id="img-base" src="image/base1.png" alt="基地俯瞰" style="width:100%; aspect-ratio: 2816/1536; border-radius:8px; object-fit:cover; margin-bottom:15px; border:1px solid var(--border);">
                
                <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--gold);">
                    <div>💰 基地资金: <span id="val-funds" style="font-weight:bold; color:var(--gold); cursor:pointer;" onclick="handleFundsClick()">$10000</span></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">🤒 难民 <span style="float:right; font-weight:bold;" id="val-refugees">0</span></div>
                    <div class="stat-box">😠 紧张 <span style="float:right;" id="val-tension">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-tension"></div></div></div>
                    <div class="stat-box">📦 物资 <span style="float:right;" id="val-supplies">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-supplies"></div></div></div>
                    <div class="stat-box">💧 净水 <span style="float:right;" id="val-water">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-water"></div></div></div>
                </div>

                <h4 style="margin-top:20px;">基地行动 (消耗资源/精力)</h4>
                <button class="action-btn" onclick="doAction('distribute_food')"><span>🥣 分发物资</span><span style="font-size:0.8em; color:#888;">物资-5, 减少紧张度</span></button>
                <button class="action-btn" onclick="doAction('distribute_water')"><span>🚰 提供净水</span><span style="font-size:0.8em; color:#888;">水-5, 减少紧张度</span></button>
                <button class="action-btn" onclick="doAction('transport')"><span>🚙 接收空投物资</span><span style="font-size:0.8em; color:#888;">物资/水+10, 健康-5</span></button>
                <button class="action-btn" onclick="doAction('pacify')"><span>🕊️ 安抚民众</span><span style="font-size:0.8em; color:#888;">紧张-5, 精力-10</span></button>
                <button class="action-btn" onclick="doAction('rescue')"><span>🚑 前线救援</span><span style="font-size:0.8em; color:#888;">健康-10, 难民+10</span></button>
                <button class="action-btn" onclick="doAction('big_spender')"><span>💸 大撒币行动</span><span style="font-size:0.8em; color:#888;">资金-1000, 紧张-108</span></button>
            </div>

            <div id="base-ward" class="base-sub-tab" style="display:none;">
                <img id="img-ward" src="image/ward1.png" alt="病房" style="width:100%; height:150px; border-radius:8px; object-fit:cover; margin-bottom:15px; border:1px solid var(--border);">
                
                <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--blue);">
                    🏥 住院部: <span id="ward-count">0</span> / <span id="ward-cap">20</span>
                    <span style="float:right; font-size:0.8em; color:#aaa;" id="ward-limit-msg">本季收治: 0/3</span>
                </div>
                
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="action-btn" style="flex:1; justify-content:center; background:var(--blue); color:white;" onclick="admitPatient()">➕ 收入院</button>
                    <button class="action-btn" id="btn-rounds" style="flex:1; justify-content:center; background:var(--purple); color:white;" onclick="doRounds()">🩺 查房</button>
                </div>
                
                <div id="patient-list"></div>
            </div>

            <div id="base-procure" class="base-sub-tab" style="display:none;">
                <div style="display:flex; gap:15px; margin-bottom:20px; background:var(--panel); padding:15px; border-radius:8px; border:1px solid var(--border); align-items:flex-start;">
                    <img src="image/place.png" alt="采购" style="width:50%; aspect-ratio: 1; border-radius:4px; object-fit:cover; flex-shrink:0;">
                    <div style="flex:1; display:flex; flex-direction:column;">
                        <div style="font-size:1.1rem; font-weight:bold; margin-bottom:10px;">基地资金: <span id="val-funds-procure" style="color:var(--gold);">$0</span></div>
                        <div class="stat-box" style="margin-bottom:10px; padding:5px; background:none; border:none;">📦 物资 <span style="float:right;" id="val-supplies-procure">0%</span><div class="bar-bg" style="height:6px;"><div class="bar-fill" id="bar-supplies-procure"></div></div></div>
                        <div class="stat-box" style="padding:5px; background:none; border:none;">💧 净水 <span style="float:right;" id="val-water-procure">0%</span><div class="bar-bg" style="height:6px;"><div class="bar-fill" id="bar-water-procure"></div></div></div>
                    </div>
                </div>
                
                <div style="background:var(--panel); padding:15px; border-radius:8px; border:1px solid var(--border); margin-bottom:20px;">
                    <h4 style="margin:0 0 10px 0; color:var(--green); font-size:1rem;">💰 捐赠支持</h4>
                    <div class="slider-container" style="border-left:4px solid var(--green);">
                        <div style="margin-bottom:5px;">🤝 捐赠个人资金 <span id="don-val" class="slider-val">0%</span></div>
                        <input type="range" id="don-slider" min="0" max="100" value="0" oninput="updateSliderUI('don')">
                        <div style="font-size:0.8em; color:#aaa;">个人捐出 <span id="don-give">$0</span> -> 基地获得 <span id="don-get">$0</span></div>
                        <button class="action-btn" style="margin-top:5px; justify-content:center; border-color:var(--green); padding:8px;" onclick="commitDonate()">确认捐赠</button>
                    </div>
                </div>

                <h3>🛒 采购项目</h3>
                <div class="item-grid" style="margin-bottom:20px;">
                    <div class="item-card">
                        <div><div class="item-name">📦 购买物资包</div><div class="item-price">基地资金 $500</div><div class="item-desc">物资 +5</div></div>
                        <button class="buy-btn" onclick="buyBaseItem('supplies')">购买</button>
                    </div>
                    <div class="item-card">
                        <div><div class="item-name">💧 购买净水</div><div class="item-price">基地资金 $500</div><div class="item-desc">净水 +5</div></div>
                        <button class="buy-btn" onclick="buyBaseItem('water')">购买</button>
                    </div>
                </div>
                <div id="base-shop-container" class="item-grid"></div>
            </div>
        </div>
        
    </div>

    <div class="bottom-nav" id="bottom-nav" style="display:none; grid-template-columns: repeat(3, 1fr);">
        <div class="nav-item active" id="nav-character" onclick="switchNav('character', this)">
            <div class="nav-icon">🩺</div>
            <div>人物</div>
        </div>
        <div class="nav-item" id="nav-base" onclick="switchNav('base', this)">
            <div class="nav-icon">⛺</div>
            <div>基地</div>
        </div>
        <div class="nav-item" id="nav-event" onclick="switchNav('event', this)">
            <div class="nav-icon">🚨</div>
            <div>季度事件</div>
        </div>
    </div>

    <div id="end-screen" class="screen" style="text-align:center; padding-top:50px;">
        <h1 id="end-title">游戏结束</h1>
        <p id="end-reason" style="font-size:1.2rem; margin:20px 0; line-height:1.6;"></p>
        
        <button id="gen-story-btn" onclick="generateStory()">📖 生成战地日记 (回顾)</button>
        <div id="story-container">
            <h4 style="margin-top:0; color:var(--accent);">📑 战地日志</h4>
            <div id="story-content">生成中...</div>
        </div>
        
        <div id="continue-game-area" style="display:none; margin-top:20px;">
            <p>您已达成最高成就！您可以选择继续经营，或重新开始。</p>
            <button onclick="continueGame()" style="background:var(--green); color:white;">🔄 继续留任</button>
        </div>

        <button onclick="location.reload()" style="background:var(--border); color:var(--text); padding:15px 40px; margin-top:20px;">🔁 重新开始</button>
    </div>
</div>

<div id="message-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" id="msg-title">提示</div>
        <div class="modal-body">
            <p id="msg-content" class="msg-text"></p>
            <button class="modal-btn" onclick="closeMsgModal()">确 定</button>
        </div>
    </div>
</div>

<div id="confirm-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" id="cfm-title">确认</div>
        <div class="modal-body">
            <p id="cfm-content" class="msg-text"></p>
            <div style="display:flex; gap:1px;">
                <button class="modal-btn secondary" onclick="closeConfirmModal(false)" style="flex:1;">取 消</button>
                <button class="modal-btn" onclick="closeConfirmModal(true)" style="flex:1;">确 定</button>
            </div>
        </div>
    </div>
</div>

<div id="load-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">读取档案</div>
        <div class="modal-body" style="text-align:left;">
            <button class="save-slot-btn" onclick="loadSlot('auto')">
                <div style="font-weight:bold;">📼 自动存档</div>
                <div class="save-meta" id="slot-auto-info">无记录</div>
            </button>
            <button class="save-slot-btn" onclick="loadSlot('manual')">
                <div style="font-weight:bold;">💾 手动存档</div>
                <div class="save-meta" id="slot-manual-info">无记录</div>
            </button>
            <button class="modal-btn secondary" style="width:100%; margin-top:10px;" onclick="$('load-modal').style.display='none'">关 闭</button>
        </div>
    </div>
</div>

<div id="result-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">行动回报</div>
        <div class="modal-body">
            <div id="result-status"></div>
            <p id="result-text"></p>
            <ul id="result-list" class="change-list"></ul>
            <button class="modal-btn" onclick="closeModal()">确 定</button>
        </div>
    </div>
</div>

<div id="investigation-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--danger); color:white;">🚨 财务审查</div>
        <div class="modal-body">
            <p style="margin-bottom:20px; line-height:1.6;">你的账户异常变动引起了总部的怀疑。调查组已经介入，你面临严重的指控。</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button style="background:var(--primary); color:white; border:none; padding:15px; border-radius:4px;" onclick="handleInvestigationAction('resist')">🛑 负隅顽抗</button>
                <button style="background:var(--blue); color:white; border:none; padding:15px; border-radius:4px;" onclick="handleInvestigationAction('surrender')">🏳️ 全数上交</button>
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:10px; text-align:center;">
                顽抗: 试图掩盖 (可能直接定罪)<br>
                上交: 清空存款并降职 (保留工作)
            </div>
        </div>
    </div>
</div>

<div id="embezzle-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--primary); color:white;">🕵️ 挪用公款？</div>
        <div class="modal-body">
            <p style="margin-bottom:20px; line-height:1.6;">你确定要挪用基地资金吗？这将增加你的嫌疑度。</p>
            <div class="slider-container" style="border-left:4px solid var(--primary); margin-bottom:15px;">
                <div style="margin-bottom:5px;">挪用比例 <span id="embezzle-val" class="slider-val">0%</span></div>
                <input type="range" id="embezzle-slider" min="0" max="100" value="0" oninput="updateEmbezzleSlider()">
                <div style="font-size:0.8em; color:#aaa;">挪用基地 <span id="embezzle-steal">$0</span> -> 个人获得 <span id="embezzle-gain">$0</span></div>
                <div style="font-size:0.8em; color:var(--danger); margin-top:5px;">预计嫌疑度增加: <span id="embezzle-suspicion">0-5</span></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="modal-btn secondary" onclick="closeEmbezzleModal()">取 消</button>
                <button class="modal-btn" onclick="confirmEmbezzle()">确认挪用</button>
            </div>
        </div>
    </div>
</div>

<div id="special-event-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--gold); color:#333;" id="special-event-title">⚡ 特殊事件</div>
        <div class="modal-body">
            <p id="special-event-desc" style="margin-bottom:20px; line-height:1.6;"></p>
            <div id="special-event-choices" style="display:flex; flex-direction:column;"></div>
        </div>
    </div>
</div>

<div id="settings-modal" class="custom-modal">
    <div class="modal-content" style="max-width:600px; max-height:90vh; overflow-y:auto;">
        <div class="modal-header" style="background:var(--panel); color:var(--text);">⚙️ 游戏设置</div>
        <div class="modal-body" style="text-align:left;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <button class="modal-btn" onclick="saveGameManual(); closeSettingsModal();">💾 手动存档</button>
                <button class="modal-btn secondary" onclick="closeSettingsModal(); openLoadModal();">📂 读取存档</button>
            </div>
            <button class="modal-btn" id="exit-game-btn-settings" onclick="tryExitGame()" style="width:100%; background:var(--danger); margin-bottom:20px;">🚪 退出游戏</button>
            
            <div style="margin-bottom:20px;">
                <button class="modal-btn" style="width:100%;" onclick="toggleTheme();">☀️/🌙 切换日间/夜间模式</button>
            </div>
            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0;">
            <div id="tutorial-section">
                <h4 style="margin:0 0 15px 0; color:var(--gold);">📖 新手教程</h4>
                <div style="font-size:0.9rem; line-height:1.8; color:#aaa;">
                    <details open style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">🎮 游戏简介</summary>
                        <p>你是一名无国界医生组织（MSF）的医疗志愿者，被派往战乱或灾难地区执行人道主义救援任务。你需要管理营地资源、救治病患、应对突发事件，并在这个过程中提升自己的能力和职级。</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">📊 核心数值</summary>
                        <p><strong>个人属性：</strong></p>
                        <ul style="margin-left:20px;">
                            <li><strong>医学</strong> - 影响治疗病人的效果</li>
                            <li><strong>行政</strong> - 降低基地运营成本</li>
                            <li><strong>社交</strong> - 安抚难民更有效，减少紧张度</li>
                            <li><strong>健康/精力</strong> - 执行行动的消耗</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>营地属性：</strong></p>
                        <ul style="margin-left:20px;">
                            <li><strong>难民</strong> - 营地收容的难民数量</li>
                            <li><strong>物资/净水</strong> - 维持营地运转的资源，每季度自然消耗</li>
                            <li><strong>紧张度</strong> - 过高会导致游戏失败</li>
                            <li><strong>基地资金</strong> - 用于运营和扩建基地</li>
                        </ul>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">🏥 病房系统</summary>
                        <p>你可以收治病人并进行治疗。每位病人有：</p>
                        <ul style="margin-left:20px;">
                            <li><strong>危急度</strong> - 分为轻症/中症/重症</li>
                            <li><strong>生命指征</strong> - 每季度自然衰减，降至0则死亡</li>
                            <li><strong>诊疗进度</strong> - 达到100%可治愈出院</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>操作：</strong>治疗(提升进度和生命指征)、抢救(生命指征≤30时可用)、查房(消耗物资/健康)、出院</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">📈 晋升系统</summary>
                        <p>通过参加考核获得连胜来晋升职级：</p>
                        <ul style="margin-left:20px;">
                            <li>Lv.2 需要连胜 3 题</li>
                            <li>Lv.3 需要连胜 5 题</li>
                            <li>Lv.4 需要连胜 10 题</li>
                            <li>Lv.5 需要连胜 15 题</li>
                            <li>Lv.6 需要连胜 20 题</li>
                        </ul>
                        <p style="margin-top:10px;">晋升需消耗<strong>40点好感度</strong>，符合连胜要求即可随时申请。</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">⚠️ 游戏结束条件</summary>
                        <p><strong>失败条件：</strong></p>
                        <ul style="margin-left:20px;">
                            <li>营地紧张度达到100%</li>
                            <li>基地资金耗尽</li>
                            <li>个人存款为负且无法维持</li>
                            <li>嫌疑度过高被调查定罪</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>胜利条件：</strong>晋升至最高职级(Lv.6)并稳定维持3个季度以上。</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">💡 小贴士</summary>
                        <ul style="margin-left:20px;">
                            <li>物资和净水每季度会自然消耗，记得及时补充</li>
                            <li>与上级保持良好关系，好感度是晋升的关键</li>
                            <li>挪用公款会增加嫌疑度，风险自负</li>
                            <li>重症病人生命指征衰减快，优先处理</li>
                            <li>健康和精力每季度会自动恢复10点</li>
                        </ul>
                    </details>
                </div>
            </div>
            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0;">
            <button class="modal-btn" style="width:100%;" onclick="closeSettingsModal()">关 闭</button>
        </div>
    </div>
</div>

<div id="tutorial-modal" class="custom-modal">
    <div class="modal-content" style="max-width:600px; max-height:90vh; overflow-y:auto;">
        <div class="modal-header" style="background:var(--gold); color:#333;">📖 新手教程</div>
        <div class="modal-body" style="text-align:left;">
            <div style="font-size:0.9rem; line-height:1.8; color:#aaa;">
                <details open style="margin-bottom:15px;">
                    <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">🎮 游戏简介</summary>
                    <p>你是一名无国界医生组织（MSF）的医疗志愿者，被派往战乱或灾难地区执行人道主义救援任务。你需要管理营地资源、救治病患、应对突发事件，并在这个过程中提升自己的能力和职级。</p>
                </details>
                
                <details style="margin-bottom:15px;">
                    <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">📊 核心数值</summary>
                    <p><strong>个人属性：</strong></p>
                    <ul style="margin-left:20px;">
                        <li><strong>医学</strong> - 影响治疗病人的效果</li>
                        <li><strong>行政</strong> - 降低基地运营成本</li>
                        <li><strong>社交</strong> - 安抚难民更有效，减少紧张度</li>
                        <li><strong>健康/精力</strong> - 执行行动的消耗</li>
                    </ul>
                    <p style="margin-top:10px;"><strong>营地属性：</strong></p>
                    <ul style="margin-left:20px;">
                        <li><strong>难民</strong> - 营地收容的难民数量</li>
                        <li><strong>物资/净水</strong> - 维持营地运转的资源，每季度自然消耗</li>
                        <li><strong>紧张度</strong> - 过高会导致游戏失败</li>
                        <li><strong>基地资金</strong> - 用于运营和扩建基地</li>
                    </ul>
                </details>
                
                <details style="margin-bottom:15px;">
                    <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">🏥 病房系统</summary>
                    <p>你可以收治病人并进行治疗。每位病人有：</p>
                    <ul style="margin-left:20px;">
                        <li><strong>危急度</strong> - 分为轻症/中症/重症</li>
                        <li><strong>生命指征</strong> - 每季度自然衰减，降至0则死亡</li>
                        <li><strong>诊疗进度</strong> - 达到100%可治愈出院</li>
                    </ul>
                    <p style="margin-top:10px;"><strong>操作：</strong>治疗(提升进度和生命指征)、抢救(生命指征≤30时可用)、查房(消耗物资/健康)、出院</p>
                </details>
                
                <details style="margin-bottom:15px;">
                    <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">📈 晋升系统</summary>
                    <p>通过参加考核获得连胜来晋升职级：</p>
                    <ul style="margin-left:20px;">
                        <li>Lv.2 需要连胜 3 题</li>
                        <li>Lv.3 需要连胜 5 题</li>
                        <li>Lv.4 需要连胜 10 题</li>
                        <li>Lv.5 需要连胜 15 题</li>
                        <li>Lv.6 需要连胜 20 题</li>
                    </ul>
                    <p style="margin-top:10px;">晋升需消耗<strong>40点好感度</strong>，符合连胜要求即可随时申请。</p>
                </details>
                
                <details style="margin-bottom:15px;">
                    <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">⚠️ 游戏结束条件</summary>
                    <p><strong>失败条件：</strong></p>
                    <ul style="margin-left:20px;">
                        <li>营地紧张度达到100%</li>
                        <li>基地资金耗尽</li>
                        <li>个人存款为负且无法维持</li>
                        <li>嫌疑度过高被调查定罪</li>
                    </ul>
                    <p style="margin-top:10px;"><strong>胜利条件：</strong>晋升至最高职级(Lv.6)并稳定维持3个季度以上。</p>
                </details>
                
                <details style="margin-bottom:15px;">
                    <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">💡 小贴士</summary>
                    <ul style="margin-left:20px;">
                        <li>物资和净水每季度会自然消耗，记得及时补充</li>
                        <li>与上级保持良好关系，好感度是晋升的关键</li>
                        <li>挪用公款会增加嫌疑度，风险自负</li>
                        <li>重症病人生命指征衰减快，优先处理</li>
                        <li>健康和精力每季度会自动恢复10点</li>
                    </ul>
                </details>
            </div>
            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0;">
            <button class="modal-btn" style="width:100%;" onclick="closeTutorialModal()">开始游戏</button>
        </div>
    </div>
</div>

<div id="achievements-modal" class="custom-modal">
    <div class="modal-content" style="max-width:600px; max-height:90vh; overflow-y:auto;">
        <div class="modal-header" style="background:var(--panel); color:var(--text);">🏆 成就系统</div>
        <div class="modal-body">
            <div id="achievement-progress-container" style="margin-bottom:20px; padding:15px; background:var(--panel); border-radius:8px;">
                <h4 style="margin:0 0 10px 0;">总达成率</h4>
                <div class="bar-bg" style="height:12px;"><div id="total-achieve-bar" class="bar-fill" style="width:0%; background:var(--gold);"></div></div>
                <div id="total-achieve-text" style="text-align:right; font-size:0.9rem; margin-top:5px; font-weight:bold; color:var(--gold);">0%</div>
            </div>
            <ul id="achievement-list" class="achieve-list"></ul>
            
            <div style="margin-top:30px; border-top: 1px solid var(--border); padding-top:20px;">
                <h3>📜 履历记录</h3>
                <div id="career-summary" style="font-size:0.9rem; line-height:1.6; color:#aaa; background:var(--panel); padding:15px; border-radius:8px; margin-bottom:20px;">
                    <div>累计治疗病人: <span id="summary-cured" style="color:var(--blue)">0</span></div>
                    <div>累计度过季度: <span id="summary-quarters" style="color:var(--gold)">0</span></div>
                    <div>最高职级: <span id="summary-max-rank" style="color:var(--accent)">1</span></div>
                </div>
            </div>
            <button class="modal-btn" style="width:100%;" onclick="$('achievements-modal').style.display='none'">关 闭</button>
        </div>
    </div>
</div>

<div id="quarterly-report-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--blue); color:white;">📊 季度经营报告</div>
        <div class="modal-body">
            <p id="report-period" style="font-weight:bold; margin-bottom:15px;"></p>
            <ul id="report-list" class="change-list"></ul>
            <button class="modal-btn" onclick="$('quarterly-report-modal').style.display='none'">确 定</button>
        </div>
    </div>
</div>

<div id="dev-modal" class="custom-modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: #333; color: #0f0; font-family: monospace;">> DEVELOPER_MODE</div>
        <div class="modal-body" style="text-align: left; font-family: monospace; font-size: 0.9rem;">
            <div style="margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
                <h4 style="margin: 0 0 10px 0; color: #0f0;">👤 人物属性</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>医学: <input type="number" id="dev-med" onchange="devUpdate('player', 'med', this.value)"></div>
                    <div>行政: <input type="number" id="dev-admin" onchange="devUpdate('player', 'admin', this.value)"></div>
                    <div>社交: <input type="number" id="dev-soc" onchange="devUpdate('player', 'soc', this.value)"></div>
                    <div>好感: <input type="number" id="dev-favor" onchange="devUpdate('player', 'favor', this.value)"></div>
                    <div>存款: <input type="number" id="dev-cash" onchange="devUpdate('player', 'cash', this.value)"></div>
                    <div>健康: <input type="number" id="dev-health" onchange="devUpdate('player', 'health', this.value)"></div>
                    <div>精力: <input type="number" id="dev-energy" onchange="devUpdate('player', 'energy', this.value)"></div>
                    <div>职级(0-5): <input type="number" id="dev-rank" onchange="devUpdate('player', 'rankIndex', this.value)"></div>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #0f0;">⛺ 基地属性</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>资金: <input type="number" id="dev-funds" onchange="devUpdate('camp', 'funds', this.value)"></div>
                    <div>难民: <input type="number" id="dev-refugees" onchange="devUpdate('camp', 'refugees', this.value)"></div>
                    <div>紧张: <input type="number" id="dev-tension" onchange="devUpdate('camp', 'tension', this.value)"></div>
                    <div>物资: <input type="number" id="dev-supplies" onchange="devUpdate('camp', 'supplies', this.value)"></div>
                    <div>净水: <input type="number" id="dev-water" onchange="devUpdate('camp', 'water', this.value)"></div>
                    <div>等级(0-3): <input type="number" id="dev-base-lv" onchange="devUpdate('camp', 'baseLevelIdx', this.value)"></div>
                    <div>病房(0-3): <input type="number" id="dev-ward-lv" onchange="devUpdate('camp', 'wardLevel', this.value)"></div>
                </div>
            </div>
            <button class="modal-btn" style="background: #333; color: #0f0; border: 1px solid #0f0;" onclick="$('dev-modal').style.display='none'">> EXIT_DEBUG</button>
        </div>
    </div>
</div>

<script>
    // --- 开发者配置 ---
    const DEVELOPER_API_KEY = "sk-87bf24fe26594fc1a85582e09cfad8c0"; // 开发者可在此填入默认KEY

    // --- 全局工具与数据定义 ---
    const $ = id => document.getElementById(id);
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    const SAVE_KEY_AUTO = 'msf_commander_save_auto';
    const SAVE_KEY_MANUAL = 'msf_commander_save_manual';

    // 数据列表
    const CHAR_NAMES = ["Alex", "Dr. Sarah", "Jean", "Dr. Ahmed", "Maria", "David", "Liang", "Dr. Chen"];
    const CHAR_DEPTS = ["全科", "内科", "外科", "传染科", "儿科", "妇产科", "急诊科"];
    const CHAR_LOCATIONS = [
        "南苏丹 - 本提乌", "巴西 - 阿维斯塔", "阿富汗 - 昆都士", "也门 - 摩卡", 
        "海地 - 太阳城", "刚果金 - 北基伍", "中非共和国 - 班吉", "叙利亚 - 伊德利卜",
        "埃塞俄比亚 - 提格雷", "缅甸 - 若开邦", "乌克兰 - 顿巴斯", "马里 - 加奥"
    ];
    
    const LOCATION_DESCRIPTIONS = {
        "南苏丹 - 本提乌": "战火纷飞的难民营地，霍乱与营养不良肆虐，数万流离失所者在泥泞中等待救援，医疗资源极度匮乏。",
        "巴西 - 阿维斯塔": "亚马逊雨林深处的偏远社区，原住民部落缺乏基本医疗，热带疾病频发，交通不便加剧了救治难度。",
        "阿富汗 - 昆都士": "持续冲突的前线城市，战伤患者络绎不绝，医院多次遭受袭击，在废墟中坚守是常态。",
        "也门 - 摩卡": "被封锁的港口城市，饥荒与传染病双重夹击，药品补给时断时续，平民承受着战争最残酷的代价。",
        "海地 - 太阳城": "地震后重建缓慢的贫民区，帮派暴力与政治动荡并存，医疗队在枪声中救治伤患。",
        "刚果金 - 北基伍": "埃博拉疫情的重灾区，武装冲突使防疫工作举步维艰，恐惧与谣言比病毒传播得更快。",
        "中非共和国 - 班吉": "内战撕裂的首都郊区，宗教冲突导致大规模流离失所，医疗设施在交火中艰难运转。",
        "叙利亚 - 伊德利卜": "最后的反对派据点，空袭频繁，地下医院里医生们与死神赛跑，每一条生命都来之不易。",
        "埃塞俄比亚 - 提格雷": "被封锁的战区，人道主义危机深重，饥饿的阴影笼罩着数百万人，外界援助难以进入。",
        "缅甸 - 若开邦": "罗兴亚难民危机的中心，种族清洗的创伤犹在，难民营中绝望与希望交织。",
        "乌克兰 - 顿巴斯": "欧洲最激烈的冲突前线，炮火下的城镇满目疮痍，老人与儿童在地下室里等待和平。",
        "马里 - 加奥": "撒哈拉边缘的沙漠城市，极端组织威胁与干旱并存，游牧民族的生存岌岌可危。"
    };
    
    const RANKS = [
        "医疗专员 (Level 1)",
        "临床专家 (Level 2)",
        "医疗主管 (Level 3)",
        "项目统筹 (Level 4)",
        "副总筹 (Level 5)",
        "区域总筹 (Level 6)"
    ];
    const RANK_SALARIES = [200, 500, 800, 1000, 1500, 2000];
    const RANK_REQ_STREAK = [0, 3, 5, 10, 15, 20]; // 对应 1->2, 2->3 等

    const BASE_LEVELS = [
        { name: "基础医疗点", cap: 150, cost: 0 },
        { name: "移动医疗队", cap: 200, cost: 10000 },
        { name: "野战医院", cap: 250, cost: 20000 },
        { name: "专科中心", cap: 500, cost: 50000 }
    ];

    const WARD_CAPS = [5, 7, 10, 12];

    const SHOP_ITEMS = [
        { id: 'snack', name: '🍫 零食', price: 50, desc: '增加 3点 精力', type: 'cons', effect: { energy: 3 } },
        { id: 'medkit', name: '🩹 急救包', price: 50, desc: '增加 3点 健康', type: 'cons', effect: { health: 3 } },
        { id: 'coffee', name: '☕ 现磨咖啡', price: 100, desc: '增加 8点 精力', type: 'cons', effect: { energy: 8 } },    
        { id: 'epi', name: '💉 肾上腺素针', price: 100, desc: '增加 8点 健康', type: 'cons', effect: { health: 8 } },
        { id: 'suit', name: '👔 正装', price: 400, desc: '永久增加 5点 社交', type: 'perm', effect: { soc: 5 } },
		{ id: 'book', name: '📚 管理学培训班', price: 600, desc: '永久增加 5点 行政', type: 'perm', effect: { admin: 5 } },
		{ id: 'scope', name: '🩺 特级听诊器', price: 800, desc: '永久增加 5点 医学', type: 'perm', effect: { med: 5 } },
		{ id: 'coat', name: '👩‍⚕️防刺白大褂', price: 1200, desc: '永久增加 10点 医学', type: 'perm', effect: { med: 10 } },
        { id: 'laptop', name: '💻 笔记本', price: 1500, desc: '永久增加 10点 行政', type: 'perm', effect: { admin: 10 } },
        { id: 'phone', name: '📡 卫星电话', price: 1800, desc: '永久增加 10点 社交', type: 'perm', effect: { soc: 10 } },
        { id: 'device', name: '🔬 实验设备', price: 5000, desc: '永久增加 15点 医学', type: 'perm', effect: { med: 15 } },
        { id: 'suv', name: '🚙 越野车', price: 10000, desc: '搬运物资不再消耗健康', type: 'perm', effect: {} },
        // 基地升级
        { id: 'base_lv2', name: '🏗️ 扩建:移动医疗队', price: 10000, desc: '难民上限200', type: 'base', level: 1 },
        { id: 'base_lv3', name: '🏥 扩建:野战医院', price: 20000, desc: '难民上限250', type: 'base', level: 2 },
        { id: 'base_lv4', name: '🏙️ 扩建:专科中心', price: 50000, desc: '难民上限500', type: 'base', level: 3 },
        { id: 'ward_upgrade', name: '🏥 病房升级', price: 5000, desc: '扩大床位容量', type: 'base_ward' }
    ];

    const CONFIG = { ranks: RANKS };
    
    // 姓名库
    const LAST_NAMES = ["赵", "钱", "孙", "李", "周", "吴", "郑", "王", "陈", "齐", "张", "许", "曹", "朱", "刘", "罗", "关", "何", "钟", "池", "林", "霍", "谢", "解", "田", "孟", "孔", "秦", "魏", "任", "杨", "黄", "苏", "冯", "楚", "隗", "贺", "仇", "戴", "龚", "薛", "史", "贾"];
    const FIRST_NAMES = ["平生", "无卯","丘壑", "平", "风", "泊", "磊", "涛", "浩宇", "梓涵", "伟", "芳菲", "静", "晨欣", "子豪", "志明", "一鸣", "于飞", "家鑫", "湛", "泽", "宇辰", "怀梦", "一诺", "雨霖", "睦", "祥", "乐天", "素世", "幽璃", "浩然", "含英", "墨瀚", "宝宝", "秋染", "舜尧", "君玉", "由之", "信礼", "晓光", "松鹤", "澡雪", "沐秋", "春夏", "峰博", "子辰", "仰止", "明阳", "铭华", "致知", "行久", "爱音", "立希", "海洋", "雪", "嘉明"];
    
    const ACHIEVEMENTS_DEF = [
        { id: 'cure10', name: '妙手回春', desc: '成功治疗10人', target: 10, key: 'cured' },
        { id: 'cure100', name: '杏林圣手', desc: '成功治疗100人', target: 100, key: 'cured' },
        { id: 'cure500', name: '悬壶济世', desc: '成功治疗500人', target: 500, key: 'cured' },
        { id: 'year1', name: '又一春', desc: '度过第1年', target: 4, key: 'totalQuarters' },
        { id: 'year10', name: '中流砥柱', desc: '度过10年', target: 40, key: 'totalQuarters' },
        { id: 'maxRank', name: '度己救人', desc: '职级升到最高', target: 5, key: 'rankIndex' },
        { id: 'maxBase', name: '大庇天下', desc: '升级基地到最高级', target: 3, key: 'baseLevelIdx' },
        { id: 'ward12', name: '人满为患', desc: '病房同时有12人', target: 12, key: 'currentPatients' },
        { id: 'streak5', name: '执业医师', desc: '连胜5题', target: 5, key: 'maxExamStreak' },
        { id: 'streak50', name: '超记忆体', desc: '连胜50题', target: 50, key: 'maxExamStreak' },
        { id: 'death1', name: '夜骐', desc: '见证1位病人的死亡', target: 1, key: 'deaths' },
        { id: 'discharge15', name: '总是安慰', desc: '送走15位病人（治愈或出院）', target: 15, key: 'discharged' },
        { id: 'stealSmall', name: '窃钩者诛', desc: '挪用1万美金', target: 10000, key: 'totalEmbezzled' },
        { id: 'stealBig', name: '窃国者侯', desc: '挪用100万美金', target: 1000000, key: 'totalEmbezzled' },
        { id: 'surrender', name: '高抬贵手', desc: '被调查后上交存款', target: 1, key: 'hasSurrendered' },
        { id: 'honest', name: '至公无私', desc: '胜利时未挪用过公款', target: 1, key: 'isHonest' },
        { id: 'inheritor', name: '传承者', desc: '完成"岁月缝合的伤口"特殊事件', target: 1, key: 'hasYearsStitchedWound' },
        { id: 'truth_keeper', name: '真理守望者', desc: '完成"第52号观察站"特殊事件', target: 1, key: 'hasObservationStation52' }
    ];
    
    // 特殊事件定义
    const SPECIAL_EVENTS = [
        {
            id: 'force_majeure',
            name: '不可抗力',
            desc: '受当地政府的强制命令，我们不得不撤离本次任务地点。',
            chance: 0.005, // 0.5%
            condition: () => true, // 无条件
            effect: 'transfer' // 调任
        },
        {
            id: 'rapid_promotion',
            name: '青云直上',
            desc: '上级对你的能力十分满意，破例擢升1级。',
            chance: 0.01, // 1%
            condition: () => player.favor >= 70 && player.rankIndex < 5, // 好感≥70且未到最高
            effect: 'promote' // 晋升1级
        },
        {
            id: 'homesickness',
            name: '羁泊欲穷年',
            desc: '你怀着济世的理想来到这里，本以为能把过去抛在身后，但在这个夜晚，乡愁突然击垮了你。',
            chance: 0.01, // 1%
            condition: () => player.stats.currentLocQuarters >= 20 && player.rankIndex < 3, // 5年(20季度)且职级<4
            effect: 'homesick' // 特殊选择
        },
        {
            id: 'international_visit',
            name: '国际慰问',
            desc: '一支来自欧洲的医疗志愿者代表团不远万里来到基地，他们带来了国际社会的关怀与支持。代表团成员们与医护人员亲切交流，分享医疗经验，还带来了急需的医疗物资和慰问品。他们的到来让整个基地都感受到了来自世界的温暖。',
            chance: 0.05, // 5%
            condition: () => true,
            effect: 'international_visit' // 国际慰问
        },
        {
            id: 'winter_festival',
            name: '联欢晚会',
            desc: '新年就要到了，基地里面难民和医护想要一同举行一场联欢晚会，你的选择：',
            chance: 0.10, // 10%
            condition: () => (currentQuarter - 1) % 4 === 3, // 冬天（第4季度）
            effect: 'winter_festival' // 联欢晚会
        },
        {
            id: 'special_patient',
            name: '特殊病人',
            desc: '一位衣衫褴褛、神色焦急的家属在凌晨敲开了基地的大门，哀求你将担架上奄奄一息的病人收下，他保证日后一定会回报你们。你决定：',
            chance: 0.05, // 5%
            condition: () => patients.length < WARD_CAPS[camp.wardLevel], // 病房未满
            effect: 'special_patient' // 特殊病人
        },
        {
            id: 'patient_reward',
            name: '救人的回报',
            desc: '几个月前你收治的那位特殊病人的家属兑现了承诺，他们带着感激和物资回到了基地。',
            chance: 1.0, // 100%（由特殊病人触发）
            condition: () => false, // 不由随机触发，由延迟事件触发
            effect: 'patient_reward' // 救人的回报
        },
        {
            id: 'visitors_from_afar',
            name: '有朋自远方来',
            desc: '基地来了一群语言不通的客人，你选择？',
            chance: 0.05, // 5%
            condition: () => true,
            effect: 'visitors_from_afar' // 有朋自远方来
        },
        {
            id: 'veteran_volunteer',
            name: '老兵志愿者加入',
            desc: '一位经验丰富的退休医生自愿加入你的团队。',
            chance: 0.03, // 3%
            condition: () => !player.stats.hasVeteranVolunteer,
            effect: 'veteran_volunteer'
        },
        {
            id: 'illegal_drug_scandal',
            name: '非法药物实验丑闻',
            desc: '营地被谣传在进行非法实验，总部要求你立即自查清白。',
            chance: 0.04, // 4%
            condition: () => true,
            effect: 'illegal_drug_scandal'
        },
        {
            id: 'international_journalists',
            name: '国际记者团到访',
            desc: '一群国际记者希望采访营地。你的言行将影响外界对项目的看法。',
            chance: 0.05, // 5%
            condition: () => true,
            effect: 'international_journalists'
        },
        {
            id: 'candlelight_mass',
            name: '烛火下的弥撒',
            desc: '停电的深夜，难民们在营地角落点起残烛。那一刻，苦难被歌声暂时抚平。',
            chance: 0.06, // 6%
            condition: () => camp.tension > 40,
            effect: 'candlelight_mass'
        },
        {
            id: 'yesterdays_phantom',
            name: '昨日的幻影',
            desc: '你在处理旧公文时发现了一张前任医生的照片，背面的文字记录了他未竟的理想。',
            chance: 0.03, // 3%
            condition: () => player.admin > 50 && !player.stats.hasYesterdaysPhantom,
            effect: 'yesterdays_phantom'
        },
        {
            id: 'crossing_redemption',
            name: '越线的救赎',
            desc: '一名受伤的敌方士兵被秘密弃置在营地门口。救他会招来报复，不救则背叛誓言。',
            chance: 0.04, // 4%
            condition: () => player.med > 70,
            effect: 'crossing_redemption'
        },
        {
            id: 'forgotten_orphan',
            name: '被遗忘的孤儿',
            desc: '战火熄灭后的废墟里，你带回了一个紧紧抱着手术剪的孩子，他拒绝和任何人说话。',
            chance: 0.05, // 5%
            condition: () => camp.refugees < BASE_LEVELS[camp.baseLevelIdx].cap,
            effect: 'forgotten_orphan'
        },
        {
            id: 'bloody_medal',
            name: '染血的勋章',
            desc: '本地官员试图授予你一枚"荣誉勋章"以换取你在医疗报告上的缄默。',
            chance: 0.04, // 4%
            condition: () => player.suspicion < 20,
            effect: 'bloody_medal'
        },
        {
            id: 'monsoon_gift',
            name: '季候风的馈赠',
            desc: '雨季超乎预期地带来了丰沛降水，干涸的井眼重新涌动，泥土气息在空气中弥漫。',
            chance: 0.05, // 5%
            condition: () => camp.water < 20,
            effect: 'monsoon_gift'
        },
        {
            id: 'silent_farewell',
            name: '沉默的告别',
            desc: '一位你长期照料的老病人在清晨悄然离世，他留下了一串亲手编织的草编幸运结。',
            chance: 0.03, // 3%
            condition: () => player.achievements.cure100 && !player.stats.hasSilentFarewell,
            effect: 'silent_farewell'
        },
        {
            id: 'last_cigarette',
            name: '最后的一支烟',
            desc: '在资源耗尽的边缘，你与副手在月光下分享最后一支烟，谈论着如果和平降临后的打算。',
            chance: 0.04, // 4%
            condition: () => camp.funds < 5000,
            effect: 'last_cigarette'
        },
        {
            id: 'wire_wedding',
            name: '铁丝网外的婚礼',
            desc: '在那道分割生死的生锈铁丝网两侧，一对新人交换了用绷带缠成的戒指。在MSF营地，生命力总是能从瓦砾中开出花来。',
            chance: 0.05, // 5%
            condition: () => camp.tension < 30,
            effect: 'wire_wedding'
        },
        {
            id: 'thousand_heartbeat',
            name: '第1000次心跳',
            desc: '这是本季度在这个简陋产房里诞生的第1000名婴儿。在硝烟散尽的清晨，啼哭声成了这片荒原上唯一的希望频率。',
            chance: 0.04, // 4%
            condition: () => admittedCount > 0,
            effect: 'thousand_heartbeat'
        },
        {
            id: 'ruins_echo',
            name: '废墟上的回响',
            desc: '手术室外的走廊里，一位母亲紧握着干枯的手，仿佛只要不松开，时间就能倒流。在这座被上帝遗忘的城市，空气中满是尘土与祈祷的味道。',
            chance: 0.05, // 5%
            condition: () => camp.tension > 50,
            effect: 'ruins_echo'
        },
        {
            id: 'buried_truth',
            name: '被掩埋的真相',
            desc: '一份被烧毁一半的实验室记录显示，当地水源污染并非天灾。真相像一枚哑弹，埋藏在权力的深层结构里，等待着敢于挖掘它的人。',
            chance: 0.04, // 4%
            condition: () => true,
            effect: 'buried_truth'
        },
        {
            id: 'horizon_dust',
            name: '地平线的尘烟',
            desc: '数千名难民正穿越红树林沼泽。他们没有国籍，没有护照，只有脚下那双磨平的凉鞋和对那个"红色标志"的盲目信任。',
            chance: 0.05, // 5%
            condition: () => camp.refugees < BASE_LEVELS[camp.baseLevelIdx].cap * 0.5,
            effect: 'horizon_dust'
        },
        {
            id: 'deadly_silence',
            name: '致命的"静默期"',
            desc: '当局宣布停火六小时，以运送必要的儿童疫苗。然而，这种静默比炮火更令人不安，没人知道狙击手的准星此刻正对着谁。',
            chance: 0.05, // 5%
            condition: () => dangerLevel > 15,
            effect: 'deadly_silence'
        },
        {
            id: 'years_stitched_wound',
            name: '岁月缝合的伤口',
            desc: '十年过去了。当年那个在你怀里死里逃生的少年今穿着白大褂回到了这里。生命在灰烬中完成了最壮丽的循环。',
            chance: 0.03, // 3%
            condition: () => (player.stats.totalQuarters || 0) > 24 && !player.stats.hasYearsStitchedWound,
            effect: 'years_stitched_wound'
        },
        {
            id: 'silent_game',
            name: '无声的博弈',
            desc: '谈判桌上的香烟已经燃尽，双方指挥官在地图上划出的"医疗安全区"，在现实中不过是几层摇摇欲坠的沙袋。',
            chance: 0.04, // 4%
            condition: () => dangerLevel > 15,
            effect: 'silent_game'
        },
        {
            id: 'monsoon_disease',
            name: '季风带来的疫症',
            desc: '随着暖湿气流越过山脊，那种熟悉的、带着泥土腥气的热症在难民营中悄然蔓延。这是一场自然与医学的原始竞赛。',
            chance: 0.05, // 5%
            condition: () => {
                const seasonInfo = getSeasonInfo();
                return seasonInfo.season === '春';
            },
            effect: 'monsoon_disease'
        },
        {
            id: 'bed7_sketch',
            name: '第7号床位的素描',
            desc: '那个失去双腿的男孩在病床边画了一架纸飞机。他说，如果飞得够高，就能看到没有铁丝网遮挡的日落。',
            chance: 0.04, // 4%
            condition: () => {
                // 本季治愈人数 > 0，检查本季度是否有治愈的病人
                return (player.stats.quarterlyCured || 0) > 0 || patients.some(p => p.prog >= 100 && !p.isDead);
            },
            effect: 'bed7_sketch'
        },
        {
            id: 'thousand_one_story',
            name: '第一千零一个故事',
            desc: '他坐在诊室门槛上，讲述着家乡那棵老橄榄树。每个难民都是一部活着的史诗，而我们只是在为这些史诗续命。',
            chance: 0.05, // 5%
            condition: () => player.soc > 50,
            effect: 'thousand_one_story'
        },
        {
            id: 'monsoon_judgment',
            name: '季候风的判决',
            desc: '暴雨将唯一的撤离通道变成了泥沼。这种来自大自然的绝对禁锢，让所有昂贵的越野车都成了困在泥淖里的废铁。',
            chance: 0.04, // 4%
            condition: () => {
                const seasonInfo = getSeasonInfo();
                return seasonInfo.season === '秋';
            },
            effect: 'monsoon_judgment'
        },
        {
            id: 'underground_clinic',
            name: '地下诊所的暗流',
            desc: '在营地几公里外的地窖里，非法行医者正在兜售过期的生理盐水。贫穷与恐惧是滋生这种阴影最肥沃的土壤。',
            chance: 0.05, // 5%
            condition: () => camp.funds < 5000,
            effect: 'underground_clinic'
        },
        {
            id: 'silent_delivery',
            name: '寂静的产房',
            desc: '没有啼哭，只有助产士急促的喘息和母亲空洞的眼神。由于营养匮乏，这个月出生的第三个婴儿没能撑过第一个黎明。',
            chance: 0.04, // 4%
            condition: () => camp.refugees > 200,
            effect: 'silent_delivery'
        },
        {
            id: 'vanished_bloodbank',
            name: '消失的血库',
            desc: '由于冷链系统在高温下瘫痪，整整三个季度的库存血浆化为了无用的暗红色液体。在战区，电力有时比血液更珍贵。',
            chance: 0.05, // 5%
            condition: () => {
                const seasonInfo = getSeasonInfo();
                return seasonInfo.season === '夏' && camp.water < 30;
            },
            effect: 'vanished_bloodbank'
        },
        {
            id: 'betrayed_coordinates',
            name: '被出卖的坐标',
            desc: '卫星定位显示营地处于安全区，但呼啸而来的集束炸弹证明，在这场多方角力的棋局中，人道主义坐标是可以被交易的。',
            chance: 0.04, // 4%
            condition: () => player.suspicion > 20,
            effect: 'betrayed_coordinates'
        },
        {
            id: 'ashes_peace',
            name: '灰烬中的和平协议',
            desc: '和平协议签署的消息传来时，营地正忙着处理最后一批烧伤员。纸面上的墨迹尚未干透，地平线上的硝烟却已开始散去。',
            chance: 0.03, // 3%
            condition: () => (player.stats.totalQuarters || 0) > 11,
            effect: 'ashes_peace'
        },
        {
            id: 'observation_station_52',
            name: '第52号观察站',
            desc: '你守着那台锈迹斑斑的显微镜，在显微镜下寻找疟原虫的踪迹。你常说，镜片里的微观世界，比外面的炮火更逻辑清晰。',
            chance: 0.04, // 4%
            condition: () => player.med > 70 && !player.stats.hasObservationStation52,
            effect: 'observation_station_52'
        },
        {
            id: 'wire_market',
            name: '铁丝网下的市集',
            desc: '在这里，半块发霉的黑面包能换到一个损坏的听诊器。当文明秩序坍塌，人类最原始的物物交换成了营地里唯一的商业脉搏。',
            chance: 0.05, // 5%
            condition: () => camp.funds < 3000,
            effect: 'wire_market'
        },
        {
            id: 'desert_mirage',
            name: '沙漠里的"海市蜃楼"',
            desc: '远处出现了一支驼队，他们带着传说中的抗生素而来。但当医生走近时，只看到漫天黄沙和一张印着虚假防伪标的旧报纸。',
            chance: 0.04, // 4%
            condition: () => camp.water < 30,
            effect: 'desert_mirage'
        },
        {
            id: 'borderless_funeral',
            name: '无国界的葬礼',
            desc: '来自三个国家的医生，为一个素不相识的当地孩子挖掘了坟墓。泥土的颜色在全世界都是一样的，无论你为何而战。',
            chance: 0.05, // 5%
            condition: () => true,
            effect: 'borderless_funeral'
        },
        {
            id: 'delayed_olive_branch',
            name: '被延迟的"橄榄枝"',
            desc: '停火协议的电文在传输中丢失了三个小时。这三个小时，足以让原本可以被缝合的生命，在战壕里流干最后一滴血。',
            chance: 0.04, // 4%
            condition: () => dangerLevel > 15,
            effect: 'delayed_olive_branch'
        },
        {
            id: 'dawn_silence',
            name: '这里的黎明静悄悄',
            desc: '当第一缕阳光穿透停尸房的破损屋顶，那些覆盖着白布的轮廓显得如此静谧。在战区，死亡不是终点，而是幸存者漫长余生的开端。',
            chance: 0.05, // 5%
            condition: () => (player.stats.deaths || 0) > 3,
            effect: 'dawn_silence'
        }
    ];

    // 状态数据
    let player = { 
        name:"", gender:"", dept:"", med:0, admin:0, soc:0, health:60, energy:60, location: "",
        suspicion: 0, investigationCount: 0, rankIndex: 0, favor: 50, cash: 300, items: [],
        stats: { cured: 0, deaths: 0, discharged: 0, totalEmbezzled: 0, currentLocQuarters: 0, visitedLocs: [] },
        achievements: {},
        eventCooldowns: {} // 记录事件冷却：{eventId: lastQuarter}
    };
    let camp = { refugees: 100, supplies: 60, water: 60, tension: 30, funds: 10000, baseLevelIdx: 0, wardLevel: 0 }; 
    let currentQuarter = 1; 
    let quartersSinceRank6 = 0;
    let dangerLevel = 5; 
    let isEventResolved = false; 
    let historyLog = [];
    let isVictoryPending = false;
    let bioCache = "";
    
    // 新增模块数据
    let patients = [];
    let admittedCount = 0; // 本季度收治人数
    let hasRounded = false; // 本季度是否查房
    let fundsClickCount = 0; // 基地资金点击计数器
    let examQuestions = [];
    let examStreak = 0;
    let maxExamStreak = 0;
    let hasTakenExam = false; // 本季度是否考过
    let pendingSpecialPatientReward = 0; // 延迟触发的"救人的回报"事件季度数
    
    // 尝试加载test.js中的testData变量作为题库
    function loadtestDataQuestions() {
        try {
            if (typeof testData !== 'undefined' && Array.isArray(testData) && testData.length > 0 && testData[0].q) {
                examQuestions = testData;
                console.log(`成功加载test.js题库，共${testData.length}道题目`);
            } else {
                console.log('test.js中未找到testData变量，题库为空');
            }
        } catch (e) {
            console.log('加载test.js题库失败，使用默认题库', e);
        }
    }

    // 弹窗回调
    let confirmCallback = null;

    // --- 核心工具 ---
    
    function showMessage(title, text) {
        $('msg-title').innerText = title;
        $('msg-content').innerText = text;
        $('message-modal').style.display = 'flex';
    }
    
    function closeMsgModal() {
        $('message-modal').style.display = 'none';
    }

    function showConfirm(title, text, callback) {
        $('cfm-title').innerText = title;
        $('cfm-content').innerText = text;
        confirmCallback = callback;
        $('confirm-modal').style.display = 'flex';
    }

    function closeConfirmModal(result) {
        $('confirm-modal').style.display = 'none';
        if (confirmCallback) confirmCallback(result);
    }

    // --- 游戏逻辑 ---

    function rollName() {
        player.lastName = LAST_NAMES[randInt(0, LAST_NAMES.length-1)];
        player.firstName = FIRST_NAMES[randInt(0, FIRST_NAMES.length-1)];
        player.name = player.lastName + player.firstName;
        if($('input-lastname')) $('input-lastname').value = player.lastName;
        if($('input-firstname')) $('input-firstname').value = player.firstName;
    }

    function rollLocation() {
        player.location = CHAR_LOCATIONS[randInt(0, CHAR_LOCATIONS.length-1)];
        if($('p-location')) $('p-location').innerText = player.location;
        if($('p-location-desc')) $('p-location-desc').innerText = LOCATION_DESCRIPTIONS[player.location] || "";
    }

    function rollStats() {
        let sum = 0;
        do {
            player.med = randInt(10, 60);
            player.admin = randInt(10, 60);
            player.soc = randInt(10, 60);
            sum = player.med + player.admin + player.soc;
        } while (sum < 100 || sum > 150);
        
        if($('p-med')) $('p-med').innerText = player.med;
        if($('p-admin')) $('p-admin').innerText = player.admin;
        if($('p-soc')) $('p-soc').innerText = player.soc;
    }

    function generateRandomData() {
        rollName();
        rollLocation();
        rollStats();
        
        player.gender = Math.random() > 0.5 ? "男" : "女";
        if($('select-gender')) $('select-gender').value = player.gender;
        
        const depts = ["全科", "内科", "外科", "传染科", "儿科", "妇产科", "急诊科"];
        player.dept = depts[randInt(0, depts.length-1)];
        if($('select-dept')) $('select-dept').value = player.dept;
        
        player.suspicion = 0;
        player.investigationCount = 0;
    }

    function updateSetupUI() {
        if(!$('p-location')) return;
        if($('input-lastname')) $('input-lastname').value = player.lastName || "";
        if($('input-firstname')) $('input-firstname').value = player.firstName || "";
        if($('select-gender')) $('select-gender').value = player.gender || "男";
        if($('select-dept')) $('select-dept').value = player.dept || "内科";
        if($('p-location')) $('p-location').innerText = player.location || "正在分配...";
        if($('p-location-desc')) $('p-location-desc').innerText = LOCATION_DESCRIPTIONS[player.location] || "";
        if($('p-med')) $('p-med').innerText = player.med || 0;
        if($('p-admin')) $('p-admin').innerText = player.admin || 0;
        if($('p-soc')) $('p-soc').innerText = player.soc || 0;
    }

    function rollCharacter() {
        generateRandomData();
        updateSetupUI();
    }

    // --- 存档系统 ---

    function saveGame(type) {
        const gameState = {
            player, camp, currentQuarter, dangerLevel, 
            isEventResolved, historyLog, 
            isVictoryPending, quartersSinceRank6, bioCache,
            patients, admittedCount, hasRounded,
            examQuestions, examStreak, maxExamStreak, hasTakenExam,
            pendingSpecialPatientReward,
            saveDate: new Date().toLocaleString()
        };
        const key = type === 'auto' ? SAVE_KEY_AUTO : SAVE_KEY_MANUAL;
        localStorage.setItem(key, JSON.stringify(gameState));
    }

    function saveGameManual() {
        saveGame('manual');
        showMessage("系统提示", "✅ 手动存档成功！");
    }

    function openLoadModal() {
        const autoData = localStorage.getItem(SAVE_KEY_AUTO);
        const manualData = localStorage.getItem(SAVE_KEY_MANUAL);

        $('slot-auto-info').innerText = autoData ? JSON.parse(autoData).saveDate : "无记录";
        $('slot-manual-info').innerText = manualData ? JSON.parse(manualData).saveDate : "无记录";
        
        $('load-modal').style.display = 'flex';
    }

    function loadSlot(type) {
        const key = type === 'auto' ? SAVE_KEY_AUTO : SAVE_KEY_MANUAL;
        const data = localStorage.getItem(key);
        if (!data) {
            showMessage("错误", "该栏位没有存档。");
            return;
        }
        
        try {
            const state = JSON.parse(data);
            player = state.player;
            camp = state.camp;
            if(camp.wardLevel === undefined) camp.wardLevel = 0; // 兼容旧存档
            currentQuarter = state.currentQuarter;
            dangerLevel = state.dangerLevel;
            isEventResolved = state.isEventResolved;
            historyLog = state.historyLog;
            isVictoryPending = state.isVictoryPending;
            quartersSinceRank6 = state.quartersSinceRank6;
            bioCache = state.bioCache || "";
            // New state load
            patients = state.patients || [];
            // 兼容旧存档：为没有生命指征的病人添加默认值
            patients.forEach(p => {
                if(p.vital === undefined) {
                    p.vital = [60, 40, 20][p.sev || 0];
                }
                if(p.isDead === undefined) {
                    p.isDead = false;
                }
            });
            admittedCount = state.admittedCount || 0;
            hasRounded = state.hasRounded || false;
            examQuestions = state.examQuestions || [];
            examStreak = state.examStreak || 0;
            maxExamStreak = state.maxExamStreak || 0;
            hasTakenExam = state.hasTakenExam || false;
            pendingSpecialPatientReward = state.pendingSpecialPatientReward || 0;
            
            $('load-modal').style.display = 'none';
            if($('setup-screen').classList.contains('active')) {
                $('setup-screen').classList.remove('active');
            }
            initGame(true); 
            showMessage("系统提示", "📂 读档成功！");
        } catch(e) {
            console.error("Load failed", e);
            showMessage("错误", "存档文件损坏。");
        }
    }

    function checkSaveFile() {
        const hasAuto = localStorage.getItem(SAVE_KEY_AUTO);
        const hasManual = localStorage.getItem(SAVE_KEY_MANUAL);
        if (hasAuto || hasManual) {
            $('continue-btn').style.display = 'block';
        } else {
            $('continue-btn').style.display = 'none';
        }
    }

    function tryExitGame() {
        showConfirm("退出游戏", "确定要退出吗？当前进度将自动保存。", (result) => {
            if(result) {
                saveGame('auto');
                $('game-screen').classList.remove('active');
                $('end-screen').classList.remove('active');
                $('setup-screen').classList.add('active');
                $('bottom-nav').style.display = 'none';
                checkSaveFile();
            }
        });
    }
    
    // --- 开发者模式逻辑 (秘密) ---
    let devPressTimer = null;
    function startDevPress() {
        devPressTimer = setTimeout(() => {
            openDevModal();
        }, 10000);
    }
    function endDevPress() {
        if(devPressTimer) clearTimeout(devPressTimer);
    }
    function openDevModal() {
        $('dev-modal').style.display = 'flex';
        // 填充当前数值
        $('dev-med').value = player.med;
        $('dev-admin').value = player.admin;
        $('dev-soc').value = player.soc;
        $('dev-favor').value = player.favor;
        $('dev-cash').value = player.cash;
        $('dev-health').value = player.health;
        $('dev-energy').value = player.energy;
        $('dev-rank').value = player.rankIndex;
        $('dev-funds').value = camp.funds;
        $('dev-refugees').value = camp.refugees;
        $('dev-tension').value = camp.tension;
        $('dev-supplies').value = camp.supplies;
        $('dev-water').value = camp.water;
        $('dev-base-lv').value = camp.baseLevelIdx;
        $('dev-ward-lv').value = camp.wardLevel;
    }
    function devUpdate(target, key, val) {
        val = parseInt(val);
        if(target === 'player') player[key] = val;
        else camp[key] = val;
        updateUI();
        saveGame('auto');
    }

    function tryStartNewGame() {
        if($('continue-btn').style.display !== 'none') {
            showConfirm("新游戏", "开始新游戏将覆盖存档，确定吗？", (res) => {
                if(res) startNewGame();
            });
        } else {
            startNewGame();
        }
    }

    function startNewGame() {
        // Reset Logic
        historyLog = [];
        dangerLevel = 5;
        currentQuarter = 1;
        isEventResolved = false;
        isVictoryPending = false;
        camp = { refugees: 100, supplies: 60, water: 60, tension: 30, funds: 10000, baseLevelIdx: 0, wardLevel: 0 };
        player.rankIndex = 0;
        player.favor = 10;
        player.cash = 300;
        player.items = [];
        player.suspicion = 0;
        player.investigationCount = 0;
        player.appliedPromo = false;
        player.lastPromoQuarter = 0;
        player.stats = { cured: 0, deaths: 0, discharged: 0, totalEmbezzled: 0, currentLocQuarters: 0, visitedLocs: [], totalQuarters: 0, isHonest: 1, hasSurrendered: 0 };
        player.achievements = {}; // 清空成就记录
        
        // 获取手动输入或选择的属性
        player.lastName = $('input-lastname').value || "无";
        player.firstName = $('input-firstname').value || "名";
        player.name = player.lastName + player.firstName;
        player.gender = $('select-gender').value;
        player.dept = $('select-dept').value;
        player.location = $('p-location').innerText;
        player.med = parseInt($('p-med').innerText);
        player.admin = parseInt($('p-admin').innerText);
        player.soc = parseInt($('p-soc').innerText);
        
        patients = [];
        admittedCount = 0;
        hasRounded = false;
        quartersSinceRank6 = 0;
        bioCache = "";
        examStreak = 0;
        maxExamStreak = 0;
        hasTakenExam = false;
        pendingSpecialPatientReward = 0;
        
        // 初始化本季行动限制
        player.quarterlyActions = { running: 0, sleep: 0 };
        
        loadtestDataQuestions();

        initGame();
        saveGame('auto');
    }

    // --- 图片预加载 ---
    function preloadImages() {
        const imagesToPreload = [
            'image/work1.png',
            'image/place.png',
            // 基地等级图片 (1-4)
            'image/base1.png', 'image/base2.png', 'image/base3.png', 'image/base4.png',
            // 补给站图片 (1-4)
            'image/supply1.png', 'image/supply2.png', 'image/supply3.png', 'image/supply4.png',
            // 病房图片 (1-4)
            'image/ward1.png', 'image/ward2.png', 'image/ward3.png', 'image/ward4.png'
        ];
        
        imagesToPreload.forEach(src => {
            const img = new Image();
            img.src = src;
        });
    }

    window.onload = function() {
        preloadImages(); // 预加载所有图片
        loadtestDataQuestions(); // 加载test.js中的testData题库
        checkSaveFile();
        renderShop();
        rollCharacter();
    };

    function toggleTheme() { document.body.classList.toggle('night-mode'); }
    
    function openSettingsModal() {
        $('settings-modal').style.display = 'flex';
    }
    
    function closeSettingsModal() {
        $('settings-modal').style.display = 'none';
    }

    function closeTutorialModal() {
        $('tutorial-modal').style.display = 'none';
    }

    function openAchievementsModal() {
        $('achievements-modal').style.display = 'flex';
        updateUI();
    }

    function switchCharSubTab(tabId, btn) {
        document.querySelectorAll('#tab-character .char-sub-tab').forEach(el => el.style.display = 'none');
        document.querySelectorAll('#tab-character .sub-tab-nav .nav-item').forEach(el => el.classList.remove('active'));
        
        $('char-' + tabId).style.display = 'block';
        if(btn) btn.classList.add('active');
        
        if(tabId === 'supply' || tabId === 'workstation') renderShop();
        updateUI();
    }

    function switchBaseSubTab(tabId, btn) {
        document.querySelectorAll('#tab-base .base-sub-tab').forEach(el => el.style.display = 'none');
        document.querySelectorAll('#tab-base .sub-tab-nav .nav-item').forEach(el => el.classList.remove('active'));
        
        $('base-' + tabId).style.display = 'block';
        if(btn) btn.classList.add('active');
        
        if(tabId === 'procure') renderShop();
        updateUI();
    }

    function switchNav(tabName, btnElement) {
        // 重定向旧的标签页名
        if(tabName === 'ward') tabName = 'base';
        if(tabName === 'exam' || tabName === 'items') tabName = 'character';
        if(tabName === 'achievements') {
            openAchievementsModal();
            return;
        }

        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const targetTab = $('tab-' + tabName);
        if(targetTab) targetTab.classList.add('active');
        
        if(btnElement) btnElement.classList.add('active');
        if(tabName === 'base') renderShop();
        if(tabName === 'character') {
            switchCharSubTab('archive', document.querySelector('.sub-tab-nav .nav-item'));
        }
        updateUI();
    }

    function toggleApiInput() {
        let isMock = $('use-mock').checked;
        $('api-key').disabled = isMock;
        $('model-name').disabled = isMock;
        $('api-url').disabled = isMock;
    }

    async function initGame(isLoad = false) {
        if(!isLoad && !player.name) rollCharacter();
        
        $('setup-screen').classList.remove('active');
        $('loading-screen').classList.add('active');

        if (!isLoad) {
            addLog("> 验证身份权限..."); await wait(600);
            let locName = player.location ? player.location.split(' - ')[0] : "未知区域";
            addLog(`> 加密连接至指挥部: ${locName}...`); await wait(800); 
            addLog("> 正在下载人员档案...");
            addLog("> 正在加载图片..."); await wait(300);
            
            try {
                const bioText = await generateBio();
                bioCache = bioText; // Cache bio
                $('bio-container').innerHTML = bioText;
            } catch (e) {
                console.error(e);
                $('bio-container').innerHTML = "（数据损坏，无法显示档案）";
            }
        } else {
            $('bio-container').innerHTML = bioCache || "（档案读取中...）";
            addLog("> 读取本地缓存..."); await wait(500);
            addLog("> 恢复指挥链路..."); await wait(500);
        }
        
        startGameUI(isLoad);
    }

    function addLog(text) {
        const div = document.createElement('div');
        div.className = 'log-line';
        div.innerText = text;
        $('log-box').appendChild(div);
    }

    function startGameUI(isLoad) {
        // 先更新UI，确保人物信息正确显示
        updateUI();
        
        $('loading-screen').classList.remove('active');
        $('game-screen').classList.add('active');
        $('bottom-nav').style.display = 'grid'; // 显示底部导航
        
        $('game-location-display').style.display = 'block';
        $('game-location-display').innerText = '📍 ' + player.location;

        if (!isLoad) {
            // 新游戏初始化
            isEventResolved = false;
            $('start-event-btn').style.display = 'block';
            $('next-day-btn').style.display = 'none';
            $('event-area').style.display = 'none';
            
            const firstSalary = RANK_SALARIES[player.rankIndex];
            player.cash += firstSalary;
            addAchievement("游戏开始 - 抵达前线");
            saveGame('auto');
            
            // 显示新手教程
            setTimeout(() => {
                $('tutorial-modal').style.display = 'flex';
            }, 500);
        } else {
            // 读档恢复状态
            $('log-box').innerHTML = ""; 
            if (isEventResolved) {
                $('start-event-btn').style.display = 'none';
                $('event-area').style.display = 'none';
                $('next-day-btn').style.display = 'block';
                $('next-quarter-msg').style.display = 'block';
            } else {
                $('start-event-btn').style.display = 'block';
                $('next-day-btn').style.display = 'none';
                $('event-area').style.display = 'none';
                $('next-quarter-msg').style.display = 'none';
            }
        }
        
        updateUI();
        renderPatients();
        renderExamUI();
    }

    async function fetchDailyEvent() {
        $('start-event-btn').style.display = 'none';
        $('loading-spinner').style.display = 'block';
        
        try {
            const eventData = await generateEventData();
            renderEvent(eventData);
        } catch (e) {
            console.error(e);
            renderEvent(mockEvent());
        }
    }

    // --- 基地 & 商店逻辑 ---

    function renderShop() {
        const personalContainer = $('personal-shop-container');
        const baseContainer = $('base-shop-container');
        if(!personalContainer || !baseContainer) return;

        personalContainer.innerHTML = '';
        baseContainer.innerHTML = '';

        SHOP_ITEMS.forEach(item => {
            if(item.id.includes('base_lv')) {
                if(item.level <= camp.baseLevelIdx) return;
                if(item.level > camp.baseLevelIdx + 1) return;
            }

            if(item.id === 'ward_upgrade') {
                if(camp.wardLevel >= 3) return; // 已达Lv.4
            }

            const el = document.createElement('div');
            el.className = 'item-card';
            const priceLabel = (item.type === 'base' || item.type === 'base_ward') ? '基地资金' : '个人存款';
            el.innerHTML = `
                <div>
                    <div class="item-name">${item.name}${item.id === 'ward_upgrade' ? ' (Lv.' + (camp.wardLevel + 1) + ' -> ' + (camp.wardLevel + 2) + ')' : ''}</div>
                    <div class="item-price">$${item.price} <span style="font-size:0.7rem; font-weight:normal; color:#888;">(${priceLabel})</span></div>
                    <div class="item-desc">${item.desc}</div>
                </div>
                <button class="buy-btn" id="btn-buy-${item.id}" onclick="buyItem('${item.id}')">购买</button>
            `;
            
            if(item.type === 'base' || item.type === 'base_ward') baseContainer.appendChild(el);
            else personalContainer.appendChild(el);
        });
    }

    function buyItem(itemId) {
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if(!item) return;

        if (item.type === 'perm' && player.items.includes(item.id)) {
            return showMessage("提示", "你已经拥有该物品了！");
        }

        // 扩建使用基地资金
        if (item.type === 'base') {
            if (camp.funds < item.price) return showMessage("提示", "基地资金不足！");
            camp.funds -= item.price;
            camp.baseLevelIdx = item.level;
            showMessage("基地升级", `${item.name} 建设完成！容量提升。`);
        } else if (item.type === 'base_ward') {
            if (camp.wardLevel >= 3) return showMessage("提示", "病房已达最高等级！");
            if (camp.funds < item.price) return showMessage("提示", "基地资金不足！");
            camp.funds -= item.price;
            camp.wardLevel++;
            showMessage("病房升级", `病房升级到 Lv.${camp.wardLevel + 1}，床位扩大到 ${WARD_CAPS[camp.wardLevel]}。`);
            renderShop(); // 更新商店显示
        } else {
            if (player.cash < item.price) return showMessage("提示", "个人存款不足！");
            player.cash -= item.price;
            if (item.type === 'perm') {
                player.items.push(item.id);
                applyChanges(item.effect);
                showMessage("购买成功", `${item.name}：能力已永久提升。`);
            } else {
                applyChanges(item.effect);
                showMessage("购买成功", `${item.name}：已立即使用。`);
            }
        }
        
        updateUI();
        renderShop();
        saveGame('auto');
    }

    function buyBaseItem(type) {
        if(camp.funds < 500) return showMessage("提示", "基地资金不足！");
        
        camp.funds -= 500;
        if(type === 'supplies') {
            camp.supplies += 5;
            showMessage("补给", "物资 +5");
        } else {
            camp.water += 5;
            showMessage("补给", "净水 +5");
        }
        updateUI();
        saveGame('auto');
    }

    // --- 病房系统逻辑 ---

    function renderPatients() {
        const list = $('patient-list');
        list.innerHTML = '';
        if(patients.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">病房空置中</div>';
            return;
        }

        patients.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = `patient-card p-sev-${p.sev}`;
            const sevText = ["轻症","中症","重症"][p.sev];
            const sevColor = ["#2ecc71","#f1c40f","#e74c3c"][p.sev];
            
            // 生命指征颜色
            const vitalColor = p.vital > 50 ? "#2ecc71" : (p.vital > 20 ? "#f1c40f" : "#e74c3c");
            const vital = p.vital !== undefined ? p.vital : 60;
            
            // 根据状态显示不同按钮
            let actionButtons = '';
            if(p.isDead) {
                actionButtons = `
                    <button class="p-btn" style="background:#555; color:white; flex:1;" onclick="buryPatient(${idx})">⚰️ 埋葬 (-$100)</button>
                `;
            } else {
                actionButtons = `
                    <button class="p-btn" style="background:var(--blue); color:white; flex:1;" onclick="treatPatient(${idx})">💉 治疗</button>
                    ${vital <= 30 ? `<button class="p-btn" style="background:var(--danger); color:white; flex:1;" onclick="rescuePatient(${idx})">🚨 抢救</button>` : ''}
                    <button class="p-btn" style="background:var(--border); color:var(--text); flex:1;" onclick="dischargePatient(${idx})">出院</button>
                `;
            }
            
            card.innerHTML = `
                <div class="p-header" style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-weight:bold;">${p.name} (${p.age}岁，${p.gender})</span>
                    <span style="color:${sevColor}; font-weight:bold;">${p.isDead ? '☠️ 已死亡' : sevText}</span>
                </div>
                <div class="p-info" style="font-size:0.9rem; margin-bottom:5px;">主诉: ${p.cc}</div>
                <div style="font-size:0.85rem; color:#888; margin-bottom:8px; font-style:italic;">${p.hpi}</div>
                <div style="font-size:0.9rem; margin-bottom:5px;">
                    诊疗进度: <span style="font-weight:bold;">${p.prog}%</span>
                    <div class="bar-bg" style="height:6px; margin-top:2px;"><div class="bar-fill" style="width:${p.prog}%; background:var(--blue);"></div></div>
                </div>
                <div style="font-size:0.9rem; margin-bottom:10px;">
                    生命指征: <span style="color:${vitalColor}; font-weight:bold;">${vital}</span>
                    <div class="bar-bg" style="height:6px; margin-top:2px;"><div class="bar-fill" style="width:${vital}%; background:${vitalColor};"></div></div>
                </div>
                <div class="p-actions" style="display:flex; gap:5px;">
                    ${actionButtons}
                </div>
            `;
            list.appendChild(card);
        });
    }

    function admitPatient() {
        const maxCap = BASE_LEVELS[camp.baseLevelIdx].wardCap;
        if(patients.length >= maxCap) return showMessage("床位已满", "无法收治更多病人。");
        if(admittedCount >= 3) return showMessage("限额已满", "每季度最多收治3人。");

        admittedCount++;
        
        // Generate basic data
        const bedNum = findEmptyBed(maxCap);
        let age, gender;
        if(player.dept === "妇产科") {
            // 妇产科病人全为女性和新生儿
            gender = "女";
            age = Math.random() > 0.3 ? randInt(18, 45) : 0; // 70%成年女性，30%新生儿(0岁)
        } else if(player.dept === "儿科") {
            age = randInt(0, 18);
            gender = Math.random()>0.5?"男":"女";
        } else {
            age = randInt(0, 75);
            gender = Math.random()>0.5?"男":"女";
        }
        
        // 轻症50%概率、中症30%、重症10%
        const sevRoll = Math.random();
        let sev = 0; // light
        if (sevRoll < 0.5) sev = 0; // light
        else if (sevRoll < 0.8) sev = 1; // medium
        else if (sevRoll < 0.9) sev = 2; // severe
        else sev = 0; // Default to light if 90-100%
        
        const name = "P." + randInt(100,999);
        const vitalInit = [60, 40, 20][sev];
        
        const newPatient = {
            bed: bedNum,
            name: name,
            age: age,
            gender: gender,
            sev: sev,
            cc: "生成中...",
            hpi: "生成中...",
            prog: 0,
            vital: vitalInit,
            isDead: false
        };
        
        patients.push(newPatient);
        patients.sort((a,b) => a.bed - b.bed);
        renderPatients();
        updateUI();

        // API Call for text
        try {
            const prompt = `生成一个无国界医生前线病人病例。
            科室:${player.dept}。病人:${age}岁${gender}，危急度:${["轻症","中症","重症"][sev]}。
            请返回JSON格式: {"cc":"主诉(20字内)", "hpi":"现病史(70字左右)"}`;
            
            callDeepSeek(prompt, true).then(res => {
                newPatient.cc = res.cc;
                newPatient.hpi = res.hpi;
                renderPatients();
            });
        } catch(e) {
            newPatient.cc = "腹痛伴发热3天";
            newPatient.hpi = "患者3天前无明显诱因出现腹痛，伴发热，最高体温38.5度。";
            renderPatients();
        }
        saveGame('auto');
    }

    function findEmptyBed(max) {
        const taken = patients.map(p => p.bed);
        let bed = randInt(1, max);
        while(taken.includes(bed)) {
            bed = randInt(1, max);
        }
        return bed;
    }

    function doRounds() {
        if(hasRounded) return showMessage("提示", "本季度已查房。");
        if(patients.length === 0) return showMessage("提示", "没有病人。");
        if(camp.supplies < 5) return showMessage("物资不足", "需要5物资。");
        if(player.health < 5) return showMessage("体力不足", "太累了。");

        applyChanges({ supplies: -5, health: -5 }, "开始查房");
        hasRounded = true;

        let log = "";
        patients.forEach(p => {
            const gain = randInt(5, 10);
            p.prog = Math.min(100, p.prog + gain);
        });
        
        showMessage("查房结束", "所有病人诊疗进度提升 5-10%。");
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    function treatPatient(idx) {
        let p = patients[idx];
        if(p.isDead) return showMessage("提示", "该病人已死亡。");
        if(!p.treatCount) p.treatCount = 0;
        if(p.treatCount >= 3) return showMessage("提示", "该病人本季度已达治疗上限(3次)");
        if(player.energy < 2) return showMessage("提示", "精力不足，无法进行治疗。");
        
        applyChanges({ energy: -2 });
        p.treatCount++;
        
        // Formula: floor(10% Med) + rand(10-20) - sev*3
        let gain = Math.floor(player.med * 0.1) + randInt(10, 20) - (p.sev * 3);
        if(player.items.includes('device')) gain += 5;
        
        if(gain < 1) gain = 1;
        p.prog = Math.min(100, p.prog + gain);
        
        // 治疗增加生命指征 5-10
        const vitalGain = randInt(5, 10);
        p.vital = Math.min(100, (p.vital || 60) + vitalGain);
        
        renderPatients();
        updateUI();
    }
    
    // 抢救功能：生命指征≤30时可用，消耗5物资，+10生命指征
    function rescuePatient(idx) {
        let p = patients[idx];
        if(p.isDead) return showMessage("提示", "该病人已死亡。");
        if(p.vital > 30) return showMessage("提示", "病人生命指征稳定，无需抢救。");
        if(camp.supplies < 5) return showMessage("物资不足", "抢救需要消耗5点物资。");
        
        applyChanges({ supplies: -5 }, "紧急抢救");
        p.vital = Math.min(100, p.vital + 10);
        
        showMessage("抢救成功", `病人生命指征提升至 ${p.vital}。`);
        renderPatients();
        updateUI();
        saveGame('auto');
    }
    
    // 埋葬功能：消耗$100，清除死亡病人
    function buryPatient(idx) {
        if(camp.funds < 100) return showMessage("资金不足", "埋葬需要消耗 $100 基地资金。");
        
        applyChanges({ funds: -100 }, "安葬病人");
        patients.splice(idx, 1);
        
        showMessage("已安葬", "病人已安息。愿逝者安宁。");
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    function dischargePatient(idx) {
        const p = patients[idx];
        player.stats.discharged = (player.stats.discharged || 0) + 1;
        
        if(p.prog >= 100) {
            // Success
            player.stats.cured++;
            player.stats.quarterlyCured = (player.stats.quarterlyCured || 0) + 1; // 记录本季度治愈人数
            const reward = randInt(50, 150) + (p.sev * 50);
            player.cash += reward;
            showMessage("治愈出院", `病人康复离开。收到报酬/捐赠 $${reward}。`);
        } else {
            // Fail/Early discharge
            player.stats.deaths++;
            camp.tension += 10;
            showMessage("提前出院", `治疗未完成。病人家属表示不满，营地紧张度 +10。`);
        }
        
        patients.splice(idx, 1);
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    // --- 考核系统逻辑 ---

    function startExam() {
        if (hasTakenExam) return showMessage("提示", "本季度已参加过考核。");
        if (examQuestions.length === 0) return showMessage("提示", "题库为空，请先加载题目！");
        
        hasTakenExam = true;
        $('exam-start-area').style.display = 'none';
        $('exam-ui').style.display = 'block';
        loadNextQuestion();
    }

    function loadNextQuestion() {
        if (examQuestions.length === 0) {
            showMessage("提示", "题库已用完！");
            setTimeout(quitExam, 1500);
            return;
        }

        $('exam-result').style.display = 'none';
        $('exam-quit-btn').style.display = 'none';
        $('confirm-exam-area').style.display = 'none';
        selectedAnswerIndex = -1;

        const qIdx = randInt(0, examQuestions.length - 1);
        currentQuestion = examQuestions.splice(qIdx, 1)[0];

        $('exam-q-text').innerText = currentQuestion.q;
        const optionsDiv = $('exam-options');
        optionsDiv.innerHTML = '';

        const labels = ["A", "B", "C", "D", "E"];
        currentQuestion.o.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'exam-opt-btn'; // Make sure this class exists or is styled
            btn.innerText = `${labels[idx]}. ${opt}`;
            btn.onclick = () => selectAnswer(idx, btn);
            optionsDiv.appendChild(btn);
        });
    }

    let selectedAnswerIndex = -1;
    function selectAnswer(idx, btn) {
        selectedAnswerIndex = idx;
        document.querySelectorAll('.exam-opt-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        $('confirm-exam-area').style.display = 'block';
        $('btn-confirm-answer').onclick = () => checkAnswer();
    }

    function checkAnswer() {
        if (selectedAnswerIndex === -1) return;
        
        const idx = selectedAnswerIndex;
        const correctIdx = currentQuestion.a;
        const btns = document.querySelectorAll('.exam-opt-btn');
        btns.forEach(btn => btn.disabled = true);
        $('confirm-exam-area').style.display = 'none';

        const resultArea = $('exam-result');
        resultArea.style.display = 'block';

        if (idx === correctIdx) {
            btns[idx].style.background = "#2ecc71";
            btns[idx].style.color = "white";
            examStreak++;
            if (examStreak > maxExamStreak) maxExamStreak = examStreak;
            resultArea.innerHTML = `<div style="color:#2ecc71; font-weight:bold;">✅ 回答正确！当前连胜: ${examStreak}</div>`;
            setTimeout(loadNextQuestion, 1500);
        } else {
            btns[idx].style.background = "#e74c3c";
            btns[idx].style.color = "white";
            btns[correctIdx].style.background = "#2ecc71";
            btns[correctIdx].style.color = "white";
            
            const labels = ["A", "B", "C", "D", "E"];
            resultArea.innerHTML = `<div style="color:#e74c3c; font-weight:bold;">❌ 回答错误！正确答案是: ${labels[correctIdx]}</div>`;
            examStreak = 0;
            $('exam-quit-btn').style.display = 'block';
        }
        updateUI();
        saveGame('auto');
    }

    function quitExam() {
        $('exam-start-area').style.display = 'block';
        $('exam-ui').style.display = 'none';
        $('exam-result').style.display = 'none';
        $('exam-quit-btn').style.display = 'none';
        $('confirm-exam-area').style.display = 'none';
        updateUI();
    }

    function importQuestions() {
        const json = $('exam-import-area').value;
        try {
            const data = JSON.parse(json);
            if(Array.isArray(data) && data.length > 0 && data[0].q) {
                examQuestions = data;
                showMessage("导入成功", `成功导入 ${data.length} 道题目。`);
            } else {
                showMessage("格式错误", "格式不正确。");
            }
        } catch(e) {
            showMessage("解析失败", "JSON解析失败。");
        }
    }

    // --- UI 更新 ---
    
    function getSeasonInfo() {
        const year = Math.ceil(currentQuarter / 4);
        const seasonIndex = (currentQuarter - 1) % 4; 
        const seasons = ["春", "夏", "秋", "冬"];
        return { year, season: seasons[seasonIndex], index: seasonIndex };
    }

    function updateSliderUI(type) {
        if (type === 'don') {
            const val = $('don-slider').value;
            $('don-val').innerText = val + "%";
            const give = Math.floor(player.cash * (val/100));
            $('don-give').innerText = '$' + give;
            $('don-get').innerText = '$' + give;
        }
    }

    function updateUI() {
        const timeInfo = getSeasonInfo();
        $('day-display').innerText = `第${timeInfo.year}年 ${timeInfo.season}`;
        
        $('val-refugees').innerText = camp.refugees;
        $('val-funds').innerText = '$' + camp.funds;
        $('val-base-lvl').innerText = BASE_LEVELS[camp.baseLevelIdx].name;
        $('val-base-lvl-num').innerText = camp.baseLevelIdx + 1;

        // 动态图片更新
        if($('img-base')) $('img-base').src = `image/base${camp.baseLevelIdx + 1}.png`;
        if($('img-ward')) $('img-ward').src = `image/ward${camp.wardLevel + 1}.png`;
        if($('img-supply')) $('img-supply').src = `image/supply${camp.baseLevelIdx + 1}.png`;
        
        // 更新个人属性显示 (工作站和补给站共享)
        ['work', 'supply'].forEach(suffix => {
            if($(`val-cash-${suffix}`)) $(`val-cash-${suffix}`).innerText = '$' + player.cash;
            if($(`val-health-${suffix}`)) $(`val-health-${suffix}`).innerText = player.health;
            if($(`bar-health-${suffix}`)) $(`bar-health-${suffix}`).style.width = player.health + '%';
            if($(`val-energy-${suffix}`)) $(`val-energy-${suffix}`).innerText = player.energy;
            if($(`bar-energy-${suffix}`)) $(`bar-energy-${suffix}`).style.width = player.energy + '%';
        });

        // 更新基地采购界面数值
        if($('val-funds-procure')) $('val-funds-procure').innerText = '$' + camp.funds;
        if($('val-supplies-procure')) $('val-supplies-procure').innerText = camp.supplies + '%';
        if($('bar-supplies-procure')) $('bar-supplies-procure').style.width = camp.supplies + '%';
        if($('val-water-procure')) $('val-water-procure').innerText = camp.water + '%';
        if($('bar-water-procure')) $('bar-water-procure').style.width = camp.water + '%';

        // 档案界面
        $('char-name-display').innerText = player.name;
        $('char-gender-display').innerText = player.gender;
        $('char-dept-display').innerText = player.dept;
        $('char-icon').innerText = player.gender === "女" ? "👩‍⚕️" : "👨‍⚕️";
        
        $('summary-cured-archive').innerText = player.stats.cured || 0;
        $('summary-quarters-archive').innerText = player.stats.totalQuarters || 0;
        $('summary-max-rank-archive').innerText = player.rankIndex + 1;

        // 工作站数值
        $('val-med-work').innerText = player.med;
        $('val-admin-work').innerText = player.admin;
        $('val-soc-work').innerText = player.soc;

        // 晋级界面
        $('val-rank-name').innerText = CONFIG.ranks[player.rankIndex];
        $('val-rank-lvl').innerText = player.rankIndex + 1;
        $('val-favor').innerText = player.favor;
        $('bar-favor').style.width = player.favor + '%';
        $('val-max-streak').innerText = maxExamStreak;
        $('curr-streak').innerText = examStreak;
        $('best-streak').innerText = maxExamStreak;
        $('val-salary-promo').innerText = `$${RANK_SALARIES[player.rankIndex]}`;

        // Ward UI
        const wardCap = WARD_CAPS[camp.wardLevel];
        $('ward-count').innerText = patients.length;
        $('ward-cap').innerText = wardCap;
        $('ward-limit-msg').innerText = `本季收治: ${admittedCount}/3`;

        const updateBar = (id, val, isReverse=false) => {
            let el = $(id);
            if(!el) return;
            el.innerText = val + (id.includes('tension')||id.includes('supplies')||id.includes('water')?'%':'');
            let bar = $('bar-' + id.replace('val-',''));
            if(bar) {
                bar.style.width = Math.max(0, Math.min(100, val)) + '%';
            }
        };

        updateBar('val-tension', camp.tension, true);
        updateBar('val-supplies', camp.supplies);
        updateBar('val-water', camp.water);
        
        // 嫌疑度 UI
        if($('val-suspicion')) $('val-suspicion').innerText = player.suspicion;
        if($('bar-suspicion')) $('bar-suspicion').style.width = Math.min(100, player.suspicion) + '%';
        
        // 成就系统渲染
        const achList = $('achievement-list');
        if(achList) {
            achList.innerHTML = '';
            let unlockedCount = 0;
            ACHIEVEMENTS_DEF.forEach(ach => {
                let current = 0;
                if (ach.key === 'rankIndex') current = player.rankIndex;
                else if (ach.key === 'currentPatients') current = patients.length;
                else if (ach.key === 'baseLevelIdx') current = camp.baseLevelIdx;
                else                 if (ach.key === 'maxExamStreak') current = maxExamStreak;
                else if (ach.key === 'hasYearsStitchedWound') current = player.stats.hasYearsStitchedWound ? 1 : 0;
                else if (ach.key === 'hasObservationStation52') current = player.stats.hasObservationStation52 ? 1 : 0;
                else current = player.stats[ach.key] || 0;
                
                let percent = Math.floor(Math.min(100, (current / ach.target) * 100));
                
                if(ach.id === 'honest' && !isVictoryPending) {
                    percent = 0;
                }
                
                if(percent >= 100) {
                    unlockedCount++;
                    if(!player.achievements[ach.id]) {
                        player.achievements[ach.id] = true;
                        addLog(`🏆 达成成就：${ach.name}`);
                    }
                }

                const item = document.createElement('li');
                item.className = 'achieve-item';
                if(percent >= 100) item.style.borderColor = 'var(--gold)';
                else item.style.borderColor = 'var(--border)';
                
                item.innerHTML = `
                    <div class="achieve-name">${percent >= 100 ? '✅ ' : ''}${ach.name}</div>
                    <div class="achieve-desc">${ach.desc}</div>
                    <div class="achieve-progress-box">
                        <div style="font-size:0.8rem; color:#666;">目标: ${ach.target} (${current}/${ach.target})</div>
                        <div class="achieve-percent">${percent}%</div>
                    </div>
                `;
                achList.appendChild(item);
            });

            const totalPercent = Math.floor((unlockedCount / ACHIEVEMENTS_DEF.length) * 100);
            if($('total-achieve-bar')) $('total-achieve-bar').style.width = totalPercent + '%';
            if($('total-achieve-text')) $('total-achieve-text').innerText = totalPercent + '%';
        }
        
        // 商店按钮状态
        SHOP_ITEMS.forEach(item => {
            const btn = $('btn-buy-' + item.id);
            if(btn) {
                let price = item.price;
                if (item.type === 'base') {
                     if (camp.funds < price) btn.style.opacity = "0.5"; else btn.style.opacity = "1";
                } else {
                     if (player.items.includes(item.id)) { btn.disabled = true; btn.innerText = "已拥有"; }
                     else if (player.cash < price) btn.style.opacity = "0.5"; else btn.style.opacity = "1";
                }
            }
        });

        // 晋升状态
        let promoText = "";
        const seasonIdx = (currentQuarter - 1) % 4; // 2 is Autumn
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;

        if (player.rankIndex >= 5) {
             promoText = "已达最高职级";
             $('btn-promo').disabled = true;
             $('btn-promo').style.background = "#555";
        } else if (player.appliedPromo) {
             promoText = "等待总部审核 (冬末出结果)";
             $('btn-promo').disabled = true;
             $('btn-promo').style.background = "#d35400";
        } else {
             if (seasonIdx === 2) { 
                 if (maxExamStreak >= reqStreak) {
                    promoText = `秋季窗口开放 (满足连胜 ${reqStreak})`;
                    $('btn-promo').disabled = false;
                    $('btn-promo').style.background = "var(--blue)";
                 } else {
                    promoText = `秋季窗口开放 (连胜不足, 需${reqStreak})`;
                    $('btn-promo').disabled = true;
                    $('btn-promo').style.background = "#555";
                 }
             } else {
                 promoText = `仅秋季开放 (需连胜${reqStreak})`;
                 $('btn-promo').disabled = true;
                 $('btn-promo').style.background = "#555";
             }
        }
        $('promo-status').innerText = promoText;
        
        updateSliderUI('don');
    }

    // --- 互动逻辑 ---

    function doAction(type) {
        // 计算社交对紧张度减少的加成：1 + floor(10% soc)
        let socBonus = 1 + Math.floor(player.soc * 0.1);

        let changes = {};
        if (type === 'distribute_food') {
            if (camp.supplies < 5) return showMessage("物资不足", "库存不足！");
            changes = { supplies: -5, tension: -socBonus };
        } else if (type === 'distribute_water') {
            if (camp.water < 5) return showMessage("净水不足", "库存不足！");
            changes = { water: -5, tension: -socBonus };
        } else if (type === 'transport') {
            let healthCost = 5;
            if (player.items.includes('suv')) { healthCost = 0; }
            if (player.health < healthCost && healthCost > 0) return showMessage("体力不足", "太累了！");
            changes = { supplies: 10, water: 10, health: -healthCost };
        } else if (type === 'pacify') {
            if(player.energy < 10) return showMessage("精力不足", "需要10点精力");
            changes = { tension: -5, energy: -10 };
        } else if (type === 'rescue') {
            if(player.health < 10) return showMessage("体力不足", "需要10点健康");
            const cap = BASE_LEVELS[camp.baseLevelIdx].cap;
            if(camp.refugees >= cap) return showMessage("营地已满", `当前等级上限 ${cap} 人`);
            changes = { health: -10, refugees: 10 };
        } else if (type === 'big_spender') {
            if(camp.funds < 2000) return showMessage("资金不足", "需要$2000基地资金");
            changes = { funds: -2000, tension: -10 };
        }

        applyChanges(changes);
        showResultModal(changes, "基地行动", "行动已执行。");
        saveGame('auto');
    }

    function handleFundsClick() {
        fundsClickCount++;
        if (fundsClickCount >= 1) {
            fundsClickCount = 0; // 重置计数器
            $('embezzle-slider').value = 0;
            updateEmbezzleSlider();
            $('embezzle-modal').style.display = 'flex';
        }
    }

    function updateEmbezzleSlider() {
        const val = $('embezzle-slider').value;
        $('embezzle-val').innerText = val + "%";
        const stealAmount = Math.floor(camp.funds * (val/100));
        $('embezzle-steal').innerText = '$' + stealAmount;
        $('embezzle-gain').innerText = '$' + Math.floor(stealAmount/2);
        
        // 新的嫌疑度计算公式：挪用百分比 - 取整(0.1 * 行政能力) + 随机数(0-5)
        const percent = parseInt(val);
        const adminReduction = Math.floor(player.admin * 0.1);
        const baseSus = Math.max(0, percent - adminReduction);
        const minSus = baseSus;
        const maxSus = baseSus + 5;
        $('embezzle-suspicion').innerText = `${minSus}-${maxSus}`;
    }

    function closeEmbezzleModal() {
        $('embezzle-modal').style.display = 'none';
        $('embezzle-slider').value = 0;
        updateEmbezzleSlider();
    }

    function confirmEmbezzle() {
        const val = $('embezzle-slider').value;
        const stealAmount = Math.floor(camp.funds * (val/100));
        
        if (stealAmount <= 0) {
            showMessage("提示", "请选择挪用比例！");
            return;
        }
        
        camp.funds -= stealAmount;
        const gain = Math.floor(stealAmount / 2);
        player.cash += gain;

        player.stats.totalEmbezzled += stealAmount;
        player.stats.isHonest = 0; 

        // 新的嫌疑度计算公式：挪用百分比 - 取整(0.1 * 行政能力) + 随机数(0-5)
        const percent = parseInt(val);
        const adminReduction = Math.floor(player.admin * 0.1);
        const randomBonus = randInt(0, 5);
        const susIncrease = Math.max(0, percent - adminReduction + randomBonus);
        player.suspicion += susIncrease;
        
        updateUI();
        saveGame('auto');
        closeEmbezzleModal();
        
        showCustomModal(
            `<li class="change-item"><span class="change-name">基地资金</span> <span class="change-val val-down">-$${stealAmount}</span></li>` +
            `<li class="change-item"><span class="change-name">个人存款</span> <span class="change-val val-up">+$${gain}</span></li>` +
            `<li class="change-item"><span class="change-name">嫌疑度</span> <span class="change-val val-down">+${susIncrease}</span></li>`,
            "操作成功",
            "挪用完成。风险正在累积..."
        );

        if (player.suspicion >= 100) {
            setTimeout(checkSuspicion, 1000); 
        }
    }

    function checkSuspicion() {
        if (player.suspicion >= 100) {
             $('investigation-modal').style.display = 'flex';
        }
    }

    function handleInvestigationAction(action) {
        $('investigation-modal').style.display = 'none';
        
        if (player.investigationCount > 0) {
            endGameByInvestigation();
            return;
        }

        if (action === 'resist') {
            endGameByInvestigation();
        } else {
            player.investigationCount++;
            player.suspicion = 0;
            player.cash = 0;
            player.rankIndex = Math.max(0, player.rankIndex - 2);
            player.stats.hasSurrendered = 1;
            updateUI();
            saveGame('auto');
            showMessage("接受处分", "你上交了所有非法所得并接受了降职处分。这是最后一次机会。");
        }
    }

    function endGameByInvestigation() {
        endGame('investigation', '身陷囹圄', '你的贪污行为已被证实。你已被逮捕并移交国际法庭，职业生涯彻底终结。');
    }
    
    function endGame(type, title, reason) {
        $('game-screen').classList.remove('active');
        $('end-screen').classList.add('active');
        $('bottom-nav').style.display = 'none';
        $('end-reason').innerText = reason;
        
        // 根据类型设置不同颜色
        const colorMap = {
            'investigation': 'var(--primary)',
            'homesick': 'var(--blue)',
            'gameover': 'var(--danger)',
            'victory': 'var(--green)'
        };
        $('end-title').style.color = colorMap[type] || 'var(--primary)';
        $('end-title').innerText = title;
        
        localStorage.removeItem(SAVE_KEY_AUTO); 
        localStorage.removeItem(SAVE_KEY_MANUAL);
    }

    function commitDonate() {
        const val = $('don-slider').value;
        const give = Math.floor(player.cash * (val/100));
        
        if (give <= 0) return;
        
        player.cash -= give;
        camp.funds += give;
        
        updateUI();
        saveGame('auto');
        showCustomModal(
            `<li class="change-item"><span class="change-name">个人存款</span> <span class="change-val val-down">-$${give}</span></li>` +
            `<li class="change-item"><span class="change-name">基地资金</span> <span class="change-val val-up">+$${give}</span></li>`,
            "捐赠成功",
            "你的慷慨解囊缓解了基地的财政压力。"
        );
        $('don-slider').value = 0;
    }

    function trainSkill(type) {
        if(player.energy < 3) return showMessage("状态不佳", "你精力不足，无法集中注意力。");
        
        let gain = randInt(1, 5);
        let changes = { energy: -3 };
        changes[type] = gain;
        applyChanges(changes); 

        let typeName = type==='med'?'医学':(type==='admin'?'行政':'社交');
        let listHtml = `<li class="change-item"><span class="change-name">${typeName}提升</span> <span class="change-val val-up">+${gain}</span></li>` +
                       `<li class="change-item"><span class="change-name">精力</span> <span class="change-val val-down">-3</span></li>`;
        showCustomModal(listHtml, "能力进修", "你投入了时间提升自我。");
        saveGame('auto');
    }

    function interactBoss(type) {
        if (type === 'network') {
            if (player.health < 10) return showMessage("状态不佳", "健康值不足，无法进行高强度社交。");
            let gain = randInt(5, 9) + Math.floor(player.soc * 0.1);
            applyChanges({ favor: gain, health: -10 }, "联络感情");
        } else if (type === 'fund') {
            if (player.favor < 30) return showMessage("请求被拒", "上级对你的信任不足(需30好感)。");
            let success = (Math.random() * 100) < player.favor;
            if (success) {
                let amount = 1000 + (player.soc * 50);
                applyChanges({ funds: amount, favor: -30 }, "请求资金");
            } else {
                applyChanges({ favor: -5 }, "请求资金(被拒)");
                showMessage("申请驳回", "上级认为目前不需要额外拨款。");
            }
        } else if (type === 'bribe') {
            if (player.cash < 500) return showMessage("资金不足", "贿赂需要 $500 个人存款。");
            applyChanges({ cash: -500, favor: 15, suspicion: 10 }, "私下贿赂");
        }
        saveGame('auto');
    }

    function applyForPromotion() {
        if (player.rankIndex >= 5) return showMessage("顶级", "你已达到最高职级。");
        
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;
        if (maxExamStreak < reqStreak) {
            return showMessage("条件不足", `当前职级晋升需要最高连胜达到 ${reqStreak} 次。`);
        }
        if (player.favor < 40) return showMessage("好感不足", "申请晋升需要消耗40点上级好感度。");

        player.rankIndex++;
        applyChanges({ favor: -40 }, "晋升成功");
        addAchievement(`第${Math.ceil(currentQuarter/4)}年: 晋升为 ${RANKS[player.rankIndex]}`);
        showMessage("职级晋升", `恭喜！你的晋升申请已获批准。现任职级：${RANKS[player.rankIndex]}。`);
        
        updateUI();
        saveGame('auto');
    }

    function processPromotion() {
        if (!player.appliedPromo) return;
        
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;
        let success = (maxExamStreak >= reqStreak);
        let logText = "";
        let resultHtml = "";
        
        if (success) {
            player.rankIndex++;
            logText = `恭喜！你的晋升申请通过了。现任职级：${RANKS[player.rankIndex]}。`;
            addAchievement(`第${Math.ceil(currentQuarter/4)}年: 晋升为 ${RANKS[player.rankIndex]}`);
            resultHtml = `<li class="change-item"><span class="change-name">职级</span> <span class="change-val val-up">晋升</span></li>`;
        } else {
            logText = `很遗憾，你的晋升申请被驳回。需在考核中证明自己(最高连胜>=${reqStreak})。`;
            resultHtml = `<li class="change-item"><span class="change-name">结果</span> <span class="change-val val-down">失败</span></li>`;
        }
        
        showCustomModal(resultHtml, "年度晋升考核", logText);
        player.appliedPromo = false;
        updateUI();
    }
    
    function addAchievement(text) {
        let li = document.createElement('li');
        li.className = 'achieve-item';
        li.innerText = text;
        $('achievement-list').appendChild(li);
    }

    // --- 核心循环 API ---

    async function callDeepSeek(prompt, isJson = false) {
        let apiKey = $('api-key').value;
        if (!apiKey || apiKey.trim() === "") apiKey = DEVELOPER_API_KEY; // Use hardcoded key if empty

        const apiUrl = $('api-url').value; 
        const model = $('model-name').value;
        const endpoint = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
        const body = { model: model, messages: [{ role: "system", content: "You are a game engine." }, { role: "user", content: prompt }], stream: false };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const err = await response.text();
            throw new Error(`API Error: ${response.status} - ${err}`);
        }

        const json = await response.json();
        let content = json.choices[0].message.content;
        content = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();

        if (isJson) return JSON.parse(content);
        return content;
    }

    async function generateStory() {
        $('gen-story-btn').disabled = true;
        $('gen-story-btn').innerText = "⏳ 正在整理档案...";
        $('story-container').style.display = 'block';

        const summary = historyLog.map(log => 
            `Q${log.day}: 遇到【${log.event}】。选择【${log.choice}】。结果：${log.isSuccess ? '成功' : '失败'}。后果：${log.resultText}`
        ).join("\n");

        const prompt = `你是一名${player.dept}医生，名叫${player.name}，最终职级${CONFIG.ranks[player.rankIndex]}。地点：${player.location}。请根据以下我的前线经历，以第一人称写一篇“战地日记”。\n经历记录：\n${summary}\n要求：情感真挚，体现无国界医生的精神与战争残酷。约300字。`;

        try {
            if($('use-mock').checked) { 
                await wait(1500); 
                $('story-content').innerText = "（模拟模式）日记生成演示：\n今天是个艰难的日子。雨一直在下...（请使用API Key获取完整AI生成故事）";
            } else {
                const story = await callDeepSeek(prompt, false);
                $('story-content').innerText = story;
            }
        } catch(e) {
            $('story-content').innerText = "生成失败: " + e.message;
        }
        $('gen-story-btn').innerText = "📖 生成战地日记 (回顾)";
        $('gen-story-btn').disabled = false;
    }

    async function generateBio() {
        const playerName = player.name || (player.lastName + player.firstName) || "医生";
        const prompt = `你是一个小说家。背景：${player.location} 的无国界医生(MSF)营地。人物：${playerName}，${player.gender}，科室：【${player.dept}】。参考数值：医学${player.med}，行政${player.admin}，社交${player.soc}。\n请生成一段约150字的人物介绍，内容必须紧扣其【${player.dept}】的专业背景，禁止出现具体数值，使用生活化阶梯描述。人物名字必须使用【${playerName}】。`;
        if($('use-mock').checked) { await wait(1000); return `（模拟模式）这里是前线。${playerName}作为一名${player.dept}医生，他冷静而果敢，专业技能是他在地狱中唯一的信仰。`; }
        return await callDeepSeek(prompt, false);
    }

    async function generateEventData() {
        const roll = Math.random() * 100;
        let eventType = "";
        let effectConstraints = "";

        if (roll < 40) {
            eventType = "外部危机";
            effectConstraints = "选项结果必须只影响【基地属性】：紧张度(tension)、资金(funds)(-500/1000/1500)、物资(supplies)(5-10)、净水(water)(5-10)。";
        } else if (roll < 70) {
            eventType = "内部危机";
            effectConstraints = "选项结果必须只影响【基地属性】：紧张度(tension)、资金(funds)(-500/1000/1500)、物资(supplies)(5-10)、净水(water)(5-10)。";
        } else if (roll < 90) {
            eventType = "个人危机";
            effectConstraints = "选项结果必须只影响【人物属性】：健康(health)（-5或+5）、精力(energy)（-5或+5）、金钱(cash)(-50/100/200/250)、能力(med/admin/soc)(2-5)、嫌疑度(suspicion)(-10到+10)。";
        } else {
            eventType = "幸运事件";
            effectConstraints = "请提供3个正面选项（可以3选1），每个选项增加随机一项【基地属性】或【人物属性】（数值=5），除了金钱(cash)(100/200/250)和资金(funds)(500/1000/1500)。";
        }
        
        const timeInfo = getSeasonInfo();
        const displayTime = `第${timeInfo.year}年 ${timeInfo.season}`;

        const contextPrompt = `
        背景：${player.location} (无国界医生前线)。当前时间：${displayTime}。
        事件类型要求：【${eventType}】。
        约束条件：${effectConstraints}
        玩家职位:${CONFIG.ranks[player.rankIndex]}。
        
        请生成一个符合类型的随机事件。
        要求：
        1. 必须包含3个选项。对于危机事件，其中1-2个为陷阱/无效选项；对于幸运事件，3个都是奖励。
        2. 返回纯JSON格式，不要Markdown代码块标记：
        {
            "type": "${eventType}：(具体名称)",
            "description": "...",
            "choices": [
                { "text": "...", "stat": "med/admin/soc", "result_win": "...", "result_lose": "...", "effects_win": {"key": value}, "effects_lose": {"key": value} }
            ]
        }
        注意：effects对象的key只能是: tension, funds, supplies, water, health, energy, cash, med, admin, soc, suspicion。
        `;
        
        if($('use-mock').checked) { await wait(1500); return mockEvent(eventType); }
        return await callDeepSeek(contextPrompt, true);
    }

    // --- 游戏循环 ---

    async function triggerNextQuarter() {
        player.stats.totalQuarters = (player.stats.totalQuarters || 0) + 1;
        player.stats.currentLocQuarters++;
        
        let report = [];
        const timeInfo = getSeasonInfo();
        const periodName = `第${timeInfo.year}年 ${timeInfo.season}`;

        // 增加调任逻辑 (第3年春开始开放)
        if(player.stats.totalQuarters >= 8) {
            addTransferButton();
        }
        
        // 1. 本季度结算：不再扣除个人生活费
        // player.cash -= 50;
        
        // 季度薪水发放
        const salary = RANK_SALARIES[player.rankIndex];
        player.cash += salary;
        report.push({ name: "季度薪水发放", val: `+$${salary}`, type: "up" });

        // 2. 基地资金消耗计算
        let fundCost = 1000 - (player.admin * 10) + (camp.tension * 10);
        if (fundCost < 0) fundCost = 100; // 最低消耗
        camp.funds -= fundCost;
        report.push({ name: "基地运营成本", val: `-$${fundCost}`, type: "down" });

        // 3. 难民自然增加
        const increaseRef = randInt(4, 8);
        const cap = BASE_LEVELS[camp.baseLevelIdx].cap;
        if(camp.refugees >= cap) {
            // 达到容量上限，增加紧张度
            camp.tension = Math.min(100, camp.tension + 5);
            report.push({ name: "难民数量已达上限", val: "紧张度 +5", type: "down" });
        } else {
            camp.refugees = Math.min(cap, camp.refugees + increaseRef);
            report.push({ name: "难民自然变动", val: `+${increaseRef}`, type: "up" });
        }
        
        // 物资与净水自然衰减：随机(3-6)
        const decaySupplies = randInt(3, 6);
        const decayWater = randInt(3, 6);
        camp.supplies = Math.max(0, camp.supplies - decaySupplies);
        camp.water = Math.max(0, camp.water - decayWater);
        report.push({ name: "物资自然损耗", val: `-${decaySupplies}%`, type: "down" });
        report.push({ name: "净水自然损耗", val: `-${decayWater}%`, type: "down" });
        
        // 病人生命指征衰减
        let deathCount = 0;
        patients.forEach(p => {
            if(p.isDead) return;
            // 衰减量：轻症5-10，中症10-15，重症15-20
            const decayRanges = [[5,10], [10,15], [15,20]];
            const [min, max] = decayRanges[p.sev];
            const decay = randInt(min, max);
            p.vital = (p.vital || 60) - decay;
            
            if(p.vital <= 0) {
                p.vital = 0;
                p.isDead = true;
                player.stats.deaths = (player.stats.deaths || 0) + 1;
                deathCount++;
            }
            p.treatCount = 0;
        });
        if(deathCount > 0) report.push({ name: "病患死亡数", val: `-${deathCount}`, type: "down" });

        // 检查延迟触发的"救人的回报"事件
        if(pendingSpecialPatientReward > 0) {
            pendingSpecialPatientReward--;
            if(pendingSpecialPatientReward === 0) {
                const rewardEvent = SPECIAL_EVENTS.find(e => e.id === 'patient_reward');
                if(rewardEvent) {
                    await triggerSpecialEvent(rewardEvent);
                }
            }
        }

        // 触发特殊事件
        await checkSpecialEvents();

        if (!checkGameOver()) return;
        
        // 4. 基地季度拨款 +2000
        camp.funds += 2000;
        report.push({ name: "总部季度拨款", val: "+$2000", type: "up" });
        
        // 5. 身心自动恢复 +10
        player.health = Math.min(100, player.health + 10);
        player.energy = Math.min(100, player.energy + 10);
        report.push({ name: "身心自动恢复", val: "+10", type: "up" });
        
        // 被遗忘的孤儿季度结算额外效果：精力 +2
        if(player.stats.hasForgottenOrphan) {
            player.energy = Math.min(100, player.energy + 2);
            report.push({ name: "被遗忘的孤儿", val: "精力 +2", type: "up" });
        }

        // 6. 重置本季行动限制
        player.quarterlyActions = { running: 0, sleep: 0 };

        // 季度增加
        currentQuarter++;

        // 7. 嫌疑度自然衰减
        let susDecay = randInt(3, 7);
        player.suspicion = Math.max(0, player.suspicion - susDecay);
        
        // 危险度自然增长
        if ((currentQuarter - 1) % 4 === 0) { 
            dangerLevel += 5;
        }

        updateUI();
        
        if (player.appliedPromo && (currentQuarter - 2) % 4 === 3) {
            processPromotion();
        }

        if (!checkGameOver()) return;
        if (checkVictory()) return;
        
        if (player.suspicion >= 100) {
            if (player.investigationCount > 0) {
                endGameByInvestigation();
            } else {
                $('investigation-modal').style.display = 'flex';
            }
        } else {
            // 显示经营报告
            showQuarterlyReport(periodName, report);
            switchNav('event');
        }

        $('next-day-btn').style.display = 'none';
        $('next-quarter-msg').style.display = 'none';
        $('event-area').style.display = 'none';
        $('start-event-btn').style.display = 'block'; 
        isEventResolved = false;
        admittedCount = 0;
        hasRounded = false;
        hasTakenExam = false;
        if(!player.stats.quarterlyCured) player.stats.quarterlyCured = 0;
        player.stats.quarterlyCured = 0; // 重置本季度治愈人数

        saveGame('auto');
    }

    function showQuarterlyReport(period, reportData) {
        $('report-period').innerText = period + " 经营结余报告";
        const list = $('report-list');
        list.innerHTML = '';
        reportData.forEach(item => {
            const li = document.createElement('li');
            li.className = 'change-item';
            li.innerHTML = `<span class="change-name">${item.name}</span> <span class="change-val val-${item.type}">${item.val}</span>`;
            list.appendChild(li);
        });
        $('quarterly-report-modal').style.display = 'flex';
    }

    function addTransferButton() {
        if($('btn-transfer')) return;
        
        // 检查是否被"季候风的判决"事件阻止调任
        if(player.stats.transferBlocked === currentQuarter) {
            return; // 本季度无法调任
        }
        
        let btn = document.createElement('button');
        btn.id = 'btn-transfer';
        btn.innerText = "🚀 申请调任 (3年期满)";
        btn.onclick = () => {
            // 再次检查是否被阻止
            if(player.stats.transferBlocked === currentQuarter) {
                showMessage("无法调任", "由于季候风的判决，本季度无法申请调任。");
                return;
            }
            
            if(!player.stats.visitedLocs) player.stats.visitedLocs = [];
            player.stats.visitedLocs.push(player.location);
            let available = CHAR_LOCATIONS.filter(l => !player.stats.visitedLocs.includes(l));
            if(available.length === 0) available = CHAR_LOCATIONS; // Reset if all visited
            player.location = available[randInt(0, available.length-1)];
            player.stats.currentLocQuarters = 0;
            camp.baseLevelIdx = 0; // 基地重置
            btn.remove(); // Remove button after transfer
            $('game-location-display').innerText = '📍 ' + player.location;
            showMessage("调任成功", `你已前往 ${player.location}，职级已保留，需从头建设基地。`);
            updateUI();
        };
        $('tab-character').appendChild(btn);
    }
    
    // 特殊事件检查
    async function checkSpecialEvents() {
        // 80%概率触发特殊事件
        if(Math.random() > 0.8) {
            return; // 20%概率不触发任何特殊事件
        }
        
        // 初始化事件冷却记录
        if(!player.eventCooldowns) player.eventCooldowns = {};
        
        // 筛选出符合条件的特殊事件（排除延迟触发的事件patient_reward）
        let availableEvents = SPECIAL_EVENTS.filter(evt => {
            if(evt.id === 'patient_reward') return false;
            if(!evt.condition()) return false;
            
            // 检查冷却：如果事件在3个季度内触发过，则跳过
            const lastQuarter = player.eventCooldowns[evt.id];
            if(lastQuarter !== undefined && (currentQuarter - lastQuarter) < 3) {
                return false;
            }
            
            return true;
        });
        
        // 如果没有任何可用事件，强制选择无条件的事件（force_majeure, international_visit, visitors_from_afar），但也要检查冷却
        if(availableEvents.length === 0) {
            availableEvents = SPECIAL_EVENTS.filter(evt => {
                if(evt.id === 'patient_reward') return false;
                if(evt.id === 'force_majeure' || evt.id === 'international_visit' || evt.id === 'visitors_from_afar') {
                    const lastQuarter = player.eventCooldowns[evt.id];
                    if(lastQuarter !== undefined && (currentQuarter - lastQuarter) < 3) {
                        return false;
                    }
                    return true;
                }
                return false;
            });
        }
        
        // 确保至少有一个事件可选
        if(availableEvents.length === 0) {
            return; // 如果真的没有任何事件，跳过
        }
        
        // 按概率随机选择一个事件
        let totalWeight = 0;
        const weightedEvents = [];
        
        availableEvents.forEach(evt => {
            if(evt.chance > 0) {
                totalWeight += evt.chance;
                weightedEvents.push({ event: evt, weight: totalWeight });
            }
        });
        
        // 如果所有事件概率都是0，选择第一个
        if(weightedEvents.length === 0) {
            if(availableEvents.length > 0) {
                await triggerSpecialEvent(availableEvents[0]);
            }
            return;
        }
        
        // 随机选择一个事件
        const random = Math.random() * totalWeight;
        let selectedEvent = null;
        for(const item of weightedEvents) {
            if(random <= item.weight) {
                selectedEvent = item.event;
                break;
            }
        }
        
        // 如果随机选择失败，选择第一个可用事件
        if(!selectedEvent) {
            selectedEvent = availableEvents[0];
        }
        
        // 触发选中的特殊事件
        if(selectedEvent) {
            await triggerSpecialEvent(selectedEvent);
        }
    }
    
    async function triggerSpecialEvent(evt) {
        addLog(`⚡ 特殊事件：${evt.name}`);
        
        // 记录事件触发季度（用于冷却机制）
        // 被遗忘的孤儿等仅触发一次的事件不记录冷却，因为它们已经有自己的标记
        if(!player.eventCooldowns) player.eventCooldowns = {};
        if(!['forgotten_orphan', 'veteran_volunteer', 'yesterdays_phantom', 'silent_farewell', 'years_stitched_wound', 'observation_station_52'].includes(evt.id)) {
            player.eventCooldowns[evt.id] = currentQuarter;
        }
        
        if(evt.effect === 'transfer') {
            // 不可抗力：强制调任
            if(!player.stats.visitedLocs) player.stats.visitedLocs = [];
            player.stats.visitedLocs.push(player.location);
            let available = CHAR_LOCATIONS.filter(l => !player.stats.visitedLocs.includes(l));
            if(available.length === 0) {
                // 如果所有地点都访问过，重置列表
                player.stats.visitedLocs = [];
                available = CHAR_LOCATIONS;
            }
            const newLocation = available[randInt(0, available.length-1)];
            player.location = newLocation;
            player.stats.currentLocQuarters = 0;
            camp.baseLevelIdx = 0; // 基地重置
            $('game-location-display').innerText = '📍 ' + player.location;
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n你被调往 ${player.location}。`);
            updateUI();
        } 
        else if(evt.effect === 'promote') {
            // 青云直上：晋升1级
            player.rankIndex++;
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n你已晋升为 ${RANKS[player.rankIndex]}！`);
            updateUI();
        }
        else if(evt.effect === 'homesick') {
            // 羁泊欲穷年：显示选择弹窗
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--danger); margin-bottom:10px;" onclick="handleHomesickChoice('resign')">🏠 辞职回家</button>
                    <button class="modal-btn secondary" onclick="handleHomesickChoice('stay')">💪 坚守岗位</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'international_visit') {
            // 国际慰问：直接生效
            applyChanges({ tension: -10, supplies: 10, water: 10 }, "国际慰问");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n基地紧张度 -10，物资 +10，净水 +10。`);
            updateUI();
        }
        else if(evt.effect === 'winter_festival') {
            // 联欢晚会：显示选择弹窗
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--green); margin-bottom:10px;" onclick="handleWinterFestivalChoice('agree')">✅ 同意</button>
                    <button class="modal-btn secondary" onclick="handleWinterFestivalChoice('refuse')">❌ 拒绝</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'special_patient') {
            // 特殊病人：显示选择弹窗
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--blue); margin-bottom:10px;" onclick="handleSpecialPatientChoice('accept')">🏥 收下</button>
                    <button class="modal-btn secondary" onclick="handleSpecialPatientChoice('refuse')">❌ 拒绝</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'patient_reward') {
            // 救人的回报：直接生效
            applyChanges({ cash: 300, supplies: 10 }, "救人的回报");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n个人存款 +$300，基地物资 +10。`);
            updateUI();
        }
        else if(evt.effect === 'visitors_from_afar') {
            // 有朋自远方来：显示选择弹窗
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--green); margin-bottom:10px;" onclick="handleVisitorsChoice('accept')">😊 不亦说乎</button>
                    <button class="modal-btn secondary" onclick="handleVisitorsChoice('refuse')">❌ 拒绝</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'veteran_volunteer') {
            // 老兵志愿者加入：医学永久 +5，行政永久 +5（仅触发一次）
            player.stats.hasVeteranVolunteer = true;
            player.med = Math.min(100, player.med + 5);
            player.admin = Math.min(100, player.admin + 5);
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n医学永久 +5，行政永久 +5。`);
            updateUI();
        }
        else if(evt.effect === 'illegal_drug_scandal') {
            // 非法药物实验丑闻：消耗 15 精力进行公关，否则嫌疑度 +20
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--blue); margin-bottom:10px;" onclick="handleDrugScandalChoice('pr')">💼 进行公关 (精力-15)</button>
                    <button class="modal-btn secondary" onclick="handleDrugScandalChoice('ignore')">❌ 置之不理 (嫌疑度+20)</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'international_journalists') {
            // 国际记者团到访：基地资金 +2000，但营地紧张度 +5
            applyChanges({ funds: 2000, tension: 5 }, "国际记者团到访");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n基地资金 +$2000，但营地紧张度 +5（引起地方武装注意）。`);
            updateUI();
        }
        else if(evt.effect === 'candlelight_mass') {
            // 烛火下的弥撒：营地紧张度 -15，精力 +10，但物资 -2
            applyChanges({ tension: -15, energy: 10, supplies: -2 }, "烛火下的弥撒");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 -15，精力 +10，但物资 -2（消耗了蜡烛和饮水）。`);
            updateUI();
        }
        else if(evt.effect === 'yesterdays_phantom') {
            // 昨日的幻影：医学永久 +2，社交永久 +2，精力 -5（仅触发一次）
            player.stats.hasYesterdaysPhantom = true;
            player.med = Math.min(100, player.med + 2);
            player.soc = Math.min(100, player.soc + 2);
            applyChanges({ energy: -5 }, "昨日的幻影");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n精神共鸣，医学永久 +2，社交永久 +2，精力 -5。`);
            updateUI();
        }
        else if(evt.effect === 'crossing_redemption') {
            // 越线的救赎：选择救或弃
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--primary); margin-bottom:10px;" onclick="handleCrossingRedemptionChoice('save')">⚕️ 救他 (健康-10, 紧张度+20, 医学+10)</button>
                    <button class="modal-btn secondary" onclick="handleCrossingRedemptionChoice('abandon')">🚫 放弃 (紧张度-5, 精力-20)</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'forgotten_orphan') {
            // 被遗忘的孤儿：难民 +1，社交 -5，但每季度结算额外获得 精力 +2
            player.stats.hasForgottenOrphan = true;
            applyChanges({ refugees: 1, soc: -5 }, "被遗忘的孤儿");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n难民 +1，社交 -5，但每季度结算额外获得 精力 +2（心灵寄托）。`);
            updateUI();
        }
        else if(evt.effect === 'bloody_medal') {
            // 染血的勋章：接受或拒绝
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `⚡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--gold); margin-bottom:10px;" onclick="handleBloodyMedalChoice('accept')">💰 接受 (个人存款+$3000, 嫌疑度+30)</button>
                    <button class="modal-btn secondary" onclick="handleBloodyMedalChoice('refuse')">❌ 拒绝 (上级好感度+10, 紧张度+10)</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
        else if(evt.effect === 'monsoon_gift') {
            // 季候风的馈赠：净水补满，营地紧张度 -10，健康 +5
            camp.water = 100; // 净水补满
            applyChanges({ tension: -10, health: 5 }, "季候风的馈赠");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n净水补满，营地紧张度 -10，健康 +5。`);
            updateUI();
        }
        else if(evt.effect === 'silent_farewell') {
            // 沉默的告别：医学永久 +3，精力 -10（仅触发一次）
            player.stats.hasSilentFarewell = true;
            player.med = Math.min(100, player.med + 3);
            applyChanges({ energy: -10 }, "沉默的告别");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n见证生死，医学永久 +3，精力 -10。`);
            updateUI();
        }
        else if(evt.effect === 'last_cigarette') {
            // 最后的一支烟：上级好感度 +15，精力 +20
            applyChanges({ favor: 15, energy: 20 }, "最后的一支烟");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n羁绊加深，上级好感度 +15，精力 +20。`);
            updateUI();
        }
        else if(evt.effect === 'wire_wedding') {
            // 铁丝网外的婚礼：营地紧张度 -20，精力 +20，社交永久 +2
            player.soc = Math.min(100, player.soc + 2);
            applyChanges({ tension: -20, energy: 20 }, "铁丝网外的婚礼");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 -20，精力 +20，社交永久 +2。`);
            updateUI();
        }
        else if(evt.effect === 'thousand_heartbeat') {
            // 第1000次心跳：精力补满，上级好感度 +15，社交永久 +3
            player.soc = Math.min(100, player.soc + 3);
            player.energy = 100;
            applyChanges({ favor: 15 }, "第1000次心跳");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n精力补满，上级好感度 +15，社交永久 +3。`);
            updateUI();
        }
        else if(evt.effect === 'ruins_echo') {
            // 废墟上的回响：营地紧张度 -10，精力 -15，但社交永久 +2
            player.soc = Math.min(100, player.soc + 2);
            applyChanges({ tension: -10, energy: -15 }, "废墟上的回响");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 -10，精力 -15，但社交永久 +2。`);
            updateUI();
        }
        else if(evt.effect === 'buried_truth') {
            // 被掩埋的真相：基地资金 +2000，嫌疑度 +15
            applyChanges({ funds: 2000, suspicion: 15 }, "被掩埋的真相");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n基地资金 +$2000（揭露真相后的专项拨款），嫌疑度 +15。`);
            updateUI();
        }
        else if(evt.effect === 'horizon_dust') {
            // 地平线的尘烟：难民 +30，物资 -10，上级好感度 +10
            const cap = BASE_LEVELS[camp.baseLevelIdx].cap;
            const actualRefugees = Math.min(cap, camp.refugees + 30);
            camp.refugees = actualRefugees;
            applyChanges({ supplies: -10, favor: 10 }, "地平线的尘烟");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n难民 +30，物资 -10，上级好感度 +10。`);
            updateUI();
        }
        else if(evt.effect === 'deadly_silence') {
            // 致命的"静默期"：物资 +15，净水 +15，营地紧张度 -5
            applyChanges({ supplies: 15, water: 15, tension: -5 }, "致命的静默期");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n物资 +15，净水 +15，营地紧张度 -5。`);
            updateUI();
        }
        else if(evt.effect === 'years_stitched_wound') {
            // 岁月缝合的伤口：医学永久 +10，精力 +50，解锁成就【传承者】
            player.stats.hasYearsStitchedWound = true;
            player.med = Math.min(100, player.med + 10);
            applyChanges({ energy: 50 }, "岁月缝合的伤口");
            // 解锁成就
            if(!player.achievements.inheritor) {
                player.achievements.inheritor = true;
                addAchievement("传承者");
            }
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n医学永久 +10，精力 +50，解锁成就：【传承者】。`);
            updateUI();
        }
        else if(evt.effect === 'silent_game') {
            // 无声的博弈：营地紧张度 -10，精力 -10，社交永久 +3
            player.soc = Math.min(100, player.soc + 3);
            applyChanges({ tension: -10, energy: -10 }, "无声的博弈");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 -10，精力 -10，社交永久 +3。`);
            updateUI();
        }
        else if(evt.effect === 'monsoon_disease') {
            // 季风带来的疫症：健康 -10，物资 -10，难民人数 -20
            const actualRefugees = Math.max(0, camp.refugees - 20);
            camp.refugees = actualRefugees;
            applyChanges({ health: -10, supplies: -10 }, "季风带来的疫症");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n健康 -10，物资 -10，难民人数 -20。`);
            updateUI();
        }
        else if(evt.effect === 'bed7_sketch') {
            // 第7号床位的素描：精力补满，社交永久 +2，上级好感度 +10
            player.soc = Math.min(100, player.soc + 2);
            player.energy = 100;
            applyChanges({ favor: 10 }, "第7号床位的素描");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n精力补满，社交永久 +2，上级好感度 +10。`);
            updateUI();
        }
        else if(evt.effect === 'thousand_one_story') {
            // 第一千零一个故事：精力补满，社交永久 +5，上级好感度 +5
            player.soc = Math.min(100, player.soc + 5);
            player.energy = 100;
            applyChanges({ favor: 5 }, "第一千零一个故事");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n精力补满，社交永久 +5，上级好感度 +5。`);
            updateUI();
        }
        else if(evt.effect === 'monsoon_judgment') {
            // 季候风的判决：无法申请调任（本季度），物资 -10，净水 +20
            player.stats.transferBlocked = currentQuarter; // 标记本季度无法调任
            applyChanges({ supplies: -10, water: 20 }, "季候风的判决");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n无法申请调任（本季度），物资 -10，净水 +20。`);
            updateUI();
        }
        else if(evt.effect === 'underground_clinic') {
            // 地下诊所的暗流：营地紧张度 +15，难民 -10，嫌疑度 +5
            const actualRefugees = Math.max(0, camp.refugees - 10);
            camp.refugees = actualRefugees;
            applyChanges({ tension: 15, suspicion: 5 }, "地下诊所的暗流");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 +15，难民 -10，嫌疑度 +5。`);
            updateUI();
        }
        else if(evt.effect === 'silent_delivery') {
            // 寂静的产房：难民 -5，精力 -20
            const actualRefugees = Math.max(0, camp.refugees - 5);
            camp.refugees = actualRefugees;
            applyChanges({ energy: -20 }, "寂静的产房");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n难民 -5，精力 -20。`);
            updateUI();
        }
        else if(evt.effect === 'vanished_bloodbank') {
            // 消失的血库：所有病人诊疗进度 -20%，营地紧张度 +10
            patients.forEach(p => {
                if(!p.isDead) {
                    p.prog = Math.max(0, p.prog - 20);
                }
            });
            applyChanges({ tension: 10 }, "消失的血库");
            renderPatients();
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n所有病人诊疗进度 -20%，营地紧张度 +10。`);
            updateUI();
        }
        else if(evt.effect === 'betrayed_coordinates') {
            // 被出卖的坐标：健康 -20，基地资金 -2000，嫌疑度 -10（总部因此事停止调查）
            applyChanges({ health: -20, funds: -2000, suspicion: -10 }, "被出卖的坐标");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n健康 -20，基地资金 -$2000，嫌疑度 -10（总部因此事停止调查）。`);
            updateUI();
        }
        else if(evt.effect === 'ashes_peace') {
            // 灰烬中的和平协议：营地紧张度 -30，精力 +50
            applyChanges({ tension: -30, energy: 50 }, "灰烬中的和平协议");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 -30，精力 +50。`);
            updateUI();
        }
        else if(evt.effect === 'observation_station_52') {
            // 第52号观察站：医学永久 +5，精力 -10，获得成就【真理守望者】
            player.stats.hasObservationStation52 = true;
            player.med = Math.min(100, player.med + 5);
            applyChanges({ energy: -10 }, "第52号观察站");
            // 解锁成就
            if(!player.achievements.truth_keeper) {
                player.achievements.truth_keeper = true;
                addAchievement("真理守望者");
            }
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n医学永久 +5，精力 -10，获得成就：【真理守望者】。`);
            updateUI();
        }
        else if(evt.effect === 'wire_market') {
            // 铁丝网下的市集：基地资金 +1000，物资 -5，嫌疑度 +10
            applyChanges({ funds: 1000, supplies: -5, suspicion: 10 }, "铁丝网下的市集");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n基地资金 +$1000，物资 -5，嫌疑度 +10。`);
            updateUI();
        }
        else if(evt.effect === 'desert_mirage') {
            // 沙漠里的"海市蜃楼"：营地紧张度 +20，精力 -10
            applyChanges({ tension: 20, energy: -10 }, "沙漠里的海市蜃楼");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 +20，精力 -10。`);
            updateUI();
        }
        else if(evt.effect === 'borderless_funeral') {
            // 无国界的葬礼：社交永久 +5，上级好感度 +15，精力补满
            player.soc = Math.min(100, player.soc + 5);
            player.energy = 100;
            applyChanges({ favor: 15 }, "无国界的葬礼");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n社交永久 +5，上级好感度 +15，精力补满。`);
            updateUI();
        }
        else if(evt.effect === 'delayed_olive_branch') {
            // 被延迟的"橄榄枝"：死亡人数 +1，营地紧张度 +10，精力 -15
            player.stats.deaths = (player.stats.deaths || 0) + 1;
            applyChanges({ tension: 10, energy: -15 }, "被延迟的橄榄枝");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n死亡人数 +1，营地紧张度 +10，精力 -15。`);
            updateUI();
        }
        else if(evt.effect === 'dawn_silence') {
            // 这里的黎明静悄悄：营地紧张度 -10，精力 -20，社交永久 +3
            player.soc = Math.min(100, player.soc + 3);
            applyChanges({ tension: -10, energy: -20 }, "这里的黎明静悄悄");
            showMessage(`⚡ ${evt.name}`, `${evt.desc}\n\n营地紧张度 -10，精力 -20，社交永久 +3。`);
            updateUI();
        }
    }
    
    function handleHomesickChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'resign') {
            // 触发"归乡"结局
            endGame('homesick', '归乡', '你选择了回到故乡。也许前线需要你，但家人更需要你。在漫长的旅途中，你回望这片土地，心中五味杂陈。你的医疗生涯就此告一段落，但生活还在继续。');
        } else {
            // 坚守岗位：降低10点能力
            player.med = Math.max(0, player.med - 10);
            player.admin = Math.max(0, player.admin - 10);
            player.soc = Math.max(0, player.soc - 10);
            showMessage("坚守岗位", "你压下了内心的思念，选择继续留在这里。但这个夜晚在你心中留下了伤痕。\n\n医学、行政、社交能力各 -10");
            updateUI();
        }
        
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function handleWinterFestivalChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'agree') {
            applyChanges({ supplies: -10, tension: -10, energy: 10 }, "联欢晚会");
            showMessage("联欢晚会", "不分国籍和肤色，人们在篝火下其乐融融，你知道希望是最珍贵的东西。\n\n物资 -10，紧张度 -10，精力 +10。");
        } else {
            showMessage("联欢晚会", "人们失望地度过了又一个艰难的冬天。");
        }
        
        updateUI();
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function handleSpecialPatientChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'accept') {
            // 添加一位重症病人
            const wardCap = WARD_CAPS[camp.wardLevel];
            const maxCap = BASE_LEVELS[camp.baseLevelIdx].wardCap;
            if(patients.length >= wardCap || patients.length >= maxCap) {
                showMessage("提示", "病房已满，无法收治。");
            } else {
                const bedNum = findEmptyBed(maxCap);
                const age = randInt(0, 75);
                const gender = Math.random() > 0.5 ? "男" : "女";
                const sev = 2; // 重症
                
                const newPatient = {
                    bed: bedNum,
                    name: "特殊病人",
                    age: age,
                    gender: gender,
                    sev: sev,
                    prog: 0,
                    vital: 20, // 重症初始生命指征
                    treatCount: 0,
                    isDead: false,
                    cc: "生成中...",
                    hpi: "生成中..."
                };
                
                patients.push(newPatient);
                patients.sort((a,b) => a.bed - b.bed);
                renderPatients();
                updateUI();
                
                // API Call for text - 调用API生成主诉和现病史
                try {
                    const prompt = `生成一个无国界医生前线病人病例。
                    科室:${player.dept}。病人:${age}岁${gender}，危急度:重症。
                    请返回JSON格式: {"cc":"主诉(20字内)", "hpi":"现病史(70字左右)"}`;
                    
                    callDeepSeek(prompt, true).then(res => {
                        newPatient.cc = res.cc;
                        newPatient.hpi = res.hpi;
                        renderPatients();
                    });
                } catch(e) {
                    newPatient.cc = "腹痛伴发热3天";
                    newPatient.hpi = "患者3天前无明显诱因出现腹痛，伴发热，最高体温38.5度。";
                    renderPatients();
                }
                
                // 设置3个季度后触发"救人的回报"
                pendingSpecialPatientReward = 3;
                showMessage("特殊病人", "家属对你叠声感谢。你收治了这位重症病人。");
                saveGame('auto');
            }
        } else {
            applyChanges({ tension: 5 }, "拒绝收治");
            showMessage("特殊病人", "家属带着病人失望地离去了。\n\n紧张度 +5。");
        }
        
        updateUI();
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function handleVisitorsChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'accept') {
            // 不亦说乎：基地紧张度降低10，物资-5
            applyChanges({ tension: -10, supplies: -5 }, "有朋自远方来");
            showMessage("有朋自远方来", "你热情地接待了这些客人，虽然语言不通，但通过手势和微笑，你们建立了友谊。\n\n基地紧张度 -10，物资 -5。");
        } else {
            // 拒绝：增加紧张度
            applyChanges({ tension: 5 }, "拒绝接待");
            showMessage("有朋自远方来", "你拒绝了这些客人的到访，他们失望地离开了。\n\n紧张度 +5。");
        }
        
        updateUI();
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function handleDrugScandalChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'pr') {
            // 进行公关：消耗15精力
            if(player.energy < 15) {
                showMessage("精力不足", "你的精力不足以进行公关。嫌疑度 +20。");
                player.suspicion += 20;
            } else {
                applyChanges({ energy: -15 }, "进行公关");
                showMessage("非法药物实验丑闻", "你花费大量精力进行公关，成功澄清了谣言。");
            }
        } else {
            // 置之不理：嫌疑度 +20
            player.suspicion += 20;
            showMessage("非法药物实验丑闻", "你没有进行公关，谣言持续发酵。嫌疑度 +20。");
        }
        
        updateUI();
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function handleCrossingRedemptionChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'save') {
            // 救他：健康 -10，紧张度 +20，医学 +10
            player.med = Math.min(100, player.med + 10);
            applyChanges({ health: -10, tension: 20 }, "越线的救赎");
            showMessage("越线的救赎", "你选择了救他，尽管这可能会招来报复。健康 -10，紧张度 +20，医学 +10。");
        } else {
            // 放弃：紧张度 -5，精力 -20
            applyChanges({ tension: -5, energy: -20 }, "越线的救赎");
            showMessage("越线的救赎", "你选择放弃，但内心的愧疚让你难以平静。紧张度 -5，精力 -20。");
        }
        
        updateUI();
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function handleBloodyMedalChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'accept') {
            // 接受：个人存款 +3000，嫌疑度 +30
            applyChanges({ cash: 3000, suspicion: 30 }, "染血的勋章");
            showMessage("染血的勋章", "你接受了勋章，但也接受了这个交易。个人存款 +$3000，嫌疑度 +30。");
        } else {
            // 拒绝：上级好感度 +10，紧张度 +10
            applyChanges({ favor: 10, tension: 10 }, "染血的勋章");
            showMessage("染血的勋章", "你拒绝了勋章，坚持了原则。上级好感度 +10，紧张度 +10。");
        }
        
        updateUI();
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function renderEvent(data) {
        $('loading-spinner').style.display = 'none';
        $('event-area').style.display = 'block';
        $('event-tag').innerText = data.type;
        $('event-desc').innerText = data.description;
        const c = $('choices-container');
        c.innerHTML = '';
        data.choices.forEach(choice => {
            let btn = document.createElement('button');
            btn.className = 'choice-btn';
            let statName = choice.stat === 'med' ? '医学' : (choice.stat === 'admin' ? '行政' : '社交');
            btn.innerHTML = `<strong>> ${choice.text}</strong> <span style="font-size:0.8em; color:var(--accent)">[检定:${statName}]</span>`;
            btn.onclick = () => resolveEvent(choice, data.type);
            c.appendChild(btn);
        });
    }

    function resolveEvent(choice, eventType) {
        let threshold = 9 + (dangerLevel / 5);
        const statVal = player[choice.stat] || 0;
        const roll = Math.random() * 10;
        const score = (statVal * 0.1) + roll;
        const isSuccess = score >= threshold;

        const finalEffects = isSuccess ? choice.effects_win : choice.effects_lose;
        const finalResultText = isSuccess ? choice.result_win : choice.result_lose;
        
        applyChanges(finalEffects);
        historyLog.push({ day: currentQuarter, event: eventType, choice: choice.text, isSuccess: isSuccess, resultText: finalResultText });

        const statusText = isSuccess ? `✅ 检定成功` : `❌ 检定失败`;
        const statusClass = isSuccess ? "status-success" : "status-fail";
        showResultModal(finalEffects, "事件结算", finalResultText, statusText, statusClass);
        
        isEventResolved = true;
        $('event-area').style.display = 'none';
        $('next-day-btn').style.display = 'block'; 
        $('next-quarter-msg').style.display = 'block';
        
        checkGameOver();
        saveGame('auto');
    }

    function mockEvent(type) {
        let desc = "突发情况：";
        let c = [];
        if (type.includes("外部") || type.includes("内部")) {
             desc += "由于战乱，一批难民涌入，导致物资紧张。";
             c = [
                 { text: "紧急调配", stat: "admin", result_win: "物资重新分配。", result_lose: "引发混乱。", effects_win: {tension:-5}, effects_lose: {tension:5, supplies:-10} },
                 { text: "安抚情绪", stat: "soc", result_win: "大家冷静下来。", result_lose: "没人听你的。", effects_win: {tension:-10}, effects_lose: {energy:-5} },
                 { text: "医疗支援", stat: "med", result_win: "防止了疫情。", result_lose: "药品耗尽。", effects_win: {health:2}, effects_lose: {supplies:-20} }
             ];
        } else if (type.includes("个人")) {
            desc += "你感到身体不适，可能是过度劳累。";
            c = [
                { text: "自我诊断", stat: "med", result_win: "只是小感冒。", result_lose: "误诊加重。", effects_win: {health:2}, effects_lose: {health:-5} },
                { text: "坚持工作", stat: "admin", result_win: "工作完成了。", result_lose: "晕倒在岗位。", effects_win: {cash:50}, effects_lose: {health:-10} },
                { text: "找人倾诉", stat: "soc", result_win: "心情好多了。", result_lose: "被嫌弃烦。", effects_win: {energy:5}, effects_lose: {energy:-5} }
            ];
        } else {
            desc += "这是一个幸运的日子！";
            c = [
                { text: "捡到钱", stat: "admin", result_win: "运气不错。", result_lose: "运气不错。", effects_win: {cash:200}, effects_lose: {cash:200} },
                { text: "休息充足", stat: "med", result_win: "精力充沛。", result_lose: "精力充沛。", effects_win: {health:5}, effects_lose: {health:5} },
                { text: "收到感谢信", stat: "soc", result_win: "心情大好。", result_lose: "心情大好。", effects_win: {energy:5}, effects_lose: {energy:5} }
            ];
        }
        
        return {
            type: type,
            description: desc,
            choices: c
        };
    }

    function applyChanges(effects, reason = null) {
        let logParts = [];
        const map = { health: "健康", energy: "精力", supplies: "物资", water: "净水", tension: "紧张度", refugees: "难民", funds: "基地资金", favor: "好感", med:"医学", admin:"行政", soc:"社交", cash:"个人存款", suspicion:"嫌疑" };
        
        for(let key in effects) {
            let val = effects[key];
            if(val === 0) continue;
            
            if(player[key] !== undefined) {
                player[key] += val;
                // Clamp certain values
                if(['health', 'energy', 'med', 'admin', 'soc'].includes(key)) {
                    player[key] = Math.max(0, Math.min(100, player[key]));
                }
            }
            if(camp[key] !== undefined) {
                camp[key] += val;
                if(['supplies', 'water', 'tension'].includes(key)) {
                    camp[key] = Math.max(0, Math.min(100, camp[key]));
                }
            }
            
            let displayVal = (key === 'funds' || key === 'cash') ? '$' + val : val;
            logParts.push(`${map[key]||key} ${val>0?'+':''}${displayVal}`);
        }
        
        if (logParts.length > 0 && reason) {
            showMessage(reason, logParts.join("，"));
        }
        updateUI();
    }

    function showResultModal(effects, title, description, statusText, statusClass) {
        const list = $('result-list');
        list.innerHTML = '';
        if (statusText) {
            $('result-status').innerText = statusText;
            $('result-status').className = statusClass || "";
            $('result-status').style.display = 'block';
        } else {
            $('result-status').style.display = 'none';
        }
        $('result-text').innerText = description;
        
        let hasContent = false;
        const map = { health: "健康", energy: "精力", supplies: "物资", water: "净水", tension: "紧张度", refugees: "难民", funds: "基地资金", favor: "上级好感", med:"医学", admin:"行政", soc:"社交", cash:"个人存款", suspicion:"嫌疑" };
        for(let key in effects) {
            let val = effects[key];
            if(val === 0) continue;
            hasContent = true;
            let isGood = (key === 'tension' || key === 'suspicion') ? val < 0 : val > 0;
            if(key === 'funds' && val < 0) isGood = false;
            
            let li = document.createElement('li');
            li.className = 'change-item';
            let displayVal = Math.abs(val);
            if (key === 'funds' || key === 'cash') displayVal = '$' + displayVal;
            
            li.innerHTML = `<span class="change-name">${map[key]||key}</span><span class="change-val ${isGood?'val-up':'val-down'}">${val>0?'+':'-'}${displayVal}</span>`;
            list.appendChild(li);
        }
        if(!hasContent) list.innerHTML = '<li class="change-item">无显著数值变化</li>';
        
        $('result-modal').querySelector('.modal-header').innerText = title;
        $('result-modal').style.display = 'flex';
    }

    function doTrainingAction(type) {
        if(!player.quarterlyActions) player.quarterlyActions = { running: 0, sleep: 0 };
        
        if(type === 'running') {
            if(player.quarterlyActions.running >= 1) return showMessage("提示", "本季度已跑过步了。");
            player.quarterlyActions.running++;
            applyChanges({ health: 5 }, "跑步健身");
        } else if(type === 'sleep') {
            if(player.quarterlyActions.sleep >= 1) return showMessage("提示", "本季度已睡过好觉了。");
            player.quarterlyActions.sleep++;
            applyChanges({ energy: 5 }, "睡个好觉");
        }
        saveGame('auto');
    }
    
    function showCustomModal(html, title, description) {
        $('result-status').style.display = 'none'; 
        $('result-text').innerText = description;
        $('result-list').innerHTML = html;
        $('result-modal').querySelector('.modal-header').innerText = title;
        $('result-modal').style.display = 'flex';
    }

    function closeModal() {
        $('result-modal').style.display = 'none';
        checkGameOver();
    }

    function checkGameOver() {
        let reason = null;
        if(camp.tension >= 100) reason = "营地暴动，武装分子接管了这里。";
        else if(camp.supplies <= 0) reason = "物资耗尽，营地崩溃。";
        else if(camp.water <= 0) reason = "水源枯竭，疫情失控。";
        else if(camp.funds <= 0) reason = "基地资金断裂，项目被迫关停。";
        else if(player.cash < 0) reason = "个人破产，无法维持生计，被迫回国。";
        else if(player.health <= 0) reason = "你在岗位上倒下了。";
        else if(player.energy <= 0) reason = "你的精力彻底透支。";
        
        if(reason) {
            $('game-screen').classList.remove('active');
            $('end-screen').classList.add('active');
            $('bottom-nav').style.display = 'none';
            $('end-reason').innerText = reason;
            $('end-title').style.color = "var(--primary)";
            $('end-title').innerText = "行动失败";
            localStorage.removeItem(SAVE_KEY_AUTO);
            return false;
        }
        return true;
    }

    function checkVictory() {
        if (player.rankIndex === 5) {
            quartersSinceRank6++;
        }
        
        if (player.rankIndex === 5 && quartersSinceRank6 >= 3 && !isVictoryPending) {
             $('game-screen').classList.remove('active');
             $('end-screen').classList.add('active');
             $('bottom-nav').style.display = 'none';
             $('end-title').style.color = "var(--green)";
             $('end-title').innerText = "光荣退休";
             $('end-reason').innerText = `你已成为区域总筹并稳定维持了局势。你是非凡的指挥官。`;
             $('continue-game-area').style.display = 'block';
             localStorage.removeItem(SAVE_KEY_AUTO); 
             return true;
        }
        return false;
    }

    function continueGame() {
        isVictoryPending = true; 
        $('end-screen').classList.remove('active');
        $('game-screen').classList.add('active');
        $('bottom-nav').style.display = 'grid';
        saveGame('auto'); 
        switchNav('event');
    }
</script>

</body>
</html>