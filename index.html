<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ— å›½ç•ŒåŒ»ç”Ÿï¼šå‰çº¿æŒ‡æŒ¥å®˜ (DeepSeek R1ç‰ˆ)</title>
    <style>
        /* æ—¥å¤œæ¨¡å¼å˜é‡å®šä¹‰ */
        :root {
            /* å¤œé—´æ¨¡å¼ (é»˜è®¤) */
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
            --primary: #ff4d4d;
            --accent: #d35400;
            --green: #2ecc71;
            --blue: #3498db;
            --gold: #f1c40f;
            --purple: #9b59b6;
            --border: #333;
            --input-bg: #2d2d2d;
            --bio-bg: #2a2520;
            --bio-text: #bdc3c7;
            --hover: #333;
            --danger: #e74c3c;
            --nav-height: 60px;
        }

        /* æ—¥é—´æ¨¡å¼ç±» */
        body:not(.night-mode) { /* é»˜è®¤æ”¹ä¸ºæ—¥é—´æ¨¡å¼é€»è¾‘ */
            --bg: #fdf6e3;
            --panel: #ffffff;
            --text: #333333;
            --primary: #EE0000;
            --accent: #e67e22;
            --green: #27ae60;
            --blue: #2980b9;
            --gold: #f39c12;
            --purple: #8e44ad;
            --border: #ddd;
            --input-bg: #eee;
            --bio-bg: #fff8e1;
            --bio-text: #5d4037;
            --hover: #fffdf5;
            --danger: #c0392b;
        }
        body.night-mode { /* åˆ‡æ¢ç±»æ”¹ä¸ºå¤œé—´ */
            --bg: #121212;
            --panel: #1e1e1e;
            --text: #e0e0e0;
            --primary: #ff4d4d;
            --accent: #d35400;
            --green: #2ecc71;
            --blue: #3498db;
            --gold: #f1c40f;
            --purple: #9b59b6;
            --border: #333;
            --input-bg: #2d2d2d;
            --bio-bg: #2a2520;
            --bio-text: #bdc3c7;
            --hover: #333;
            --danger: #e74c3c;
        }

        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; transition: background 0.3s, color 0.3s; padding-bottom: var(--nav-height); }
        .container { max-width: 800px; margin: 0 auto; background: var(--panel); padding: 20px; min-height: 100vh; box-sizing: border-box; position: relative; }
        
        /* å¤´éƒ¨ä¸çŠ¶æ€ */
        header { border-bottom: 3px solid var(--primary); padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; flex-direction: column; gap: 5px; }
        
        .system-btns { display: flex; gap: 8px; margin-bottom: 5px; }
        .sys-btn { padding: 4px 8px; font-size: 0.8rem; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 4px; }
        .sys-btn:hover { background: var(--accent); color: white; }

        h1 { margin: 0; font-size: 1.6rem; color: var(--text); }
        #game-location-display { font-size: 0.95rem; color: var(--accent); font-weight: bold; margin-top: 5px; display: none; animation: fadeIn 1s; }
        
        .day-counter { background: var(--border); color: var(--text); padding: 5px 10px; border-radius: 4px; font-weight: bold; height: fit-content; border: 1px solid var(--text); min-width: 80px; text-align: center; }

        /* ç•Œé¢åˆ‡æ¢ */
        .screen { display: none; animation: fadeIn 0.5s; padding-bottom: 20px; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* åŠ è½½ç•Œé¢ */
        #loading-screen { text-align: center; padding-top: 50px; }
        .loader-content { display: inline-block; text-align: left; background: #000; color: #0f0; padding: 20px; border-radius: 5px; font-family: 'Courier New', Courier, monospace; width: 80%; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .loader-spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .log-line { margin: 5px 0; opacity: 0; animation: typeIn 0.5s forwards; }
        @keyframes typeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* æŒ‰é’®ä½“ç³» */
        button { background: var(--border); color: var(--text); border: none; padding: 12px 18px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-bottom: 8px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); background: var(--primary); color: white; }
        button:disabled { background: #555; cursor: not-allowed; transform: none; color: #888; }
        
        .action-btn { width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; background: var(--panel); border: 1px solid var(--border); }
        .action-btn:hover { background: var(--hover); }
        
        .skill-btn { background: var(--accent); color: white; width: 100%; }
        .rest-btn { background: var(--green); color: white; width: 100%; margin-top: 15px; font-weight: bold; }
        
        .choice-btn { 
            background: var(--panel); color: var(--text); border: 2px solid var(--border); width: 100%; text-align: left; padding: 18px; margin-bottom: 12px;
            transition: all 0.2s;
        }
        .choice-btn:hover { border-color: var(--accent); background: var(--hover); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .input-group { background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: var(--text); }
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 10px; margin-top: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; background: var(--panel); color: var(--text); }

        /* Slider æ ·å¼ */
        .slider-container { background: var(--input-bg); padding: 10px; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 8px; }
        input[type=range] { width: 100%; margin: 10px 0; }
        .slider-val { float: right; font-weight: bold; color: var(--gold); }

        /* æ•°å€¼æ¡ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--input-bg); padding: 12px; border-radius: 6px; border-left: 4px solid var(--accent); position: relative; }
        .bar-bg { background: #555; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; background: var(--accent); width: 50%; transition: width 0.5s ease-out; }
        .bar-fill.high { background: var(--green); }
        .bar-fill.low { background: var(--primary); }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: var(--panel); border-top: 1px solid var(--border);
            display: grid; grid-template-columns: repeat(7, 1fr); /* 7ä¸ªTab */
            z-index: 999; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }
        .nav-item {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; color: #888; font-size: 0.7rem; transition: 0.2s; padding: 2px 0;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; background: rgba(255,255,255,0.05); }
        .nav-icon { font-size: 1.2rem; margin-bottom: 2px; }

        /* å†…å®¹åŒºåŸŸ */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        .bio-box { background: var(--bio-bg); padding: 15px; border-radius: 6px; font-style: italic; color: var(--bio-text); line-height: 1.6; margin-bottom: 20px; border: 1px dashed var(--border); }

        .rank-card {
            background: linear-gradient(135deg, var(--input-bg), var(--panel));
            border: 2px solid var(--gold); border-radius: 8px; padding: 15px;
            margin-bottom: 20px; text-align: center;
        }
        .rank-title { font-size: 1.4rem; font-weight: bold; color: var(--gold); margin-bottom: 5px; }
        .rank-progress { font-size: 0.9rem; color: #888; margin-bottom: 10px; }
        .rank-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

        /* å•†åº—ç‰©å“ Grid */
        .item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card { background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .item-name { font-weight: bold; color: var(--accent); margin-bottom: 5px; font-size: 1rem; }
        .item-price { color: var(--gold); font-weight: bold; margin-bottom: 5px; }
        .item-desc { font-size: 0.8em; color: #aaa; margin-bottom: 10px; height: 3em; overflow: hidden; }
        .buy-btn { width: 100%; padding: 8px; font-size: 0.9rem; background: var(--border); color: var(--text); }
        .buy-btn:not(:disabled):hover { background: var(--green); color: white; }

        #event-area { background: var(--panel); border: 1px solid var(--border); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .event-tag { display: inline-block; background: var(--primary); color: white; padding: 3px 8px; font-size: 0.8rem; border-radius: 4px; margin-bottom: 10px; text-transform: uppercase; }
        .event-text { line-height: 1.8; color: var(--text); font-size: 1.05rem; margin-bottom: 25px; text-align: justify; }
        .loading-spinner { text-align: center; padding: 40px; color: #888; display: none; }

        /* ç—…æˆ¿æ ·å¼ */
        .patient-card { background: var(--input-bg); border-left: 4px solid #888; padding: 10px; margin-bottom: 10px; border-radius: 4px; position: relative; }
        .p-sev-0 { border-color: var(--green); }
        .p-sev-1 { border-color: var(--gold); }
        .p-sev-2 { border-color: var(--danger); }
        .p-header { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; }
        .p-info { font-size: 0.9rem; color: #bbb; margin-bottom: 5px; }
        .p-desc { font-size: 0.85rem; font-style: italic; color: #888; margin-bottom: 8px; }
        .p-actions { display: flex; gap: 5px; margin-top: 5px; }
        .p-btn { padding: 4px 8px; font-size: 0.8rem; flex: 1; }

        /* è€ƒæ ¸æ ·å¼ */
        .exam-box { background: var(--input-bg); padding: 15px; border: 1px solid var(--border); border-radius: 8px; }
        .exam-q { font-size: 1.1rem; margin-bottom: 15px; font-weight: bold; }
        .exam-opt { width: 100%; text-align: left; margin-bottom: 8px; padding: 10px; border: 1px solid var(--border); background: var(--panel); color: var(--text); }
        .exam-opt:hover { border-color: var(--blue); }
        .streak-badge { background: var(--gold); color: #000; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em; margin-left: 10px; }

        /* å¼¹çª—é€šç”¨æ ·å¼ */
        .custom-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 2000; display: none;
            justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: var(--panel); width: 90%; max-width: 400px; padding: 0; 
            border-radius: 10px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: popIn 0.3s; border: 1px solid var(--border); color: var(--text); position: relative; max-height: 90vh; overflow-y: auto;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { background: var(--input-bg); color: var(--text); padding: 15px; text-align: center; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid var(--border); }
        .modal-body { padding: 20px; text-align: center; }
        
        #result-status { font-weight: bold; font-size: 1.2rem; text-align: center; margin-bottom: 10px; }
        .status-success { color: var(--green); }
        .status-fail { color: var(--primary); }

        #result-text, .msg-text { font-style: italic; color: var(--text); opacity: 0.9; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); line-height: 1.5; }

        .change-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .change-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 1.1rem; }
        .change-val { font-weight: bold; }
        .val-up { color: var(--green); }
        .val-down { color: var(--primary); }
        .modal-btn { width: 100%; padding: 15px; background: var(--primary); border-radius: 0; margin: 0; font-size: 1.1rem; color: white; cursor: pointer; border: none; }
        .modal-btn:hover { opacity: 0.9; }
        .modal-btn.secondary { background: var(--border); color: var(--text); }
        
        .save-slot-btn { 
            display: block; width: 100%; text-align: left; margin-bottom: 10px; 
            background: var(--input-bg); border: 1px solid var(--border); padding: 15px;
            border-radius: 6px; cursor: pointer;
        }
        .save-slot-btn:hover { border-color: var(--accent); }
        .save-meta { font-size: 0.8em; color: #888; margin-top: 5px; }

        #start-event-btn { 
            width: 100%; margin-top: 15px; background: var(--accent); padding: 15px; 
            font-size: 1.1rem; font-weight: bold; display: none; color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(230, 126, 34, 0); } 100% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); } }

        #story-container {
            margin-top: 20px; text-align: left;
            border: 1px solid var(--border); background: var(--input-bg);
            padding: 15px; border-radius: 6px; display: none;
        }
        #story-content {
            font-family: 'Georgia', serif; line-height: 1.8; white-space: pre-wrap;
            max-height: 300px; overflow-y: auto; color: var(--text);
        }
        #gen-story-btn {
            background: var(--accent);
            width: 100%; margin-top: 15px; padding: 15px;
            font-weight: bold; color: white;
        }

        .achieve-list { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 0; 
            list-style: none;
        }
        .achieve-item { 
            background: var(--input-bg); 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 5px solid var(--gold);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
        }
        .achieve-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text);
            margin-bottom: 4px;
        }
        .achieve-desc {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 8px;
        }
        .achieve-percent {
            font-size: 1rem;
            font-weight: bold;
            color: var(--gold);
        }
        .achieve-progress-box {
            margin-top: auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #setup-screen .input-group {
            margin-top: -10px; /* ä¸Šç§» */
        }
        .setup-header-row {
            font-size: 1.2rem; /* å¢å¤§å­—ä½“ */
            font-weight: bold;
            margin-bottom: 15px;
        }
        .setup-btn-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .setup-main-btn {
            width: 70%; /* ç¼©çª„ */
            padding: 12px;
            font-size: 1.1rem;
        }
    </style>
    <script src="test.js"></script>
</head>
<body>

<div class="container">
    <header>
        <div class="header-left">
            <div class="system-btns">
                <button class="sys-btn" id="exit-game-btn" onclick="tryExitGame()">ğŸšª é€€å‡º</button>
                <button class="sys-btn" onclick="openSettingsModal()">âš™ï¸ è®¾ç½®</button>
            </div>
            <h1>ğŸš‘ å‰çº¿æŒ‡æŒ¥å®˜ <span style="font-size:0.6em; color:#888">MSF</span></h1>
            <div id="game-location-display">ğŸ“ ???</div>
        </div>

        <div class="day-counter" id="day-display">ç¬¬1å¹´ æ˜¥</div>
    </header>

    <div id="setup-screen" class="screen active">
        <div class="story-intro" style="background:linear-gradient(135deg, rgba(44,62,80,0.95), rgba(52,73,94,0.9)); border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:20px; position:relative; overflow:hidden;">
            <div style="position:absolute; top:0; right:0; font-size:4rem; opacity:0.1; transform:translate(10%, -20%);">ğŸ¥</div>
            <h3 style="margin:0 0 15px 0; color:var(--gold); font-size:1.2rem; letter-spacing:2px;">ğŸ“œ æˆ˜åœ°æ¡£æ¡ˆ Â· åºç« </h3>
            <p style="font-size:0.95rem; line-height:1.9; color:#ccc; margin:0; text-align:justify; text-indent:2em;">
                æ­¥å…¥äºŒåä¸€ä¸–çºªï¼Œä¸–ç•Œå¹¶æœªå¦‚äººä»¬æœŸæœ›çš„é‚£æ ·èµ°å‘å’Œå¹³ã€‚åœ¨å—è‹ä¸¹çš„éš¾æ°‘è¥é‡Œï¼Œæªå£°ä¸å©´å„¿çš„å•¼å“­äº¤ç»‡ï¼›åœ¨ä¹Ÿé—¨çš„åºŸå¢Ÿé—´ï¼ŒåŒ»ç–—å¸ç¯·æ˜¯æ–¹åœ†ç™¾é‡Œå”¯ä¸€çš„å…‰ã€‚æ— å›½ç•ŒåŒ»ç”Ÿç»„ç»‡ï¼ˆMSFï¼‰çš„å¿—æ„¿è€…ä»¬ï¼Œç©¿æ¢­äºè¢«é—å¿˜çš„è§’è½ï¼Œç”¨å¬è¯Šå™¨å¯¹æŠ—ç‚®ç«ï¼Œä»¥æ‰‹æœ¯åˆ€å®ˆæŠ¤æœ€åçš„åº•çº¿ã€‚
            </p>
            <p style="font-size:0.95rem; line-height:1.9; color:#ccc; margin:15px 0 0 0; text-align:justify; text-indent:2em;">
                ä½ å³å°†æˆä¸ºä»–ä»¬ä¸­çš„ä¸€å‘˜ã€‚åœ¨èµ„æºåŒ®ä¹çš„å‰çº¿è¥åœ°ï¼Œä½ è¦æ•‘æ²»ä¼¤æ‚£ã€ç®¡ç†ç‰©èµ„ã€å®‰æŠšéš¾æ°‘ã€åº”å¯¹çªå‘å±æœºã€‚æ¯ä¸€ä¸ªå†³å®šéƒ½å…³ä¹ç”Ÿæ­»ï¼Œæ¯ä¸€æ¬¡é€‰æ‹©éƒ½è€ƒéªŒäººæ€§ã€‚ä»ä¸€åæ™®é€šåŒ»ç–—ä¸“å‘˜åšèµ·ï¼Œå‡­å€ŸåŒ»æœ¯ä¸æ™ºæ…§æ™‹å‡è‡³æœ€é«˜èŒçº§â€”â€”è¿™æ˜¯ä½ çš„ä½¿å‘½ï¼Œä¹Ÿæ˜¯ä½ çš„æ•‘èµã€‚
            </p>
            <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.85rem; color:var(--gold); text-align:center;">
                ğŸ¯ <strong>æ¸¸æˆç›®æ ‡</strong>ï¼šæ´»ä¸‹å»ï¼ŒåšæŒä½ï¼Œåœ¨æˆ˜ç«ä¸­å®ˆæŠ¤ç”Ÿå‘½ä¸å¸Œæœ›ã€‚
            </div>
        </div>

        <div class="input-group">
            <h3>ğŸªª å¿—æ„¿ç”³è¯·è¡¨</h3>
            
            <div class="setup-header-row" style="margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px;">
                <div style="margin-bottom: 10px;">
                    <strong>ğŸ“ ä»»åŠ¡åœ°ç‚¹:</strong> <span id="p-location" style="color:var(--primary); font-size:1.3rem;">æ­£åœ¨åˆ†é…...</span>
                    <div id="p-location-desc" style="font-size:0.85rem; color:#888; margin-top:8px; line-height:1.5; font-style:italic; font-weight:normal;"></div>
                </div>

                <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                    <div style="flex: 1;">
                        <input type="text" id="input-lastname" placeholder="å§“" style="width: 60px; display: inline-block; padding: 8px; font-size: 1.1rem;">
                        <input type="text" id="input-firstname" placeholder="å" style="width: 100px; display: inline-block; padding: 8px; font-size: 1.1rem;">
                        <span style="font-size: 1rem; color:#888; font-weight: normal;">(<span id="p-gender">?</span> / <span id="p-dept">?</span>)</span>
                    </div>
                    <button onclick="rollCharacter()" style="padding:8px 15px; font-size:0.9rem;">ğŸ² éšæœº</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; text-align:center; margin-bottom: 20px;">
                <div style="background:var(--panel); border:1px solid var(--border); padding:10px; border-radius:4px;">åŒ»å­¦<br><strong id="p-med" style="font-size:1.4em">0</strong></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:10px; border-radius:4px;">è¡Œæ”¿<br><strong id="p-admin" style="font-size:1.4em">0</strong></div>
                <div style="background:var(--panel); border:1px solid var(--border); padding:10px; border-radius:4px;">ç¤¾äº¤<br><strong id="p-soc" style="font-size:1.4em">0</strong></div>
            </div>

            <div class="setup-btn-container">
                <button class="setup-main-btn" style="background:var(--primary); color:white; font-weight:bold;" onclick="tryStartNewGame()">ğŸš€ å¼€å§‹æ–°æ¸¸æˆ</button>
                <button id="continue-btn" class="setup-main-btn" onclick="openLoadModal()" style="display:none; background:var(--green); color:white; border:2px solid var(--text);">ğŸ”„ ç»§ç»­æ¸¸æˆ (æ£€æµ‹åˆ°å­˜æ¡£)</button>
            </div>
        </div>

        <details style="margin-top:20px; border:1px solid var(--border); border-radius:4px; background:var(--panel);">
            <summary style="padding:12px 15px; cursor:pointer; color:#888; font-size:0.9rem;">ğŸ“¡ é«˜çº§è®¾ç½® (APIé…ç½®)</summary>
            <div style="padding:15px; border-top:1px solid var(--border);">
                <p style="font-size:0.8em; color:#888; margin-bottom:10px;">å¼€å‘è€…API Keyå·²é¢„è£…ã€‚å¦‚éœ€ä½¿ç”¨è‡ªå·±çš„Keyè¯·åœ¨ä¸‹æ–¹è¾“å…¥ã€‚</p>
                <label style="font-size:0.85em; font-weight:bold;">API Base URL:</label>
                <input type="text" id="api-url" value="https://api.deepseek.com" style="margin-bottom:10px;">

                <label style="font-size:0.85em; font-weight:bold;">è‡ªå®šä¹‰API Key (å¯é€‰):</label>
                <input type="password" id="api-key" placeholder="ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤Key..." style="margin-bottom:10px;">
                
                <label style="font-size:0.85em; font-weight:bold;">æ¨¡å‹ç‰ˆæœ¬:</label>
                <input type="text" id="model-name" value="deepseek-reasoner" placeholder="deepseek-reasoner" style="margin-bottom:10px;">
                
                <div style="margin-top:5px;">
                    <input type="checkbox" id="use-mock" onchange="toggleApiInput()"> 
                    <label for="use-mock" style="font-size:0.85em;">ç¦»çº¿æ¨¡æ‹Ÿæ¨¡å¼ (æ—  Key å¯ç©)</label>
                </div>
            </div>
        </details>
    </div>

    <div id="loading-screen" class="screen">
        <div class="loader-content">
            <div>> è¿æ¥ MSF å«æ˜Ÿç½‘ç»œ...</div>
            <div id="log-box"></div>
            <div class="loader-spinner"></div>
            <div style="text-align:center; color:#888; font-size:0.8em; margin-top:10px;">ä»»åŠ¡ç”Ÿæˆä¸­ï¼Œè¯·ä¿æŒä¿¡å·ç•…é€š</div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        
        <div id="tab-event" class="tab-content active">
            <h3>ğŸš¨ å­£åº¦ç®€æŠ¥</h3>
            <div id="loading-spinner" class="loading-spinner">
                ğŸ›°ï¸ æ­£åœ¨ä»å‰çº¿è·å–æƒ…æŠ¥ (DeepSeekæ¨ç†ä¸­)...
            </div>

            <div id="event-area" style="display:none;">
                <span class="event-tag" id="event-tag">EVENT</span>
                <div class="event-text" id="event-desc"></div>
                <div id="choices-container"></div>
            </div>

            <button id="start-event-btn" onclick="fetchDailyEvent()">ğŸ“¡ è·å–å­£åº¦æƒ…æŠ¥ (å¼€å§‹äº‹ä»¶)</button>
            
            <div id="next-quarter-msg" style="text-align:center; margin-top:20px; color:#888; display:none;">
                æœ¬å­£åº¦äº‹ä»¶å·²å¤„ç†ã€‚è¯·ç®¡ç†äººç‰©ä¸åŸºåœ°ï¼Œå‡†å¤‡è¿›å…¥ä¸‹ä¸€å­£åº¦ã€‚
            </div>
            <button id="next-day-btn" onclick="triggerNextQuarter()" style="width:100%; margin-top:15px; background:var(--primary); padding:15px; font-size:1.1rem; display:none; color: white;">ğŸ“… è¿›å…¥ä¸‹ä¸€å­£åº¦</button>
        </div>

        <div id="tab-character" class="tab-content">
            <div id="bio-container" class="bio-box"></div>

            <div class="rank-card">
                <div class="rank-title" id="val-rank-name">åŒ»ç–—ä¸“å‘˜</div>
                <div class="rank-progress">å½“å‰èŒçº§: Lv.<span id="val-rank-lvl">1</span></div>
                <div style="font-size:0.9em; margin-bottom:5px;">ä¸Šçº§å¥½æ„Ÿåº¦: <span id="val-favor">10</span>/100</div>
                <div class="bar-bg" style="margin-bottom:10px;"><div class="bar-fill" id="bar-favor" style="background:var(--gold)"></div></div>
                <div style="font-size:1.1rem; color:#fff; margin-bottom: 5px;">è€ƒæ ¸è¿èƒœ: <span id="val-max-streak" style="color:var(--gold); font-weight:bold; font-size:1.3rem;">0</span> (æ™‹å‡å…³é”®)</div>
                
                <div class="rank-actions">
                    <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('network')">ğŸ¤ è”ç»œæ„Ÿæƒ…</button>
                    <button style="font-size:0.9rem; padding:8px;" onclick="interactBoss('fund')">ğŸ’° è¯·æ±‚èµ„é‡‘</button>
                </div>
                <button id="btn-promo" style="width:100%; margin-top:10px; background:var(--blue); color:white;" onclick="applyForPromotion()">â¬†ï¸ ç”³è¯·æ™‹å‡ (ä»…ç§‹å­£å¼€æ”¾)</button>
                <div id="promo-status" style="font-size:0.8em; color:#888; margin-top:5px;"></div>
            </div>

            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--purple);">
                ğŸ’µ ä¸ªäººå­˜æ¬¾: <span id="val-cash-char" style="font-weight:bold; color:var(--purple); float:right;">$100</span>
                <div style="font-size:0.8em; color:#888; margin-top:5px;">ç”Ÿæ´»è´¹: -$50 (å­£åº¦ç»“ç®—æ—¶æ‰£é™¤)</div>
                <div style="font-size:0.8em; color:#2ecc71; margin-top:2px;">ä¸‹å­£åº¦è–ªæ°´: <span id="val-salary"></span></div>
            </div>

            <h4>äººç‰©ç‰¹æ€§</h4>
            <div class="stats-grid">
                <div class="stat-box">â¤ï¸ å¥åº· <span style="float:right;" id="val-health">0</span><div class="bar-bg"><div class="bar-fill" id="bar-health"></div></div></div>
                <div class="stat-box">âš¡ ç²¾åŠ› <span style="float:right;" id="val-energy">0</span><div class="bar-bg"><div class="bar-fill" id="bar-energy"></div></div></div>
                <div class="stat-box">ğŸ’‰ åŒ»å­¦ <span style="float:right;" id="val-med">0</span><div class="bar-bg"><div class="bar-fill" id="bar-med" style="background:var(--blue)"></div></div></div>
                <div class="stat-box">ğŸ“‹ è¡Œæ”¿ <span style="float:right;" id="val-admin">0</span><div class="bar-bg"><div class="bar-fill" id="bar-admin" style="background:var(--blue)"></div></div></div>
                <div class="stat-box">ğŸ—£ï¸ ç¤¾äº¤ <span style="float:right;" id="val-soc">0</span><div class="bar-bg"><div class="bar-fill" id="bar-soc" style="background:var(--blue)"></div></div></div>
                <div class="stat-box" style="border-left-color:var(--danger);">ğŸ‘® å«Œç–‘ <span style="float:right;" id="val-suspicion">0</span><div class="bar-bg"><div class="bar-fill" id="bar-suspicion" style="background:var(--danger)"></div></div></div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                <button class="skill-btn" onclick="trainSkill('med')">ğŸ“– ç ”è¯»åŒ»å­¦</button>
                <button class="skill-btn" onclick="trainSkill('admin')">ğŸ“‹ å¤„ç†æ–‡ä¹¦</button>
                <button class="skill-btn" onclick="trainSkill('soc')">ğŸ—£ï¸ äº¤æµç»éªŒ</button>
            </div>
            
            <button class="rest-btn" id="btn-rest" onclick="doRest()">ğŸ›Œ ä¼‘æ¯ (æœ¬å­£åº¦é™ä¸€æ¬¡)</button>
        </div>

        <div id="tab-ward" class="tab-content">
            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--blue);">
                ğŸ¥ ä½é™¢éƒ¨: <span id="ward-count">0</span> / <span id="ward-cap">20</span>
                <span style="float:right; font-size:0.8em; color:#aaa;" id="ward-limit-msg">æœ¬å­£æ”¶æ²»: 0/3</span>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="action-btn" style="flex:1; justify-content:center; background:var(--blue); color:white;" onclick="admitPatient()">â• æ”¶å…¥é™¢</button>
                <button class="action-btn" id="btn-rounds" style="flex:1; justify-content:center; background:var(--purple); color:white;" onclick="doRounds()">ğŸ©º æŸ¥æˆ¿ (æ¶ˆè€—ç‰©èµ„/å¥åº·)</button>
            </div>
            
            <div id="patient-list"></div>
        </div>

        <div id="tab-exam" class="tab-content">
            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--gold);">
                ğŸ“ æ‰§ä¸šèƒ½åŠ›è€ƒæ ¸
                <div style="font-size:0.8em; color:#aaa;">å½“å‰è¿èƒœ: <span id="curr-streak">0</span> | æœ€é«˜è¿èƒœ: <span id="best-streak">0</span></div>
            </div>
            
            <div id="exam-start-area">
                <p>æ¯å­£åº¦å¯å‚åŠ ä¸€æ¬¡è€ƒæ ¸ã€‚è¿èƒœæ˜¯æ™‹å‡çš„å…³é”®ã€‚</p>
                <div style="background:var(--panel); padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid var(--border);">
                    <div style="font-weight:bold; margin-bottom:10px; color:var(--gold); border-bottom:1px solid var(--border); padding-bottom:5px;">ğŸ“Š èŒçº§æ™‹å‡è¿èƒœè¦æ±‚</div>
                    <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; text-align:center;">
                        <div><div style="font-size:0.8rem; color:#888;">Lv.2</div><div style="font-weight:bold; font-size:1.2rem;">3</div></div>
                        <div><div style="font-size:0.8rem; color:#888;">Lv.3</div><div style="font-weight:bold; font-size:1.2rem;">5</div></div>
                        <div><div style="font-size:0.8rem; color:#888;">Lv.4</div><div style="font-weight:bold; font-size:1.2rem;">10</div></div>
                        <div><div style="font-size:0.8rem; color:#888;">Lv.5</div><div style="font-weight:bold; font-size:1.2rem;">15</div></div>
                        <div><div style="font-size:0.8rem; color:#888;">Lv.6</div><div style="font-weight:bold; font-size:1.2rem;">20</div></div>
                    </div>
                </div>
                <button class="skill-btn" id="btn-start-exam" onclick="startExam()" style="width:100%; padding:15px; font-weight:bold; font-size:1.1rem;">âœï¸ å¼€å§‹è€ƒè¯•</button>
                
                <details style="display:none;">
                    <summary style="cursor:pointer; font-size:0.8em; color:#888;">[å¼€å‘è€…] å¯¼å…¥é¢˜åº“</summary>
                    <textarea id="exam-import-area" style="width:100%; height:100px; background:var(--input-bg); color:var(--text); border:none; margin-top:5px;" placeholder='[{"q":"é—®é¢˜?","o":["é€‰é¡¹A","é€‰é¡¹B","é€‰é¡¹C","é€‰é¡¹D","é€‰é¡¹E"],"a":0},...]'></textarea>
                    <button onclick="importQuestions()" style="width:100%; margin-top:5px; font-size:0.8em;">å¯¼å…¥JSON</button>
                </details>
            </div>

            <div id="exam-ui" style="display:none;" class="exam-box">
                <div id="exam-q-text" class="exam-q"></div>
                <div id="exam-options"></div>
                <div id="exam-result" style="margin-top:20px; padding:15px; border-radius:6px; display:none;"></div>
                <button id="exam-quit-btn" style="width:100%; margin-top:15px; display:none; background:var(--border); color:var(--text);" onclick="quitExam()">é€€å‡ºç­”é¢˜</button>
            </div>
        </div>

        <div id="tab-base" class="tab-content">
            <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--gold);">
                <div>ğŸ’° åŸºåœ°èµ„é‡‘: <span id="val-funds" style="font-weight:bold; color:var(--gold); cursor:pointer;" onclick="handleFundsClick()">$10000</span></div>
                <div style="font-size:0.9em; margin-top:5px;">ğŸ° ç­‰çº§: <span id="val-base-lvl">åŸºç¡€åŒ»ç–—ç‚¹</span> (Lv.<span id="val-base-lvl-num">1</span>)</div>
                <div style="font-size:0.8em; color:#888;">æ¯å­£æ¶ˆè€—: $1000 - (è¡Œæ”¿x10) + (ç´§å¼ x10) | æ‹¨æ¬¾ +$1000</div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">ğŸ¤’ éš¾æ°‘ <span style="float:right; font-weight:bold;" id="val-refugees">0</span></div>
                <div class="stat-box">ğŸ˜  ç´§å¼  <span style="float:right;" id="val-tension">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-tension"></div></div></div>
                <div class="stat-box">ğŸ“¦ ç‰©èµ„ <span style="float:right;" id="val-supplies">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-supplies"></div></div></div>
                <div class="stat-box">ğŸ’§ å‡€æ°´ <span style="float:right;" id="val-water">0%</span><div class="bar-bg"><div class="bar-fill" id="bar-water"></div></div></div>
            </div>
            
            <h4>åŸºåœ°è¡ŒåŠ¨ (æ¶ˆè€—èµ„æº/ç²¾åŠ›)</h4>
            <button class="action-btn" onclick="doAction('distribute_food')"><span>ğŸ¥£ åˆ†å‘å£ç²®ä¸è¯å“</span><span style="font-size:0.8em; color:#888;">ç‰©èµ„-5, ç´§å¼ å‡å°‘å—ç¤¾äº¤åŠ æˆ</span></button>
            <button class="action-btn" onclick="doAction('distribute_water')"><span>ğŸš° æä¾›å‡€æ°´</span><span style="font-size:0.8em; color:#888;">æ°´-5, ç´§å¼ å‡å°‘å—ç¤¾äº¤åŠ æˆ</span></button>
            <button class="action-btn" onclick="doAction('transport')"><span>ğŸš™ æ¥æ”¶ç©ºæŠ•ç‰©èµ„</span><span style="font-size:0.8em; color:#888;">ç‰©èµ„/æ°´+10, å¥åº·-5</span></button>
            <button class="action-btn" onclick="doAction('pacify')"><span>ğŸ•Šï¸ å®‰æŠšæ°‘ä¼—</span><span style="font-size:0.8em; color:#888;">ç´§å¼ -5, ç²¾åŠ›-10</span></button>
            <button class="action-btn" onclick="doAction('rescue')"><span>ğŸš‘ å‰çº¿æ•‘æ´</span><span style="font-size:0.8em; color:#888;">å¥åº·-10, éš¾æ°‘+10</span></button>
            <button class="action-btn" onclick="doAction('big_spender')"><span>ğŸ’¸ å¤§æ’’å¸è¡ŒåŠ¨</span><span style="font-size:0.8em; color:#888;">èµ„é‡‘-1000, ç´§å¼ -8</span></button>
            
            <h4 style="margin-top:20px; color:var(--gold);">èµ„é‡‘æ“ä½œ</h4>

            <div class="slider-container" style="border-left:4px solid var(--green);">
                <div style="margin-bottom:5px;">ğŸ¤ æèµ èµ„é‡‘ <span id="don-val" class="slider-val">0%</span></div>
                <input type="range" id="don-slider" min="0" max="100" value="0" oninput="updateSliderUI('don')">
                <div style="font-size:0.8em; color:#aaa;">ä¸ªäººæå‡º <span id="don-give">$0</span> -> åŸºåœ°è·å¾— <span id="don-get">$0</span></div>
                <button class="action-btn" style="margin-top:5px; justify-content:center; border-color:var(--green);" onclick="commitDonate()">ç¡®è®¤æèµ </button>
            </div>
        </div>
        
        <div id="tab-items" class="tab-content">
             <div class="stat-box" style="margin-bottom:15px; border-left-color:var(--purple);">
                ğŸ’µ ä¸ªäººå­˜æ¬¾: <span id="val-cash-items" style="font-weight:bold; color:var(--purple); float:right;">$100</span>
            </div>
            <h3>ğŸ›’ è¡¥ç»™ç«™ & å»ºè®¾</h3>
            
            <div class="item-grid" style="margin-bottom:20px;">
                <div class="item-card">
                    <div><div class="item-name">ğŸ“¦ è´­ä¹°ç‰©èµ„åŒ…</div><div class="item-price">åŸºåœ°èµ„é‡‘ $500</div><div class="item-desc">ç‰©èµ„ +5</div></div>
                    <button class="buy-btn" onclick="buyBaseItem('supplies')">è´­ä¹°</button>
                </div>
                <div class="item-card">
                    <div><div class="item-name">ğŸ’§ è´­ä¹°å‡€æ°´</div><div class="item-price">åŸºåœ°èµ„é‡‘ $500</div><div class="item-desc">å‡€æ°´ +5</div></div>
                    <button class="buy-btn" onclick="buyBaseItem('water')">è´­ä¹°</button>
                </div>
            </div>

            <div id="shop-container" class="item-grid"></div>
        </div>

        <div id="tab-achievements" class="tab-content">
            <h3>ğŸ† æˆå°±ç³»ç»Ÿ</h3>
            <div id="achievement-progress-container" style="margin-bottom:20px; padding:15px; background:var(--panel); border-radius:8px;">
                <h4 style="margin:0 0 10px 0;">æ€»è¾¾æˆç‡</h4>
                <div class="bar-bg" style="height:12px;"><div id="total-achieve-bar" class="bar-fill" style="width:0%; background:var(--gold);"></div></div>
                <div id="total-achieve-text" style="text-align:right; font-size:0.9rem; margin-top:5px; font-weight:bold; color:var(--gold);">0%</div>
            </div>
            <ul id="achievement-list" class="achieve-list"></ul>
            
            <div style="margin-top:30px; border-top: 1px solid var(--border); padding-top:20px;">
                <h3>ğŸ“œ å±¥å†è®°å½•</h3>
                <div id="career-summary" style="font-size:0.9rem; line-height:1.6; color:#aaa; background:var(--panel); padding:15px; border-radius:8px; margin-bottom:20px;">
                    <div>ç´¯è®¡æ²»ç–—ç—…äºº: <span id="summary-cured" style="color:var(--blue)">0</span></div>
                    <div>ç´¯è®¡åº¦è¿‡å­£åº¦: <span id="summary-quarters" style="color:var(--gold)">0</span></div>
                    <div>æœ€é«˜èŒçº§: <span id="summary-max-rank" style="color:var(--accent)">1</span></div>
                </div>
            </div>
        </div>

    </div>

    <div class="bottom-nav" id="bottom-nav" style="display:none;">
        <div class="nav-item active" onclick="switchNav('event', this)">
            <div class="nav-icon">ğŸš¨</div>
            <div>äº‹ä»¶</div>
        </div>
        <div class="nav-item" onclick="switchNav('ward', this)">
            <div class="nav-icon">ğŸ¥</div>
            <div>ç—…æˆ¿</div>
        </div>
        <div class="nav-item" onclick="switchNav('character', this)">
            <div class="nav-icon">ğŸ©º</div>
            <div>äººç‰©</div>
        </div>
        <div class="nav-item" onclick="switchNav('base', this)">
            <div class="nav-icon">â›º</div>
            <div>åŸºåœ°</div>
        </div>
        <div class="nav-item" onclick="switchNav('items', this)">
            <div class="nav-icon">ğŸ›’</div>
            <div>ç‰©å“</div>
        </div>
        <div class="nav-item" onclick="switchNav('exam', this)">
            <div class="nav-icon">ğŸ“</div>
            <div>è€ƒæ ¸</div>
        </div>
        <div class="nav-item" onclick="switchNav('achievements', this)">
            <div class="nav-icon">ğŸ†</div>
            <div>æˆå°±</div>
        </div>
    </div>

    <div id="end-screen" class="screen" style="text-align:center; padding-top:50px;">
        <h1 id="end-title">æ¸¸æˆç»“æŸ</h1>
        <p id="end-reason" style="font-size:1.2rem; margin:20px 0; line-height:1.6;"></p>
        
        <button id="gen-story-btn" onclick="generateStory()">ğŸ“– ç”Ÿæˆæˆ˜åœ°æ—¥è®° (å›é¡¾)</button>
        <div id="story-container">
            <h4 style="margin-top:0; color:var(--accent);">ğŸ“‘ æˆ˜åœ°æ—¥å¿—</h4>
            <div id="story-content">ç”Ÿæˆä¸­...</div>
        </div>
        
        <div id="continue-game-area" style="display:none; margin-top:20px;">
            <p>æ‚¨å·²è¾¾æˆæœ€é«˜æˆå°±ï¼æ‚¨å¯ä»¥é€‰æ‹©ç»§ç»­ç»è¥ï¼Œæˆ–é‡æ–°å¼€å§‹ã€‚</p>
            <button onclick="continueGame()" style="background:var(--green); color:white;">ğŸ”„ ç»§ç»­ç•™ä»»</button>
        </div>

        <button onclick="location.reload()" style="background:var(--border); color:var(--text); padding:15px 40px; margin-top:20px;">ğŸ” é‡æ–°å¼€å§‹</button>
    </div>
</div>

<div id="message-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" id="msg-title">æç¤º</div>
        <div class="modal-body">
            <p id="msg-content" class="msg-text"></p>
            <button class="modal-btn" onclick="closeMsgModal()">ç¡® å®š</button>
        </div>
    </div>
</div>

<div id="confirm-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" id="cfm-title">ç¡®è®¤</div>
        <div class="modal-body">
            <p id="cfm-content" class="msg-text"></p>
            <div style="display:flex; gap:1px;">
                <button class="modal-btn secondary" onclick="closeConfirmModal(false)" style="flex:1;">å– æ¶ˆ</button>
                <button class="modal-btn" onclick="closeConfirmModal(true)" style="flex:1;">ç¡® å®š</button>
            </div>
        </div>
    </div>
</div>

<div id="load-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">è¯»å–æ¡£æ¡ˆ</div>
        <div class="modal-body" style="text-align:left;">
            <button class="save-slot-btn" onclick="loadSlot('auto')">
                <div style="font-weight:bold;">ğŸ“¼ è‡ªåŠ¨å­˜æ¡£</div>
                <div class="save-meta" id="slot-auto-info">æ— è®°å½•</div>
            </button>
            <button class="save-slot-btn" onclick="loadSlot('manual')">
                <div style="font-weight:bold;">ğŸ’¾ æ‰‹åŠ¨å­˜æ¡£</div>
                <div class="save-meta" id="slot-manual-info">æ— è®°å½•</div>
            </button>
            <button class="modal-btn secondary" style="width:100%; margin-top:10px;" onclick="$('load-modal').style.display='none'">å…³ é—­</button>
        </div>
    </div>
</div>

<div id="result-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header">è¡ŒåŠ¨å›æŠ¥</div>
        <div class="modal-body">
            <div id="result-status"></div>
            <p id="result-text"></p>
            <ul id="result-list" class="change-list"></ul>
            <button class="modal-btn" onclick="closeModal()">ç¡® å®š</button>
        </div>
    </div>
</div>

<div id="investigation-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--danger); color:white;">ğŸš¨ è´¢åŠ¡å®¡æŸ¥</div>
        <div class="modal-body">
            <p style="margin-bottom:20px; line-height:1.6;">ä½ çš„è´¦æˆ·å¼‚å¸¸å˜åŠ¨å¼•èµ·äº†æ€»éƒ¨çš„æ€€ç–‘ã€‚è°ƒæŸ¥ç»„å·²ç»ä»‹å…¥ï¼Œä½ é¢ä¸´ä¸¥é‡çš„æŒ‡æ§ã€‚</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button style="background:var(--primary); color:white; border:none; padding:15px; border-radius:4px;" onclick="handleInvestigationAction('resist')">ğŸ›‘ è´Ÿéš…é¡½æŠ—</button>
                <button style="background:var(--blue); color:white; border:none; padding:15px; border-radius:4px;" onclick="handleInvestigationAction('surrender')">ğŸ³ï¸ å…¨æ•°ä¸Šäº¤</button>
            </div>
            <div style="font-size:0.8em; color:#888; margin-top:10px; text-align:center;">
                é¡½æŠ—: è¯•å›¾æ©ç›– (å¯èƒ½ç›´æ¥å®šç½ª)<br>
                ä¸Šäº¤: æ¸…ç©ºå­˜æ¬¾å¹¶é™èŒ (ä¿ç•™å·¥ä½œ)
            </div>
        </div>
    </div>
</div>

<div id="embezzle-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--primary); color:white;">ğŸ•µï¸ æŒªç”¨å…¬æ¬¾ï¼Ÿ</div>
        <div class="modal-body">
            <p style="margin-bottom:20px; line-height:1.6;">ä½ ç¡®å®šè¦æŒªç”¨åŸºåœ°èµ„é‡‘å—ï¼Ÿè¿™å°†å¢åŠ ä½ çš„å«Œç–‘åº¦ã€‚</p>
            <div class="slider-container" style="border-left:4px solid var(--primary); margin-bottom:15px;">
                <div style="margin-bottom:5px;">æŒªç”¨æ¯”ä¾‹ <span id="embezzle-val" class="slider-val">0%</span></div>
                <input type="range" id="embezzle-slider" min="0" max="100" value="0" oninput="updateEmbezzleSlider()">
                <div style="font-size:0.8em; color:#aaa;">æŒªç”¨åŸºåœ° <span id="embezzle-steal">$0</span> -> ä¸ªäººè·å¾— <span id="embezzle-gain">$0</span></div>
                <div style="font-size:0.8em; color:var(--danger); margin-top:5px;">é¢„è®¡å«Œç–‘åº¦å¢åŠ : <span id="embezzle-suspicion">0-5</span></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="modal-btn secondary" onclick="closeEmbezzleModal()">å– æ¶ˆ</button>
                <button class="modal-btn" onclick="confirmEmbezzle()">ç¡®è®¤æŒªç”¨</button>
            </div>
        </div>
    </div>
</div>

<div id="special-event-modal" class="custom-modal">
    <div class="modal-content">
        <div class="modal-header" style="background:var(--gold); color:#333;" id="special-event-title">âš¡ ç‰¹æ®Šäº‹ä»¶</div>
        <div class="modal-body">
            <p id="special-event-desc" style="margin-bottom:20px; line-height:1.6;"></p>
            <div id="special-event-choices" style="display:flex; flex-direction:column;"></div>
        </div>
    </div>
</div>

<div id="settings-modal" class="custom-modal">
    <div class="modal-content" style="max-width:600px; max-height:90vh; overflow-y:auto;">
        <div class="modal-header" style="background:var(--panel); color:var(--text);">âš™ï¸ æ¸¸æˆè®¾ç½®</div>
        <div class="modal-body" style="text-align:left;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="modal-btn" onclick="saveGameManual(); closeSettingsModal();">ğŸ’¾ æ‰‹åŠ¨å­˜æ¡£</button>
                <button class="modal-btn secondary" onclick="closeSettingsModal(); openLoadModal();">ğŸ“‚ è¯»å–å­˜æ¡£</button>
            </div>
            <div style="margin-bottom:20px;">
                <button class="modal-btn" style="width:100%;" onclick="toggleTheme();">â˜€ï¸/ğŸŒ™ åˆ‡æ¢æ—¥é—´/å¤œé—´æ¨¡å¼</button>
            </div>
            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0;">
            <div id="tutorial-section">
                <h4 style="margin:0 0 15px 0; color:var(--gold);">ğŸ“– æ–°æ‰‹æ•™ç¨‹</h4>
                <div style="font-size:0.9rem; line-height:1.8; color:#aaa;">
                    <details open style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">ğŸ® æ¸¸æˆç®€ä»‹</summary>
                        <p>ä½ æ˜¯ä¸€åæ— å›½ç•ŒåŒ»ç”Ÿç»„ç»‡ï¼ˆMSFï¼‰çš„åŒ»ç–—å¿—æ„¿è€…ï¼Œè¢«æ´¾å¾€æˆ˜ä¹±æˆ–ç¾éš¾åœ°åŒºæ‰§è¡Œäººé“ä¸»ä¹‰æ•‘æ´ä»»åŠ¡ã€‚ä½ éœ€è¦ç®¡ç†è¥åœ°èµ„æºã€æ•‘æ²»ç—…æ‚£ã€åº”å¯¹çªå‘äº‹ä»¶ï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æå‡è‡ªå·±çš„èƒ½åŠ›å’ŒèŒçº§ã€‚</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">ğŸ“Š æ ¸å¿ƒæ•°å€¼</summary>
                        <p><strong>ä¸ªäººå±æ€§ï¼š</strong></p>
                        <ul style="margin-left:20px;">
                            <li><strong>åŒ»å­¦</strong> - å½±å“æ²»ç–—ç—…äººçš„æ•ˆæœ</li>
                            <li><strong>è¡Œæ”¿</strong> - é™ä½åŸºåœ°è¿è¥æˆæœ¬</li>
                            <li><strong>ç¤¾äº¤</strong> - å®‰æŠšéš¾æ°‘æ›´æœ‰æ•ˆï¼Œå‡å°‘ç´§å¼ åº¦</li>
                            <li><strong>å¥åº·/ç²¾åŠ›</strong> - æ‰§è¡Œè¡ŒåŠ¨çš„æ¶ˆè€—ï¼Œå¯é€šè¿‡ä¼‘æ¯æ¢å¤</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>è¥åœ°å±æ€§ï¼š</strong></p>
                        <ul style="margin-left:20px;">
                            <li><strong>éš¾æ°‘</strong> - è¥åœ°æ”¶å®¹çš„éš¾æ°‘æ•°é‡</li>
                            <li><strong>ç‰©èµ„/å‡€æ°´</strong> - ç»´æŒè¥åœ°è¿è½¬çš„èµ„æºï¼Œæ¯å­£åº¦è‡ªç„¶æ¶ˆè€—</li>
                            <li><strong>ç´§å¼ åº¦</strong> - è¿‡é«˜ä¼šå¯¼è‡´æ¸¸æˆå¤±è´¥</li>
                            <li><strong>åŸºåœ°èµ„é‡‘</strong> - ç”¨äºè¿è¥å’Œæ‰©å»ºåŸºåœ°</li>
                        </ul>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">ğŸ¥ ç—…æˆ¿ç³»ç»Ÿ</summary>
                        <p>ä½ å¯ä»¥æ”¶æ²»ç—…äººå¹¶è¿›è¡Œæ²»ç–—ã€‚æ¯ä½ç—…äººæœ‰ï¼š</p>
                        <ul style="margin-left:20px;">
                            <li><strong>å±æ€¥åº¦</strong> - åˆ†ä¸ºè½»ç—‡/ä¸­ç—‡/é‡ç—‡</li>
                            <li><strong>ç”Ÿå‘½æŒ‡å¾</strong> - æ¯å­£åº¦è‡ªç„¶è¡°å‡ï¼Œé™è‡³0åˆ™æ­»äº¡</li>
                            <li><strong>è¯Šç–—è¿›åº¦</strong> - è¾¾åˆ°100%å¯æ²»æ„ˆå‡ºé™¢</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>æ“ä½œï¼š</strong>æ²»ç–—(æå‡è¿›åº¦å’Œç”Ÿå‘½æŒ‡å¾)ã€æŠ¢æ•‘(ç”Ÿå‘½æŒ‡å¾â‰¤30æ—¶å¯ç”¨)ã€å‡ºé™¢</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">ğŸ“ˆ æ™‹å‡ç³»ç»Ÿ</summary>
                        <p>é€šè¿‡å‚åŠ è€ƒæ ¸è·å¾—è¿èƒœæ¥æ™‹å‡èŒçº§ï¼š</p>
                        <ul style="margin-left:20px;">
                            <li>Lv.2 éœ€è¦è¿èƒœ 3 é¢˜</li>
                            <li>Lv.3 éœ€è¦è¿èƒœ 5 é¢˜</li>
                            <li>Lv.4 éœ€è¦è¿èƒœ 10 é¢˜</li>
                            <li>Lv.5 éœ€è¦è¿èƒœ 15 é¢˜</li>
                            <li>Lv.6 éœ€è¦è¿èƒœ 20 é¢˜</li>
                        </ul>
                        <p style="margin-top:10px;">æ™‹å‡éœ€åœ¨<strong>ç§‹å­£</strong>ç”³è¯·ï¼Œæ¶ˆè€—<strong>40ç‚¹å¥½æ„Ÿåº¦</strong>ï¼Œå†¬å­£å…¬å¸ƒç»“æœã€‚</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">âš ï¸ æ¸¸æˆç»“æŸæ¡ä»¶</summary>
                        <p><strong>å¤±è´¥æ¡ä»¶ï¼š</strong></p>
                        <ul style="margin-left:20px;">
                            <li>è¥åœ°ç´§å¼ åº¦è¾¾åˆ°100%</li>
                            <li>åŸºåœ°èµ„é‡‘è€—å°½</li>
                            <li>ä¸ªäººå­˜æ¬¾ä¸ºè´Ÿä¸”æ— æ³•ç»´æŒ</li>
                            <li>å«Œç–‘åº¦è¿‡é«˜è¢«è°ƒæŸ¥å®šç½ª</li>
                        </ul>
                        <p style="margin-top:10px;"><strong>èƒœåˆ©æ¡ä»¶ï¼š</strong>æ™‹å‡è‡³æœ€é«˜èŒçº§(Lv.6)å¹¶ç¨³å®šç»´æŒ3ä¸ªå­£åº¦ä»¥ä¸Šã€‚</p>
                    </details>
                    
                    <details style="margin-bottom:15px;">
                        <summary style="font-weight:bold; color:var(--text); cursor:pointer; margin-bottom:10px;">ğŸ’¡ å°è´´å£«</summary>
                        <ul style="margin-left:20px;">
                            <li>ç‰©èµ„å’Œå‡€æ°´æ¯å­£åº¦ä¼šè‡ªç„¶æ¶ˆè€—ï¼Œè®°å¾—åŠæ—¶è¡¥å……</li>
                            <li>ä¸ä¸Šçº§ä¿æŒè‰¯å¥½å…³ç³»ï¼Œå¥½æ„Ÿåº¦æ˜¯æ™‹å‡çš„å…³é”®</li>
                            <li>æŒªç”¨å…¬æ¬¾ä¼šå¢åŠ å«Œç–‘åº¦ï¼Œé£é™©è‡ªè´Ÿ</li>
                            <li>é‡ç—‡ç—…äººç”Ÿå‘½æŒ‡å¾è¡°å‡å¿«ï¼Œä¼˜å…ˆå¤„ç†</li>
                            <li>æ¯å­£åº¦åªèƒ½ä¼‘æ¯ä¸€æ¬¡ï¼Œåˆç†è§„åˆ’ç²¾åŠ›</li>
                        </ul>
                    </details>
                </div>
            </div>
            <hr style="border:none; border-top:1px solid var(--border); margin:20px 0;">
            <button class="modal-btn" style="width:100%;" onclick="closeSettingsModal()">å…³ é—­</button>
        </div>
    </div>
</div>

<script>
    // --- å¼€å‘è€…é…ç½® ---
    const DEVELOPER_API_KEY = "sk-87bf24fe26594fc1a85582e09cfad8c0"; // å¼€å‘è€…å¯åœ¨æ­¤å¡«å…¥é»˜è®¤KEY

    // --- å…¨å±€å·¥å…·ä¸æ•°æ®å®šä¹‰ ---
    const $ = id => document.getElementById(id);
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));
    const SAVE_KEY_AUTO = 'msf_commander_save_auto';
    const SAVE_KEY_MANUAL = 'msf_commander_save_manual';

    // æ•°æ®åˆ—è¡¨
    const CHAR_NAMES = ["Alex", "Dr. Sarah", "Jean", "Dr. Ahmed", "Maria", "David", "Liang", "Dr. Chen"];
    const CHAR_DEPTS = ["éª¨ç§‘", "æ„ŸæŸ“ç§‘", "å„¿ç§‘", "å¦‡äº§ç§‘", "æ€¥è¯Šç§‘", "å†…ç§‘", "çœ¼ç§‘"];
    const CHAR_LOCATIONS = [
        "å—è‹ä¸¹ - æœ¬æä¹Œ", "å·´è¥¿ - é˜¿ç»´æ–¯å¡”", "é˜¿å¯Œæ±— - æ˜†éƒ½å£«", "ä¹Ÿé—¨ - æ‘©å¡", 
        "æµ·åœ° - å¤ªé˜³åŸ", "åˆšæœé‡‘ - åŒ—åŸºä¼", "ä¸­éå…±å’Œå›½ - ç­å‰", "å™åˆ©äºš - ä¼Šå¾·åˆ©åœ",
        "åŸƒå¡ä¿„æ¯”äºš - ææ ¼é›·", "ç¼…ç”¸ - è‹¥å¼€é‚¦", "ä¹Œå…‹å…° - é¡¿å·´æ–¯", "é©¬é‡Œ - åŠ å¥¥"
    ];
    
    const LOCATION_DESCRIPTIONS = {
        "å—è‹ä¸¹ - æœ¬æä¹Œ": "æˆ˜ç«çº·é£çš„éš¾æ°‘è¥åœ°ï¼Œéœä¹±ä¸è¥å…»ä¸è‰¯è‚†è™ï¼Œæ•°ä¸‡æµç¦»å¤±æ‰€è€…åœ¨æ³¥æ³ä¸­ç­‰å¾…æ•‘æ´ï¼ŒåŒ»ç–—èµ„æºæåº¦åŒ®ä¹ã€‚",
        "å·´è¥¿ - é˜¿ç»´æ–¯å¡”": "äºšé©¬é€Šé›¨æ—æ·±å¤„çš„åè¿œç¤¾åŒºï¼ŒåŸä½æ°‘éƒ¨è½ç¼ºä¹åŸºæœ¬åŒ»ç–—ï¼Œçƒ­å¸¦ç–¾ç—…é¢‘å‘ï¼Œäº¤é€šä¸ä¾¿åŠ å‰§äº†æ•‘æ²»éš¾åº¦ã€‚",
        "é˜¿å¯Œæ±— - æ˜†éƒ½å£«": "æŒç»­å†²çªçš„å‰çº¿åŸå¸‚ï¼Œæˆ˜ä¼¤æ‚£è€…ç»œç»ä¸ç»ï¼ŒåŒ»é™¢å¤šæ¬¡é­å—è¢­å‡»ï¼Œåœ¨åºŸå¢Ÿä¸­åšå®ˆæ˜¯å¸¸æ€ã€‚",
        "ä¹Ÿé—¨ - æ‘©å¡": "è¢«å°é”çš„æ¸¯å£åŸå¸‚ï¼Œé¥¥è’ä¸ä¼ æŸ“ç—…åŒé‡å¤¹å‡»ï¼Œè¯å“è¡¥ç»™æ—¶æ–­æ—¶ç»­ï¼Œå¹³æ°‘æ‰¿å—ç€æˆ˜äº‰æœ€æ®‹é…·çš„ä»£ä»·ã€‚",
        "æµ·åœ° - å¤ªé˜³åŸ": "åœ°éœ‡åé‡å»ºç¼“æ…¢çš„è´«æ°‘åŒºï¼Œå¸®æ´¾æš´åŠ›ä¸æ”¿æ²»åŠ¨è¡å¹¶å­˜ï¼ŒåŒ»ç–—é˜Ÿåœ¨æªå£°ä¸­æ•‘æ²»ä¼¤æ‚£ã€‚",
        "åˆšæœé‡‘ - åŒ—åŸºä¼": "åŸƒåšæ‹‰ç–«æƒ…çš„é‡ç¾åŒºï¼Œæ­¦è£…å†²çªä½¿é˜²ç–«å·¥ä½œä¸¾æ­¥ç»´è‰°ï¼Œææƒ§ä¸è°£è¨€æ¯”ç—…æ¯’ä¼ æ’­å¾—æ›´å¿«ã€‚",
        "ä¸­éå…±å’Œå›½ - ç­å‰": "å†…æˆ˜æ’•è£‚çš„é¦–éƒ½éƒŠåŒºï¼Œå®—æ•™å†²çªå¯¼è‡´å¤§è§„æ¨¡æµç¦»å¤±æ‰€ï¼ŒåŒ»ç–—è®¾æ–½åœ¨äº¤ç«ä¸­è‰°éš¾è¿è½¬ã€‚",
        "å™åˆ©äºš - ä¼Šå¾·åˆ©åœ": "æœ€åçš„åå¯¹æ´¾æ®ç‚¹ï¼Œç©ºè¢­é¢‘ç¹ï¼Œåœ°ä¸‹åŒ»é™¢é‡ŒåŒ»ç”Ÿä»¬ä¸æ­»ç¥èµ›è·‘ï¼Œæ¯ä¸€æ¡ç”Ÿå‘½éƒ½æ¥ä¹‹ä¸æ˜“ã€‚",
        "åŸƒå¡ä¿„æ¯”äºš - ææ ¼é›·": "è¢«å°é”çš„æˆ˜åŒºï¼Œäººé“ä¸»ä¹‰å±æœºæ·±é‡ï¼Œé¥¥é¥¿çš„é˜´å½±ç¬¼ç½©ç€æ•°ç™¾ä¸‡äººï¼Œå¤–ç•Œæ´åŠ©éš¾ä»¥è¿›å…¥ã€‚",
        "ç¼…ç”¸ - è‹¥å¼€é‚¦": "ç½—å…´äºšéš¾æ°‘å±æœºçš„ä¸­å¿ƒï¼Œç§æ—æ¸…æ´—çš„åˆ›ä¼¤çŠ¹åœ¨ï¼Œéš¾æ°‘è¥ä¸­ç»æœ›ä¸å¸Œæœ›äº¤ç»‡ã€‚",
        "ä¹Œå…‹å…° - é¡¿å·´æ–¯": "æ¬§æ´²æœ€æ¿€çƒˆçš„å†²çªå‰çº¿ï¼Œç‚®ç«ä¸‹çš„åŸé•‡æ»¡ç›®ç–®ç—ï¼Œè€äººä¸å„¿ç«¥åœ¨åœ°ä¸‹å®¤é‡Œç­‰å¾…å’Œå¹³ã€‚",
        "é©¬é‡Œ - åŠ å¥¥": "æ’’å“ˆæ‹‰è¾¹ç¼˜çš„æ²™æ¼ åŸå¸‚ï¼Œæç«¯ç»„ç»‡å¨èƒä¸å¹²æ—±å¹¶å­˜ï¼Œæ¸¸ç‰§æ°‘æ—çš„ç”Ÿå­˜å²Œå²Œå¯å±ã€‚"
    };
    
    const RANKS = [
        "åŒ»ç–—ä¸“å‘˜ (Level 1)",
        "ä¸´åºŠä¸“å®¶ (Level 2)",
        "åŒ»ç–—ä¸»ç®¡ (Level 3)",
        "é¡¹ç›®ç»Ÿç­¹ (Level 4)",
        "å‰¯æ€»ç­¹ (Level 5)",
        "åŒºåŸŸæ€»ç­¹ (Level 6)"
    ];
    const RANK_SALARIES = [100, 400, 800, 1200, 1600, 2000];
    const RANK_REQ_STREAK = [0, 3, 5, 10, 15, 20]; // å¯¹åº” 1->2, 2->3 ç­‰

    const BASE_LEVELS = [
        { name: "åŸºç¡€åŒ»ç–—ç‚¹", cap: 150, cost: 0, wardCap: 5 },
        { name: "ç§»åŠ¨åŒ»ç–—é˜Ÿ", cap: 200, cost: 10000, wardCap: 7 },
        { name: "é‡æˆ˜åŒ»é™¢", cap: 250, cost: 20000, wardCap: 9 },
        { name: "ä¸“ç§‘ä¸­å¿ƒ", cap: 500, cost: 50000, wardCap: 12 }
    ];

    const SHOP_ITEMS = [
        { id: 'snack', name: 'ğŸ« é›¶é£Ÿ', price: 100, desc: 'å¢åŠ  3ç‚¹ ç²¾åŠ›', type: 'cons', effect: { energy: 3 } },
        { id: 'medkit', name: 'ğŸ©¹ æ€¥æ•‘åŒ…', price: 150, desc: 'å¢åŠ  3ç‚¹ å¥åº·', type: 'cons', effect: { health: 3 } },
        { id: 'coffee', name: 'â˜• ç°ç£¨å’–å•¡', price: 200, desc: 'å¢åŠ  5ç‚¹ ç²¾åŠ›', type: 'cons', effect: { energy: 5 } },    
        { id: 'suit', name: 'ğŸ‘” æ­£è£…', price: 400, desc: 'æ°¸ä¹…å¢åŠ  5ç‚¹ ç¤¾äº¤', type: 'perm', effect: { soc: 5 } },
		{ id: 'book', name: 'ğŸ“š ç®¡ç†å­¦åŸ¹è®­ç­', price: 600, desc: 'æ°¸ä¹…å¢åŠ  5ç‚¹ è¡Œæ”¿', type: 'perm', effect: { admin: 5 } },
		{ id: 'scope', name: 'ğŸ©º ç‰¹çº§å¬è¯Šå™¨', price: 800, desc: 'æ°¸ä¹…å¢åŠ  5ç‚¹ åŒ»å­¦', type: 'perm', effect: { med: 5 } },
		{ id: 'coat', name: 'ğŸ‘©â€âš•ï¸é˜²åˆºç™½å¤§è¤‚', price: 1200, desc: 'æ°¸ä¹…å¢åŠ  10ç‚¹ åŒ»å­¦', type: 'perm', effect: { med: 10 } },
        { id: 'laptop', name: 'ğŸ’» ç¬”è®°æœ¬', price: 1500, desc: 'æ°¸ä¹…å¢åŠ  10ç‚¹ è¡Œæ”¿', type: 'perm', effect: { admin: 10 } },
        { id: 'phone', name: 'ğŸ“¡ å«æ˜Ÿç”µè¯', price: 1800, desc: 'æ°¸ä¹…å¢åŠ  10ç‚¹ ç¤¾äº¤', type: 'perm', effect: { soc: 10 } },
        { id: 'device', name: 'ğŸ”¬ å®éªŒè®¾å¤‡', price: 5000, desc: 'æ°¸ä¹…å¢åŠ  15ç‚¹ åŒ»å­¦', type: 'perm', effect: { med: 15 } },
        { id: 'suv', name: 'ğŸš™ è¶Šé‡è½¦', price: 10000, desc: 'æ¬è¿ç‰©èµ„ä¸å†æ¶ˆè€—å¥åº·', type: 'perm', effect: {} },
        // åŸºåœ°å‡çº§
        { id: 'base_lv2', name: 'ğŸ—ï¸ æ‰©å»º:ç§»åŠ¨åŒ»ç–—é˜Ÿ', price: 10000, desc: 'éš¾æ°‘ä¸Šé™200, æ›´å¤šåºŠä½', type: 'base', level: 1 },
        { id: 'base_lv3', name: 'ğŸ¥ æ‰©å»º:é‡æˆ˜åŒ»é™¢', price: 20000, desc: 'éš¾æ°‘ä¸Šé™250, æ›´å¤šåºŠä½', type: 'base', level: 2 },
        { id: 'base_lv4', name: 'ğŸ™ï¸ æ‰©å»º:ä¸“ç§‘ä¸­å¿ƒ', price: 50000, desc: 'éš¾æ°‘ä¸Šé™500, æ›´å¤šåºŠä½', type: 'base', level: 3 }
    ];

    const CONFIG = { ranks: RANKS };
    
    // å§“ååº“
    const LAST_NAMES = ["èµµ", "é’±", "å­™", "æ", "å‘¨", "å´", "éƒ‘", "ç‹", "é™ˆ", "é½", "å¼ ", "è®¸", "æ›¹", "æœ±", "åˆ˜", "ç½—", "å…³", "ä½•", "é’Ÿ", "æ± ", "æ—", "éœ", "è°¢", "è§£", "ç”°", "å­Ÿ", "å­”", "ç§¦", "é­", "ä»»", "æ¨", "é»„", "è‹", "å†¯", "æ¥š", "éš—", "è´º", "ä»‡", "æˆ´", "é¾š", "è–›", "å²", "è´¾"];
    const FIRST_NAMES = ["å¹³ç”Ÿ", "ä¸˜å£‘", "å¹³", "é£", "æ³Š", "ç£Š", "æ¶›", "æµ©å®‡", "æ¢“æ¶µ", "ä¼Ÿ", "èŠ³è²", "é™", "æ™¨æ¬£", "å­è±ª", "å¿—æ˜", "ä¸€é¸£", "äºé£", "å®¶é‘«", "æ¹›", "æ³½", "å®‡è¾°", "æ€€æ¢¦", "ä¸€è¯º", "é›¨éœ–", "ç¦", "ç¥¥", "ä¹å¤©", "ç´ ä¸–", "å¹½ç’ƒ", "æµ©ç„¶", "å«è‹±", "å¢¨ç€š", "å®å®", "ç§‹æŸ“", "èˆœå°§", "å›ç‰", "ç”±ä¹‹", "ä¿¡ç¤¼", "æ™“å…‰", "æ¾é¹¤", "æ¾¡é›ª", "æ²ç§‹", "æ˜¥å¤", "å³°åš", "å­è¾°", "ä»°æ­¢", "æ˜é˜³", "é“­å", "è‡´çŸ¥", "è¡Œä¹…", "çˆ±éŸ³", "ç«‹å¸Œ", "æµ·æ´‹", "é›ª", "å˜‰æ˜"];
    
    const ACHIEVEMENTS_DEF = [
        { id: 'cure10', name: 'å¦™æ‰‹å›æ˜¥', desc: 'æˆåŠŸæ²»ç–—10äºº', target: 10, key: 'cured' },
        { id: 'cure100', name: 'ææ—åœ£æ‰‹', desc: 'æˆåŠŸæ²»ç–—100äºº', target: 100, key: 'cured' },
        { id: 'cure500', name: 'æ‚¬å£¶æµä¸–', desc: 'æˆåŠŸæ²»ç–—500äºº', target: 500, key: 'cured' },
        { id: 'year1', name: 'åˆä¸€æ˜¥', desc: 'åº¦è¿‡ç¬¬1å¹´', target: 4, key: 'totalQuarters' },
        { id: 'year10', name: 'ä¸­æµç ¥æŸ±', desc: 'åº¦è¿‡10å¹´', target: 40, key: 'totalQuarters' },
        { id: 'maxRank', name: 'åº¦å·±æ•‘äºº', desc: 'èŒçº§å‡åˆ°æœ€é«˜', target: 5, key: 'rankIndex' },
        { id: 'maxBase', name: 'å¤§åº‡å¤©ä¸‹', desc: 'å‡çº§åŸºåœ°åˆ°æœ€é«˜çº§', target: 3, key: 'baseLevelIdx' },
        { id: 'ward12', name: 'äººæ»¡ä¸ºæ‚£', desc: 'ç—…æˆ¿åŒæ—¶æœ‰12äºº', target: 12, key: 'currentPatients' },
        { id: 'streak5', name: 'æ‰§ä¸šåŒ»å¸ˆ', desc: 'è¿èƒœ5é¢˜', target: 5, key: 'maxExamStreak' },
        { id: 'streak50', name: 'è¶…è®°å¿†ä½“', desc: 'è¿èƒœ50é¢˜', target: 50, key: 'maxExamStreak' },
        { id: 'death1', name: 'å¤œéª', desc: 'è§è¯1ä½ç—…äººçš„æ­»äº¡', target: 1, key: 'deaths' },
        { id: 'discharge15', name: 'æ€»æ˜¯å®‰æ…°', desc: 'é€èµ°15ä½ç—…äººï¼ˆæ²»æ„ˆæˆ–å‡ºé™¢ï¼‰', target: 15, key: 'discharged' },
        { id: 'stealSmall', name: 'çªƒé’©è€…è¯›', desc: 'æŒªç”¨1ä¸‡ç¾é‡‘', target: 10000, key: 'totalEmbezzled' },
        { id: 'stealBig', name: 'çªƒå›½è€…ä¾¯', desc: 'æŒªç”¨100ä¸‡ç¾é‡‘', target: 1000000, key: 'totalEmbezzled' },
        { id: 'surrender', name: 'é«˜æŠ¬è´µæ‰‹', desc: 'è¢«è°ƒæŸ¥åä¸Šäº¤å­˜æ¬¾', target: 1, key: 'hasSurrendered' },
        { id: 'honest', name: 'è‡³å…¬æ— ç§', desc: 'èƒœåˆ©æ—¶æœªæŒªç”¨è¿‡å…¬æ¬¾', target: 1, key: 'isHonest' }
    ];
    
    // ç‰¹æ®Šäº‹ä»¶å®šä¹‰
    const SPECIAL_EVENTS = [
        {
            id: 'force_majeure',
            name: 'ä¸å¯æŠ—åŠ›',
            desc: 'å—å½“åœ°æ”¿åºœçš„å¼ºåˆ¶å‘½ä»¤ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ’¤ç¦»æœ¬æ¬¡ä»»åŠ¡åœ°ç‚¹ã€‚',
            chance: 0.005, // 0.5%
            condition: () => true, // æ— æ¡ä»¶
            effect: 'transfer' // è°ƒä»»
        },
        {
            id: 'rapid_promotion',
            name: 'é’äº‘ç›´ä¸Š',
            desc: 'ä¸Šçº§å¯¹ä½ çš„èƒ½åŠ›ååˆ†æ»¡æ„ï¼Œç ´ä¾‹æ“¢å‡1çº§ã€‚',
            chance: 0.01, // 1%
            condition: () => player.favor >= 70 && player.rankIndex < 5, // å¥½æ„Ÿâ‰¥70ä¸”æœªåˆ°æœ€é«˜
            effect: 'promote' // æ™‹å‡1çº§
        },
        {
            id: 'homesickness',
            name: 'ç¾æ³Šæ¬²ç©·å¹´',
            desc: 'ä½ æ€€ç€æµä¸–çš„ç†æƒ³æ¥åˆ°è¿™é‡Œï¼Œæœ¬ä»¥ä¸ºèƒ½æŠŠè¿‡å»æŠ›åœ¨èº«åï¼Œä½†åœ¨è¿™ä¸ªå¤œæ™šï¼Œä¹¡æ„çªç„¶å‡»å®äº†ä½ ã€‚',
            chance: 0.01, // 1%
            condition: () => player.stats.currentLocQuarters >= 20 && player.rankIndex < 3, // 5å¹´(20å­£åº¦)ä¸”èŒçº§<4
            effect: 'homesick' // ç‰¹æ®Šé€‰æ‹©
        }
    ];

    // çŠ¶æ€æ•°æ®
    let player = { 
        name:"", gender:"", dept:"", med:0, admin:0, soc:0, health:60, energy:60, location: "",
        suspicion: 0, investigationCount: 0, rankIndex: 0, favor: 50, cash: 100, items: [],
        stats: { cured: 0, deaths: 0, discharged: 0, totalEmbezzled: 0, currentLocQuarters: 0, visitedLocs: [] },
        achievements: {}
    };
    let camp = { refugees: 100, supplies: 60, water: 60, tension: 30, funds: 10000, baseLevelIdx: 0 }; 
    let currentQuarter = 1; 
    let quartersSinceRank6 = 0;
    let dangerLevel = 5; 
    let isEventResolved = false; 
    let hasRestedToday = false; 
    let historyLog = [];
    let isVictoryPending = false;
    let bioCache = "";
    
    // æ–°å¢æ¨¡å—æ•°æ®
    let patients = [];
    let admittedCount = 0; // æœ¬å­£åº¦æ”¶æ²»äººæ•°
    let hasRounded = false; // æœ¬å­£åº¦æ˜¯å¦æŸ¥æˆ¿
    let fundsClickCount = 0; // åŸºåœ°èµ„é‡‘ç‚¹å‡»è®¡æ•°å™¨
    let examQuestions = [];
    let examStreak = 0;
    let maxExamStreak = 0;
    let hasTakenExam = false; // æœ¬å­£åº¦æ˜¯å¦è€ƒè¿‡
    
    // å°è¯•åŠ è½½test.jsä¸­çš„testDataå˜é‡ä½œä¸ºé¢˜åº“
    function loadtestDataQuestions() {
        try {
            if (typeof testData !== 'undefined' && Array.isArray(testData) && testData.length > 0 && testData[0].q) {
                examQuestions = testData;
                console.log(`æˆåŠŸåŠ è½½test.jsé¢˜åº“ï¼Œå…±${testData.length}é“é¢˜ç›®`);
            } else {
                console.log('test.jsä¸­æœªæ‰¾åˆ°testDataå˜é‡ï¼Œé¢˜åº“ä¸ºç©º');
            }
        } catch (e) {
            console.log('åŠ è½½test.jsé¢˜åº“å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é¢˜åº“', e);
        }
    }

    // å¼¹çª—å›è°ƒ
    let confirmCallback = null;

    // --- æ ¸å¿ƒå·¥å…· ---
    
    function showMessage(title, text) {
        $('msg-title').innerText = title;
        $('msg-content').innerText = text;
        $('message-modal').style.display = 'flex';
    }
    
    function closeMsgModal() {
        $('message-modal').style.display = 'none';
    }

    function showConfirm(title, text, callback) {
        $('cfm-title').innerText = title;
        $('cfm-content').innerText = text;
        confirmCallback = callback;
        $('confirm-modal').style.display = 'flex';
    }

    function closeConfirmModal(result) {
        $('confirm-modal').style.display = 'none';
        if (confirmCallback) confirmCallback(result);
    }

    // --- æ¸¸æˆé€»è¾‘ ---

    function generateRandomData() {
        player.lastName = LAST_NAMES[randInt(0, LAST_NAMES.length-1)];
        player.firstName = FIRST_NAMES[randInt(0, FIRST_NAMES.length-1)];
        player.name = player.lastName + player.firstName;
        
        player.gender = Math.random() > 0.5 ? "ç”·" : "å¥³";
        const depts = ["å†…ç§‘", "å¤–ç§‘", "ä¼ æŸ“ç§‘", "å„¿ç§‘", "å¦‡äº§ç§‘"];
        player.dept = depts[randInt(0, depts.length-1)];
        
        player.location = CHAR_LOCATIONS[randInt(0, CHAR_LOCATIONS.length-1)]; 
        player.suspicion = 0;
        player.investigationCount = 0;
        
        let sum = 0;
        do {
            player.med = randInt(10, 60);
            player.admin = randInt(10, 60);
            player.soc = randInt(10, 60);
            sum = player.med + player.admin + player.soc;
        } while (sum < 100 || sum > 150);
    }

    function updateSetupUI() {
        if(!$('p-location')) return;
        if($('input-lastname')) $('input-lastname').value = player.lastName || "";
        if($('input-firstname')) $('input-firstname').value = player.firstName || "";
        if($('p-gender')) $('p-gender').innerText = player.gender;
        if($('p-dept')) $('p-dept').innerText = player.dept;
        if($('p-location')) $('p-location').innerText = player.location;
        if($('p-location-desc')) $('p-location-desc').innerText = LOCATION_DESCRIPTIONS[player.location] || "";
        if($('p-med')) $('p-med').innerText = player.med;
        if($('p-admin')) $('p-admin').innerText = player.admin;
        if($('p-soc')) $('p-soc').innerText = player.soc;
    }

    function rollCharacter() {
        generateRandomData();
        updateSetupUI();
    }

    // --- å­˜æ¡£ç³»ç»Ÿ ---

    function saveGame(type) {
        const gameState = {
            player, camp, currentQuarter, dangerLevel, 
            isEventResolved, hasRestedToday, historyLog, 
            isVictoryPending, quartersSinceRank6, bioCache,
            patients, admittedCount, hasRounded,
            examQuestions, examStreak, maxExamStreak, hasTakenExam,
            saveDate: new Date().toLocaleString()
        };
        const key = type === 'auto' ? SAVE_KEY_AUTO : SAVE_KEY_MANUAL;
        localStorage.setItem(key, JSON.stringify(gameState));
    }

    function saveGameManual() {
        saveGame('manual');
        showMessage("ç³»ç»Ÿæç¤º", "âœ… æ‰‹åŠ¨å­˜æ¡£æˆåŠŸï¼");
    }

    function openLoadModal() {
        const autoData = localStorage.getItem(SAVE_KEY_AUTO);
        const manualData = localStorage.getItem(SAVE_KEY_MANUAL);

        $('slot-auto-info').innerText = autoData ? JSON.parse(autoData).saveDate : "æ— è®°å½•";
        $('slot-manual-info').innerText = manualData ? JSON.parse(manualData).saveDate : "æ— è®°å½•";
        
        $('load-modal').style.display = 'flex';
    }

    function loadSlot(type) {
        const key = type === 'auto' ? SAVE_KEY_AUTO : SAVE_KEY_MANUAL;
        const data = localStorage.getItem(key);
        if (!data) {
            showMessage("é”™è¯¯", "è¯¥æ ä½æ²¡æœ‰å­˜æ¡£ã€‚");
            return;
        }
        
        try {
            const state = JSON.parse(data);
            player = state.player;
            camp = state.camp;
            currentQuarter = state.currentQuarter;
            dangerLevel = state.dangerLevel;
            isEventResolved = state.isEventResolved;
            hasRestedToday = state.hasRestedToday;
            historyLog = state.historyLog;
            isVictoryPending = state.isVictoryPending;
            quartersSinceRank6 = state.quartersSinceRank6;
            bioCache = state.bioCache || "";
            // New state load
            patients = state.patients || [];
            // å…¼å®¹æ—§å­˜æ¡£ï¼šä¸ºæ²¡æœ‰ç”Ÿå‘½æŒ‡å¾çš„ç—…äººæ·»åŠ é»˜è®¤å€¼
            patients.forEach(p => {
                if(p.vital === undefined) {
                    p.vital = [60, 40, 20][p.sev || 0];
                }
                if(p.isDead === undefined) {
                    p.isDead = false;
                }
            });
            admittedCount = state.admittedCount || 0;
            hasRounded = state.hasRounded || false;
            examQuestions = state.examQuestions || [];
            examStreak = state.examStreak || 0;
            maxExamStreak = state.maxExamStreak || 0;
            hasTakenExam = state.hasTakenExam || false;
            
            $('load-modal').style.display = 'none';
            if($('setup-screen').classList.contains('active')) {
                $('setup-screen').classList.remove('active');
            }
            initGame(true); 
            showMessage("ç³»ç»Ÿæç¤º", "ğŸ“‚ è¯»æ¡£æˆåŠŸï¼");
        } catch(e) {
            console.error("Load failed", e);
            showMessage("é”™è¯¯", "å­˜æ¡£æ–‡ä»¶æŸåã€‚");
        }
    }

    function checkSaveFile() {
        const hasAuto = localStorage.getItem(SAVE_KEY_AUTO);
        const hasManual = localStorage.getItem(SAVE_KEY_MANUAL);
        if (hasAuto || hasManual) {
            $('continue-btn').style.display = 'block';
        } else {
            $('continue-btn').style.display = 'none';
        }
    }

    function tryExitGame() {
        showConfirm("é€€å‡ºæ¸¸æˆ", "ç¡®å®šè¦é€€å‡ºå—ï¼Ÿå½“å‰è¿›åº¦å°†è‡ªåŠ¨ä¿å­˜ã€‚", (result) => {
            if(result) {
                saveGame('auto');
                $('game-screen').classList.remove('active');
                $('end-screen').classList.remove('active');
                $('setup-screen').classList.add('active');
                $('bottom-nav').style.display = 'none';
                $('exit-game-btn').style.display = 'none';
                checkSaveFile();
            }
        });
    }
    
    function tryStartNewGame() {
        if($('continue-btn').style.display !== 'none') {
            showConfirm("æ–°æ¸¸æˆ", "å¼€å§‹æ–°æ¸¸æˆå°†è¦†ç›–å­˜æ¡£ï¼Œç¡®å®šå—ï¼Ÿ", (res) => {
                if(res) startNewGame();
            });
        } else {
            startNewGame();
        }
    }

    function startNewGame() {
        // Reset Logic
        historyLog = [];
        dangerLevel = 5;
        currentQuarter = 1;
        isEventResolved = false;
        isVictoryPending = false;
        camp = { refugees: 100, supplies: 60, water: 60, tension: 30, funds: 10000, baseLevelIdx: 0 };
        player.rankIndex = 0;
        player.favor = 10;
        player.cash = 100;
        player.items = [];
        player.suspicion = 0;
        player.investigationCount = 0;
        player.appliedPromo = false;
        player.lastPromoQuarter = 0;
        player.stats = { cured: 0, deaths: 0, discharged: 0, totalEmbezzled: 0, currentLocQuarters: 0, visitedLocs: [], totalQuarters: 0, isHonest: 1, hasSurrendered: 0 };
        player.achievements = {}; // æ¸…ç©ºæˆå°±è®°å½•
        
        // è·å–æ‰‹åŠ¨è¾“å…¥çš„å§“å
        player.lastName = $('input-lastname').value || "æ— ";
        player.firstName = $('input-firstname').value || "å";
        player.name = player.lastName + player.firstName;
        
        patients = [];
        admittedCount = 0;
        hasRounded = false;
        hasRestedToday = false;
        quartersSinceRank6 = 0;
        bioCache = "";
        examStreak = 0;
        maxExamStreak = 0;
        hasTakenExam = false;
        
        loadtestDataQuestions();

        initGame();
        saveGame('auto');
    }

    window.onload = function() {
        loadtestDataQuestions(); // åŠ è½½test.jsä¸­çš„testDataé¢˜åº“
        checkSaveFile();
        renderShop();
        rollCharacter();
    };

    function toggleTheme() { document.body.classList.toggle('night-mode'); }
    
    function openSettingsModal() {
        $('settings-modal').style.display = 'flex';
    }
    
    function closeSettingsModal() {
        $('settings-modal').style.display = 'none';
    }

    function switchNav(tabName, btnElement) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        $('tab-' + tabName).classList.add('active');
        if(btnElement) btnElement.classList.add('active');
    }

    function toggleApiInput() {
        let isMock = $('use-mock').checked;
        $('api-key').disabled = isMock;
        $('model-name').disabled = isMock;
        $('api-url').disabled = isMock;
    }

    async function initGame(isLoad = false) {
        if(!isLoad && !player.name) rollCharacter();
        
        $('setup-screen').classList.remove('active');
        $('loading-screen').classList.add('active');
        $('exit-game-btn').style.display = 'block';

        if (!isLoad) {
            addLog("> éªŒè¯èº«ä»½æƒé™..."); await wait(600);
            let locName = player.location ? player.location.split(' - ')[0] : "æœªçŸ¥åŒºåŸŸ";
            addLog(`> åŠ å¯†è¿æ¥è‡³æŒ‡æŒ¥éƒ¨: ${locName}...`); await wait(800); 
            addLog("> æ­£åœ¨ä¸‹è½½äººå‘˜æ¡£æ¡ˆ...");
            
            try {
                const bioText = await generateBio();
                bioCache = bioText; // Cache bio
                $('bio-container').innerHTML = bioText;
            } catch (e) {
                console.error(e);
                $('bio-container').innerHTML = "ï¼ˆæ•°æ®æŸåï¼Œæ— æ³•æ˜¾ç¤ºæ¡£æ¡ˆï¼‰";
            }
        } else {
            $('bio-container').innerHTML = bioCache || "ï¼ˆæ¡£æ¡ˆè¯»å–ä¸­...ï¼‰";
            addLog("> è¯»å–æœ¬åœ°ç¼“å­˜..."); await wait(500);
            addLog("> æ¢å¤æŒ‡æŒ¥é“¾è·¯..."); await wait(500);
        }
        
        startGameUI(isLoad);
    }

    function addLog(text) {
        const div = document.createElement('div');
        div.className = 'log-line';
        div.innerText = text;
        $('log-box').appendChild(div);
    }

    function startGameUI(isLoad) {
        $('loading-screen').classList.remove('active');
        $('game-screen').classList.add('active');
        $('bottom-nav').style.display = 'grid'; // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆª
        
        $('game-location-display').style.display = 'block';
        $('game-location-display').innerText = 'ğŸ“ ' + player.location;

        if (!isLoad) {
            // æ–°æ¸¸æˆåˆå§‹åŒ–
            isEventResolved = false;
            $('start-event-btn').style.display = 'block';
            $('next-day-btn').style.display = 'none';
            $('event-area').style.display = 'none';
            
            const firstSalary = RANK_SALARIES[player.rankIndex];
            player.cash += firstSalary;
            addAchievement("æ¸¸æˆå¼€å§‹ - æŠµè¾¾å‰çº¿");
            saveGame('auto');
        } else {
            // è¯»æ¡£æ¢å¤çŠ¶æ€
            $('log-box').innerHTML = ""; 
            if (isEventResolved) {
                $('start-event-btn').style.display = 'none';
                $('event-area').style.display = 'none';
                $('next-day-btn').style.display = 'block';
                $('next-quarter-msg').style.display = 'block';
            } else {
                $('start-event-btn').style.display = 'block';
                $('next-day-btn').style.display = 'none';
                $('event-area').style.display = 'none';
                $('next-quarter-msg').style.display = 'none';
            }
        }
        
        updateUI();
        renderPatients();
        renderExamUI();
    }

    async function fetchDailyEvent() {
        $('start-event-btn').style.display = 'none';
        $('loading-spinner').style.display = 'block';
        
        try {
            const eventData = await generateEventData();
            renderEvent(eventData);
        } catch (e) {
            console.error(e);
            renderEvent(mockEvent());
        }
    }

    // --- åŸºåœ° & å•†åº—é€»è¾‘ ---

    function renderShop() {
        const container = $('shop-container');
        container.innerHTML = '';
        SHOP_ITEMS.forEach(item => {
            if(item.id.includes('base_lv')) {
                // Check level requirement
                if(item.level <= camp.baseLevelIdx) return; // Already bought or lower level
                if(item.level > camp.baseLevelIdx + 1) return; // Next level only
            }

            const el = document.createElement('div');
            el.className = 'item-card';
            const priceLabel = item.type === 'base' ? 'åŸºåœ°èµ„é‡‘' : 'ä¸ªäººå­˜æ¬¾';
            el.innerHTML = `
                <div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price} <span style="font-size:0.7rem; font-weight:normal; color:#888;">(${priceLabel})</span></div>
                    <div class="item-desc">${item.desc}</div>
                </div>
                <button class="buy-btn" id="btn-buy-${item.id}" onclick="buyItem('${item.id}')">è´­ä¹°</button>
            `;
            container.appendChild(el);
        });
    }

    function buyItem(itemId) {
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if(!item) return;

        if (item.type === 'perm' && player.items.includes(item.id)) {
            return showMessage("æç¤º", "ä½ å·²ç»æ‹¥æœ‰è¯¥ç‰©å“äº†ï¼");
        }

        // æ‰©å»ºä½¿ç”¨åŸºåœ°èµ„é‡‘
        if (item.type === 'base') {
            if (camp.funds < item.price) return showMessage("æç¤º", "åŸºåœ°èµ„é‡‘ä¸è¶³ï¼");
            camp.funds -= item.price;
            camp.baseLevelIdx = item.level;
            showMessage("åŸºåœ°å‡çº§", `${item.name} å»ºè®¾å®Œæˆï¼å®¹é‡æå‡ã€‚`);
        } else {
            if (player.cash < item.price) return showMessage("æç¤º", "ä¸ªäººå­˜æ¬¾ä¸è¶³ï¼");
            player.cash -= item.price;
            if (item.type === 'perm') {
                player.items.push(item.id);
                applyChanges(item.effect);
                showMessage("è´­ä¹°æˆåŠŸ", `${item.name}ï¼šèƒ½åŠ›å·²æ°¸ä¹…æå‡ã€‚`);
            } else {
                applyChanges(item.effect);
                showMessage("è´­ä¹°æˆåŠŸ", `${item.name}ï¼šå·²ç«‹å³ä½¿ç”¨ã€‚`);
            }
        }
        
        updateUI();
        renderShop();
        saveGame('auto');
    }

    function buyBaseItem(type) {
        if(camp.funds < 500) return showMessage("æç¤º", "åŸºåœ°èµ„é‡‘ä¸è¶³ï¼");
        
        camp.funds -= 500;
        if(type === 'supplies') {
            camp.supplies += 5;
            showMessage("è¡¥ç»™", "ç‰©èµ„ +5");
        } else {
            camp.water += 5;
            showMessage("è¡¥ç»™", "å‡€æ°´ +5");
        }
        updateUI();
        saveGame('auto');
    }

    // --- ç—…æˆ¿ç³»ç»Ÿé€»è¾‘ ---

    function renderPatients() {
        const list = $('patient-list');
        list.innerHTML = '';
        if(patients.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">ç—…æˆ¿ç©ºç½®ä¸­</div>';
            return;
        }

        patients.forEach((p, idx) => {
            const card = document.createElement('div');
            card.className = `patient-card p-sev-${p.sev}`;
            const sevText = ["è½»ç—‡","ä¸­ç—‡","é‡ç—‡"][p.sev];
            const sevColor = ["#2ecc71","#f1c40f","#e74c3c"][p.sev];
            
            // ç”Ÿå‘½æŒ‡å¾é¢œè‰²
            const vitalColor = p.vital > 50 ? "#2ecc71" : (p.vital > 30 ? "#f1c40f" : "#e74c3c");
            const vital = p.vital !== undefined ? p.vital : 60;
            
            // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæŒ‰é’®
            let actionButtons = '';
            if(p.isDead) {
                actionButtons = `
                    <button class="p-btn" style="background:#555; color:white;" onclick="buryPatient(${idx})">âš°ï¸ åŸ‹è‘¬ (-$100)</button>
                `;
            } else {
                actionButtons = `
                    <button class="p-btn" style="background:var(--blue); color:white;" onclick="treatPatient(${idx})">ğŸ’‰ æ²»ç–—</button>
                    ${vital <= 30 ? `<button class="p-btn" style="background:var(--danger); color:white;" onclick="rescuePatient(${idx})">ğŸš¨ æŠ¢æ•‘</button>` : ''}
                    <button class="p-btn" style="background:var(--border); color:var(--text);" onclick="dischargePatient(${idx})">å‡ºé™¢</button>
                `;
            }
            
            card.innerHTML = `
                <div class="p-header">
                    <span>${p.bed}åºŠ  (${p.age}å²ï¼Œ${p.gender})</span>
                    <span style="color:${sevColor}">${p.isDead ? 'â˜ ï¸ å·²æ­»äº¡' : sevText}</span>
                </div>
                <div class="p-info">ä¸»è¯‰: ${p.cc}</div>
                <div class="p-desc">${p.hpi}</div>
                <div style="font-size:0.9em; margin-bottom:5px;">
                    è¯Šç–—è¿›åº¦: ${p.prog}% <div class="bar-bg" style="display:inline-block; width:100px; height:6px; vertical-align:middle;"><div class="bar-fill" style="width:${p.prog}%; background:var(--blue);"></div></div>
                </div>
                <div style="font-size:0.9em; margin-bottom:5px;">
                    ç”Ÿå‘½æŒ‡å¾: <span style="color:${vitalColor}; font-weight:bold;">${vital}</span>/100 
                    <div class="bar-bg" style="display:inline-block; width:100px; height:6px; vertical-align:middle;"><div class="bar-fill" style="width:${vital}%; background:${vitalColor};"></div></div>
                </div>
                <div class="p-actions">
                    ${actionButtons}
                </div>
            `;
            list.appendChild(card);
        });
    }

    async function admitPatient() {
        const maxCap = BASE_LEVELS[camp.baseLevelIdx].wardCap;
        if(patients.length >= maxCap) return showMessage("åºŠä½å·²æ»¡", "æ— æ³•æ”¶æ²»æ›´å¤šç—…äººã€‚");
        if(admittedCount >= 3) return showMessage("é™é¢å·²æ»¡", "æ¯å­£åº¦æœ€å¤šæ”¶æ²»3äººã€‚");

        admittedCount++;
        
        // Generate basic data
        const bedNum = findEmptyBed(maxCap);
        // å„¿ç§‘å¹´é¾„0-18ï¼Œå…¶ä»–ç§‘å®¤0-75
        const age = player.dept === "å„¿ç§‘" ? randInt(0, 18) : randInt(0, 75);
        const gender = Math.random()>0.5?"ç”·":"å¥³";
        // è½»ç—‡50%ï¼Œä¸­ç—‡30%ï¼Œé‡ç—‡20%
        const sevRoll = Math.random();
        const sev = sevRoll < 0.5 ? 0 : (sevRoll < 0.8 ? 1 : 2);
        const name = "P." + randInt(100,999);
        
        // ç”Ÿå‘½æŒ‡å¾åˆå§‹å€¼ï¼šè½»ç—‡60ï¼Œä¸­ç—‡40ï¼Œé‡ç—‡20
        const vitalInit = [60, 40, 20][sev];
        
        const newPatient = {
            bed: bedNum,
            name: name,
            age: age,
            gender: gender,
            sev: sev,
            cc: "ç”Ÿæˆä¸­...",
            hpi: "ç”Ÿæˆä¸­...",
            prog: 0,
            vital: vitalInit, // ç”Ÿå‘½æŒ‡å¾
            isDead: false // æ˜¯å¦æ­»äº¡
        };
        
        patients.push(newPatient);
        // Sort by bed
        patients.sort((a,b) => a.bed - b.bed);
        renderPatients();
        updateUI();

        // API Call for text
        try {
            const prompt = `ç”Ÿæˆä¸€ä¸ªæ— å›½ç•ŒåŒ»ç”Ÿå‰çº¿ç—…äººç—…ä¾‹ã€‚
            ç§‘å®¤:${player.dept}ã€‚ç—…äºº:${age}å²${gender}ï¼Œå±æ€¥åº¦:${["è½»ç—‡","ä¸­ç—‡","é‡ç—‡"][sev]}ã€‚
            è¯·è¿”å›JSONæ ¼å¼: {"cc":"ä¸»è¯‰(20å­—å†…)", "hpi":"ç°ç—…å²(70å­—å·¦å³)"}`;
            
            const res = await callDeepSeek(prompt, true);
            newPatient.cc = res.cc;
            newPatient.hpi = res.hpi;
            renderPatients();
        } catch(e) {
            newPatient.cc = "è…¹ç—›ä¼´å‘çƒ­3å¤©";
            newPatient.hpi = "æ‚£è€…3å¤©å‰æ— æ˜æ˜¾è¯±å› å‡ºç°è…¹ç—›ï¼Œä¼´å‘çƒ­ï¼Œæœ€é«˜ä½“æ¸©38.5åº¦ã€‚";
            renderPatients();
        }
        saveGame('auto');
    }

    function findEmptyBed(max) {
        const taken = patients.map(p => p.bed);
        let bed = randInt(1, max);
        while(taken.includes(bed)) {
            bed = randInt(1, max);
        }
        return bed;
    }

    function doRounds() {
        if(hasRounded) return showMessage("æç¤º", "æœ¬å­£åº¦å·²æŸ¥æˆ¿ã€‚");
        if(patients.length === 0) return showMessage("æç¤º", "æ²¡æœ‰ç—…äººã€‚");
        if(camp.supplies < 5) return showMessage("ç‰©èµ„ä¸è¶³", "éœ€è¦5ç‰©èµ„ã€‚");
        if(player.health < 5) return showMessage("ä½“åŠ›ä¸è¶³", "å¤ªç´¯äº†ã€‚");

        camp.supplies -= 5;
        player.health -= 5;
        hasRounded = true;

        let log = "";
        patients.forEach(p => {
            const gain = randInt(5, 10);
            p.prog = Math.min(100, p.prog + gain);
        });
        
        showMessage("æŸ¥æˆ¿ç»“æŸ", "æ‰€æœ‰ç—…äººè¯Šç–—è¿›åº¦æå‡ 5-10%ã€‚");
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    function treatPatient(idx) {
        let p = patients[idx];
        if(p.isDead) return showMessage("æç¤º", "è¯¥ç—…äººå·²æ­»äº¡ã€‚");
        if(!p.treatCount) p.treatCount = 0;
        if(p.treatCount >= 3) return showMessage("æç¤º", "è¯¥ç—…äººæœ¬å­£åº¦å·²è¾¾æ²»ç–—ä¸Šé™(3æ¬¡)");
        
        player.energy -= 2;
        p.treatCount++;
        
        // Formula: floor(10% Med) + rand(10-20) - sev*3
        let gain = Math.floor(player.med * 0.1) + randInt(10, 20) - (p.sev * 3);
        // Buffs? Assuming items might add buffs later, strictly logic now:
        if(player.items.includes('device')) gain += 5; // Example buff
        
        if(gain < 1) gain = 1;
        p.prog = Math.min(100, p.prog + gain);
        
        // æ²»ç–—å¢åŠ ç”Ÿå‘½æŒ‡å¾ 5-10
        const vitalGain = randInt(5, 10);
        p.vital = Math.min(100, (p.vital || 60) + vitalGain);
        
        renderPatients();
        updateUI();
    }
    
    // æŠ¢æ•‘åŠŸèƒ½ï¼šç”Ÿå‘½æŒ‡å¾â‰¤30æ—¶å¯ç”¨ï¼Œæ¶ˆè€—5ç‰©èµ„ï¼Œ+10ç”Ÿå‘½æŒ‡å¾
    function rescuePatient(idx) {
        let p = patients[idx];
        if(p.isDead) return showMessage("æç¤º", "è¯¥ç—…äººå·²æ­»äº¡ã€‚");
        if(p.vital > 30) return showMessage("æç¤º", "ç—…äººç”Ÿå‘½æŒ‡å¾ç¨³å®šï¼Œæ— éœ€æŠ¢æ•‘ã€‚");
        if(camp.supplies < 5) return showMessage("ç‰©èµ„ä¸è¶³", "æŠ¢æ•‘éœ€è¦æ¶ˆè€—5ç‚¹ç‰©èµ„ã€‚");
        
        camp.supplies -= 5;
        p.vital = Math.min(100, p.vital + 10);
        
        showMessage("æŠ¢æ•‘æˆåŠŸ", `ç—…äººç”Ÿå‘½æŒ‡å¾æå‡è‡³ ${p.vital}ã€‚`);
        renderPatients();
        updateUI();
        saveGame('auto');
    }
    
    // åŸ‹è‘¬åŠŸèƒ½ï¼šæ¶ˆè€—$100ï¼Œæ¸…é™¤æ­»äº¡ç—…äºº
    function buryPatient(idx) {
        if(camp.funds < 100) return showMessage("èµ„é‡‘ä¸è¶³", "åŸ‹è‘¬éœ€è¦æ¶ˆè€— $100 åŸºåœ°èµ„é‡‘ã€‚");
        
        camp.funds -= 100;
        patients.splice(idx, 1);
        
        showMessage("å·²å®‰è‘¬", "ç—…äººå·²å®‰æ¯ã€‚æ„¿é€è€…å®‰å®ã€‚");
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    function dischargePatient(idx) {
        const p = patients[idx];
        player.stats.discharged = (player.stats.discharged || 0) + 1;
        
        if(p.prog >= 100) {
            // Success
            player.stats.cured++;
            const reward = randInt(50, 150) + (p.sev * 50);
            player.cash += reward;
            showMessage("æ²»æ„ˆå‡ºé™¢", `ç—…äººåº·å¤ç¦»å¼€ã€‚æ”¶åˆ°æŠ¥é…¬/æèµ  $${reward}ã€‚`);
        } else {
            // Fail/Early discharge
            player.stats.deaths++;
            camp.tension += 10;
            showMessage("æå‰å‡ºé™¢", `æ²»ç–—æœªå®Œæˆã€‚ç—…äººå®¶å±è¡¨ç¤ºä¸æ»¡ï¼Œè¥åœ°ç´§å¼ åº¦ +10ã€‚`);
        }
        
        patients.splice(idx, 1);
        renderPatients();
        updateUI();
        saveGame('auto');
    }

    // --- è€ƒæ ¸ç³»ç»Ÿé€»è¾‘ ---

    function startExam() {
        if(hasTakenExam) return showMessage("æç¤º", "æœ¬å­£åº¦å·²å‚åŠ è¿‡è€ƒæ ¸ã€‚");
        
        hasTakenExam = true;
        $('exam-start-area').style.display = 'none';
        $('exam-ui').style.display = 'block';
        
        // Check if questions available
        if(examQuestions.length === 0) {
            return showMessage("æç¤º", "é¢˜åº“ä¸ºç©ºï¼Œè¯·å…ˆåŠ è½½é¢˜ç›®ï¼");
        }
        
        loadNextQuestion();
    }

    function loadNextQuestion() {
        // Pick random
        if(examQuestions.length === 0) {
            showMessage("æç¤º", "é¢˜åº“å·²ç”¨å®Œï¼");
            setTimeout(() => {
                closeMsgModal();
                quitExam();
            }, 1500);
            return;
        }
        const qIdx = randInt(0, examQuestions.length - 1);
        const qData = examQuestions[qIdx];
        
        // Remove used
        examQuestions.splice(qIdx, 1); // Remove to prevent repeat in one session? 
        // Logic: Continuous correct answers.
        
        $('exam-q-text').innerText = qData.q;
        const div = $('exam-options');
        div.innerHTML = '';
        
        // éšè—ç»“æœå’Œé€€å‡ºæŒ‰é’®
        $('exam-result').style.display = 'none';
        $('exam-quit-btn').style.display = 'none';
        
        const optionLabels = ["A","B","C","D","E"];
        qData.o.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'exam-opt';
            btn.innerText = optionLabels[idx] + ". " + opt;
            btn.onclick = () => checkAnswer(idx, qData.a);
            div.appendChild(btn);
        });
    }

    function checkAnswer(chosen, correct) {
        // ç¦ç”¨æ‰€æœ‰é€‰é¡¹æŒ‰é’®å¹¶é«˜äº®æ˜¾ç¤º
        const options = $('exam-options').querySelectorAll('.exam-opt');
        const optionLabels = ["A","B","C","D","E"];
        
        options.forEach((btn, idx) => {
            btn.disabled = true;
            if(idx === correct) {
                // æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤ºç»¿è‰²
                btn.style.background = 'var(--green)';
                btn.style.color = 'white';
            } else if(idx === chosen && chosen !== correct) {
                // é”™è¯¯ç­”æ¡ˆæ˜¾ç¤ºçº¢è‰²
                btn.style.background = 'var(--danger)';
                btn.style.color = 'white';
            }
        });
        
        const resultDiv = $('exam-result');
        resultDiv.style.display = 'block';
        
        if(chosen === correct) {
            examStreak++;
            if(examStreak > maxExamStreak) maxExamStreak = examStreak;
            updateUI();
            resultDiv.style.background = 'var(--green)';
            resultDiv.style.color = 'white';
            resultDiv.innerHTML = `<strong>âœ“ å›ç­”æ­£ç¡®ï¼</strong><br>è¿èƒœ +1ï¼Œå½“å‰è¿èƒœï¼š${examStreak}`;
            setTimeout(() => {
                loadNextQuestion();
            }, 1500);
        } else {
            examStreak = 0; // Reset streak on fail
            resultDiv.style.background = 'var(--danger)';
            resultDiv.style.color = 'white';
            resultDiv.innerHTML = `<strong>âœ— å›ç­”é”™è¯¯</strong><br>æ­£ç¡®ç­”æ¡ˆæ˜¯: ${optionLabels[correct]}<br>æœ¬æ¬¡è€ƒæ ¸ç»“æŸã€‚`;
            // æ˜¾ç¤ºé€€å‡ºæŒ‰é’®
            $('exam-quit-btn').style.display = 'block';
        }
        saveGame('auto');
    }

    function quitExam() {
        $('exam-start-area').style.display = 'block';
        $('exam-ui').style.display = 'none';
        // é‡ç½®ç»“æœå’Œé€€å‡ºæŒ‰é’®
        $('exam-result').style.display = 'none';
        $('exam-quit-btn').style.display = 'none';
        $('exam-result').innerHTML = '';
        updateUI();
    }

    function importQuestions() {
        const json = $('exam-import-area').value;
        try {
            const data = JSON.parse(json);
            if(Array.isArray(data) && data.length > 0 && data[0].q) {
                examQuestions = data;
                showMessage("å¯¼å…¥æˆåŠŸ", `æˆåŠŸå¯¼å…¥ ${data.length} é“é¢˜ç›®ã€‚`);
            } else {
                showMessage("æ ¼å¼é”™è¯¯", "æ ¼å¼ä¸æ­£ç¡®ã€‚");
            }
        } catch(e) {
            showMessage("è§£æå¤±è´¥", "JSONè§£æå¤±è´¥ã€‚");
        }
    }

    // --- UI æ›´æ–° ---
    
    function getSeasonInfo() {
        const year = Math.ceil(currentQuarter / 4);
        const seasonIndex = (currentQuarter - 1) % 4; 
        const seasons = ["æ˜¥", "å¤", "ç§‹", "å†¬"];
        return { year, season: seasons[seasonIndex], index: seasonIndex };
    }

    function updateSliderUI(type) {
        if (type === 'don') {
            const val = $('don-slider').value;
            $('don-val').innerText = val + "%";
            const give = Math.floor(player.cash * (val/100));
            $('don-give').innerText = '$' + give;
            $('don-get').innerText = '$' + give;
        }
    }

    function updateUI() {
        const timeInfo = getSeasonInfo();
        $('day-display').innerText = `ç¬¬${timeInfo.year}å¹´ ${timeInfo.season}`;
        
        $('val-refugees').innerText = camp.refugees;
        $('val-funds').innerText = '$' + camp.funds;
        $('val-cash-char').innerText = '$' + player.cash;
        $('val-cash-items').innerText = '$' + player.cash;
        $('val-base-lvl').innerText = BASE_LEVELS[camp.baseLevelIdx].name;
        $('val-base-lvl-num').innerText = camp.baseLevelIdx + 1;
        
        const currentSalary = RANK_SALARIES[player.rankIndex];
        $('val-salary').innerText = `+$${currentSalary}`;
        
        $('curr-streak').innerText = examStreak;
        $('best-streak').innerText = maxExamStreak;
        $('val-max-streak').innerText = maxExamStreak;

        // Ward UI
        const wardCap = BASE_LEVELS[camp.baseLevelIdx].wardCap;
        $('ward-count').innerText = patients.length;
        $('ward-cap').innerText = wardCap;
        $('ward-limit-msg').innerText = `æœ¬å­£æ”¶æ²»: ${admittedCount}/3`;

        const updateBar = (id, val, isReverse=false) => {
            let el = $(id);
            if(!el) return;
            el.innerText = val + (id.includes('tension')||id.includes('supplies')||id.includes('water')?'%':'');
            let bar = $('bar-' + id.replace('val-',''));
            if(bar) {
                bar.style.width = Math.max(0, Math.min(100, val)) + '%';
                bar.className = 'bar-fill';
                if (isReverse) { 
                    if(val > 70) bar.classList.add('low'); else if(val < 30) bar.classList.add('high');
                } else { 
                    if(val < 30) bar.classList.add('low'); else if(val > 70) bar.classList.add('high');
                }
            }
        };

        updateBar('val-tension', camp.tension, true);
        updateBar('val-supplies', camp.supplies);
        updateBar('val-water', camp.water);
        updateBar('val-health', player.health);
        updateBar('val-energy', player.energy);
        updateBar('val-med', player.med);
        updateBar('val-admin', player.admin);
        updateBar('val-soc', player.soc);
        
        // å«Œç–‘åº¦ UI
        $('val-suspicion').innerText = player.suspicion;
        $('bar-suspicion').style.width = Math.min(100, player.suspicion) + '%';
        
        // èŒçº§UI
        $('val-rank-name').innerText = CONFIG.ranks[player.rankIndex];
        $('val-rank-lvl').innerText = player.rankIndex + 1;
        $('val-favor').innerText = player.favor;
        $('bar-favor').style.width = player.favor + '%';

        // æˆå°±ç³»ç»Ÿæ¸²æŸ“
        const achList = $('achievement-list');
        if(achList) {
            achList.innerHTML = '';
            let unlockedCount = 0;
            ACHIEVEMENTS_DEF.forEach(ach => {
                let current = 0;
                if (ach.key === 'rankIndex') current = player.rankIndex;
                else if (ach.key === 'currentPatients') current = patients.length;
                else if (ach.key === 'baseLevelIdx') current = camp.baseLevelIdx;
                else if (ach.key === 'maxExamStreak') current = maxExamStreak;
                else current = player.stats[ach.key] || 0;
                
                let percent = Math.floor(Math.min(100, (current / ach.target) * 100));
                
                // ç‰¹æ®Šé€»è¾‘ï¼šè‡³å…¬æ— ç§æˆå°±è¦åˆ°æ¸¸æˆç»“æŸæ‰ç®—100%
                if(ach.id === 'honest' && !isVictoryPending) {
                    percent = 0;
                }
                
                if(percent >= 100) {
                    unlockedCount++;
                    if(!player.achievements[ach.id]) {
                        player.achievements[ach.id] = true;
                        addLog(`ğŸ† è¾¾æˆæˆå°±ï¼š${ach.name}`);
                    }
                }

                const item = document.createElement('li');
                item.className = 'achieve-item';
                if(percent >= 100) item.style.borderColor = 'var(--gold)';
                else item.style.borderColor = 'var(--border)';
                
                item.innerHTML = `
                    <div class="achieve-name">${percent >= 100 ? 'âœ… ' : ''}${ach.name}</div>
                    <div class="achieve-desc">${ach.desc}</div>
                    <div class="achieve-progress-box">
                        <div style="font-size:0.8rem; color:#666;">ç›®æ ‡: ${ach.target} (${current}/${ach.target})</div>
                        <div class="achieve-percent">${percent}%</div>
                    </div>
                `;
                achList.appendChild(item);
            });

            // æ€»è¾¾æˆç‡
            const totalPercent = Math.floor((unlockedCount / ACHIEVEMENTS_DEF.length) * 100);
            if($('total-achieve-bar')) $('total-achieve-bar').style.width = totalPercent + '%';
            if($('total-achieve-text')) $('total-achieve-text').innerText = totalPercent + '%';

            // å±¥å†æ±‡æ€»
            if($('summary-cured')) $('summary-cured').innerText = player.stats.cured || 0;
            if($('summary-quarters')) $('summary-quarters').innerText = player.stats.totalQuarters || 0;
            if($('summary-max-rank')) $('summary-max-rank').innerText = player.rankIndex + 1;
        }
        
        // å•†åº—æŒ‰é’®çŠ¶æ€
        SHOP_ITEMS.forEach(item => {
            const btn = $('btn-buy-' + item.id);
            if(btn) {
                let price = item.price;
                let fundSource = (item.type === 'base') ? camp.funds : player.cash; // Wait, actually logic says base funds buy equip
                
                // Logic correction: 
                // Consumables (type 'cons') -> Player Cash? No prompt says "Base funds buy supplies/water" in Prompt 7
                // Wait. Prompt 7: "1. base funds buy supplies/water... 2. permanent base upgrades... cost 10000"
                // So Base Items use Camp Funds. Personal Items use Player Cash.
                
                if (item.id === 'supplies' || item.id === 'water') {
                    // Handled by buyBaseItem buttons separately
                } else if (item.type === 'base') {
                     if (camp.funds < price) btn.style.opacity = "0.5"; else btn.style.opacity = "1";
                } else {
                     if (player.items.includes(item.id)) { btn.disabled = true; btn.innerText = "å·²æ‹¥æœ‰"; }
                     else if (player.cash < price) btn.style.opacity = "0.5"; else btn.style.opacity = "1";
                }
            }
        });

        // æ™‹å‡çŠ¶æ€
        let promoText = "";
        const seasonIdx = (currentQuarter - 1) % 4; // 2 is Autumn
        const nextRankReq = RANK_REQ_STREAK[player.rankIndex]; // Req to go to next level? 
        // Array index 0 is rank 1. Req for rank 2 is index 1?
        // RANK_REQ_STREAK = [0, 3, 5, 10, 15, 20]
        // Current Rank Index 0 (Lv1). Target Rank Index 1 (Lv2). Need streak 3 (idx 1).
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;

        if (player.rankIndex >= 5) {
             promoText = "å·²è¾¾æœ€é«˜èŒçº§";
             $('btn-promo').disabled = true;
             $('btn-promo').style.background = "#555";
        } else if (player.appliedPromo) {
             promoText = "ç­‰å¾…æ€»éƒ¨å®¡æ ¸ (å†¬æœ«å‡ºç»“æœ)";
             $('btn-promo').disabled = true;
             $('btn-promo').style.background = "#d35400";
        } else {
             if (seasonIdx === 2) { 
                 if (maxExamStreak >= reqStreak) {
                    promoText = `ç§‹å­£çª—å£å¼€æ”¾ (æ»¡è¶³è¿èƒœ ${reqStreak})`;
                    $('btn-promo').disabled = false;
                    $('btn-promo').style.background = "var(--blue)";
                 } else {
                    promoText = `ç§‹å­£çª—å£å¼€æ”¾ (è¿èƒœä¸è¶³, éœ€${reqStreak})`;
                    $('btn-promo').disabled = true;
                    $('btn-promo').style.background = "#555";
                 }
             } else {
                 promoText = `ä»…ç§‹å­£å¼€æ”¾ (éœ€è¿èƒœ${reqStreak})`;
                 $('btn-promo').disabled = true;
                 $('btn-promo').style.background = "#555";
             }
        }
        $('promo-status').innerText = promoText;

        const restBtn = $('btn-rest');
        if (hasRestedToday) {
            restBtn.disabled = true;
            restBtn.innerText = "ğŸ›Œ ä¼‘æ¯ (æœ¬å­£å·²ä¼‘)";
            restBtn.style.background = "#555";
        } else {
            restBtn.disabled = false;
            restBtn.innerText = "ğŸ›Œ ä¼‘æ¯ (æœ¬å­£é™ä¸€æ¬¡)";
            restBtn.style.background = "var(--green)";
        }
        
        updateSliderUI('don');
    }

    // --- äº’åŠ¨é€»è¾‘ ---

    function doAction(type) {
        // è®¡ç®—ç¤¾äº¤å¯¹ç´§å¼ åº¦å‡å°‘çš„åŠ æˆï¼š1 + floor(10% soc)
        let socBonus = 1 + Math.floor(player.soc * 0.1);

        let changes = {};
        if (type === 'distribute_food') {
            if (camp.supplies < 5) return showMessage("ç‰©èµ„ä¸è¶³", "åº“å­˜ä¸è¶³ï¼");
            changes = { supplies: -5, tension: -socBonus };
        } else if (type === 'distribute_water') {
            if (camp.water < 5) return showMessage("å‡€æ°´ä¸è¶³", "åº“å­˜ä¸è¶³ï¼");
            changes = { water: -5, tension: -socBonus };
        } else if (type === 'transport') {
            let healthCost = 5;
            if (player.items.includes('suv')) { healthCost = 0; }
            if (player.health < healthCost && healthCost > 0) return showMessage("ä½“åŠ›ä¸è¶³", "å¤ªç´¯äº†ï¼");
            changes = { supplies: 10, water: 10, health: -healthCost };
        } else if (type === 'pacify') {
            if(player.energy < 10) return showMessage("ç²¾åŠ›ä¸è¶³", "éœ€è¦10ç‚¹ç²¾åŠ›");
            changes = { tension: -5, energy: -10 };
        } else if (type === 'rescue') {
            if(player.health < 10) return showMessage("ä½“åŠ›ä¸è¶³", "éœ€è¦10ç‚¹å¥åº·");
            const cap = BASE_LEVELS[camp.baseLevelIdx].cap;
            if(camp.refugees >= cap) return showMessage("è¥åœ°å·²æ»¡", `å½“å‰ç­‰çº§ä¸Šé™ ${cap} äºº`);
            changes = { health: -10, refugees: 10 };
        } else if (type === 'big_spender') {
            if(camp.funds < 1000) return showMessage("èµ„é‡‘ä¸è¶³", "éœ€è¦$1000åŸºåœ°èµ„é‡‘");
            changes = { funds: -1000, tension: -8 };
        }

        applyChanges(changes);
        showResultModal(changes, "åŸºåœ°è¡ŒåŠ¨", "è¡ŒåŠ¨å·²æ‰§è¡Œã€‚");
        saveGame('auto');
    }

    function handleFundsClick() {
        fundsClickCount++;
        if (fundsClickCount >= 3) {
            fundsClickCount = 0; // é‡ç½®è®¡æ•°å™¨
            $('embezzle-slider').value = 0;
            updateEmbezzleSlider();
            $('embezzle-modal').style.display = 'flex';
        }
    }

    function updateEmbezzleSlider() {
        const val = $('embezzle-slider').value;
        $('embezzle-val').innerText = val + "%";
        const stealAmount = Math.floor(camp.funds * (val/100));
        $('embezzle-steal').innerText = '$' + stealAmount;
        $('embezzle-gain').innerText = '$' + Math.floor(stealAmount/2);
        
        // æ–°çš„å«Œç–‘åº¦è®¡ç®—å…¬å¼ï¼šæŒªç”¨ç™¾åˆ†æ¯” - å–æ•´(0.1 * è¡Œæ”¿èƒ½åŠ›) + éšæœºæ•°(0-5)
        const percent = parseInt(val);
        const adminReduction = Math.floor(player.admin * 0.1);
        const baseSus = Math.max(0, percent - adminReduction);
        const minSus = baseSus;
        const maxSus = baseSus + 5;
        $('embezzle-suspicion').innerText = `${minSus}-${maxSus}`;
    }

    function closeEmbezzleModal() {
        $('embezzle-modal').style.display = 'none';
        $('embezzle-slider').value = 0;
        updateEmbezzleSlider();
    }

    function confirmEmbezzle() {
        const val = $('embezzle-slider').value;
        const stealAmount = Math.floor(camp.funds * (val/100));
        
        if (stealAmount <= 0) {
            showMessage("æç¤º", "è¯·é€‰æ‹©æŒªç”¨æ¯”ä¾‹ï¼");
            return;
        }
        
        camp.funds -= stealAmount;
        const gain = Math.floor(stealAmount / 2);
        player.cash += gain;

        player.stats.totalEmbezzled += stealAmount;
        player.stats.isHonest = 0; 

        // æ–°çš„å«Œç–‘åº¦è®¡ç®—å…¬å¼ï¼šæŒªç”¨ç™¾åˆ†æ¯” - å–æ•´(0.1 * è¡Œæ”¿èƒ½åŠ›) + éšæœºæ•°(0-5)
        const percent = parseInt(val);
        const adminReduction = Math.floor(player.admin * 0.1);
        const randomBonus = randInt(0, 5);
        const susIncrease = Math.max(0, percent - adminReduction + randomBonus);
        player.suspicion += susIncrease;
        
        updateUI();
        saveGame('auto');
        closeEmbezzleModal();
        
        showCustomModal(
            `<li class="change-item"><span class="change-name">åŸºåœ°èµ„é‡‘</span> <span class="change-val val-down">-$${stealAmount}</span></li>` +
            `<li class="change-item"><span class="change-name">ä¸ªäººå­˜æ¬¾</span> <span class="change-val val-up">+$${gain}</span></li>` +
            `<li class="change-item"><span class="change-name">å«Œç–‘åº¦</span> <span class="change-val val-down">+${susIncrease}</span></li>`,
            "æ“ä½œæˆåŠŸ",
            "æŒªç”¨å®Œæˆã€‚é£é™©æ­£åœ¨ç´¯ç§¯..."
        );

        if (player.suspicion >= 100) {
            setTimeout(checkSuspicion, 1000); 
        }
    }

    function checkSuspicion() {
        if (player.suspicion >= 100) {
             $('investigation-modal').style.display = 'flex';
        }
    }

    function handleInvestigationAction(action) {
        $('investigation-modal').style.display = 'none';
        
        if (player.investigationCount > 0) {
            endGameByInvestigation();
            return;
        }

        if (action === 'resist') {
            endGameByInvestigation();
        } else {
            player.investigationCount++;
            player.suspicion = 0;
            player.cash = 0;
            player.rankIndex = Math.max(0, player.rankIndex - 2);
            player.stats.hasSurrendered = 1;
            updateUI();
            saveGame('auto');
            showMessage("æ¥å—å¤„åˆ†", "ä½ ä¸Šäº¤äº†æ‰€æœ‰éæ³•æ‰€å¾—å¹¶æ¥å—äº†é™èŒå¤„åˆ†ã€‚è¿™æ˜¯æœ€åä¸€æ¬¡æœºä¼šã€‚");
        }
    }

    function endGameByInvestigation() {
        endGame('investigation', 'èº«é™·å›¹åœ„', 'ä½ çš„è´ªæ±¡è¡Œä¸ºå·²è¢«è¯å®ã€‚ä½ å·²è¢«é€®æ•å¹¶ç§»äº¤å›½é™…æ³•åº­ï¼ŒèŒä¸šç”Ÿæ¶¯å½»åº•ç»ˆç»“ã€‚');
    }
    
    function endGame(type, title, reason) {
        $('game-screen').classList.remove('active');
        $('end-screen').classList.add('active');
        $('bottom-nav').style.display = 'none';
        $('exit-game-btn').style.display = 'none';
        $('end-reason').innerText = reason;
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
        const colorMap = {
            'investigation': 'var(--primary)',
            'homesick': 'var(--blue)',
            'gameover': 'var(--danger)',
            'victory': 'var(--green)'
        };
        $('end-title').style.color = colorMap[type] || 'var(--primary)';
        $('end-title').innerText = title;
        
        localStorage.removeItem(SAVE_KEY_AUTO); 
        localStorage.removeItem(SAVE_KEY_MANUAL);
    }

    function commitDonate() {
        const val = $('don-slider').value;
        const give = Math.floor(player.cash * (val/100));
        
        if (give <= 0) return;
        
        player.cash -= give;
        camp.funds += give;
        
        updateUI();
        saveGame('auto');
        showCustomModal(
            `<li class="change-item"><span class="change-name">ä¸ªäººå­˜æ¬¾</span> <span class="change-val val-down">-$${give}</span></li>` +
            `<li class="change-item"><span class="change-name">åŸºåœ°èµ„é‡‘</span> <span class="change-val val-up">+$${give}</span></li>`,
            "æèµ æˆåŠŸ",
            "ä½ çš„æ…·æ…¨è§£å›Šç¼“è§£äº†åŸºåœ°çš„è´¢æ”¿å‹åŠ›ã€‚"
        );
        $('don-slider').value = 0;
    }

    function trainSkill(type) {
        if(player.energy < 3) return showMessage("çŠ¶æ€ä¸ä½³", "ä½ ç²¾åŠ›ä¸è¶³ï¼Œæ— æ³•é›†ä¸­æ³¨æ„åŠ›ã€‚");
        
        let gain = randInt(1, 5);
        player[type] = Math.min(100, player[type] + gain);
        applyChanges({ energy: -3 }); 

        let typeName = type==='med'?'åŒ»å­¦':(type==='admin'?'è¡Œæ”¿':'ç¤¾äº¤');
        let listHtml = `<li class="change-item"><span class="change-name">${typeName}æå‡</span> <span class="change-val val-up">+${gain}</span></li>` +
                       `<li class="change-item"><span class="change-name">ç²¾åŠ›</span> <span class="change-val val-down">-3</span></li>`;
        showCustomModal(listHtml, "èƒ½åŠ›è¿›ä¿®", "ä½ æŠ•å…¥äº†æ—¶é—´æå‡è‡ªæˆ‘ã€‚");
        saveGame('auto');
    }

    function doRest() {
        if(hasRestedToday) return showMessage("æç¤º", "æœ¬å­£åº¦å·²ç»ä¼‘æ¯è¿‡äº†ï¼");

        hasRestedToday = true; 
        applyChanges({ health: 5, energy: 5 });

        let listHtml = `<li class="change-item"><span class="change-name">å¥åº·æ¢å¤</span> <span class="change-val val-up">+5</span></li>` +
                       `<li class="change-item"><span class="change-name">ç²¾åŠ›æ¢å¤</span> <span class="change-val val-up">+5</span></li>`;
        showCustomModal(listHtml, "ä¼‘æ•´ç»“æŸ", "è™½ç„¶åªæœ‰çŸ­æš‚çš„ä¼‘æ¯ï¼Œä½†æ„Ÿè§‰å¥½å¤šäº†ã€‚");
        updateUI(); 
        saveGame('auto');
    }

    function interactBoss(type) {
        if (type === 'network') {
            if (player.energy < 3) return showMessage("çŠ¶æ€ä¸ä½³", "ç²¾åŠ›å¤ªå·®ï¼Œä¸é€‚åˆç¤¾äº¤ã€‚");
            
            let randBase = randInt(-3, 3);
            let socBonus = Math.floor(player.soc * 0.1);
            let gain = randBase + socBonus;

            let oldFavor = player.favor;
            player.favor = Math.min(100, Math.max(0, player.favor + gain));
            applyChanges({ energy: -3 });
            
            let actualChange = player.favor - oldFavor;
            let listHtml = `<li class="change-item"><span class="change-name">ä¸Šçº§å¥½æ„Ÿ</span> <span class="change-val ${actualChange>=0?'val-up':'val-down'}">${actualChange>=0?'+':''}${actualChange}</span></li>` +
                           `<li class="change-item"><span class="change-name">ç²¾åŠ›</span> <span class="change-val val-down">-3</span></li>`;
            
            let desc = actualChange > 0 ? "æ²Ÿé€šéå¸¸é¡ºåˆ©ï¼Œä¸Šçº§å¯¹ä½ çš„å°è±¡åŠ æ·±äº†ã€‚" : (actualChange < 0 ? "ä¹Ÿè®¸æ˜¯è¯´è¯æ–¹å¼ä¸å¯¹ï¼Œæ°”æ°›å˜å¾—å°´å°¬äº†ã€‚" : "è¿™æ˜¯ä¸€æ¬¡å¹³æ·¡çš„è°ˆè¯ã€‚");
            showCustomModal(listHtml, "äººé™…äº¤å¾€", desc);

        } else if (type === 'fund') {
            if (player.favor < 3) return showMessage("è¯·æ±‚è¢«æ‹’", "ä¸Šçº§å¯¹ä½ çš„å¥½æ„Ÿä¸è¶³ï¼Œä¸æ„¿å—ç†è¯·æ±‚ã€‚");
            
            player.favor -= 3;
            let success = (Math.random() * 100) < player.favor;
            
            let listHtml = `<li class="change-item"><span class="change-name">ä¸Šçº§å¥½æ„Ÿ</span> <span class="change-val val-down">-3</span></li>`;
            let msg = "";
            let title = "";
            
            if (success) {
                let amount = randInt(500, 1000);
                camp.funds += amount;
                title = "ç”³è¯·æ‰¹å‡†";
                msg = `ä¸Šçº§æ‰¹å‡†äº†ä½ çš„ç‰¹åˆ«èµ„é‡‘ç”³è¯·ã€‚`;
                listHtml += `<li class="change-item"><span class="change-name">åŸºåœ°èµ„é‡‘</span> <span class="change-val val-up">+$${amount}</span></li>`;
            } else {
                title = "ç”³è¯·é©³å›";
                msg = "ä¸Šçº§è®¤ä¸ºç›®å‰ä¸éœ€è¦é¢å¤–æ‹¨æ¬¾ã€‚";
            }
            updateUI();
            showCustomModal(listHtml, title, msg);
        }
        saveGame('auto');
    }

    function applyForPromotion() {
        // Check strict streak req
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;
        if (maxExamStreak < reqStreak) {
            return showMessage("æ¡ä»¶ä¸è¶³", `å½“å‰èŒçº§æ™‹å‡éœ€è¦æœ€é«˜è¿èƒœè¾¾åˆ° ${reqStreak} æ¬¡ã€‚`);
        }
        if (player.favor < 40) return showMessage("å¥½æ„Ÿä¸è¶³", "ç”³è¯·æ™‹å‡éœ€è¦æ¶ˆè€—40ç‚¹ä¸Šçº§å¥½æ„Ÿåº¦ã€‚");

        player.appliedPromo = true;
        player.favor -= 40; 
        player.lastPromoQuarter = currentQuarter; 
        updateUI();
        saveGame('auto');
        showMessage("å·²æäº¤", "å·²æäº¤æ™‹å‡ç”³è¯·ï¼Œæ€»éƒ¨å°†åœ¨å†¬å­£ç»“æŸæ—¶è¿›è¡Œè€ƒæ ¸ã€‚");
    }

    function processPromotion() {
        if (!player.appliedPromo) return;
        
        // Hard requirement: Streak. Assuming checked at apply time, but check again for safety
        const reqStreak = RANK_REQ_STREAK[player.rankIndex + 1] || 0;
        
        let success = (maxExamStreak >= reqStreak);
        let logText = "";
        let resultHtml = "";
        
        if (success) {
            player.rankIndex++;
            // 40å¥½æ„Ÿåº¦å·²åœ¨ç”³è¯·æ—¶æ‰£é™¤ï¼ŒæˆåŠŸåä¸å†æ‰£é™¤
            logText = `æ­å–œï¼ä½ çš„æ™‹å‡ç”³è¯·é€šè¿‡äº†ã€‚ç°ä»»èŒçº§ï¼š${CONFIG.ranks[player.rankIndex]}ã€‚è–ªæ°´æå‡è‡³ $${RANK_SALARIES[player.rankIndex]}ã€‚`;
            addAchievement(`ç¬¬${Math.ceil(currentQuarter/4)}å¹´: æ™‹å‡ä¸º ${CONFIG.ranks[player.rankIndex]}`);
            resultHtml = `<li class="change-item"><span class="change-name">èŒçº§</span> <span class="change-val val-up">æ™‹å‡</span></li>`;
        } else {
            logText = `å¾ˆé—æ†¾ï¼Œä½ çš„æ™‹å‡ç”³è¯·è¢«é©³å›ã€‚éœ€åœ¨è€ƒæ ¸ä¸­è¯æ˜è‡ªå·±(æœ€é«˜è¿èƒœ>=${reqStreak})ã€‚`;
            resultHtml = `<li class="change-item"><span class="change-name">ç»“æœ</span> <span class="change-val val-down">å¤±è´¥</span></li>`;
        }
        
        showCustomModal(resultHtml, "å¹´åº¦è€ƒæ ¸ç»“æœ", logText);
        player.appliedPromo = false;
    }
    
    function addAchievement(text) {
        let li = document.createElement('li');
        li.className = 'achieve-item';
        li.innerText = text;
        $('achievement-list').appendChild(li);
    }

    // --- æ ¸å¿ƒå¾ªç¯ API ---

    async function callDeepSeek(prompt, isJson = false) {
        let apiKey = $('api-key').value;
        if (!apiKey || apiKey.trim() === "") apiKey = DEVELOPER_API_KEY; // Use hardcoded key if empty

        const apiUrl = $('api-url').value; 
        const model = $('model-name').value;
        const endpoint = apiUrl.endsWith('/') ? `${apiUrl}chat/completions` : `${apiUrl}/chat/completions`;
        const body = { model: model, messages: [{ role: "system", content: "You are a game engine." }, { role: "user", content: prompt }], stream: false };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify(body)
        });

        if (!response.ok) {
            const err = await response.text();
            throw new Error(`API Error: ${response.status} - ${err}`);
        }

        const json = await response.json();
        let content = json.choices[0].message.content;
        content = content.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();

        if (isJson) return JSON.parse(content);
        return content;
    }

    async function generateStory() {
        $('gen-story-btn').disabled = true;
        $('gen-story-btn').innerText = "â³ æ­£åœ¨æ•´ç†æ¡£æ¡ˆ...";
        $('story-container').style.display = 'block';

        const summary = historyLog.map(log => 
            `Q${log.day}: é‡åˆ°ã€${log.event}ã€‘ã€‚é€‰æ‹©ã€${log.choice}ã€‘ã€‚ç»“æœï¼š${log.isSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}ã€‚åæœï¼š${log.resultText}`
        ).join("\n");

        const prompt = `ä½ æ˜¯ä¸€å${player.dept}åŒ»ç”Ÿï¼Œåå«${player.name}ï¼Œæœ€ç»ˆèŒçº§${CONFIG.ranks[player.rankIndex]}ã€‚åœ°ç‚¹ï¼š${player.location}ã€‚è¯·æ ¹æ®ä»¥ä¸‹æˆ‘çš„å‰çº¿ç»å†ï¼Œä»¥ç¬¬ä¸€äººç§°å†™ä¸€ç¯‡â€œæˆ˜åœ°æ—¥è®°â€ã€‚\nç»å†è®°å½•ï¼š\n${summary}\nè¦æ±‚ï¼šæƒ…æ„ŸçœŸæŒšï¼Œä½“ç°æ— å›½ç•ŒåŒ»ç”Ÿçš„ç²¾ç¥ä¸æˆ˜äº‰æ®‹é…·ã€‚çº¦300å­—ã€‚`;

        try {
            if($('use-mock').checked) { 
                await wait(1500); 
                $('story-content').innerText = "ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰æ—¥è®°ç”Ÿæˆæ¼”ç¤ºï¼š\nä»Šå¤©æ˜¯ä¸ªè‰°éš¾çš„æ—¥å­ã€‚é›¨ä¸€ç›´åœ¨ä¸‹...ï¼ˆè¯·ä½¿ç”¨API Keyè·å–å®Œæ•´AIç”Ÿæˆæ•…äº‹ï¼‰";
            } else {
                const story = await callDeepSeek(prompt, false);
                $('story-content').innerText = story;
            }
        } catch(e) {
            $('story-content').innerText = "ç”Ÿæˆå¤±è´¥: " + e.message;
        }
        $('gen-story-btn').innerText = "ğŸ“– ç”Ÿæˆæˆ˜åœ°æ—¥è®° (å›é¡¾)";
        $('gen-story-btn').disabled = false;
    }

    async function generateBio() {
        const prompt = `ä½ æ˜¯ä¸€ä¸ªå°è¯´å®¶ã€‚èƒŒæ™¯ï¼š${player.location} çš„æ— å›½ç•ŒåŒ»ç”Ÿ(MSF)è¥åœ°ã€‚äººç‰©ï¼š${player.name}ï¼Œ${player.gender}ï¼Œç§‘å®¤ï¼šã€${player.dept}ã€‘ã€‚å‚è€ƒæ•°å€¼ï¼šåŒ»å­¦${player.med}ï¼Œè¡Œæ”¿${player.admin}ï¼Œç¤¾äº¤${player.soc}ã€‚\nè¯·ç”Ÿæˆä¸€æ®µçº¦150å­—çš„äººç‰©ä»‹ç»ï¼Œç¦æ­¢å‡ºç°å…·ä½“æ•°å€¼ï¼Œä½¿ç”¨ç”Ÿæ´»åŒ–é˜¶æ¢¯æè¿°ã€‚`;
        if($('use-mock').checked) { await wait(1000); return "ï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰è¿™é‡Œæ˜¯å‰çº¿ã€‚ä½œä¸ºä¸€åå¤–ç§‘åŒ»ç”Ÿï¼Œä»–å†·é™è€Œæœæ•¢ï¼Œæ‰‹æœ¯åˆ€æ˜¯ä»–åœ¨åœ°ç‹±ä¸­å”¯ä¸€çš„ä¿¡ä»°ã€‚"; }
        return await callDeepSeek(prompt, false);
    }

    async function generateEventData() {
        const roll = Math.random() * 100;
        let eventType = "";
        let effectConstraints = "";

        if (roll < 40) {
            eventType = "å¤–éƒ¨å±æœº";
            effectConstraints = "é€‰é¡¹ç»“æœå¿…é¡»åªå½±å“ã€åŸºåœ°å±æ€§ã€‘ï¼šç´§å¼ åº¦(tension)ã€èµ„é‡‘(funds)(-500/1000/1500)ã€ç‰©èµ„(supplies)(5-10)ã€å‡€æ°´(water)(5-10)ã€‚";
        } else if (roll < 70) {
            eventType = "å†…éƒ¨å±æœº";
            effectConstraints = "é€‰é¡¹ç»“æœå¿…é¡»åªå½±å“ã€åŸºåœ°å±æ€§ã€‘ï¼šç´§å¼ åº¦(tension)ã€èµ„é‡‘(funds)(-500/1000/1500)ã€ç‰©èµ„(supplies)(5-10)ã€å‡€æ°´(water)(5-10)ã€‚";
        } else if (roll < 90) {
            eventType = "ä¸ªäººå±æœº";
            effectConstraints = "é€‰é¡¹ç»“æœå¿…é¡»åªå½±å“ã€äººç‰©å±æ€§ã€‘ï¼šå¥åº·(health)ï¼ˆ-5æˆ–+5ï¼‰ã€ç²¾åŠ›(energy)ï¼ˆ-5æˆ–+5ï¼‰ã€é‡‘é’±(cash)(-50/100/200/250)ã€èƒ½åŠ›(med/admin/soc)(2-5)ã€å«Œç–‘åº¦(suspicion)(-10åˆ°+10)ã€‚";
        } else {
            eventType = "å¹¸è¿äº‹ä»¶";
            effectConstraints = "è¯·æä¾›3ä¸ªæ­£é¢é€‰é¡¹ï¼ˆå¯ä»¥3é€‰1ï¼‰ï¼Œæ¯ä¸ªé€‰é¡¹å¢åŠ éšæœºä¸€é¡¹ã€åŸºåœ°å±æ€§ã€‘æˆ–ã€äººç‰©å±æ€§ã€‘ï¼ˆæ•°å€¼=5ï¼‰ï¼Œé™¤äº†é‡‘é’±(cash)(100/200/250)å’Œèµ„é‡‘(funds)(500/1000/1500)ã€‚";
        }
        
        const timeInfo = getSeasonInfo();
        const displayTime = `ç¬¬${timeInfo.year}å¹´ ${timeInfo.season}`;

        const contextPrompt = `
        èƒŒæ™¯ï¼š${player.location} (æ— å›½ç•ŒåŒ»ç”Ÿå‰çº¿)ã€‚å½“å‰æ—¶é—´ï¼š${displayTime}ã€‚
        äº‹ä»¶ç±»å‹è¦æ±‚ï¼šã€${eventType}ã€‘ã€‚
        çº¦æŸæ¡ä»¶ï¼š${effectConstraints}
        ç©å®¶èŒä½:${CONFIG.ranks[player.rankIndex]}ã€‚
        
        è¯·ç”Ÿæˆä¸€ä¸ªç¬¦åˆç±»å‹çš„éšæœºäº‹ä»¶ã€‚
        è¦æ±‚ï¼š
        1. å¿…é¡»åŒ…å«3ä¸ªé€‰é¡¹ã€‚å¯¹äºå±æœºäº‹ä»¶ï¼Œå…¶ä¸­1-2ä¸ªä¸ºé™·é˜±/æ— æ•ˆé€‰é¡¹ï¼›å¯¹äºå¹¸è¿äº‹ä»¶ï¼Œ3ä¸ªéƒ½æ˜¯å¥–åŠ±ã€‚
        2. è¿”å›çº¯JSONæ ¼å¼ï¼Œä¸è¦Markdownä»£ç å—æ ‡è®°ï¼š
        {
            "type": "${eventType}ï¼š(å…·ä½“åç§°)",
            "description": "...",
            "choices": [
                { "text": "...", "stat": "med/admin/soc", "result_win": "...", "result_lose": "...", "effects_win": {"key": value}, "effects_lose": {"key": value} }
            ]
        }
        æ³¨æ„ï¼šeffectså¯¹è±¡çš„keyåªèƒ½æ˜¯: tension, funds, supplies, water, health, energy, cash, med, admin, soc, suspicionã€‚
        `;
        
        if($('use-mock').checked) { await wait(1500); return mockEvent(eventType); }
        return await callDeepSeek(contextPrompt, true);
    }

    // --- æ¸¸æˆå¾ªç¯ ---

    async function triggerNextQuarter() {
        player.stats.totalQuarters = (player.stats.totalQuarters || 0) + 1;
        player.stats.currentLocQuarters++;
        
        // å¢åŠ è°ƒä»»é€»è¾‘ (è¦æ±‚4)
        if(player.stats.currentLocQuarters >= 12) {
            addTransferButton();
        }
        
        // 1. æœ¬å­£åº¦ç»“ç®—ï¼šæ‰£é™¤ä¸ªäººç”Ÿæ´»è´¹
        player.cash -= 50;

        // 2. åŸºåœ°èµ„é‡‘æ¶ˆè€—è®¡ç®—
        let fundCost = 1000 - (player.admin * 10) + (camp.tension * 10);
        if (fundCost < 0) fundCost = 100; // æœ€ä½æ¶ˆè€—
        camp.funds -= fundCost;

        // éš¾æ°‘è‡ªç„¶è¡°å‡
        const decayRef = randInt(5, 10);
        camp.refugees = Math.max(0, camp.refugees - decayRef);
        
        // ç‰©èµ„ä¸å‡€æ°´è‡ªç„¶è¡°å‡ï¼šéšæœº(3-6)
        const decaySupplies = randInt(3, 6);
        const decayWater = randInt(3, 6);
        camp.supplies = Math.max(0, camp.supplies - decaySupplies);
        camp.water = Math.max(0, camp.water - decayWater);
        
        // ç—…äººç”Ÿå‘½æŒ‡å¾è¡°å‡
        patients.forEach(p => {
            if(p.isDead) return;
            // è¡°å‡é‡ï¼šè½»ç—‡5-10ï¼Œä¸­ç—‡10-15ï¼Œé‡ç—‡15-20
            const decayRanges = [[5,10], [10,15], [15,20]];
            const [min, max] = decayRanges[p.sev];
            const decay = randInt(min, max);
            p.vital = (p.vital || 60) - decay;
            
            // ç”Ÿå‘½æŒ‡å¾â‰¤0ï¼Œç—…äººæ­»äº¡
            if(p.vital <= 0) {
                p.vital = 0;
                p.isDead = true;
                player.stats.deaths = (player.stats.deaths || 0) + 1;
                addLog(`ğŸ’€ ${p.bed}åºŠç—…äººå› ç—…æƒ…æ¶åŒ–æ­»äº¡ã€‚`);
            }
            // é‡ç½®æ¯å­£åº¦æ²»ç–—æ¬¡æ•°
            p.treatCount = 0;
        });
        renderPatients();
        
        // è§¦å‘ç‰¹æ®Šäº‹ä»¶
        await checkSpecialEvents();

        if (!checkGameOver()) return;
        
        $('next-day-btn').style.display = 'none';
        $('next-quarter-msg').style.display = 'none';
        $('event-area').style.display = 'none';
        $('start-event-btn').style.display = 'block'; 
        isEventResolved = false;
        hasRestedToday = false; 
        admittedCount = 0; // Reset admissions
        hasRounded = false; // Reset rounds
        hasTakenExam = false; // Reset exam attempt (streak preserved if didn't fail)

        // 3. åŸºåœ°å›ºå®šæ‹¨æ¬¾ (æ–°å­£åº¦èµ„é‡‘)
        camp.funds += 1000;
        
        // å¢åŠ å­£åº¦
        currentQuarter++;

        // 4. ä¸ªäººè–ªæ°´å‘æ”¾ (æ–°å­£åº¦å¼€å§‹)
        const salary = RANK_SALARIES[player.rankIndex];
        player.cash += salary;

        // 5. å«Œç–‘åº¦è‡ªç„¶è¡°å‡
        let decay = randInt(3, 7);
        player.suspicion = Math.max(0, player.suspicion - decay);
        
        // å±é™©åº¦è‡ªç„¶å¢é•¿
        if ((currentQuarter - 1) % 4 === 0) { 
            dangerLevel += 5;
        }

        updateUI();
        
        if (player.appliedPromo && (currentQuarter - 2) % 4 === 3) {
            processPromotion();
        }

        if (!checkGameOver()) return;
        if (checkVictory()) return;
        
        if (player.suspicion >= 100) {
            if (player.investigationCount > 0) {
                endGameByInvestigation();
            } else {
                $('investigation-modal').style.display = 'flex';
            }
        } else {
            switchNav('event');
        }
        saveGame('auto');
    }

    function addTransferButton() {
        if($('btn-transfer')) return;
        let btn = document.createElement('button');
        btn.id = 'btn-transfer';
        btn.innerText = "ğŸš€ ç”³è¯·è°ƒä»» (3å¹´æœŸæ»¡)";
        btn.onclick = () => {
            if(!player.stats.visitedLocs) player.stats.visitedLocs = [];
            player.stats.visitedLocs.push(player.location);
            let available = CHAR_LOCATIONS.filter(l => !player.stats.visitedLocs.includes(l));
            if(available.length === 0) available = CHAR_LOCATIONS; // Reset if all visited
            player.location = available[randInt(0, available.length-1)];
            player.stats.currentLocQuarters = 0;
            camp.baseLevelIdx = 0; // åŸºåœ°é‡ç½®
            btn.remove(); // Remove button after transfer
            showMessage("è°ƒä»»æˆåŠŸ", `ä½ å·²å‰å¾€ ${player.location}ï¼ŒèŒçº§å·²ä¿ç•™ï¼Œéœ€ä»å¤´å»ºè®¾åŸºåœ°ã€‚`);
            updateUI();
        };
        $('tab-character').appendChild(btn);
    }
    
    // ç‰¹æ®Šäº‹ä»¶æ£€æŸ¥
    async function checkSpecialEvents() {
        for(const evt of SPECIAL_EVENTS) {
            if(Math.random() < evt.chance && evt.condition()) {
                await triggerSpecialEvent(evt);
                break; // æ¯å­£åº¦æœ€å¤šè§¦å‘1ä¸ªç‰¹æ®Šäº‹ä»¶
            }
        }
    }
    
    async function triggerSpecialEvent(evt) {
        addLog(`âš¡ ç‰¹æ®Šäº‹ä»¶ï¼š${evt.name}`);
        
        if(evt.effect === 'transfer') {
            // ä¸å¯æŠ—åŠ›ï¼šå¼ºåˆ¶è°ƒä»»
            if(!player.stats.visitedLocs) player.stats.visitedLocs = [];
            player.stats.visitedLocs.push(player.location);
            let available = CHAR_LOCATIONS.filter(l => !player.stats.visitedLocs.includes(l));
            if(available.length === 0) available = CHAR_LOCATIONS;
            player.location = available[randInt(0, available.length-1)];
            player.stats.currentLocQuarters = 0;
            camp.baseLevelIdx = 0;
            showMessage(`âš¡ ${evt.name}`, `${evt.desc}\n\nä½ è¢«è°ƒå¾€ ${player.location}ã€‚`);
            updateUI();
        } 
        else if(evt.effect === 'promote') {
            // é’äº‘ç›´ä¸Šï¼šæ™‹å‡1çº§
            player.rankIndex++;
            showMessage(`âš¡ ${evt.name}`, `${evt.desc}\n\nä½ å·²æ™‹å‡ä¸º ${RANKS[player.rankIndex]}ï¼`);
            updateUI();
        }
        else if(evt.effect === 'homesick') {
            // ç¾æ³Šæ¬²ç©·å¹´ï¼šæ˜¾ç¤ºé€‰æ‹©å¼¹çª—
            return new Promise(resolve => {
                $('special-event-modal').style.display = 'flex';
                $('special-event-title').innerText = `âš¡ ${evt.name}`;
                $('special-event-desc').innerText = evt.desc;
                $('special-event-choices').innerHTML = `
                    <button class="modal-btn" style="background:var(--danger); margin-bottom:10px;" onclick="handleHomesickChoice('resign')">ğŸ  è¾èŒå›å®¶</button>
                    <button class="modal-btn secondary" onclick="handleHomesickChoice('stay')">ğŸ’ª åšå®ˆå²—ä½</button>
                `;
                window.specialEventResolve = resolve;
            });
        }
    }
    
    function handleHomesickChoice(choice) {
        $('special-event-modal').style.display = 'none';
        
        if(choice === 'resign') {
            // è§¦å‘"å½’ä¹¡"ç»“å±€
            endGame('homesick', 'å½’ä¹¡', 'ä½ é€‰æ‹©äº†å›åˆ°æ•…ä¹¡ã€‚ä¹Ÿè®¸å‰çº¿éœ€è¦ä½ ï¼Œä½†å®¶äººæ›´éœ€è¦ä½ ã€‚åœ¨æ¼«é•¿çš„æ—…é€”ä¸­ï¼Œä½ å›æœ›è¿™ç‰‡åœŸåœ°ï¼Œå¿ƒä¸­äº”å‘³æ‚é™ˆã€‚ä½ çš„åŒ»ç–—ç”Ÿæ¶¯å°±æ­¤å‘Šä¸€æ®µè½ï¼Œä½†ç”Ÿæ´»è¿˜åœ¨ç»§ç»­ã€‚');
        } else {
            // åšå®ˆå²—ä½ï¼šé™ä½10ç‚¹èƒ½åŠ›
            player.med = Math.max(0, player.med - 10);
            player.admin = Math.max(0, player.admin - 10);
            player.soc = Math.max(0, player.soc - 10);
            showMessage("åšå®ˆå²—ä½", "ä½ å‹ä¸‹äº†å†…å¿ƒçš„æ€å¿µï¼Œé€‰æ‹©ç»§ç»­ç•™åœ¨è¿™é‡Œã€‚ä½†è¿™ä¸ªå¤œæ™šåœ¨ä½ å¿ƒä¸­ç•™ä¸‹äº†ä¼¤ç—•ã€‚\n\nåŒ»å­¦ã€è¡Œæ”¿ã€ç¤¾äº¤èƒ½åŠ›å„ -10");
            updateUI();
        }
        
        if(window.specialEventResolve) {
            window.specialEventResolve();
            window.specialEventResolve = null;
        }
    }

    function renderEvent(data) {
        $('loading-spinner').style.display = 'none';
        $('event-area').style.display = 'block';
        $('event-tag').innerText = data.type;
        $('event-desc').innerText = data.description;
        const c = $('choices-container');
        c.innerHTML = '';
        data.choices.forEach(choice => {
            let btn = document.createElement('button');
            btn.className = 'choice-btn';
            let statName = choice.stat === 'med' ? 'åŒ»å­¦' : (choice.stat === 'admin' ? 'è¡Œæ”¿' : 'ç¤¾äº¤');
            btn.innerHTML = `<strong>> ${choice.text}</strong> <span style="font-size:0.8em; color:var(--accent)">[æ£€å®š:${statName}]</span>`;
            btn.onclick = () => resolveEvent(choice, data.type);
            c.appendChild(btn);
        });
    }

    function resolveEvent(choice, eventType) {
        let threshold = 9 + (dangerLevel / 5);
        const statVal = player[choice.stat] || 0;
        const roll = Math.random() * 10;
        const score = (statVal * 0.1) + roll;
        const isSuccess = score >= threshold;

        const finalEffects = isSuccess ? choice.effects_win : choice.effects_lose;
        const finalResultText = isSuccess ? choice.result_win : choice.result_lose;
        
        applyChanges(finalEffects);
        historyLog.push({ day: currentQuarter, event: eventType, choice: choice.text, isSuccess: isSuccess, resultText: finalResultText });

        const statusText = isSuccess ? `âœ… æ£€å®šæˆåŠŸ` : `âŒ æ£€å®šå¤±è´¥`;
        const statusClass = isSuccess ? "status-success" : "status-fail";
        showResultModal(finalEffects, "äº‹ä»¶ç»“ç®—", finalResultText, statusText, statusClass);
        
        isEventResolved = true;
        $('event-area').style.display = 'none';
        $('next-day-btn').style.display = 'block'; 
        $('next-quarter-msg').style.display = 'block';
        
        checkGameOver();
        saveGame('auto');
    }

    function mockEvent(type) {
        let desc = "çªå‘æƒ…å†µï¼š";
        let c = [];
        if (type.includes("å¤–éƒ¨") || type.includes("å†…éƒ¨")) {
             desc += "ç”±äºæˆ˜ä¹±ï¼Œä¸€æ‰¹éš¾æ°‘æ¶Œå…¥ï¼Œå¯¼è‡´ç‰©èµ„ç´§å¼ ã€‚";
             c = [
                 { text: "ç´§æ€¥è°ƒé…", stat: "admin", result_win: "ç‰©èµ„é‡æ–°åˆ†é…ã€‚", result_lose: "å¼•å‘æ··ä¹±ã€‚", effects_win: {tension:-5}, effects_lose: {tension:5, supplies:-10} },
                 { text: "å®‰æŠšæƒ…ç»ª", stat: "soc", result_win: "å¤§å®¶å†·é™ä¸‹æ¥ã€‚", result_lose: "æ²¡äººå¬ä½ çš„ã€‚", effects_win: {tension:-10}, effects_lose: {energy:-5} },
                 { text: "åŒ»ç–—æ”¯æ´", stat: "med", result_win: "é˜²æ­¢äº†ç–«æƒ…ã€‚", result_lose: "è¯å“è€—å°½ã€‚", effects_win: {health:2}, effects_lose: {supplies:-20} }
             ];
        } else if (type.includes("ä¸ªäºº")) {
            desc += "ä½ æ„Ÿåˆ°èº«ä½“ä¸é€‚ï¼Œå¯èƒ½æ˜¯è¿‡åº¦åŠ³ç´¯ã€‚";
            c = [
                { text: "è‡ªæˆ‘è¯Šæ–­", stat: "med", result_win: "åªæ˜¯å°æ„Ÿå†’ã€‚", result_lose: "è¯¯è¯ŠåŠ é‡ã€‚", effects_win: {health:2}, effects_lose: {health:-5} },
                { text: "åšæŒå·¥ä½œ", stat: "admin", result_win: "å·¥ä½œå®Œæˆäº†ã€‚", result_lose: "æ™•å€’åœ¨å²—ä½ã€‚", effects_win: {cash:50}, effects_lose: {health:-10} },
                { text: "æ‰¾äººå€¾è¯‰", stat: "soc", result_win: "å¿ƒæƒ…å¥½å¤šäº†ã€‚", result_lose: "è¢«å«Œå¼ƒçƒ¦ã€‚", effects_win: {energy:5}, effects_lose: {energy:-5} }
            ];
        } else {
            desc += "è¿™æ˜¯ä¸€ä¸ªå¹¸è¿çš„æ—¥å­ï¼";
            c = [
                { text: "æ¡åˆ°é’±", stat: "admin", result_win: "è¿æ°”ä¸é”™ã€‚", result_lose: "è¿æ°”ä¸é”™ã€‚", effects_win: {cash:200}, effects_lose: {cash:200} },
                { text: "ä¼‘æ¯å……è¶³", stat: "med", result_win: "ç²¾åŠ›å……æ²›ã€‚", result_lose: "ç²¾åŠ›å……æ²›ã€‚", effects_win: {health:5}, effects_lose: {health:5} },
                { text: "æ”¶åˆ°æ„Ÿè°¢ä¿¡", stat: "soc", result_win: "å¿ƒæƒ…å¤§å¥½ã€‚", result_lose: "å¿ƒæƒ…å¤§å¥½ã€‚", effects_win: {energy:5}, effects_lose: {energy:5} }
            ];
        }
        
        return {
            type: type,
            description: desc,
            choices: c
        };
    }

    function applyChanges(effects) {
        for(let key in effects) {
            if(player[key] !== undefined) player[key] += effects[key];
            if(camp[key] !== undefined) camp[key] += effects[key];
        }
        updateUI();
    }

    function showResultModal(effects, title, description, statusText, statusClass) {
        const list = $('result-list');
        list.innerHTML = '';
        if (statusText) {
            $('result-status').innerText = statusText;
            $('result-status').className = statusClass || "";
            $('result-status').style.display = 'block';
        } else {
            $('result-status').style.display = 'none';
        }
        $('result-text').innerText = description;
        
        let hasContent = false;
        const map = { health: "å¥åº·", energy: "ç²¾åŠ›", supplies: "ç‰©èµ„", water: "å‡€æ°´", tension: "ç´§å¼ åº¦", refugees: "éš¾æ°‘", funds: "èµ„é‡‘", favor: "å¥½æ„Ÿ", med:"åŒ»å­¦", admin:"è¡Œæ”¿", soc:"ç¤¾äº¤", cash:"é‡‘é’±", suspicion:"å«Œç–‘" };
        for(let key in effects) {
            let val = effects[key];
            if(val === 0) continue;
            hasContent = true;
            let isGood = (key === 'tension' || key === 'suspicion') ? val < 0 : val > 0;
            if(key === 'funds' && val < 0) isGood = false;
            
            let li = document.createElement('li');
            li.className = 'change-item';
            let displayVal = val;
            if (key === 'funds' || key === 'cash') displayVal = '$' + val;
            
            li.innerHTML = `<span class="change-name">${map[key]||key}</span><span class="change-val ${isGood?'val-up':'val-down'}">${val>0?'+':''}${displayVal}</span>`;
            list.appendChild(li);
        }
        if(!hasContent) list.innerHTML = '<li class="change-item">æ— æ˜¾è‘—æ•°å€¼å˜åŒ–</li>';
        
        $('result-modal').querySelector('.modal-header').innerText = title;
        $('result-modal').style.display = 'flex';
    }
    
    function showCustomModal(html, title, description) {
        $('result-status').style.display = 'none'; 
        $('result-text').innerText = description;
        $('result-list').innerHTML = html;
        $('result-modal').querySelector('.modal-header').innerText = title;
        $('result-modal').style.display = 'flex';
    }

    function closeModal() {
        $('result-modal').style.display = 'none';
        checkGameOver();
    }

    function checkGameOver() {
        let reason = null;
        if(camp.tension >= 100) reason = "è¥åœ°æš´åŠ¨ï¼Œæ­¦è£…åˆ†å­æ¥ç®¡äº†è¿™é‡Œã€‚";
        else if(camp.supplies <= 0) reason = "ç‰©èµ„è€—å°½ï¼Œè¥åœ°å´©æºƒã€‚";
        else if(camp.water <= 0) reason = "æ°´æºæ¯ç«­ï¼Œç–«æƒ…å¤±æ§ã€‚";
        else if(camp.funds <= 0) reason = "åŸºåœ°èµ„é‡‘æ–­è£‚ï¼Œé¡¹ç›®è¢«è¿«å…³åœã€‚";
        else if(player.cash < 0) reason = "ä¸ªäººç ´äº§ï¼Œæ— æ³•ç»´æŒç”Ÿè®¡ï¼Œè¢«è¿«å›å›½ã€‚";
        else if(player.health <= 0) reason = "ä½ åœ¨å²—ä½ä¸Šå€’ä¸‹äº†ã€‚";
        else if(player.energy <= 0) reason = "ä½ çš„ç²¾åŠ›å½»åº•é€æ”¯ã€‚";
        
        if(reason) {
            $('game-screen').classList.remove('active');
            $('end-screen').classList.add('active');
            $('bottom-nav').style.display = 'none';
            $('exit-game-btn').style.display = 'none';
            $('end-reason').innerText = reason;
            $('end-title').style.color = "var(--primary)";
            $('end-title').innerText = "è¡ŒåŠ¨å¤±è´¥";
            localStorage.removeItem(SAVE_KEY_AUTO);
            return false;
        }
        return true;
    }

    function checkVictory() {
        if (player.rankIndex === 5) {
            quartersSinceRank6++;
        }
        
        if (player.rankIndex === 5 && quartersSinceRank6 >= 3 && !isVictoryPending) {
             $('game-screen').classList.remove('active');
             $('end-screen').classList.add('active');
             $('bottom-nav').style.display = 'none';
             $('exit-game-btn').style.display = 'none';
             $('end-title').style.color = "var(--green)";
             $('end-title').innerText = "å…‰è£é€€ä¼‘";
             $('end-reason').innerText = `ä½ å·²æˆä¸ºåŒºåŸŸæ€»ç­¹å¹¶ç¨³å®šç»´æŒäº†å±€åŠ¿ã€‚ä½ æ˜¯éå‡¡çš„æŒ‡æŒ¥å®˜ã€‚`;
             $('continue-game-area').style.display = 'block';
             localStorage.removeItem(SAVE_KEY_AUTO); 
             return true;
        }
        return false;
    }

    function continueGame() {
        isVictoryPending = true; 
        $('end-screen').classList.remove('active');
        $('game-screen').classList.add('active');
        $('bottom-nav').style.display = 'grid';
        $('exit-game-btn').style.display = 'block';
        saveGame('auto'); 
        switchNav('event');
    }
</script>

</body>
</html>